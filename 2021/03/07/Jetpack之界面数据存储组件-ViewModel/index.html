<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-material.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tinlone.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ViewModelè¿™ä¸ªåç§°å¸¸å¸¸ä½¿äººè¯¯è§£ä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿å‘¢ï¼Ÿ ViewModelå¯ä»¥ä½œä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œä½†ä¸æ˜¯ç‰¹æŒ‡MVVMä¸­çš„ViewModelå±‚ã€‚  ViewModel ç±»æ—¨åœ¨ä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®ã€‚ViewModel ç±»è®©æ•°æ®å¯åœ¨å‘ç”Ÿå±å¹•æ—‹è½¬ç­‰é…ç½®æ›´æ”¹åç»§ç»­ç•™å­˜ã€‚  å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒè§†ä½œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„">
<meta property="og:type" content="article">
<meta property="og:title" content="Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel">
<meta property="og:url" content="http://tinlone.com/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/index.html">
<meta property="og:site_name" content="Tinlone">
<meta property="og:description" content="ViewModelè¿™ä¸ªåç§°å¸¸å¸¸ä½¿äººè¯¯è§£ä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿å‘¢ï¼Ÿ ViewModelå¯ä»¥ä½œä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œä½†ä¸æ˜¯ç‰¹æŒ‡MVVMä¸­çš„ViewModelå±‚ã€‚  ViewModel ç±»æ—¨åœ¨ä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®ã€‚ViewModel ç±»è®©æ•°æ®å¯åœ¨å‘ç”Ÿå±å¹•æ—‹è½¬ç­‰é…ç½®æ›´æ”¹åç»§ç»­ç•™å­˜ã€‚  å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒè§†ä½œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://developer.android.google.cn/images/topic/libraries/architecture/viewmodel-lifecycle.png">
<meta property="article:published_time" content="2021-03-07T09:02:10.963Z">
<meta property="article:modified_time" content="2021-03-07T08:41:22.092Z">
<meta property="article:author" content="Tinlone">
<meta property="article:tag" content="ViewModel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.google.cn/images/topic/libraries/architecture/viewmodel-lifecycle.png">

<link rel="canonical" href="http://tinlone.com/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel | Tinlone</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tinlone</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">å •è½çš„ğŸŸ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://tinlone.com/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon-32x32-next.png">
      <meta itemprop="name" content="Tinlone">
      <meta itemprop="description" content="Tinloneçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinlone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-07 17:02:10 / ä¿®æ”¹æ—¶é—´ï¼š16:41:22" itemprop="dateCreated datePublished" datetime="2021-03-07T17:02:10+08:00">2021-03-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Jetpack/" itemprop="url" rel="index"><span itemprop="name">Jetpack</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>4 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ViewModelè¿™ä¸ªåç§°å¸¸å¸¸ä½¿äººè¯¯è§£ä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿å‘¢ï¼Ÿ</p>
<p>ViewModelå¯ä»¥ä½œä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œä½†ä¸æ˜¯ç‰¹æŒ‡MVVMä¸­çš„ViewModelå±‚ã€‚</p>
<blockquote>
<p>ViewModel ç±»æ—¨åœ¨ä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®ã€‚ViewModel ç±»è®©æ•°æ®å¯åœ¨å‘ç”Ÿå±å¹•æ—‹è½¬ç­‰é…ç½®æ›´æ”¹åç»§ç»­ç•™å­˜ã€‚</p>
</blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒè§†ä½œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ•°æ®å­˜å‚¨å·¥å…·, æŠŠå®ƒç”¨åœ¨ä½ è§‰å¾—åˆé€‚çš„ä»»æ„åœ°æ–¹ï¼Œ<strong>å®ƒå¯ä»¥æ˜¯Fragmentå…±äº«æ•°æ®çš„æ¡¥æ¢ã€å¯ä»¥æ˜¯å±å¹•æ–¹å‘åˆ‡æ¢æ—¶çš„æ•°æ®æ¥æºã€å½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ MVVM ä¸­ ViewModelå±‚çš„ æ•°æ®æä¾›è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨LiveDataè®©å®ƒå˜æˆå¯è§‚å¯Ÿçš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DataBindingè®©ä»–æˆä¸ºViewçš„æ•°æ®æº</strong>ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/TinloneX/ArchitecturalComponentExample">ã€æœ¬ç³»åˆ—æ–‡ç« (JAVA/KOTLIN)æ¼”ç¤ºæ¡ˆä¾‹å‡å­˜å‚¨åœ¨githubå­˜å‚¨åº“ArchitecturalComponentExampleä¸­ã€‘</a></p>
<p>æœ¬ç¯‡æ‰€è¿°æºç åŠä»£ç åŸºäº <strong>API 30</strong>ï¼›</p>
<a id="more"></a>
<h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>ä»¥å¾€ï¼Œæˆ‘ä»¬åœ¨ç³»ç»Ÿé”€æ¯æˆ–é‡æ–°åˆ›å»ºç•Œé¢æ§åˆ¶å™¨æ—¶ï¼Œä¸ºä¿è¯å­˜å‚¨åœ¨å…¶ä¸­çš„ä»»ä½•ç¬æ€ç•Œé¢ç›¸å…³æ•°æ®ä¸ä¸¢å¤±ï¼Œå¾€å¾€ä½¿ç”¨Activity å¯ä»¥ä½¿ç”¨ onSaveInstanceState() æ–¹æ³•ä» onCreate() ä¸­çš„æ†ç»‘åŒ…æ¢å¤å…¶æ•°æ®ã€‚æ­¤æ–¹æ³•åœ¨ä¸€å®šåœºæ™¯ä¸‹æœ‰å¯èƒ½ä¸é€‚ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<blockquote>
<p>æ­¤æ–¹æ³•ä»…é€‚åˆå¯ä»¥åºåˆ—åŒ–å†ååºåˆ—åŒ–çš„å°‘é‡æ•°æ®ï¼Œè€Œä¸é€‚åˆæ•°é‡å¯èƒ½è¾ƒå¤§çš„æ•°æ®ï¼Œå¦‚ç”¨æˆ·åˆ—è¡¨æˆ–ä½å›¾ã€‚</p>
</blockquote>
<p>åœ¨è¿™ä¸€æ–¹é¢ä¸Šï¼ŒViewModelå¯ä»¥å­˜å‚¨ä»»æ„ä½ æƒ³è¦å­˜å‚¨çš„æ•°æ®ï¼Œç›¸å¯¹äºonSaveInstanceState() æ˜¾ç„¶æ˜¯å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿çš„ã€‚åŒæ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ•æ„Ÿç»„ä»¶ï¼Œå¯¹äºåƒæ¨ªç«–å±åˆ‡æ¢ç±»ä¼¼æƒ…å†µï¼Œé‡å»ºç•Œé¢æ—¶ï¼Œå¯ä»¥ä¸å¿…åšç±»ä¼¼é‡å»ºä½å›¾ã€é‡æ–°ååºåˆ—åŒ–æ•°æ®ã€é‡æ–°è¯·æ±‚ç½‘ç»œæ•°æ®çš„æ“ä½œã€‚</p>
<p>ä»è§„èŒƒä¸Šæ¥è¯´ï¼ŒViewModelæ¨èæˆ‘ä»¬å°†æ•°æ®ä»ç•Œé¢å±‚ä¸­æ‹¿å‡ºå»ï¼š</p>
<blockquote>
<p>ä»ç•Œé¢æ§åˆ¶å™¨é€»è¾‘ä¸­åˆ†ç¦»å‡ºè§†å›¾æ•°æ®æ‰€æœ‰æƒçš„æ“ä½œæ›´å®¹æ˜“ä¸”æ›´é«˜æ•ˆã€‚</p>
</blockquote>
<h3 id="ViewModelä½¿ç”¨ç¯‡"><a href="#ViewModelä½¿ç”¨ç¯‡" class="headerlink" title="ViewModelä½¿ç”¨ç¯‡"></a>ViewModelä½¿ç”¨ç¯‡</h3><p>æ­¤ç¯‡æ‰€è®²è¿°çš„ä½¿ç”¨ç¯‡å‡ä»…ä»‹ç»ViewModelè‡ªèº«ç‰¹æ€§ï¼ŒåŒºåˆ«äº<a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel#java">å®˜æ–¹æ–‡æ¡£</a>å¯¹äºViewModelä½¿ç”¨ä¸LiveDataç­‰ç»„ä»¶æ··åœ¨ä¸€èµ·è®²çš„æƒ…æ™¯ã€‚</p>
<h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&quot;androidx.lifecycle:lifecycle-viewmodel:2.3.0&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºæ¡ˆä¾‹"><a href="#åˆ›å»ºæ¡ˆä¾‹" class="headerlink" title="åˆ›å»ºæ¡ˆä¾‹"></a>åˆ›å»ºæ¡ˆä¾‹</h4><p>é¦–å…ˆï¼Œç®€å•çš„ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•é¡µé¢ï¼Œä¸€ä¸ªè®¡æ•°Buttonä»¥åŠä¸€ä¸ªè¾“å…¥æ¡†ç”¨ä»¥åšæ•°æ®çš„è¾“å…¥å’Œå˜åŒ–ï¼Œç•Œé¢æ¯”è¾ƒç®€å•ï¼Œæ­¤å¤„ä¸åšèµ˜è¿°ã€‚</p>
<p>æˆ‘ä»¬ä½¿æ“ä½œä¸Šè¿°æ§ä»¶æ”¹å˜å“åº”çš„å€¼å¹¶å­˜å‚¨åœ¨Activityä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;ViewModelDemoLog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String input = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        Button btnCounter = findViewById(R.id.button);</span><br><span class="line">        EditText etInput = findViewById(R.id.editText);</span><br><span class="line"></span><br><span class="line">        btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, count));</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;å½“å‰è®¡æ•°å€¼ï¼š&quot;</span> + count);</span><br><span class="line"></span><br><span class="line">        btnCounter.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            count++;</span><br><span class="line">            btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, count));</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;è®¡æ•°å¢è‡³ï¼š&quot;</span> + count);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        etInput.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">                input = s.toString();</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;è¾“å…¥æ¡†è¾“å…¥ï¼š&quot;</span> + s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        findViewById(R.id.button2).setOnClickListener(v -&gt; startActivity(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, SecActivity.class)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹è¿è¡Œï¼Œç‚¹å‡»è®¡æ•°Buttonæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š3</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œç¿»è½¬å±å¹•åæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼š</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è§‚å¯Ÿåˆ°é€šè¿‡ç‚¹å‡»buttonæ”¹å˜çš„countå€¼åœ¨ç¿»è½¬å±å¹•åè¢«æ¸…é™¤äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•éªŒè¯äº†ç¿»è½¬å±å¹•æ—¶å±å¹•é‡å»ºï¼ŒActivityä¸­ä¿å­˜çš„ç¬æ—¶é‡æ•°æ®ä¸ä¼šè¢«ä¿å­˜ï¼ˆçœŸçš„ä¸ä¼šå—ï¼‰ã€‚è¿™é‡Œæˆ‘ä»¬å‘ç°å¤šäº†ä¸€è¡Œçš„æ—¥å¿—ï¼Œä¼¼ä¹EditTextåœ¨å±å¹•é‡å»ºåè¢«å¡«å……äº†ä¸€æ¬¡å€¼ï¼Œä¸å¦‚æˆ‘ä»¬åœ¨ç¿»è½¬å±å¹•å‰ä¸ºEditTextè¾“å…¥ä¸€ä¸ªå€¼å†è¯•ä¸€ä¸‹ï¼š<br>ç¿»è½¬å±å¹•å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼ša</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaa</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaaa</span><br></pre></td></tr></table></figure>
<p>ç¿»è½¬å±å¹•åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaaa</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°è¾“å…¥æ¡†çš„æ•°æ®è¢«ä¿å­˜ä¸‹æ¥å¹¶åœ¨é‡å»ºå±å¹•æ—¶è¢«é‡æ–°èµ‹å€¼ï¼Œéœ€è¦å…³æ³¨æ­¤éƒ¨åˆ†åŸç†è¯·è§ã€<a href="#edit_text_save_state">é™„å½•</a>ã€‘ã€‚</p>
<p>å›åˆ°æ­£é¢˜ï¼Œé‚£ä¹ˆï¼Œä¸Šè¿°æ•°æ®å¦‚æœä¿å­˜åœ¨ViewModelä¸­ä¼šæ€æ ·å‘¢ï¼Ÿ</p>
<h4 id="ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹"><a href="#ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹" class="headerlink" title="ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹"></a>ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹</h4><p>é¦–å…ˆï¼Œåˆ›å»ºæˆ‘ä»¬çš„ViewModelï¼Œå¹¶æŠŠéœ€è¦å­˜å‚¨çš„æ•°æ®æ”¾åˆ°ViewModelä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeDataViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String logText = <span class="string">&quot;==start==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLog</span><span class="params">(String log)</span> </span>&#123;</span><br><span class="line">        logText += <span class="string">&quot;\n&quot;</span> + log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>ä¸ºé¿å…EditTexté—®é¢˜å½±å“æ•ˆæœè§‚æµ‹ï¼Œåç»­æµç¨‹å°†ä¼šç§»é™¤EditTextã€‚</em></p>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªç±»ç»§æ‰¿ViewModelï¼Œå¹¶å°†ä½ éœ€è¦å­˜å‚¨çš„æ•°æ®æ”¾åœ¨ViewModelä¸­å³å¯ã€‚</p>
<p>è€Œä½¿ç”¨ViewModelä»£ç ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä½ åªéœ€è¦é€šè¿‡<code>ViewModelProvider(activity).get(HomeDataViewModel.class)</code>å³å¯è·å–åˆ°ViewModelå¯¹è±¡ã€‚è‡³äºä¸ºä½•éœ€è¦ä½¿ç”¨è¿™æ ·ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ–¹å¼è·å–ViewModelï¼Œæˆ‘ä»¬ç¨ååœ¨åŸç†ç¯‡ä¸­å…·ä½“è¯´æ˜ã€‚</p>
<p>å½“ç„¶ä½ å¯èƒ½åœ¨æƒ³ï¼Œå¦‚æœæˆ‘çš„ViewModeléœ€è¦ä½¿ç”¨æœ‰å‚æ„é€ å™¨æ€ä¹ˆåŠï¼Ÿ<br>ä¸ç”¨æ‹…å¿ƒï¼Œå®ƒä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³åŠæ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyViewModelFactory</span> <span class="keyword">implements</span> <span class="title">ViewModelProvider</span>.<span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String defaultConfig = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyViewModelFactory</span><span class="params">(String defaultConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultConfig = defaultConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> HomeDataViewModel(defaultConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ—¶</span></span><br><span class="line">viewModel = <span class="keyword">new</span> ViewModelProvider(<span class="keyword">this</span>, </span><br><span class="line">                <span class="keyword">new</span> MyViewModelFactory(<span class="string">&quot;i have default config&quot;</span>))</span><br><span class="line">                .get(HomeDataViewModel.class);</span><br></pre></td></tr></table></figure>
<p>å³åˆ›å»ºä¸€ä¸ª ViewModelProvider.Factory ä¸ºViewModelProvideræä¾›ViewModelçš„åˆå§‹åŒ–æ“ä½œï¼Œå°†ViewModeléœ€è¦çš„å‚æ•°ä¼ å€¼ç»™ MyViewModelFactory ï¼Œç”±MyViewModelFactoryåœ¨åˆ›å»º ViewModelæ—¶è°ƒç”¨å¯¹åº”çš„æ„é€ å™¨æ–¹æ³•å³å¯ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ”¹é€ Activityä»£ç ï¼Œä½¿å…¶ä½¿ç”¨ViewModelä½œä¸ºæ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;ViewModelDemoLog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HomeDataViewModel viewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_sec);</span><br><span class="line"></span><br><span class="line">        Button btnCounter = findViewById(R.id.button);</span><br><span class="line"></span><br><span class="line">        viewModel = <span class="keyword">new</span> ViewModelProvider(<span class="keyword">this</span>).get(HomeDataViewModel.class);</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;è¯»å–viewModel.hashCode(): &quot;</span> + viewModel.hashCode());</span><br><span class="line"></span><br><span class="line">        btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, viewModel.count));</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;å½“å‰è®¡æ•°å€¼ï¼š&quot;</span> + viewModel.count);</span><br><span class="line"></span><br><span class="line">        btnCounter.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            viewModel.count++;</span><br><span class="line">            btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, viewModel.count));</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;è®¡æ•°å¢è‡³ï¼š&quot;</span> + viewModel.count);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†å…ˆå‰ä½¿ç”¨Activityä¸­å˜é‡æ”¹ä¸ºä½¿ç”¨ViewModelä¸­çš„å˜é‡å³å¯ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶æ•ˆæœï¼š</p>
<p>ç¿»è½¬å±å¹•å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¯»å–viewModel.hashCode(): 210932679</span><br><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š3</span><br></pre></td></tr></table></figure>
<p>ç¿»è½¬å±å¹•åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¯»å–viewModel.hashCode(): 210932679</span><br><span class="line">å½“å‰è®¡æ•°å€¼ï¼š3</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†ç‚¹å‡»ä¸¤æ¬¡è®¡æ•°æŒ‰é’®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è®¡æ•°å¢è‡³ï¼š4</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š5</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬çš„countå­—æ®µå€¼è¢«ä¿å­˜äº†ä¸‹æ¥ï¼Œè€Œä¸”ç¿»è½¬å±å¹•å‰åçš„ViewModelæ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>æ—¢ç„¶ç¿»è½¬å‰åçš„ViewModelæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆï¼Œå¯é¢„è§åœ°ï¼Œ<strong>æˆ‘ä»¬æ”¾åœ¨å…¶å†…éƒ¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«æ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­è·å–ç½‘ç»œæ•°æ®ã€ç¼“å­˜ç½‘ç»œå›¾ç‰‡ç­‰ç­‰ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåœ¨å±å¹•ç¿»è½¬ç­‰æ”¹å˜Activityé…ç½®æ—¶ï¼Œä½ çš„æ“ä½œè¢«ä¸­æ–­ä»¥åŠé‡æ–°åˆ›å»ºæ—¶è¢«é‡å¤è°ƒç”¨ã€‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel">å…³äºæ›´å¤šViewModelä½¿ç”¨çš„æ¡ˆä¾‹ï¼Œè¯·ç‚¹å‡»æ­¤å¤„å‚è§å®˜æ–¹æ–‡æ¡£</a></p>
<p>ViewModelçš„ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œå…¶èŒè´£å•ä¸€ï¼Œæ³¨é‡ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨ç¯‡å°±ä»‹ç»åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…¶æºç åŠå·¥ä½œåŸç†å§ã€‚</p>
<h4 id="ViewModelç”Ÿå‘½å‘¨æœŸ"><a href="#ViewModelç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ViewModelç”Ÿå‘½å‘¨æœŸ"></a>ViewModelç”Ÿå‘½å‘¨æœŸ</h4><p>é¦–å…ˆï¼ŒViewModelä½œä¸ºä¸€ä¸ªä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®çš„ç»„ä»¶ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæˆ‘ä»¬å¼•ç”¨å®˜ç½‘å¯¹äº<a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel#lifecycle">ViewModel çš„ç”Ÿå‘½å‘¨æœŸ</a>ä»‹ç»çš„ä¸€å¼ å›¾æ¥è¯´æ˜ï¼š<br><img src="https://developer.android.google.cn/images/topic/libraries/architecture/viewmodel-lifecycle.png" alt="viewmodel_lifecycle.png"></p>
<blockquote>
<p>æ‚¨é€šå¸¸åœ¨ç³»ç»Ÿé¦–æ¬¡è°ƒç”¨ Activity å¯¹è±¡çš„ onCreate() æ–¹æ³•æ—¶è¯·æ±‚ ViewModelã€‚ç³»ç»Ÿå¯èƒ½ä¼šåœ¨ Activity çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å¤šæ¬¡è°ƒç”¨ onCreate()ï¼Œå¦‚åœ¨æ—‹è½¬è®¾å¤‡å±å¹•æ—¶ã€‚ViewModel å­˜åœ¨çš„æ—¶é—´èŒƒå›´æ˜¯ä»æ‚¨é¦–æ¬¡è¯·æ±‚ ViewModel ç›´åˆ° Activity å®Œæˆå¹¶é”€æ¯ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…¶å…·ä½“æ˜¯æ€ä¹ˆåšåˆ°çš„å§ï¼</p>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆä»ViewModelå¯¹è±¡çš„è·å–å¼€å§‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ViewModelStoreä¸­å–</span></span><br><span class="line">    ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line">    <span class="comment">// ç±»å‹æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> OnRequeryFactory) &#123;</span><br><span class="line">            ((OnRequeryFactory) mFactory).onRequery(viewModel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//noinspection StatementWithEmptyBody</span></span><br><span class="line">        <span class="keyword">if</span> (viewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœªå–åˆ°åˆ™åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">        viewModel = ((KeyedFactory) mFactory).create(key, modelClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        viewModel = mFactory.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­˜å…¥ViewModelStore</span></span><br><span class="line">    mViewModelStore.put(key, viewModel);</span><br><span class="line">    <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦åˆ©ç”¨ViewModelStoreåšäº†ç¼“å­˜ï¼ˆå­˜å‚¨ï¼‰ï¼Œç¼“å­˜ä¸­æœ‰åˆ™å–å‡ºï¼Œæ— åˆ™åˆ›å»ºå¹¶åŠ å…¥ç¼“å­˜ã€‚</p>
<p>ViewModelStoreå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>HashMap<String, ViewModel></code>å­˜å‚¨ViewModel:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, ViewModel viewModel)</span> </span>&#123;</span><br><span class="line">        ViewModel oldViewModel = mMap.put(key, viewModel);</span><br><span class="line">        <span class="keyword">if</span> (oldViewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldViewModel.onCleared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ViewModel <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;&gt;(mMap.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Clears internal storage and notifies ViewModels that they are no longer used.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// è®°ä½æ­¤å¤„ï¼Œç¨åä¼šè®²</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">            vm.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        mMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç æ¯”è¾ƒç®€å•,æ­¤å¤„ä¸åšèµ˜è¿°ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å®ƒçš„æ³¨é‡Šä¸­å‘ç°äº†è¿™æ ·ä¸€å¥è¯ï¼š</p>
<blockquote>
<p>Use {@link ViewModelStoreOwner#getViewModelStore()} to retrieve a {@code ViewModelStore} for activities and fragments.</p>
</blockquote>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ ViewModelStoreOwner ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewModelStoreOwner</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns owned &#123;<span class="doctag">@link</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰ä¸€ä¸ª getViewModelStoreçš„å®šä¹‰ï¼ŒæŸ¥çœ‹å…¶å®ç°ç±»ï¼Œæ‰¾åˆ°<code>androidx.activity.ComponentActivity</code>çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getApplication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Your activity is not yet attached to the &quot;</span></span><br><span class="line">                + <span class="string">&quot;Application instance. You can&#x27;t request ViewModel before onCreate call.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">        NonConfigurationInstances nc =</span><br><span class="line">                (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Restore the ViewModelStore from NonConfigurationInstances</span></span><br><span class="line">            mViewModelStore = nc.viewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mViewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼ŒViewModelStoreæ¥è‡ªäº NonConfigurationInstances ï¼Œè€Œ NonConfigurationInstances åˆ™å–è‡ª getLastNonConfigurationInstance()ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ NonConfigurationInstances ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class ComponentActivity&#123;</span><br><span class="line">    </span><br><span class="line">    static final class NonConfigurationInstances &#123;</span><br><span class="line">        Object custom;</span><br><span class="line">        ViewModelStore viewModelStore;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Activity&#123;</span><br><span class="line">    </span><br><span class="line">    static final class NonConfigurationInstances &#123;</span><br><span class="line">        Object activity;</span><br><span class="line">        HashMap&lt;String, Object&gt; children;</span><br><span class="line">        FragmentManagerNonConfig fragments;</span><br><span class="line">        ArrayMap&lt;String, LoaderManager&gt; loaders;</span><br><span class="line">        VoiceInteractor voiceInteractor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Object getLastNonConfigurationInstance() &#123;</span><br><span class="line">        return mLastNonConfigurationInstances !&#x3D; null</span><br><span class="line">                ? mLastNonConfigurationInstances.activity : null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šè¿°ä¸¤æ®µä»£ç å¯çŸ¥ï¼ŒViewModelStoreæœ€ç»ˆä¼šå­˜å‚¨åœ¨ Activity.NonConfigurationInstancesä¸­çš„ activityå­—æ®µä¸­ï¼Œæˆ‘ä»¬ç»§ç»­è¿½æº¯<code>Activity.NonConfigurationInstances mLastNonConfigurationInstances;</code>æ˜¯ä»å“ªé‡Œè·å–å’Œå–å€¼çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@link&#123;Activity#attach&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†è§£è¿‡Activityå¯åŠ¨æµç¨‹çš„åº”è¯¥éƒ½çŸ¥é“ activity.attach() ä¼šåœ¨ ActivityThread.performLaunchActivity()ä¸­è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... å¿½ç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">    activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        <span class="comment">// r.lastNonConfigurationInstances ä»ActivityClientRecordä¸­å–å¾—</span></span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback,</span><br><span class="line">                        r.assistToken);</span><br><span class="line">    <span class="comment">// ... å¿½ç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾å‘ç°ï¼ŒlastNonConfigurationInstancesæ¥è‡ªäºActivityClientRecordå¯¹è±¡ï¼Œæˆ‘ä»¬ä»…å…³æ³¨é…ç½®å˜åŒ–æ—¶çš„Activityé‡å»ºæµç¨‹ï¼Œç»§ç»­è¿½æº¯ï¼Œæˆ‘ä»¬ä¸€æ¬¡å¯ä»¥å‘å‰æ‰¾åˆ°ä¸€ä¸‹è°ƒç”¨ï¼š</p>
<ul>
<li>ActivityThread.handleLaunchActivity(ActivityClientRecord r ,â€¦)</li>
<li>ActivityThread.handleRelaunchActivityInner(ActivityClientRecord r ,â€¦)</li>
<li>ActivityThread.handleRelaunchActivity(ActivityClientRecord r ,â€¦)</li>
<li>ClientTransactionHandler.handleRelaunchActivity(ActivityThread.ActivityClientRecord r,â€¦)</li>
<li>ActivityRelaunchItem.excute(ClientTransactionHandler client,â€¦)</li>
<li>ActivityConfigurationChangeItem.excute(ClientTransactionHandler client,â€¦)</li>
</ul>
<p>æˆ‘ä»¬è§‚å¯ŸActivityé‡å»ºçš„é‡å»ºæµç¨‹ï¼Œåªæ˜¯å¯¹å½“å‰Activityå¯¹åº”çš„ActivityClientRecordè¿›è¡Œäº†è½¬æ¢, æ–°åˆ›å»ºçš„Activityçš„ActivityClientRecordä¾æ—§æŒæœ‰åŸActivityçš„lastNonConfigurationInstanceså¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆè¿™å°±<strong>æœ€ç»ˆä¿è¯äº†NonConfigurationInstancesä¸­çš„ViewModelStoreåœ¨é…ç½®æ›´æ”¹Activityé‡å»ºè¿‡ç¨‹ä¸­ä¸ä¼šè¢«æ”¹å˜ï¼Œé‚£ä¹ˆå­˜å‚¨åœ¨å…¶ä¸­çš„ViewModelè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å˜åŒ–ã€‚</strong></p>
<p>å‰é¢æˆ‘ä»¬äº†è§£äº†ViewModelçš„å­˜å‚¨åŸç†ï¼Œå…¶ä¸»è¦ä¾èµ–äºActivityClientRecordçš„ç‰¹æ€§æ¥å­˜å‚¨NonConfigurationInstanceså¯¹è±¡ï¼Œä¿è¯ViewModelå­˜åœ¨ï¼Œè€Œç•Œé¢é”€æ¯æ—¶ActivityClientRecordä¹Ÿä¼šè¢«é”€æ¯ï¼Œé‚£ä¹ˆä¿å­˜åœ¨å…¶ä¸­çš„NonConfigurationInstancesåŠå…¶åŒ…å«çš„ViewModelè‡ªç„¶ä¹Ÿå°±ä¼šè¢«é”€æ¯ã€‚</p>
<p>å½“ç„¶é”€æ¯çš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šçŸ¥åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ViewModelï¼Œç”¨ä»¥åšå†…å­˜åŠèµ„æºçš„å›æ”¶ï¼Œå…·ä½“å®ç°ä¸ºé‡å†™ onCleared()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeDataViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCleared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCleared();</span><br><span class="line">        <span class="comment">// åšæµçš„å…³é—­ï¼Œèµ„æºå›æ”¶ç­‰</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘å‰è¿½æº¯å¯ä»¥çœ‹åˆ°è°ƒç”¨æ­¤æ–¹æ³•çš„å®ä¸ºViewModel.clear()æ–¹æ³•ã€æ­¤å¤„æ‡’å¾—è´´ä»£ç ã€‘ï¼Œ<br>åœ¨ä¹‹å‰çš„ViewModelStoreä»£ç ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°æœ‰ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ViewModel.clear()</span></span><br><span class="line">        vm.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    mMap.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è¿½æº¯ï¼Œä½ ä¼šå‘ç°ï¼Œä»–ä¼šåœ¨ComponentActivityæ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå…·ä½“ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public ComponentActivity() &#123;</span><br><span class="line">    &#x2F;&#x2F; å¿½ç•¥å…¶ä»–ä»£ç </span><br><span class="line">    getLifecycle().addObserver(new LifecycleEventObserver() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onStateChanged(@NonNull LifecycleOwner source,</span><br><span class="line">                @NonNull Lifecycle.Event event) &#123;</span><br><span class="line">            if (event &#x3D;&#x3D; Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                if (!isChangingConfigurations()) &#123;</span><br><span class="line">                    getViewModelStore().clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> &#x2F;&#x2F; å¿½ç•¥å…¶ä»–ä»£ç </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ›å»ºå¹¶æ³¨å†Œäº†ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ï¼Œåœ¨Lifecycle.Event.ON_DESTROYäº‹ä»¶ï¼ˆç•Œé¢é”€æ¯ï¼‰æ—¶è°ƒç”¨ViewModelStore.clear();</p>
<p>è‡³æ­¤ï¼ŒViewModelçš„ä½¿ç”¨åŠå·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å°±å¤§è‡´æ¢³ç†äº†ä¸€éäº†~ï¼</p>
<h3 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a><span id="edit_text_save_state">é™„å½•</h3><h4 id="EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤"><a href="#EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤" class="headerlink" title="EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤"></a>EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤</h4><p>åœ¨ViewModelä»¥å‰ï¼ŒActivityé‡å»ºæ•°æ®æ¢å¤ä¸»è¦ä¾é Activit.onSaveInstanceState, æˆ‘ä»¬å¤§èƒ†çŒœæµ‹EditTextæ•°æ®åœ¨ç¿»è½¬å±å¹•æ—¶æ•°æ®ä¾æ—§å­˜åœ¨ä¸æ­¤æœ‰å…³ï¼Œæˆ‘ä»¬å°è¯•è·Ÿè¿›ä¸€ä¸‹å…¶ä¿å­˜æ•°æ®çš„æµç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected void onSaveInstanceState(@NonNull Bundle outState) &#123;</span><br><span class="line">    &#x2F;&#x2F; è·å–Windowå±‚çº§</span><br><span class="line">    outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</span><br><span class="line"></span><br><span class="line">    outState.putInt(LAST_AUTOFILL_ID, mLastAutofillId);</span><br><span class="line">    Parcelable p &#x3D; mFragments.saveAllState();</span><br><span class="line">    if (p !&#x3D; null) &#123;</span><br><span class="line">        outState.putParcelable(FRAGMENTS_TAG, p);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mAutoFillResetNeeded) &#123;</span><br><span class="line">        outState.putBoolean(AUTOFILL_RESET_NEEDED, true);</span><br><span class="line">        getAutofillManager().onSaveInstanceState(outState);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; åˆ†å‘Activityå­˜å‚¨çŠ¶æ€</span><br><span class="line">    dispatchActivitySaveInstanceState(outState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆEditTextä½œä¸ºViewæ˜¾ç„¶æ˜¯ä¾å­˜åœ¨Windowä¸‹çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•ä»Windowä¸‹æ‰‹ï¼Œå…ˆæ¥çœ‹çœ‹è¿™é‡Œè°ƒç”¨çš„<code>mWindow.saveHierarchyState()</code>, ç”±äºè¿™é‡Œæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å»çœ‹<code>PhoneWindow.saveHierarchyState()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Bundle outState = <span class="keyword">new</span> Bundle();</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> outState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">    <span class="comment">// æ”¶é›†çˆ¶å®¹å™¨ä¸­çš„å±‚çº§çŠ¶æ€</span></span><br><span class="line">    mContentParent.saveHierarchyState(states);</span><br><span class="line">    outState.putSparseParcelableArray(VIEWS_TAG, states);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å®¹å™¨ä¸­å–å¾—æœ‰ç„¦ç‚¹çš„æ§ä»¶</span></span><br><span class="line">    <span class="keyword">final</span> View focusedView = mContentParent.findFocus();</span><br><span class="line">    <span class="keyword">if</span> (focusedView != <span class="keyword">null</span> &amp;&amp; focusedView.getId() != View.NO_ID) &#123;</span><br><span class="line">        <span class="comment">// å­˜å‚¨æ§ä»¶ID</span></span><br><span class="line">        outState.putInt(FOCUSED_ID_TAG, focusedView.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save the panels</span></span><br><span class="line">    SparseArray&lt;Parcelable&gt; panelStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">    savePanelState(panelStates);</span><br><span class="line">    <span class="keyword">if</span> (panelStates.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        outState.putSparseParcelableArray(PANELS_TAG, panelStates);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDecorContentParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        SparseArray&lt;Parcelable&gt; actionBarStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">        mDecorContentParent.saveToolbarHierarchyState(actionBarStates);</span><br><span class="line">        outState.putSparseParcelableArray(ACTION_BAR_TAG, actionBarStates);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–å®¹å™¨Viewå±‚çº§åŠçŠ¶æ€<code>mContentParent.saveHierarchyState(states)</code>æœ€ç»ˆä¼šè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="meta">@Nullable</span> <span class="function"><span class="keyword">protected</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPrivateFlags |= PFLAG_SAVE_STATE_CALLED;</span><br><span class="line">    <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span> || isAutofilled()</span><br><span class="line">            || mAutofillViewId &gt; LAST_APP_AUTOFILL_ID) &#123;</span><br><span class="line">        BaseSavedState state = <span class="keyword">new</span> BaseSavedState(AbsSavedState.EMPTY_STATE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span>) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.START_ACTIVITY_REQUESTED_WHO_SAVED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isAutofilled()) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.IS_AUTOFILLED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAutofillViewId &gt; LAST_APP_AUTOFILL_ID) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.AUTOFILL_ID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state.mStartActivityRequestWhoSaved = mStartActivityRequestWho;</span><br><span class="line">        state.mIsAutofilled = isAutofilled();</span><br><span class="line">        state.mHideHighlight = hideAutofillHighlight();</span><br><span class="line">        state.mAutofillViewId = mAutofillViewId;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BaseSavedState.EMPTY_STATE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PhoneWindow.saveHierarchyState()</code>çš„ä½œç”¨æ˜¯ï¼šè·å–å®¹å™¨ä¸­æ‰€æœ‰Viewçš„å±‚çº§åŠçŠ¶æ€ï¼Œç„¶åç­›é€‰å‡ºé¢æ¿panelså’Œå…·æœ‰ç„¦ç‚¹çš„æ§ä»¶è¿”å›ç»™Activityï¼ŒEditTextè‡ªç„¶å°±è¢«ç­›é€‰è®°å½•ï¼Œå¹¶è¢«<code>outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState())</code>è®°å½•ä¸‹æ¥ï¼Œæœ€ç»ˆè¢«onSaveInstanceState()å­˜å‚¨ï¼Œè‡³äºonSaveInstanceçš„å…·ä½“åŸç†æ­¤å¤„ä¸åšè®¨è®ºï¼Œæœ‰å…´è¶£å¯è‡ªè¡Œæ·±æŒ–ã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ViewModel/" rel="tag"># ViewModel</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/02/28/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E5%8E%9F%E7%90%86%E7%AF%87/" rel="prev" title="Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡">
      <i class="fa fa-chevron-left"></i> Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å¼•è¨€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewModel%E4%BD%BF%E7%94%A8%E7%AF%87"><span class="nav-number">2.</span> <span class="nav-text">ViewModelä½¿ç”¨ç¯‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">2.1.</span> <span class="nav-text">å¼•å…¥ä¾èµ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A1%88%E4%BE%8B"><span class="nav-number">2.2.</span> <span class="nav-text">åˆ›å»ºæ¡ˆä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ViewModel%E6%94%B9%E9%80%A0%E6%A1%88%E4%BE%8B"><span class="nav-number">2.3.</span> <span class="nav-text">ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ViewModel%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">2.4.</span> <span class="nav-text">ViewModelç”Ÿå‘½å‘¨æœŸ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">3.</span> <span class="nav-text">é™„å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EditText%E6%8E%A7%E4%BB%B6%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-number">3.1.</span> <span class="nav-text">EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tinlone"
      src="/images/favicon-32x32-next.png">
  <p class="site-author-name" itemprop="name">Tinlone</p>
  <div class="site-description" itemprop="description">Tinloneçš„ä¸ªäººåšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
	
	<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=16435049&auto=1&height=66"></iframe>
	
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tinlone</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">37k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">33 åˆ†é’Ÿ</span>
</div>
<!--
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

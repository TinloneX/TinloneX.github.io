<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-material.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tinlone.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²äº†Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œçš„å§ã€‚ åœ¨äº†è§£å…¶å·¥ä½œåŸç†å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä»¥ä¸‹ActivityThreadå¯¹Activityç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘æµç¨‹ï¼Œä»¥ä¾¿ç†è§£Lifecycleçš„å·¥ä½œåŸç†ã€‚ æ­¤ç¯‡å‰åŠéƒ¨åˆ†å°†è®²è¿°API26åŠAPI30ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ï¼ŒååŠéƒ¨åˆ†ä¾ç…§å‰åŠéƒ¨åˆ†å¯¹ç…§è®²è¿°Lifecycleç”Ÿå‘½å‘¨æœŸåˆ†å‘æ—¶æœºï¼Œæœ€åå°†ä»‹ç»L">
<meta property="og:type" content="article">
<meta property="og:title" content="Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡">
<meta property="og:url" content="http://tinlone.com/2021/02/28/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E5%8E%9F%E7%90%86%E7%AF%87/index.html">
<meta property="og:site_name" content="Tinlone">
<meta property="og:description" content="ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²äº†Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œçš„å§ã€‚ åœ¨äº†è§£å…¶å·¥ä½œåŸç†å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä»¥ä¸‹ActivityThreadå¯¹Activityç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘æµç¨‹ï¼Œä»¥ä¾¿ç†è§£Lifecycleçš„å·¥ä½œåŸç†ã€‚ æ­¤ç¯‡å‰åŠéƒ¨åˆ†å°†è®²è¿°API26åŠAPI30ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ï¼ŒååŠéƒ¨åˆ†ä¾ç…§å‰åŠéƒ¨åˆ†å¯¹ç…§è®²è¿°Lifecycleç”Ÿå‘½å‘¨æœŸåˆ†å‘æ—¶æœºï¼Œæœ€åå°†ä»‹ç»L">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://developer.android.google.cn/images/topic/libraries/architecture/lifecycle-states.svg">
<meta property="og:image" content="https://s3.ax1x.com/2021/03/01/6i7Ubj.png">
<meta property="article:published_time" content="2021-02-28T11:32:13.392Z">
<meta property="article:modified_time" content="2021-03-01T14:09:30.408Z">
<meta property="article:author" content="Tinlone">
<meta property="article:tag" content="Lifecycle">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.android.google.cn/images/topic/libraries/architecture/lifecycle-states.svg">

<link rel="canonical" href="http://tinlone.com/2021/02/28/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E5%8E%9F%E7%90%86%E7%AF%87/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡ | Tinlone</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Tinlone</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">å •è½çš„ğŸŸ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://tinlone.com/2021/02/28/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E5%8E%9F%E7%90%86%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/favicon-32x32-next.png">
      <meta itemprop="name" content="Tinlone">
      <meta itemprop="description" content="Tinloneçš„ä¸ªäººåšå®¢">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinlone">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-28 19:32:13" itemprop="dateCreated datePublished" datetime="2021-02-28T19:32:13+08:00">2021-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-03-01 22:09:30" itemprop="dateModified" datetime="2021-03-01T22:09:30+08:00">2021-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Jetpack/" itemprop="url" rel="index"><span itemprop="name">Jetpack</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>6 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²äº†<a href="https://tinlone.com/2021/02/25/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E4%BD%BF%E7%94%A8%E7%AF%87/">Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œçš„å§ã€‚</p>
<p>åœ¨äº†è§£å…¶å·¥ä½œåŸç†å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä»¥ä¸‹ActivityThreadå¯¹Activityç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘æµç¨‹ï¼Œä»¥ä¾¿ç†è§£Lifecycleçš„å·¥ä½œåŸç†ã€‚</p>
<p>æ­¤ç¯‡å‰åŠéƒ¨åˆ†å°†è®²è¿°API26åŠAPI30ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ï¼ŒååŠéƒ¨åˆ†ä¾ç…§å‰åŠéƒ¨åˆ†å¯¹ç…§è®²è¿°Lifecycleç”Ÿå‘½å‘¨æœŸåˆ†å‘æ—¶æœºï¼Œæœ€åå°†ä»‹ç»Lifecycleæºç æ‰§è¡Œæµç¨‹åŠProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬çš„ã€‚</p>
<a id="more"></a>

<h3 id="ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘"><a href="#ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘"></a>ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘</h3><p>æ­¤éƒ¨åˆ†æºç å–è‡ª<code>Android SDK api26 & api30</code>, è·å–æ–¹å¼ä¸ºä½¿ç”¨Android Studio çš„ SDK Manager ä¸‹è½½ api26 åŠ api30 æºä»£ç ï¼Œæºä»£ç ç›®å½•ä¸º<code> %AndroidSDK%/source/android-ç‰ˆæœ¬å·</code>ï¼Œä½ å¯ä»¥ä½¿ç”¨SublimeTextç­‰å·¥å…·æ‰“å¼€æºç å¯¹ç…§é˜…è¯»ã€‚</p>
<p>Lifecycleä»¥Api29ä¸ºåˆ†ç•Œç‚¹æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œè¿™æ˜¯å…ˆè®²è¿°æ­¤èŠ‚å†…å®¹çš„åŸå› ï¼Œæ­¤å¤„ä»¥Api26åŠApi30ä¸ºä»£è¡¨è®²è¿°ã€‚</p>
<h4 id="API-26"><a href="#API-26" class="headerlink" title="API 26"></a>API 26</h4><p>æˆ‘ä»¬çŸ¥é“ï¼ŒActivityæ˜¯ç”±ActivityThreadç”ŸæˆåŠç®¡ç†çš„ã€‚æ­¤å¤„ä»¥<code>ActivityThread.performLaunchActivity()</code>ä¸ºèµ·ç‚¹ï¼Œåˆ†æActivity onCreate()/onStart()äº‹ä»¶çš„äº§ç”ŸåŠåˆ†å‘ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ç®€åŒ–ç‰ˆçš„performLaunchActivity()ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something create Activity</span></span><br><span class="line">    activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">    <span class="comment">// ... init Activity</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        <span class="comment">// logs </span></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// activity attach &amp; setTheme ...</span></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                <span class="comment">// onCreate()</span></span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// some log</span></span><br><span class="line">            r.activity = activity;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="comment">// onStart()</span></span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">// do something</span></span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// do something</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="comment">// log error</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å®Œæˆäº†Activityå¯åŠ¨æ¡ä»¶åè°ƒç”¨äº†<code>mInstrumentation.callActivityOnCreate(</code>åŠ<code>activity.performStart()</code>( å³ç”Ÿå‘½å‘¨æœŸonCreate()å’ŒonStart()ï¼‰, ä¸ºäº†ä¸€å¹¶äº†è§£Fragmentç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘ï¼Œæˆ‘ä»¬ä»¥onStart()ä¸ºä¾‹ï¼ŒonStart()äº‹ä»¶äº§ç”Ÿäºæ­¤ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿› <code>activity.performStart()</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œä¼šå›è°ƒåˆ°activity.onStart();</span></span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// logs</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„mFragmentsæ˜¯ FragmentControllerï¼Œ</span></span><br><span class="line">    <span class="comment">// åç»­ä¼šè°ƒç”¨FragmentManager.dispatchStart()ã€fragment.performStart()</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‰§è¡Œåˆ° fragment.onStart()</span></span><br><span class="line">    mFragments.dispatchStart();</span><br><span class="line">    mFragments.reportLoaderStart();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do Something others</span></span><br><span class="line"></span><br><span class="line">    mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Instrumentation&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šé¢ä»£ç ä»£ç æˆ‘ä»¬äº†è§£äº†<strong>API26</strong>æ—¶ Activityçš„onStart()äº‹ä»¶çš„äº§ç”Ÿåˆ°ä¼ é€’ï¼Œä»¥åŠä¼ é€’ç»™Fragmentçš„æ–¹å¼ã€æ­¤å¤„ä»£ç è·Ÿè¿›çœç•¥ï¼Œä½†åº”äº†è§£è¿™ä¸ªæµç¨‹ï¼Œåç»­åœ¨è®²è¿°Lifecycleæ—¶å°†ä¼šç”¨åˆ°ã€‘ã€‚</p>
<h4 id="API-30-ï¼ˆAPI-lvl-â‰¥-29ï¼‰"><a href="#API-30-ï¼ˆAPI-lvl-â‰¥-29ï¼‰" class="headerlink" title="API 30 ï¼ˆAPI lvl â‰¥ 29ï¼‰"></a>API 30 ï¼ˆAPI lvl â‰¥ 29ï¼‰</h4><p>åŒæ ·çš„ï¼Œæ­¤å¤„ä»¥<code>ActivityThread.performLaunchActivity()</code>ä¸ºèµ·ç‚¹ï¼Œåˆ†æActivity onCreate()/onStart()äº‹ä»¶çš„äº§ç”ŸåŠåˆ†å‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create Activity</span></span><br><span class="line">    activity = mInstrumentation.newActivity(</span><br><span class="line">            cl, component.getClassName(), r.intent);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        <span class="comment">// init Activity &amp; setTheme</span></span><br><span class="line">        activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">            <span class="comment">// onCreate()</span></span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// some log</span></span><br><span class="line">        r.activity = activity;</span><br><span class="line">        mLastReportedWindowingMode.put(activity.getActivityToken(),</span><br><span class="line">                config.windowConfiguration.getWindowingMode());</span><br><span class="line">        <span class="comment">// è®¾ç½®ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        r.setState(ON_CREATE);</span><br><span class="line">        <span class="comment">// something</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// log error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸ API 26 åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯æ­¤æ—¶onCreateäº‹ä»¶ä¸onStartäº‹ä»¶çš„äº§ç”Ÿå·²ä¸æ˜¯è€¦åˆç›¸å…³ï¼ŒåŒæ ·çš„å…³æ³¨onStart()ç”Ÿå‘½å‘¨æœŸï¼Œæ­¤å¤„å·²ä¸åŒ…å«onStart()ç›¸å…³çš„ä»£ç åŠè°ƒç”¨ï¼Œæˆ‘ä»¬å‘ç°æœ‰æ–°çš„ä»£ç <code>r.setState(ON_CREATE);</code>å¯èƒ½ä¸ç”Ÿå‘½å‘¨æœŸæœ‰å…³ï¼ŒçŒœæµ‹æ˜¯å¦onStart()äº‹ä»¶ä¹Ÿä¼šæœ‰ç±»ä¼¼æ–¹æ³•ï¼Œæœç„¶ï¼Œåœ¨ç›¸é‚»çš„ä¸‹ä¸€ä¸ªæ–¹æ³•<code>handleStartActivity</code>ä¸­æˆ‘ä»¬å‘ç°ç±»ä¼¼ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartActivity</span><span class="params">(IBinder token, PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// Start</span></span><br><span class="line">    activity.performStart(<span class="string">&quot;handleStartActivity&quot;</span>);</span><br><span class="line">    r.setState(ON_START);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// something Restore instance state</span></span><br><span class="line">   </span><br><span class="line">    updateVisibility(r, <span class="keyword">true</span> <span class="comment">/* show */</span>);</span><br><span class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼çš„ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>activity.performStart("handleStartActivity");</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„æ³¨æ„</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„æœ‰æ–°ä»£ç ï¼Œç”¨ä»¥é€šçŸ¥æ³¨å†Œåœ¨ApplicationåŠActivityä¸­çš„ActivityLifecycleCallbackså½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œç”±è¿™äº›å›è°ƒæ–¹æ³•åˆ†å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">    dispatchActivityPreStarted();</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨onStart()</span></span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„mFragmentsæ˜¯ FragmentControllerï¼Œ</span></span><br><span class="line">    <span class="comment">// åç»­ä¼šè°ƒç”¨FragmentManager.dispatchStart()ã€fragment.performStart()</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‰§è¡Œåˆ° fragment.onStart()</span></span><br><span class="line">    mFragments.dispatchStart();</span><br><span class="line">    mFragments.reportLoaderStart();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something debug</span></span><br><span class="line"></span><br><span class="line">    mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨æ„æ³¨æ„</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„æœ‰æ–°ä»£ç ï¼Œç”¨ä»¥é€šçŸ¥æ³¨å†Œåœ¨ApplicationåŠActivityä¸­çš„ActivityLifecycleCallbackså½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œç”±è¿™äº›å›è°ƒæ–¹æ³•åˆ†å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">    dispatchActivityPostStarted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Instrumentation&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„ä¸»ä½“é€»è¾‘ä¸API 26ä¸€è‡´ï¼Œå‡æ˜¯è°ƒç”¨Activity onStart()å›è°ƒå’Œåˆ†å‘äº‹ä»¶ç»™Fragmentï¼Œæˆ‘ä»¬æ³¨æ„åˆ°æ­¤å¤„å¤šäº†ä¸¤ä¸ª â€œdispatchActivityXXX()â€ æ–¹æ³•ï¼Œè·Ÿè¿›è¿™ä¸¤ä¸ª â€œdispatchActivityXXX()â€ æ–¹æ³•ï¼Œå‡ä¸ºæ‰§è¡Œä»¥ä¸‹ç±»ä¼¼ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchActivityPreStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    getApplication().dispatchActivityPreStarted(<span class="keyword">this</span>);</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((Application.ActivityLifecycleCallbacks) callbacks[i]).onActivityPreStarted(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Application&#125;</span><br><span class="line"><span class="comment">/* package */</span> <span class="function"><span class="keyword">void</span> <span class="title">dispatchActivityPreStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((ActivityLifecycleCallbacks) callbacks[i]).onActivityPreStarted(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•åˆ†æä»£ç ï¼Œå¯ä»¥å‘ç°ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸ŠæŠ¥ç»™Applicaitonè¿›è¡Œå›è°ƒåˆ†å‘ä»¥åŠé€šçŸ¥æ³¨å†Œåœ¨Activityä¸­çš„å›è°ƒåˆ†å‘ã€è®°ä½æ­¤å¤„ï¼Œä¸Lifecycleåœ¨Api29å‰åä¸åŒå¤„ç†æ–¹å¼æœ‰å…³ã€‘ã€‚</p>
<p>è€Œç›¸æ¯”äº API26ï¼Œé€šè¿‡è·Ÿè¿›<code>collectActivityLifecycleCallbacks()</code>å‘ç°ï¼Œ Activityåœ¨API29ä¹‹åæ–°å¢äº†ç”Ÿå‘½å‘¨æœŸæ³¨å†ŒåŠŸèƒ½ï¼Œå³ç»´æŠ¤äº†ä¸€ä¸ª <code> ActivityLifecycleCallbacks</code>é›†åˆï¼Œè€Œç”Ÿå‘½å‘¨æœŸåœ¨Activityä¸­çš„æœ€åä½¿å‘½å°±æ˜¯é€šè¿‡ dispatchActivityXXX() å‘æ³¨å†Œåœ¨Activity/Applicationä¸­çš„ ActivityLifecycleCallbacks åˆ†å‘äº‹ä»¶ã€‚</p>
<h3 id="Lifecycleæºç è§£æ"><a href="#Lifecycleæºç è§£æ" class="headerlink" title="Lifecycleæºç è§£æ"></a>Lifecycleæºç è§£æ</h3><p>å‰åŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬è®²è¿°äº†Activityç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„äº§ç”Ÿå’Œåˆ†å‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Lifecycleæ˜¯å¦‚ä½•è®¢é˜…å’Œæ¶ˆè´¹è¿™äº›äº‹ä»¶çš„å§ã€‚</p>
<h4 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h4><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Lifecycleçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> State <span class="title">getCurrentState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        ON_CREATE,</span><br><span class="line">        ON_START,</span><br><span class="line">        ON_RESUME,</span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        ON_STOP,</span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        ON_ANY;</span><br><span class="line">       <span class="comment">// some apis</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        DESTROYED,</span><br><span class="line">        INITIALIZED,</span><br><span class="line">        CREATED,</span><br><span class="line">        STARTED,</span><br><span class="line">        RESUMED;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Lifecycle æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºå­˜å‚¨æœ‰å…³ç»„ä»¶ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„ä¿¡æ¯ï¼Œå¹¶å…è®¸å…¶ä»–å¯¹è±¡è§‚å¯Ÿæ­¤çŠ¶æ€ã€‚<br>Lifecycle ä½¿ç”¨ä¸¤ç§ä¸»è¦æšä¸¾è·Ÿè¸ªå…¶å…³è”ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š</p>
<ul>
<li>äº‹ä»¶<pre><code> ä»æ¡†æ¶å’Œ Lifecycle ç±»åˆ†æ´¾çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶æ˜ å°„åˆ° Activity å’Œ Fragment ä¸­çš„å›è°ƒäº‹ä»¶ã€‚
</code></pre>
</li>
<li>çŠ¶æ€<pre><code> ç”± Lifecycle å¯¹è±¡è·Ÿè¸ªçš„ç»„ä»¶çš„å½“å‰çŠ¶æ€ã€‚ 
</code></pre>
</li>
</ul>
</blockquote>
<p><img src="https://developer.android.google.cn/images/topic/libraries/architecture/lifecycle-states.svg" alt="Lifecycle.png"></p>
<p>Lifecycleçš„ä¸»è¦å­ç±»æ˜¯LifecycleRegistryï¼Œä¸»è¦ç”¨äºæœ€ç»ˆå¤„ç†å’Œåˆ†å‘äº‹ä»¶ç»™å¯¹åº”çš„Observerï¼Œç”±äºå…¶åœ¨è°ƒç”¨æµç¨‹çš„æœ€å°¾ç«¯ï¼Œæ•…æˆ‘ä»¬æ”¾åˆ°åé¢æµç¨‹ä¸­ä¸€èµ·è®²è§£ã€‚</p>
<h4 id="ComponentActivity"><a href="#ComponentActivity" class="headerlink" title="ComponentActivity"></a>ComponentActivity</h4><blockquote>
<p>æ”¯æŒåº“ 26.1.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸­çš„ Fragment å’Œ Activity å·²å®ç° LifecycleOwner æ¥å£ã€‚</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£æœ‰æŒ‡å‡ºæ”¯æŒåº“ 26.1.0ä»¥ä¸Šçš„Fragmentå’ŒActivityä¸­å·²å®ç°LifecycleOwner æ¥å£ï¼Œæˆ‘ä»¬ä»<code>androidx.appcompat.app.AppCompatActivity</code>å‘ä¸Šæ‰¾å¯»LifecycleOwnerçš„èº«å½±ï¼Œ<code>androidx.activity.ComponentActivity</code>åŠ<code>androidx.core.app.ComponentActivity</code>å‡æœ‰å¯¹ LifecycleOwnerçš„å®ç°ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹çˆ¶ç±»<code>androidx.core.app.ComponentActivity</code>ä¸­çš„å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">LifecycleOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">KeyEventDispatcher</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;RestrictedApi&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ReportFragment.injectIfNeededIn(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(<span class="meta">@NonNull</span> Bundle outState)</span> </span>&#123;</span><br><span class="line">        mLifecycleRegistry.markState(Lifecycle.State.CREATED);</span><br><span class="line">        <span class="keyword">super</span>.onSaveInstanceState(outState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œå…¶ä»£ç ä¸å¤šï¼Œä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ ¸å¿ƒä»£ç ä»…å®ç°äº†onCreateåŠonSaveInstanceStateï¼Œå…¶ä¸­onCreate()ä¸­ä¸­ä»…æœ‰ä¸€å¥ç‰¹åˆ«çš„ä»£ç <code>ReportFragment.injectIfNeededIn(this);</code>æˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡ä»–ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ‰å…³ï¼Œæˆ‘ä»¬å°è¯•è·Ÿè¿›ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ReportFragment&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="comment">// åœ¨API 29+ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ³¨å†Œæ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</span></span><br><span class="line">        LifecycleCallbacks.registerIn(activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¹‹å‰çš„API 29å’Œä¿æŒä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§</span></span><br><span class="line">    <span class="comment">// ProcessLifecycleOwner(å½“ç”Ÿå‘½å‘¨æœŸè¿è¡Œæ—¶æ›´æ–°æ—¶å¯èƒ½ä¸ä¼šæ›´æ–°ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”éœ€è¦æ”¯æŒä¸ä»æ”¯æŒåº“çš„FragmentActivityæ‰©å±•çš„æ´»åŠ¨)ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ¡†æ¶ç‰‡æ®µæ¥è·å¾—ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æ­£ç¡®æ—¶é—´</span></span><br><span class="line">    android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">        <span class="comment">// å¸Œæœ›æˆ‘ä»¬æ˜¯ç¬¬ä¸€ä¸ªè¾¾æˆäº¤æ˜“çš„ã€‚</span></span><br><span class="line">        manager.executePendingTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœä¸å…¶ç„¶ï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œæœ‰<code>LifecycleCallbacks</code>å…³é”®å­—ï¼Œè¿˜è®°å¾—å‰é¢è®²åˆ°çš„ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ä¸­æåˆ°çš„APIä¸åŒç‰ˆæœ¬å¯¹äºç”Ÿå‘½å‘¨æœŸå¤„ç†æ–¹å¼çš„ä¸åŒå—ï¼Œä¸»è¦åŒºåˆ«åœ¨äºAPI29 Activityä¸­æ–°å¢äº†<code>ActivityLifecycleCallbacks</code>çš„æ³¨å†Œå’Œåˆ†å‘ï¼Œè€ŒAPI 29ä¹‹å‰ç”Ÿå‘½å‘¨æœŸå‡ä¼šä¼ é€’ç»™Fragmentã€‚ æ­¤å¤„æˆ‘ä»¬å‘ç°è¿™é‡Œçš„ ReportFragment æœ¬è´¨æ˜¯ä¸€ä¸ªFragmentï¼Œåœ¨Activityåˆ›å»ºï¼ˆonCreateï¼‰çš„æ—¶å€™ï¼š</p>
<ul>
<li>å¯¹äºAPI â‰¥ 29 å°†ä¼šæ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå¹¶å°†ReportFragmentæ·»åŠ åˆ°Activityä¸­</li>
<li>å¯¹äºAPI &lt; 29 å°†ReportFragmentæ·»åŠ åˆ°Activityä¸­.</li>
</ul>
<p>é‚£ä¹ˆè¿™æ ·åšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™é‡ŒinjectIfNeededInå…·ä½“å¹²äº†ä»€ä¹ˆã€‚<br>é¦–å…ˆ <code>LifecycleCallbacks.registerIn(activity)</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiresApi(29)</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleCallbacks</span> <span class="keyword">implements</span> <span class="title">Application</span>.<span class="title">ActivityLifecycleCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.registerActivityLifecycleCallbacks(<span class="keyword">new</span> LifecycleCallbacks());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostCreated</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostResumed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPrePaused</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreStopped</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreDestroyed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ignore empty function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°†ä¼šæŠŠä¸€ä¸ª Application.ActivityLifecycleCallbacks æ³¨å†Œåˆ°å½“å‰Activityä¸­ï¼Œè¿˜è®°å¾—å‰é¢è®²åˆ°çš„ï¼Œç”Ÿå‘½å‘¨æœŸåœ¨Activityä¸­çš„æœ€åä½¿å‘½å°±æ˜¯é€šè¿‡ dispatchActivityXXX() å‘æ³¨å†Œåœ¨Activity/Applicationä¸­çš„ ActivityLifecycleCallbacks åˆ†å‘äº‹ä»¶ã€‚<br>å¯¹åº”æ­¤å¤„ï¼Œå³æ˜¯ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¼šåé¦ˆåˆ° <code> ReportFragment.LifecycleCallbacks</code> å¹¶æœ€ç»ˆè°ƒç”¨<code>dispatch(activity, Lifecycle.Event.ON_XXXX);</code>åˆ†å‘ã€‚</p>
<p>é‚£ä¹ˆåœ¨API29ä»¥å‰å‘¢ï¼Ÿï¼Ÿ</p>
<p>å‰é¢æœ‰è¦æ±‚æ³¨æ„è¿‡ åœ¨ç”Ÿå‘½å‘¨æœŸåˆ†å‘è¿‡ç¨‹ä¸­ å‡ä¼šè°ƒç”¨<code> FragmentController.dispatchXXX();</code> æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨Fragmentçš„ onXXXX()æ–¹æ³•ï¼Œæˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡åœ¨ReportFragmentä¸­ä¼šå­˜åœ¨å¯¹è¿™äº›ç”Ÿå‘½å‘¨æœŸçš„å®ç°åŠåˆ†å‘ï¼Œè®©æˆ‘ä»¬æ¥éªŒè¯ä¸‹æˆ‘ä»¬çš„çŒœæµ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPORT_FRAGMENT_TAG = <span class="string">&quot;androidx.lifecycle&quot;</span></span><br><span class="line">            + <span class="string">&quot;.LifecycleDispatcher.report_fragment_tag&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è§ä¸Šä¸€codepod</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private ActivityInitializationListener mProcessListener;</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatchStart(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatchResume(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        <span class="comment">// just want to be sure that we won&#x27;t leak reference to an activity</span></span><br><span class="line">        mProcessListener = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">            <span class="comment">//åªåœ¨API 29ä¹‹å‰çš„APIçº§åˆ«ä¸Šä»ReportFragmentåˆ†æ´¾äº‹ä»¶ã€‚åœ¨API 29+ä¸­ï¼Œ</span></span><br><span class="line">            <span class="comment">//è¿™æ˜¯ç”±reportfragment . injectifneeddinä¸­æ·»åŠ çš„ActivityLifecycleCallbackså¤„ç†çš„</span></span><br><span class="line">            dispatch(getActivity(), event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœç„¶ï¼ŒéªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼Œå¹¶ä» dispatch() ä¸­çš„ä»£ç æ³¨é‡Šæˆ‘ä»¬å¯çŸ¥:</p>
<blockquote>
<p>åªåœ¨API 29ä¹‹å‰çš„APIçº§åˆ«ä¸Šä»ReportFragmentåˆ†æ´¾äº‹ä»¶ã€‚åœ¨API 29+ä¸­ï¼Œè¿™æ˜¯ç”±reportfragment . injectifneeddinä¸­æ·»åŠ çš„ActivityLifecycleCallbackså¤„ç†çš„</p>
</blockquote>
<p>è¿™å¥è¯åŸºæœ¬æ€»ç»“äº†ReportFragmentåœ¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘è¿‡ç¨‹ä¸­çš„æ‰®æ¼”çš„è§’è‰²ï¼Œç»“åˆå‰é¢è®²çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘ï¼Œæˆ‘ä»¬å¯¹äºç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¼ é€’åˆ°åˆ†å‘ç»™å…·ä½“çš„Lifecycleä»¬çš„æµç¨‹åŸºæœ¬å·²ç»æ¸…æ™°äº†ï¼š</p>
<ul>
<li>ActivityThreadäº§ç”Ÿç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¹¶é€šè¿‡Instrumentationå’ŒActivityä¼ é€’æˆ–è°ƒç”¨ Activity.onXXX()</li>
<li>Activityåˆ›å»ºæ—¶(onCreate)ä¼šè¢«æ³¨å…¥ReportFragmentï¼Œè€ŒReportFragmentè´Ÿè´£å°†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„Lifecycle</li>
<li>API29åŠä»¥ä¸Šæ—¶ï¼ŒActivityåœ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸæ—¶ä¼šé€šçŸ¥ Application å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒä¸”è‡ªèº«ä¹ŸåŒæ ·å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ŒAPI29ä»¥ä¸Šè¿™äº›å›è°ƒå°†ä¼šè¢«ReportFragmentæ¥æ”¶ï¼Œè€ŒAPI29ä»¥ä¸‹åˆ™ç”±FragmentControllerç›´æ¥åˆ†å‘ç»™ReportFragmentã€‚</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å‰©ä¸‹ä¸€ä¸ªé—®é¢˜äº†ï¼ŒReportFragmentåˆ†å‘äº‹ä»¶æ˜¯å¦‚ä½•åˆ°è¾¾æˆ‘ä»¬æ³¨å†Œçš„LifecycleObserverçš„ï¼Ÿ</p>
<h4 id="dispatch-Activity-Lifecycle-Event"><a href="#dispatch-Activity-Lifecycle-Event" class="headerlink" title="dispatch(Activity, Lifecycle.Event);"></a>dispatch(Activity, Lifecycle.Event);</h4><p>æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ReportFragmentä¸­æœ€ç»ˆåˆ†å‘çš„æ–¹æ³•<code>dispatch(Activity, Lifecycle.Event)</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ReportFragment&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">        <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéƒ½ä¼šè°ƒç”¨<code>LifecycleRegistry.handleLifecycleEvent(Lifecycle.Event event)</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;handleLifecycleEvent&quot;</span>);</span><br><span class="line">    moveToState(event.getTargetState());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// somethingã€‚ã€‚ã€‚ </span></span><br><span class="line">    sync();</span><br><span class="line">    <span class="comment">// code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">    <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        backwardPass(lifecycleOwner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">    <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        forwardPass(lifecycleOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// // something</span></span><br><span class="line">    observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">    observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œæ­¤å¤„åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¯»å–LifecycleObserverä¸­çš„è¿è¡Œæ—¶</span></span><br><span class="line">        <span class="comment">// æ³¨è§£@OnLifecycleEventï¼Œä¸ºåç»­åå°„æ–¹æ³•åšå‡†å¤‡</span></span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = event.getTargetState();</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œæ— è®ºå¦‚ä½•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°<code>(ObserverWithState)observer.dispatchEvent(lifecycleOwner, event)</code>, å³æœ€ç»ˆè°ƒç”¨<code>LifecycleObserver.onStateChanged(owner, event)</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleEventObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source, <span class="meta">@NonNull</span> Lifecycle.Event event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ é€šè¿‡<code>Go to implementation(s)</code> å¿«æ·é”® <strong>ã€å¦‚æœ‰ä¸æ¸…æ¥šå¿«æ·é”®çš„ï¼Œè¯·æ‰“å¼€ File -&gt; Settings -&gt; Keymap æœç´¢ Go to implementation(s)ã€‘</strong> æŸ¥çœ‹å…¶å®ç°ä»¥è·Ÿè¿›å…¶æµç¨‹ã€‚<br>æˆ‘ä»¬ä»¥ åå°„é€šç”¨ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿå™¨ <code>ReflectiveGenericLifecycleObserver</code> ä¸ºä¾‹ç»§ç»­è·Ÿè¿›ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; å‘½åç›´è¯‘ä¸º åå°„é€šç”¨ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿå™¨</span><br><span class="line">class ReflectiveGenericLifecycleObserver implements LifecycleEventObserver &#123;</span><br><span class="line">    private final Object mWrapped;</span><br><span class="line">    private final CallbackInfo mInfo;</span><br><span class="line"></span><br><span class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;</span><br><span class="line">        mWrapped &#x3D; wrapped;</span><br><span class="line">        mInfo &#x3D; ClassesInfoCache.sInstance.getInfo(mWrapped.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Event event) &#123;</span><br><span class="line">        mInfo.invokeCallbacks(source, event, mWrapped);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé€šè¿‡å§”æ‰˜ CallbackInfo å»æ‰§è¡ŒCallback ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">static class CallbackInfo &#123;</span><br><span class="line">    &#x2F;&#x2F; something</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;ConstantConditions&quot;)</span><br><span class="line">    void invokeCallbacks(LifecycleOwner source, Lifecycle.Event event, Object target) &#123;</span><br><span class="line">        invokeMethodsForEvent(mEventToHandlers.get(event), source, event, target);</span><br><span class="line">        invokeMethodsForEvent(mEventToHandlers.get(Lifecycle.Event.ON_ANY), source, event,</span><br><span class="line">                target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void invokeMethodsForEvent(List&lt;MethodReference&gt; handlers,</span><br><span class="line">            LifecycleOwner source, Lifecycle.Event event, Object mWrapped) &#123;</span><br><span class="line">        if (handlers !&#x3D; null) &#123;</span><br><span class="line">            for (int i &#x3D; handlers.size() - 1; i &gt;&#x3D; 0; i--) &#123;</span><br><span class="line">                handlers.get(i).invokeCallback(source, event, mWrapped);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static final class MethodReference &#123;</span><br><span class="line">   &#x2F;&#x2F; something</span><br><span class="line"></span><br><span class="line">    void invokeCallback(LifecycleOwner source, Lifecycle.Event event, Object target) &#123;</span><br><span class="line">        &#x2F;&#x2F;noinspection TryWithIdenticalCatches</span><br><span class="line">        try &#123;</span><br><span class="line">            switch (mCallType) &#123;</span><br><span class="line">                case CALL_TYPE_NO_ARG:</span><br><span class="line">                    mMethod.invoke(target);</span><br><span class="line">                    break;</span><br><span class="line">                case CALL_TYPE_PROVIDER:</span><br><span class="line">                    mMethod.invoke(target, source);</span><br><span class="line">                    break;</span><br><span class="line">                case CALL_TYPE_PROVIDER_WITH_EVENT:</span><br><span class="line">                    mMethod.invoke(target, source, event);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to call observer method&quot;, e.getCause());</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒCallbackInfo.invokeCallbacks æœ€ç»ˆè°ƒç”¨ MethodReference.invokeCallback() é€šè¿‡åå°„å®Œæˆæœ€ç»ˆè°ƒç”¨ï¼Œå…¶å®è‡³æ­¤ï¼Œæ•´ä¸ªæµç¨‹å°±ä»¥å®Œç»“ã€‚</p>
<p>ä½†æ˜¯ï¼ï¼ï¼</p>
<p>æ­¤æ—¶æœ‰ä¸€ä¸ªç–‘é—®ï¼Œè¿™äº›è¿™é‡Œåå°„ä½¿ç”¨çš„æ–¹æ³•æ˜¯å“ªé‡Œè·å–çš„ï¼Œä¸ºä»€ä¹ˆä»–èƒ½æ‰¾åˆ°æˆ‘ä»¬æ·»åŠ äº†@OnLifecycleEventæ³¨è§£çš„æ–¹æ³•ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>æ¥ï¼Œè®©æˆ‘ä»¬åå‘æŸ¥æ‰¾ä¸€ä¸‹ï¼Œ æ—¢ç„¶ä»–ç”¨äº†CallbackInfoï¼Œæˆ‘ä»¬æ¥æ‰¾æ‰¾ä»å“ªé‡Œåˆ›å»ºäº†CallbackInfoï¼Œæˆ‘ä»¬ä»”ç»†å¯»æ‰¾ä¸€ä¸‹ CallbackInfoæ‰€åœ¨çš„classæ–‡ä»¶ï¼Œå˜¿ï¼Œå°±åœ¨å†…éƒ¨ç±» CallbackInfoå®šä¹‰çš„ä¸Šé¢ä¸€è¡Œ~ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CallbackInfo <span class="title">createInfo</span><span class="params">(Class&lt;?&gt; klass, <span class="meta">@Nullable</span> Method[] declaredMethods)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; superclass = klass.getSuperclass();</span><br><span class="line">    Map&lt;MethodReference, Lifecycle.Event&gt; handlerToEvent = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        CallbackInfo superInfo = getInfo(superclass);</span><br><span class="line">        <span class="keyword">if</span> (superInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handlerToEvent.putAll(superInfo.mHandlerToEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] interfaces = klass.getInterfaces();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intrfc : interfaces) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;MethodReference, Lifecycle.Event&gt; entry : getInfo(</span><br><span class="line">                intrfc).mHandlerToEvent.entrySet()) &#123;</span><br><span class="line">            verifyAndPutHandler(handlerToEvent, entry.getKey(), entry.getValue(), klass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–classä¸­çš„æ–¹æ³•</span></span><br><span class="line">    Method[] methods = declaredMethods != <span class="keyword">null</span> ? declaredMethods : getDeclaredMethods(klass);</span><br><span class="line">    <span class="keyword">boolean</span> hasLifecycleMethods = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°æ–¹æ³•çš„OnLifecycleEventæ³¨è§£</span></span><br><span class="line">        OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hasLifecycleMethods = <span class="keyword">true</span>;</span><br><span class="line">        Class&lt;?&gt;[] params = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">int</span> callType = CALL_TYPE_NO_ARG;</span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            callType = CALL_TYPE_PROVIDER;</span><br><span class="line">            <span class="keyword">if</span> (!params[<span class="number">0</span>].isAssignableFrom(LifecycleOwner.class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;invalid parameter type. Must be one and instanceof LifecycleOwner&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">        Lifecycle.Event event = annotation.value();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            callType = CALL_TYPE_PROVIDER_WITH_EVENT;</span><br><span class="line">            <span class="keyword">if</span> (!params[<span class="number">1</span>].isAssignableFrom(Lifecycle.Event.class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;invalid parameter type. second arg must be an event&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (event != Lifecycle.Event.ON_ANY) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;Second arg is supported only for ON_ANY value&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;cannot have more than 2 params&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°è£…æˆMethodReferenceä»¥å¾…ä½¿ç”¨</span></span><br><span class="line">        MethodReference methodReference = <span class="keyword">new</span> MethodReference(callType, method);</span><br><span class="line">        <span class="comment">// æ ¡éªŒåŠå­˜å‚¨ MethodReference</span></span><br><span class="line">        verifyAndPutHandler(handlerToEvent, methodReference, event, klass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è£…æˆ CallbackInfo ä»¥å¾…ä½¿ç”¨</span></span><br><span class="line">    CallbackInfo info = <span class="keyword">new</span> CallbackInfo(handlerToEvent);</span><br><span class="line">    <span class="comment">// å­˜å‚¨ CallbackInfo</span></span><br><span class="line">    mCallbackMap.put(klass, info);</span><br><span class="line">    mHasLifecycleMethods.put(klass, hasLifecycleMethods);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸€ç®©ç­ï¼Œçœ‹èµ·æ¥å“äººï¼Œå®é™…å‡ å¥è¯ï¼Œæˆ‘ä»¬ç®€å•è§£é‡Šä¸€ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>è·å–classä¸­çš„æ–¹æ³• ã€æ­¤å¤„classå®ä¸ºæˆ‘ä»¬å®šä¹‰çš„LifecycleObserverï¼Œæ¥è‡ªäºaddObserverã€‘</li>
<li>éå†æ–¹æ³•<ul>
<li>æ‹¿åˆ°æ–¹æ³•çš„OnLifecycleEventæ³¨è§£</li>
<li>è·å–å…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
<li>å°è£…æˆMethodReferenceä»¥å¾…ä½¿ç”¨</li>
<li>æ ¡éªŒåŠå­˜å‚¨ MethodReference</li>
</ul>
</li>
<li>å°è£…æˆ CallbackInfo ä»¥å¾…ä½¿ç”¨</li>
<li>å­˜å‚¨ CallbackInfo</li>
</ul>
<p>æˆ‘ä»¬ç»§ç»­å…³æ³¨ï¼Œæ˜¯å“ªé‡Œè°ƒç”¨ä»–çš„å‘¢ï¼Ÿï¼Ÿ</p>
<p>å‘å‰å‘å‰ï¼šClassesInfoCache.hasLifecycleMethods()<br>ç»§ç»­å‘å‰ï¼šLifecycling.resolveObserverCallbackType()<br>         -&gt; Lifecycling.getObserverConstructorType()<br>         -&gt; Lifecycling.lifecycleEventObserver()</p>
<p>å˜¿ï¼Œä¼¼ä¹æœ‰ç‚¹çœ¼ç†Ÿï¼Œæ²¡é”™ï¼Œåœ¨å‰é¢æµç¨‹ä¸­è°ƒç”¨ LifecycleRegistry.ObserverWithState.dispatchEvent()æ—¶ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­æˆ‘ä»¬è§è¿‡è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;LifecycleRegistry.ObserverWithState&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œè¿™é‡Œ</span></span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = event.getTargetState();</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŸ¥æ‰¾å®ƒçš„è°ƒç”¨æ—¶æœºå‘ç°ï¼Œåœ¨ addObserverä¸­æœ‰è°ƒç”¨å…¶åˆå§‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">    <span class="comment">// åˆ›å»º ObserverWithState</span></span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æ•´ä¸ªæµç¨‹ç®—æ˜¯å®Œå…¨èµ°é€šäº†ï¼š</p>
<p><strong>æ³¨å†Œæ—¶addObserver</strong></p>
<ul>
<li>ç¼–å†™LifecycleObserverå¹¶é€šè¿‡ Lifecycle.addObserveræ–¹æ³•å°†è§‚å¯Ÿè€…æ³¨å†Œåˆ°LifecycleRegistry</li>
<li>LifecycleRegistryé€šè¿‡ ObserverWithState è°ƒç”¨ Lifecycling æœ€ç»ˆé€šè¿‡åå°„è·å–LifecycleObserverä¸­å…³æ³¨ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•å’Œå…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°è£…æˆMethodReferenceå’ŒCallbackInfoå¹¶ç¼“å­˜</li>
<li>ObserverWithState.dispatchEvent() åˆ†å‘å½“å‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
</ul>
<p><strong>ç”Ÿå‘½å‘¨æœŸå˜åŒ–æ—¶</strong></p>
<ul>
<li>ActivityThreadé€šçŸ¥Activityï¼ŒActivityï¼ˆæ— è®ºä½•ç§æ–¹å¼ï¼‰é€šçŸ¥ ReportFragment</li>
<li>ReportFragmentè°ƒç”¨ LifecycleRegistry.handleLifecycleEvent(event)</li>
<li>LifecycleRegistryç»è¿‡ moveToState() -&gt; sync() -&gt; backwardPass()/forwardPass() æœ€ç»ˆè°ƒç”¨ObserverWithState.dispatchEvent()</li>
<li>ObserverWithState.dispatchEvent() è°ƒç”¨LifecycleObserver.onStateChanged() é€šçŸ¥ CallbackInfo é€šè¿‡åå°„æ‰§è¡Œå¯¹åº”æ–¹æ³•</li>
<li>CallbackInfo.invokeCallbacks()æŸ¥æ‰¾åˆ°å¯¹åº”ç”Ÿå‘½å‘¨æœŸçš„ MethodReference ç¼“å­˜ï¼Œé€šè¿‡Method.invoke()è°ƒç”¨ï¼Œæœ€ç»ˆæ‰§è¡ŒLifecycleObserverä¸­å…³æ³¨å¯¹åº”ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ•´ç†ä¸€ä¸‹ç”»ä¸€ä¸ªæ—¶åºå›¾ï¼š</p>
<p><img src="https://s3.ax1x.com/2021/03/01/6i7Ubj.png" alt="Lifecycleæ—¶åºå›¾.png"></p>
<h3 id="é™„-ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬"><a href="#é™„-ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬" class="headerlink" title="é™„ - ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬"></a>é™„ - ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬</h3><p>åœ¨ lifecycle-process.aarä¸­å­˜åœ¨AndroidManifest.xmlæ–‡ä»¶ï¼Œå…¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªproviderç»„ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">    &lt;provider</span><br><span class="line">        android:name=&quot;androidx.lifecycle.ProcessLifecycleOwnerInitializer&quot;</span><br><span class="line">        android:authorities=&quot;$&#123;applicationId&#125;.lifecycle-process&quot;</span><br><span class="line">        android:exported=&quot;false&quot;</span><br><span class="line">        android:multiprocess=&quot;true&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessLifecycleOwnerInitializer</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LifecycleDispatcher.init(getContext());</span><br><span class="line">        ProcessLifecycleOwner.init(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»„ä»¶åœ¨åˆ›å»ºæ—¶æœºåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œå…¶onCreateä¸­åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>LifecycleDispatcher.init(getContext()) å‘Applicationä¸­æ³¨å†Œç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç›‘å¬</li>
<li>ProcessLifecycleOwner.init(getContext()) å‘ProcessLifecycleOwnerä¸­ç»‘å®šApplicationï¼Œä¸”ä¸ºReportFragmentæ·»åŠ ActivityInitializationListenerã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler();</span><br><span class="line">    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    Application app = (Application) context.getApplicationContext();</span><br><span class="line">    app.registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</span><br><span class="line">        <span class="meta">@RequiresApi(29)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreCreated</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// log</span></span><br><span class="line">            activity.registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">                    activityStarted();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostResumed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">                    activityResumed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// log</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">                <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œä¸ºReportFragmentæ·»åŠ ActivityInitializationListener</span></span><br><span class="line">                ReportFragment.get(activity).setProcessListener(mInitializationListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„æ­¤å¤„</span></span><br><span class="line">            activityPaused();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">             <span class="comment">// æ³¨æ„æ­¤å¤„</span></span><br><span class="line">            activityStopped();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°è¿™é‡Œä¸ºApplicationæ·»åŠ äº†ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œæ­¤ç›‘å¬åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>åˆ›å»ºéƒ¨åˆ†åˆ†åˆ«ä¸º api29ä»¥ä¸‹å’ŒAPI29åŠä»¥ä¸Š æ³¨å†Œäº†ç›‘å¬</li>
<li>åœæ­¢éƒ¨åˆ†è°ƒç”¨äº†å†…éƒ¨æ–¹æ³•activityPausedå’ŒactivityStopped</li>
</ul>
<p>ç”±å‰æ–‡å¯çŸ¥ï¼Œç”Ÿå‘½å‘¨æœŸå˜åŒ–æ˜¯ä¼šé€šçŸ¥å›è°ƒï¼Œæœ€ç»ˆä¼šé€šçŸ¥ReportFragmentï¼Œåœ¨å‰é¢ä»‹ç»ç”Ÿå‘½å‘¨æœŸåˆ†å‘è¿‡ç¨‹ä¸­ReportFragmentä¸­æœ‰ä¸€éƒ¨åˆ†å…³äºActivityInitializationListener æˆ‘æ²¡æœ‰ä»‹ç»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityInitializationListener mProcessListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onStart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onResume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        <span class="comment">// ä¼šé€šçŸ¥ç›‘å¬å™¨ï¼Œå…¶ä»–ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯å¦‚æ­¤</span></span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ProcessLifecycleOwnerä¸ºReportFragmentæ·»åŠ  ActivityInitializationListenerï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸå˜åŒ–æ˜¯ä¼šé€šçŸ¥ProcessLifecycleOwnerä¸­çš„ActivityInitializationListenerå¯¹è±¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">ActivityInitializationListener mInitializationListener &#x3D;</span><br><span class="line">            new ActivityInitializationListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onCreate() &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onStart() &#123;</span><br><span class="line">                    activityStarted();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onResume() &#123;</span><br><span class="line">                    activityResumed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line"> void activityStarted() &#123;</span><br><span class="line">        mStartedCounter++;</span><br><span class="line">        if (mStartedCounter &#x3D;&#x3D; 1 &amp;&amp; mStopSent) &#123;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">            mStopSent &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityResumed() &#123;</span><br><span class="line">        mResumedCounter++;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            if (mPauseSent) &#123;</span><br><span class="line">                mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">                mPauseSent &#x3D; false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mHandler.removeCallbacks(mDelayedPauseRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityPaused() &#123;</span><br><span class="line">        mResumedCounter--;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityStopped() &#123;</span><br><span class="line">        mStartedCounter--;</span><br><span class="line">        dispatchStopIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void dispatchPauseIfNeeded() &#123;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            mPauseSent &#x3D; true;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void dispatchStopIfNeeded() &#123;</span><br><span class="line">        if (mStartedCounter &#x3D;&#x3D; 0 &amp;&amp; mPauseSent) &#123;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);</span><br><span class="line">            mStopSent &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œåœ¨å±•ç¤ºæ—¶è°ƒç”¨ activityStarted å’Œ activityResumed å¹¶ä½œè®¡æ•°é€’å¢ï¼Œåœ¨åœæ­¢æ—¶è°ƒç”¨ activityPaused å’Œ activityStopped åšè®¡æ•°é€’å‡ï¼Œå¹¶åˆ¤æ–­è®¡æ•°æ˜¯å¦ä¸º0ï¼Œ ä¸ºé›¶åˆ™æ‰§è¡Œ LifecycleRegistry.handleLifecycleEvent é€šçŸ¥åˆ°æˆ‘ä»¬æ³¨å†Œçš„ LifecycleObserverï¼Œ å…¶é€šçŸ¥æµç¨‹ä¸Activityç”Ÿå‘½å‘¨æœŸåˆ†å‘åˆ°LifecycleObserverä¸€è‡´ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªæµç¨‹ç»“æŸã€‚</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Lifecycle/" rel="tag"># Lifecycle</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/02/25/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E4%BD%BF%E7%94%A8%E7%AF%87/" rel="prev" title="Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡">
      <i class="fa fa-chevron-left"></i> Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/" rel="next" title="Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel">
      Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E4%BA%A7%E7%94%9F%E5%8F%8A%E5%88%86%E5%8F%91"><span class="nav-number">1.</span> <span class="nav-text">ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#API-26"><span class="nav-number">1.1.</span> <span class="nav-text">API 26</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API-30-%EF%BC%88API-lvl-%E2%89%A5-29%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">API 30 ï¼ˆAPI lvl â‰¥ 29ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lifecycle%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">Lifecycleæºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Lifecycle"><span class="nav-number">2.1.</span> <span class="nav-text">Lifecycle</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ComponentActivity"><span class="nav-number">2.2.</span> <span class="nav-text">ComponentActivity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-Activity-Lifecycle-Event"><span class="nav-number">2.3.</span> <span class="nav-text">dispatch(Activity, Lifecycle.Event);</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84-ProcessLifecycleOwner%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BA%94%E7%94%A8%E5%89%8D%E5%90%8E%E5%8F%B0%E7%9B%91%E5%90%AC"><span class="nav-number">3.</span> <span class="nav-text">é™„ - ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tinlone"
      src="/images/favicon-32x32-next.png">
  <p class="site-author-name" itemprop="name">Tinlone</p>
  <div class="site-description" itemprop="description">Tinloneçš„ä¸ªäººåšå®¢</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
	
	<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=16435049&auto=1&height=66"></iframe>
	
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tinlone</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">48k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">43 åˆ†é’Ÿ</span>
</div>
<!--
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

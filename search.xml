<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Jetpackä¹‹å¯è§‚å¯Ÿçš„æ•°æ®å­˜å‚¨å™¨-LiveDataä½¿ç”¨ç¯‡</title>
    <url>/2021/03/10/Jetpack%E4%B9%8B%E5%8F%AF%E8%A7%82%E5%AF%9F%E7%9A%84%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E5%99%A8-LiveData%E4%BD%BF%E7%94%A8%E7%AF%87/</url>
    <content><![CDATA[<blockquote>
<p>LiveData æ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®å­˜å‚¨å™¨ç±»ã€‚ä¸å¸¸è§„çš„å¯è§‚å¯Ÿç±»ä¸åŒï¼ŒLiveData å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ„æŒ‡å®ƒéµå¾ªå…¶ä»–åº”ç”¨ç»„ä»¶ï¼ˆå¦‚ Activityã€Fragment æˆ– Serviceï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™ç§æ„ŸçŸ¥èƒ½åŠ›å¯ç¡®ä¿ LiveData ä»…æ›´æ–°å¤„äºæ´»è·ƒç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„åº”ç”¨ç»„ä»¶è§‚å¯Ÿè€…ã€‚</p>
</blockquote>
<p><a href="https://github.com/TinloneX/ArchitecturalComponentExample">ã€æœ¬ç³»åˆ—æ–‡ç« (JAVA/KOTLIN)æ¼”ç¤ºæ¡ˆä¾‹å‡å­˜å‚¨åœ¨githubå­˜å‚¨åº“ArchitecturalComponentExampleä¸­ã€‘</a></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/livedata#create_livedata_objects">ã€å¦‚éœ€å‚è€ƒLiveDataå®˜æ–¹æ–‡æ¡£è¯·ç§»æ­¥æ­¤å¤„ã€‘</a></p>
<a id="more"></a>

<h4 id="LiveDataçš„ä¼˜åŠ¿"><a href="#LiveDataçš„ä¼˜åŠ¿" class="headerlink" title="LiveDataçš„ä¼˜åŠ¿"></a>LiveDataçš„ä¼˜åŠ¿</h4><p>åœ¨æ­£å¼ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹å…¶ä¼˜åŠ¿ï¼ˆå³æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒï¼‰ï¼Œä»¥ä¸‹å¼•ç”¨å–è‡ªå®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><strong>ç¡®ä¿ç•Œé¢ç¬¦åˆæ•°æ®çŠ¶æ€</strong></p>
<blockquote>
<p>LiveData éµå¾ªè§‚å¯Ÿè€…æ¨¡å¼ã€‚å½“åº•å±‚æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLiveData ä¼šé€šçŸ¥ Observer å¯¹è±¡ã€‚æ‚¨å¯ä»¥æ•´åˆä»£ç ä»¥åœ¨è¿™äº› Observer å¯¹è±¡ä¸­æ›´æ–°ç•Œé¢ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‚¨æ— éœ€åœ¨æ¯æ¬¡åº”ç”¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°ç•Œé¢ï¼Œå› ä¸ºè§‚å¯Ÿè€…ä¼šæ›¿æ‚¨å®Œæˆæ›´æ–°ã€‚</p>
</blockquote>
<p><strong>ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼</strong></p>
<blockquote>
<p>è§‚å¯Ÿè€…ä¼šç»‘å®šåˆ° Lifecycle å¯¹è±¡ï¼Œå¹¶åœ¨å…¶å…³è”çš„ç”Ÿå‘½å‘¨æœŸé­åˆ°é”€æ¯åè¿›è¡Œè‡ªæˆ‘æ¸…ç†ã€‚</p>
</blockquote>
<p><strong>ä¸ä¼šå›  Activity åœæ­¢è€Œå¯¼è‡´å´©æºƒ</strong></p>
<blockquote>
<p>å¦‚æœè§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸå¤„äºéæ´»è·ƒçŠ¶æ€ï¼ˆå¦‚è¿”å›æ ˆä¸­çš„ Activityï¼‰ï¼Œåˆ™å®ƒä¸ä¼šæ¥æ”¶ä»»ä½• LiveData äº‹ä»¶ã€‚</p>
</blockquote>
<p><strong>ä¸å†éœ€è¦æ‰‹åŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ</strong></p>
<blockquote>
<p>ç•Œé¢ç»„ä»¶åªæ˜¯è§‚å¯Ÿç›¸å…³æ•°æ®ï¼Œä¸ä¼šåœæ­¢æˆ–æ¢å¤è§‚å¯Ÿã€‚LiveData å°†è‡ªåŠ¨ç®¡ç†æ‰€æœ‰è¿™äº›æ“ä½œï¼Œå› ä¸ºå®ƒåœ¨è§‚å¯Ÿæ—¶å¯ä»¥æ„ŸçŸ¥ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å˜åŒ–ã€‚</p>
</blockquote>
<p><strong>æ•°æ®å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€</strong></p>
<blockquote>
<p>å¦‚æœç”Ÿå‘½å‘¨æœŸå˜ä¸ºéæ´»è·ƒçŠ¶æ€ï¼Œå®ƒä¼šåœ¨å†æ¬¡å˜ä¸ºæ´»è·ƒçŠ¶æ€æ—¶æ¥æ”¶æœ€æ–°çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ›¾ç»åœ¨åå°çš„ Activity ä¼šåœ¨è¿”å›å‰å°åç«‹å³æ¥æ”¶æœ€æ–°çš„æ•°æ®ã€‚</p>
</blockquote>
<p><strong>é€‚å½“çš„é…ç½®æ›´æ”¹</strong></p>
<blockquote>
<p>å¦‚æœç”±äºé…ç½®æ›´æ”¹ï¼ˆå¦‚è®¾å¤‡æ—‹è½¬ï¼‰è€Œé‡æ–°åˆ›å»ºäº† Activity æˆ– Fragmentï¼Œå®ƒä¼šç«‹å³æ¥æ”¶æœ€æ–°çš„å¯ç”¨æ•°æ®ã€‚</p>
</blockquote>
<p><strong>å…±äº«èµ„æº</strong></p>
<blockquote>
<p>æ‚¨å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼æ‰©å±• LiveData å¯¹è±¡ä»¥å°è£…ç³»ç»ŸæœåŠ¡ï¼Œä»¥ä¾¿åœ¨åº”ç”¨ä¸­å…±äº«å®ƒä»¬ã€‚LiveData å¯¹è±¡è¿æ¥åˆ°ç³»ç»ŸæœåŠ¡ä¸€æ¬¡ï¼Œç„¶åéœ€è¦ç›¸åº”èµ„æºçš„ä»»ä½•è§‚å¯Ÿè€…åªéœ€è§‚å¯Ÿ LiveData å¯¹è±¡ã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…æ‰©å±• LiveDataã€‚ </p>
</blockquote>
<h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><p>LiveDataä½œä¸ºç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶ï¼Œå®ƒçš„ä¾èµ–åŒ…ä¹Ÿæ˜¯ lifecycleæ—ç³»ï¼Œé€šå¸¸çš„ï¼Œæˆ‘ä»¬å¸¸å¸¸å°†LiveDataé…åˆViewModelä½¿ç”¨ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨LiveDataä¾èµ–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def lifecycle_version &#x3D; &quot;2.3.0&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å¦‚æœä½ éœ€è¦é…åˆViewModelä½¿ç”¨ï¼Œè¯·åŠ ä¸Š</span><br><span class="line">implementation &quot;androidx.lifecycle:lifecycle-viewmodel-ktx:$lifecycle_version&quot;</span><br><span class="line">&#x2F;&#x2F; LiveData</span><br><span class="line">implementation &quot;androidx.lifecycle:lifecycle-livedata-ktx:$lifecycle_version&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ­¤æ–‡æ¼”ç¤ºé¡¹ç›®ä¸ºViewModel+LiveDataï¼Œå¦‚æœ‰å¯¹ViewModelä¸äº†è§£çš„å¯ä»¥é€šè¿‡<a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel">ã€å®˜æ–¹æ–‡æ¡£ã€‘</a>æˆ–<a href="https://tinlone.com/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/">ã€Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModelã€‘</a>å…·ä½“äº†è§£ã€‚</p>
<blockquote>
<p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨ LiveData å¯¹è±¡ï¼š</p>
<ul>
<li>åˆ›å»º LiveData çš„å®ä¾‹ä»¥å­˜å‚¨æŸç§ç±»å‹çš„æ•°æ®ã€‚è¿™é€šå¸¸åœ¨ ViewModel ç±»ä¸­å®Œæˆã€‚</li>
<li>åˆ›å»ºå¯å®šä¹‰ onChanged() æ–¹æ³•çš„ Observer å¯¹è±¡ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ§åˆ¶å½“ LiveData å¯¹è±¡å­˜å‚¨çš„æ•°æ®æ›´æ”¹æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ç•Œé¢æ§åˆ¶å™¨ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰ä¸­åˆ›å»º Observer å¯¹è±¡ã€‚</li>
<li>ä½¿ç”¨ observe() æ–¹æ³•å°† Observer å¯¹è±¡é™„åŠ åˆ° LiveData å¯¹è±¡ã€‚observe() æ–¹æ³•ä¼šé‡‡ç”¨ LifecycleOwner å¯¹è±¡ã€‚è¿™æ ·ä¼šä½¿ Observer å¯¹è±¡è®¢é˜… LiveData å¯¹è±¡ï¼Œä»¥ä½¿å…¶æ”¶åˆ°æœ‰å…³æ›´æ”¹çš„é€šçŸ¥ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åœ¨ç•Œé¢æ§åˆ¶å™¨ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰ä¸­é™„åŠ  Observer å¯¹è±¡ã€‚</li>
</ul>
</blockquote>
<h4 id="åˆ›å»ºLiveData"><a href="#åˆ›å»ºLiveData" class="headerlink" title="åˆ›å»ºLiveData"></a>åˆ›å»ºLiveData</h4><p>åˆ›å»ºLiveDataçš„æ–¹å¼éå¸¸ç®€å•ï¼Œä½ åªéœ€è¦ç›´æ¥newå‡ºä»–çš„å­ç±»å¹¶ä¼ å…¥ä½ æƒ³è¦è§‚å¯Ÿçš„æ•°æ®ç±»å‹æ³›å‹å³å¯ï¼ŒLiveDataæä¾›<code>setValue(T t) & postValue(T t)</code>ç”¨ä»¥æ›´æ–°å€¼, å¯ä»¥ä½¿ç”¨<code>T getValue()</code>è·å–å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MutableLiveData&lt;Integer&gt; price = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"><span class="comment">// å½“ç„¶ä½ ä¹Ÿå¯ä»¥è¿™æ ·</span></span><br><span class="line">MutableLiveData&lt;Seller&gt; mSeller = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"><span class="comment">// å®šä¹‰æ›´æ–°LiveDataå€¼çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼Œåœ¨åˆå§‹æ—¶LiveDataä¸­åŒ…å«çš„æ•°æ®å¯èƒ½ä¸ºç©ºï¼Œä½ éœ€è¦ä¸ºå®ƒè®¾ç½®å€¼</span></span><br><span class="line">    price.setValue(price.getValue() == <span class="keyword">null</span> ? <span class="number">0</span> : price.getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è§‚å¯ŸLiveData"><a href="#è§‚å¯ŸLiveData" class="headerlink" title="è§‚å¯ŸLiveData"></a>è§‚å¯ŸLiveData</h4><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ç”¨ç»„ä»¶çš„ onCreate() æ–¹æ³•æ˜¯å¼€å§‹è§‚å¯Ÿ LiveData å¯¹è±¡çš„æ­£ç¡®ç€æ‰‹ç‚¹ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¡®ä¿ç³»ç»Ÿä¸ä¼šä» Activity æˆ– Fragment çš„ onResume() æ–¹æ³•è¿›è¡Œå†—ä½™è°ƒç”¨ã€‚</li>
<li>ç¡®ä¿ Activity æˆ– Fragment å˜ä¸ºæ´»è·ƒçŠ¶æ€åå…·æœ‰å¯ä»¥ç«‹å³æ˜¾ç¤ºçš„æ•°æ®ã€‚ä¸€æ—¦åº”ç”¨ç»„ä»¶å¤„äº STARTED çŠ¶æ€ï¼Œå°±ä¼šä»å®ƒæ­£åœ¨è§‚å¯Ÿçš„ LiveData å¯¹è±¡æ¥æ”¶æœ€æ–°å€¼ã€‚åªæœ‰åœ¨è®¾ç½®äº†è¦è§‚å¯Ÿçš„ LiveData å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</li>
</ul>
<p>LiveDataè®¢é˜…<code>observe(@NonNull LifecycleOwner owner, @NonNull Observer<? super T> observer)</code>éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç”Ÿå‘½å‘¨æœŸæ‹¥æœ‰è€…LifecycleOwnerå’Œè§‚å¯Ÿè€…Observerã€‚</p>
<p>ä¸€èˆ¬çš„ï¼Œç»§æ‰¿è‡ªAndroidXåŒ…ä¸­çš„Activity/Fragmentç»„ä»¶(api &gt;= 26)å·²è‡ªè¡Œå®ç°LifecycleOwnerã€‚</p>
<p><em>åœ¨æœªå¼ºè°ƒè¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæœ¬æ–‡ä»£ç å—å‡ä¿æŒä½¿ç”¨Java8ç‰¹æ€§ã€‚</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å»ºç«‹è®¢é˜…å…³ç³»</span></span><br><span class="line">viewModel.price.observe(<span class="keyword">this</span>, <span class="keyword">this</span>::updatePriceButton);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰Observer.onChanged(T t)å›è°ƒæ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePriceButton</span><span class="params">(<span class="keyword">int</span> price)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// åœ¨æœªå¼ºè°ƒæ—¶ï¼Œæ­¤å¤„å‡ä¸ºæ—¥å¿—æ‰“å°ï¼Œè¯¦ç»†ä»£ç è§Demo</span></span><br><span class="line">   <span class="comment">// åç»­ä»£ç å—ä¸­å°†ç®€åŒ–æˆ–ä¸å†™ç±»ä¼¼å®ç°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªonClickè§¦å‘LiveDataå€¼çš„æ›´æ–°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countUp</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    viewModel.countUp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ‰§è¡Œæ•ˆæœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è®¢é˜…æ•°æ®å˜åŒ–ğŸ‘‰ 0</span><br><span class="line">è®¢é˜…æ•°æ®å˜åŒ–ğŸ‘‰ 1</span><br><span class="line">è®¢é˜…æ•°æ®å˜åŒ–ğŸ‘‰ 2</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬æ”¹å˜è¢«è§‚å¯Ÿçš„å€¼æ—¶ï¼Œæˆ‘ä»¬çš„è§‚å¯Ÿè€…ä¹Ÿå¦‚é¢„æœŸè¢«é€šçŸ¥åˆ°äº†ï¼Œè¿™æ ·ä¾¿å®ç°äº†æœ€ç®€LiveDataæ•°æ®è§‚å¯Ÿæµç¨‹ï¼ˆè¯¦ç»†ä»£ç <a href="https://github.com/TinloneX/ArchitecturalComponentExample/tree/main/LiveDataExample/LiveDataExampleJava/app/src/main/java/com/tinlone/livedataexamplejava">ã€Javaç¤ºä¾‹è¯·å‚è§æ­¤å¤„ã€‘</a>ã€<a href="https://github.com/TinloneX/ArchitecturalComponentExample/tree/main/LiveDataExample/LiveDataExampleKotlin/app/src/main/java/com/tinlone/livedataexamplekotlin">ã€Kotlinç¤ºä¾‹è¯·å‚è§æ­¤å¤„ã€‘</a>ï¼‰ã€‚</p>
<h4 id="æ‰©å±•LiveData"><a href="#æ‰©å±•LiveData" class="headerlink" title="æ‰©å±•LiveData"></a>æ‰©å±•LiveData</h4><p>ä½ å¯ä»¥ç»§æ‰¿LiveDataè‡ªè¡Œå®ç°LiveDataçš„æ•°æ®å˜æ›´çŠ¶æ€çš„åˆ†å‘ï¼Œå·²æ¼”ç¤ºé¡¹ç›®ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPriceLiveData</span> <span class="keyword">extends</span> <span class="title">LiveData</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;LiveDataExampleLog&quot;</span>;</span><br><span class="line">    <span class="comment">// æ­¤å¤„å®šä¹‰ç›‘å¬ï¼Œç›‘å¬è§¦å‘æ—¶è°ƒç”¨ setValue(T t)æ–¹æ³•</span></span><br><span class="line">    PriceManager.PriceListener listener = <span class="keyword">this</span>::setValue;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åŒæ ·çš„ä½ å¯ä»¥å°†LiveDataè®¾ç½®æˆå•ä¾‹ï¼Œæ­¤å¤„ä¸åšå®ç°</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ­¤å¤„å®šä¹‰ç”Ÿå‘½å‘¨æœŸå¤„äº STARTED æˆ– RESUMED çŠ¶æ€æ—¶çš„æ“ä½œ</span></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;MyPriceLiveData.onActive&quot;</span>);</span><br><span class="line">        PriceManager.getInstance().requestPriceUpdate(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;MyPriceLiveData.onInactive&quot;</span>);</span><br><span class="line">        <span class="comment">// æ­¤å¤„å®šä¹‰æ²¡æœ‰ä»»ä½•æ´»è·ƒè§‚å¯Ÿè€…æ—¶ï¼Œè§£é™¤å¯¹PriceManagerçš„å…³è”</span></span><br><span class="line">        PriceManager.getInstance().removeUpdateListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åƒå…ˆå‰ä¸€æ ·ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; ViewModelä¸­</span><br><span class="line">private final PriceManager priceManager &#x3D; PriceManager.getInstance();</span><br><span class="line">MyPriceLiveData extensionData &#x3D; new MyPriceLiveData();</span><br><span class="line"></span><br><span class="line">public void updatePriceForExtension() &#123;</span><br><span class="line">    priceManager.updatePrice(priceManager.price + 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Activity&#x2F;Fragmentä¸­</span><br><span class="line">&#x2F;&#x2F; è®¢é˜…LiveDataæ‰©å±•</span><br><span class="line">viewModel.extensionData.observe(this, this::updateExtensionButton);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç‚¹å‡»äº‹ä»¶è§¦å‘å€¼æ›´æ–°</span><br><span class="line">public void extensionData(View view) &#123;</span><br><span class="line">    viewModel.updatePriceForExtension();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿è¡ŒæŸ¥çœ‹ç»“æœï¼Œå¹¶åšæ¯å±äº®å±æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; ç‚¹å‡»æŒ‰é’®</span><br><span class="line">æµ‹è¯•æ‰©å±•LiveDatağŸ‘‰ 1</span><br><span class="line">æµ‹è¯•æ‰©å±•LiveDatağŸ‘‰ 2</span><br><span class="line">&#x2F;&#x2F; æ¯å±</span><br><span class="line">MyPriceLiveData.onInactive</span><br><span class="line">&#x2F;&#x2F; äº®å±</span><br><span class="line">MyPriceLiveData.onActive</span><br><span class="line">&#x2F;&#x2F; æ­¤å¤„PriceManageræœªåšå€¼æœªæ”¹å˜æ—¶ä¸æ›´æ–°çš„é™åˆ¶ï¼Œæ•…ä¼šé‡æ–°åˆ†å‘å€¼å˜åŒ–</span><br><span class="line">æµ‹è¯•æ‰©å±•LiveDatağŸ‘‰ 2</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„æ‰©å±•LiveDataä¼šåœ¨æ¯å±/äº®å±æ—¶è§¦å‘<code> onInactive()/ onActive()</code>å›è°ƒï¼Œä»è€Œæ‰§è¡Œæˆ‘ä»¬çš„è‡ªå®šä¹‰å®ç°ä»£ç ã€‚</p>
<h4 id="è½¬æ¢-LiveData"><a href="#è½¬æ¢-LiveData" class="headerlink" title="è½¬æ¢ LiveData"></a>è½¬æ¢ LiveData</h4><p>LiveDataä¸ºæˆ‘ä»¬æä¾›äº†æ•°æ®è½¬æ¢åŠŸèƒ½ï¼ŒåŒ…å«<code>Transformations.map()</code>ã€<code>Transformations.switchMap()</code>ä¸¤ç§æ–¹å¼ï¼Œå…¶è°ƒç”¨æ–¹å¼ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº map() çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯ç†è§£ä¸ºè½¬æ¢å™¨ï¼‰éœ€è¿”å›æ³›å‹Tï¼Œè€ŒswitchMap() çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯ç†è§£ä¸ºè½¬æ¢å™¨ï¼‰éœ€è¿”å›LiveData<T>ã€‚</p>
<p>map()è½¬æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ViewModelä¸­</span></span><br><span class="line">MutableLiveData&lt;Integer&gt; priceForMap = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"><span class="comment">// è§‚å¯Ÿpriceå¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„å¯è§‚å¯Ÿå¯¹è±¡</span></span><br><span class="line">LiveData&lt;String&gt; userThink = Transformations.map(priceForMap,</span><br><span class="line">        price -&gt; price + (price % <span class="number">2</span> == <span class="number">0</span> ? <span class="string">&quot;å—åˆšåˆšå¥½&quot;</span> : <span class="string">&quot;å—è´µäº†&quot;</span>));</span><br><span class="line"><span class="comment">// æ›´æ–°priceå€¼</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPriceForMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    priceForMap.setValue(priceForMap.getValue() == <span class="keyword">null</span> ? <span class="number">0</span> : priceForMap.getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Activity/Fragmentä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="comment">// æ•°æ®è½¬æ¢ è®¢é˜…ä»·æ ¼çš„è½¬æ¢ =&gt; ç”¨æˆ·ä»·æ ¼æ„ŸçŸ¥</span></span><br><span class="line">viewModel.userThink.observe(<span class="keyword">this</span>, <span class="keyword">this</span>::updateUserThinkButton);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰§è¡Œè§‚å¯Ÿç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è½¬æ¢æ•°æ®(map)ğŸ‘‰ 0å—åˆšåˆšå¥½</span><br><span class="line">è½¬æ¢æ•°æ®(map)ğŸ‘‰ 1å—è´µäº†</span><br><span class="line">è½¬æ¢æ•°æ®(map)ğŸ‘‰ 2å—åˆšåˆšå¥½</span><br></pre></td></tr></table></figure>
<p>switchMap()è½¬æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è½¬æ¢å‰çš„LiveData</span></span><br><span class="line">MutableLiveData&lt;Integer&gt; priceForSwitch = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"><span class="comment">// è½¬æ¢åçš„ç›®æ ‡LiveData</span></span><br><span class="line">MutableLiveData&lt;String&gt; sellerThink = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> MutableLiveData&lt;String&gt; <span class="title">getSellerThink</span><span class="params">(<span class="keyword">int</span> price)</span> </span>&#123;</span><br><span class="line">    String think = price + (price &lt;= <span class="number">3</span> ? <span class="string">&quot;ç©·é¬¼&quot;</span> : <span class="string">&quot;å†¤å¤§å¤´&quot;</span>);</span><br><span class="line">    sellerThink.setValue(think);</span><br><span class="line">    <span class="keyword">return</span> sellerThink;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°priceå€¼</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPriceForSeller</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    priceForSwitch.setValue(priceForSwitch.getValue() == <span class="keyword">null</span> ? <span class="number">0</span> : priceForSwitch.getValue() + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è½¬æ¢ç»“æœLiveData</span></span><br><span class="line">LiveData&lt;String&gt; switchToUserLook = Transformations.switchMap(priceForSwitch, <span class="keyword">this</span>::getSellerThink);</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨æ–¹å¼ä¸map()ä¸€è‡´ï¼Œä½ å¯ä»¥å¯¹è½¬æ¢åçš„LiveDataè§‚æµ‹ï¼Œä¹Ÿå¯ä»¥å¯¹è½¬æ¢ç»“æœLiveDataè§‚æµ‹ï¼Œæ­¤å¤„çœç•¥ï¼Œæˆ‘ä»¬æ¥è§‚å¯Ÿå…¶æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æˆ‘æ˜¯å•†å®¶æƒ³æ³•çš„è®¢é˜…ï¼š0ç©·é¬¼</span><br><span class="line">è½¬æ¢æ•°æ®(switchMap)ğŸ‘‰ 0ç©·é¬¼</span><br><span class="line">æˆ‘æ˜¯å•†å®¶æƒ³æ³•çš„è®¢é˜…ï¼š1ç©·é¬¼</span><br><span class="line">è½¬æ¢æ•°æ®(switchMap)ğŸ‘‰ 1ç©·é¬¼</span><br></pre></td></tr></table></figure>
<p>å¯¹è½¬æ¢åçš„LiveDataè§‚æµ‹åŠä»¥å¯¹è½¬æ¢ç»“æœLiveDataè§‚æµ‹å‡èƒ½æ”¶åˆ°å“åº”ã€‚ä¸ºåˆ¤æ–­2ä¸ªLiveDataæ˜¯å¦è§‚å¯Ÿçš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°†è½¬æ¢åçš„ç›®æ ‡åŠç»“æœæ”¹é€ ä¸ºå¯¹è±¡ï¼Œè§‚å¯Ÿå…¶hashCodeæ˜¯å¦ç›¸ç­‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è½¬æ¢åçš„ç›®æ ‡LiveData</span></span><br><span class="line">MutableLiveData&lt;Seller&gt; mSeller = <span class="keyword">new</span> MutableLiveData&lt;&gt;();</span><br><span class="line"><span class="comment">// è½¬æ¢ç»“æœLiveData</span></span><br><span class="line">LiveData&lt;Seller&gt; switchToSeller = Transformations.switchMap(priceForSeller, <span class="keyword">this</span>::getSeller);</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œè§‚å¯Ÿç»“æœæ‰“å°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è®¢é˜…çš„Seller.hashCode() &#x3D; 84056966</span><br><span class="line">viewModel.mSeller.getValue().hashCode() &#x3D; 84056966</span><br><span class="line">viewModel.switchToSeller.getValue().hashCode() &#x3D; 84056966</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œè½¬æ¢åçš„ç›®æ ‡LiveDataåŠè½¬æ¢ç»“æœLiveDataå®é™…è§‚å¯Ÿå¯¹è±¡ä¸ºåŒä¸€ä¸ªï¼Œä¸ä¼šä¸ºæ•°æ®åˆ›å»ºå‰¯æœ¬ã€‚</p>
<h4 id="åˆå¹¶LiveData"><a href="#åˆå¹¶LiveData" class="headerlink" title="åˆå¹¶LiveData"></a>åˆå¹¶LiveData</h4><blockquote>
<p>MediatorLiveData æ˜¯ LiveData çš„å­ç±»ï¼Œå…è®¸æ‚¨åˆå¹¶å¤šä¸ª LiveData æºã€‚åªè¦ä»»ä½•åŸå§‹çš„ LiveData æºå¯¹è±¡å‘ç”Ÿæ›´æ”¹ï¼Œå°±ä¼šè§¦å‘ MediatorLiveData å¯¹è±¡çš„è§‚å¯Ÿè€…ã€‚</p>
</blockquote>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªåˆå¹¶LiveDataæºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MediatorLiveData&lt;Object&gt; mediatorLiveData = <span class="keyword">new</span> MediatorLiveData&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>å¹¶åœ¨ä½¿ç”¨æ—¶ï¼Œä¸ºå…¶æ·»åŠ è§‚å¯Ÿçš„LiveDataæºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå¹¶è§‚å¯Ÿ1</span></span><br><span class="line">viewModel.mediatorLiveData.addSource(viewModel.switchToSeller, <span class="keyword">this</span>::onMediatorData);</span><br><span class="line"><span class="comment">// åˆå¹¶è§‚å¯Ÿ2</span></span><br><span class="line">viewModel.mediatorLiveData.addSource(viewModel.userThink, <span class="keyword">this</span>::onMediatorData);</span><br><span class="line"><span class="comment">// è§‚å¯Ÿæ•°æ®åˆå¹¶</span></span><br><span class="line">viewModel.mediatorLiveData.observe(<span class="keyword">this</span>,<span class="keyword">this</span>::onMediatorData);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> mediatorFlag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦å‘ä¸åŒçš„æ•°æ®æ›´æ–°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mediatorData</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mediatorFlag) &#123;</span><br><span class="line">        viewModel.setPriceForSeller();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        viewModel.setPriceForMap();</span><br><span class="line">    &#125;</span><br><span class="line">    mediatorFlag = !mediatorFlag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è§‚å¯Ÿå…¶æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; ç¬¬ä¸€æ¬¡è§¦å‘</span><br><span class="line">è½¬æ¢æ•°æ®(map)ğŸ‘‰ 0å—åˆšåˆšå¥½</span><br><span class="line">åˆå¹¶æ•°æ®ğŸ‘‰ 0å—åˆšåˆšå¥½</span><br><span class="line">&#x2F;&#x2F; ç¬¬äºŒæ¬¡è§¦å‘</span><br><span class="line">æˆ‘æ˜¯å•†å®¶æƒ³æ³•çš„è®¢é˜…ï¼š0ç©·é¬¼</span><br><span class="line">åˆå¹¶æ•°æ®ğŸ‘‰ 0ç©·é¬¼</span><br><span class="line">è½¬æ¢æ•°æ®(switchMap)ğŸ‘‰ 0ç©·é¬¼</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨è§¦å‘å•ä¸ªLiveDataå€¼å˜åŒ–æ—¶é™¤äº†å…¶æœ¬èº«LiveDataçš„è§‚å¯Ÿè€…è¢«è§¦å‘ï¼Œåˆå¹¶æ•°æ®çš„è§‚å¯Ÿè€…ä¹Ÿä¼šè¢«è§¦å‘ã€‚</p>
<p>å¯¹äºæ­¤APIçš„åº”ç”¨åœºæ™¯ï¼Œå®˜æ–¹æœ‰æå‡ºä»¥ä¸‹åœºæ™¯ï¼š</p>
<blockquote>
<p>ä¾‹å¦‚ï¼Œå¦‚æœç•Œé¢ä¸­æœ‰å¯ä»¥ä»æœ¬åœ°æ•°æ®åº“æˆ–ç½‘ç»œæ›´æ–°çš„ LiveData å¯¹è±¡ï¼Œåˆ™å¯ä»¥å‘ MediatorLiveData å¯¹è±¡æ·»åŠ ä»¥ä¸‹æºï¼š</p>
<ul>
<li>ä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„æ•°æ®å…³è”çš„ LiveData å¯¹è±¡ã€‚</li>
<li>ä¸ä»ç½‘ç»œè®¿é—®çš„æ•°æ®å…³è”çš„ LiveData å¯¹è±¡ã€‚</li>
</ul>
</blockquote>
<blockquote>
<p>æ‚¨çš„ Activity åªéœ€è§‚å¯Ÿ MediatorLiveData å¯¹è±¡å³å¯ä»è¿™ä¸¤ä¸ªæºæ¥æ”¶æ›´æ–°ã€‚</p>
</blockquote>
<h3 id="å°èŠ‚"><a href="#å°èŠ‚" class="headerlink" title="å°èŠ‚"></a>å°èŠ‚</h3><p>LiveData æ˜¯ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ•°æ®è§‚å¯Ÿè€…ï¼Œä½ å¯ä»¥é€šè¿‡è‡ªå®šä¹‰LiveDataã€ä½¿ç”¨map()åŠswitchMap()è½¬æ¢LiveDataæºä¸ºä½ éœ€è¦çš„LiveDataæºã€ä½ ä¹Ÿå¯ä»¥åˆå¹¶è§‚å¯Ÿä¸åŒçš„LiveDataæºçš„å˜åŒ–ï¼Œè¿™äº›æ–¹å¼åŸºæœ¬èƒ½æ»¡è¶³å¯¹ä¸€èˆ¬æ•°æ®è§‚å¯Ÿçš„éœ€æ±‚ã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>LiveData</tag>
      </tags>
  </entry>
  <entry>
    <title>Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡</title>
    <url>/2021/02/25/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E4%BD%BF%E7%94%A8%E7%AF%87/</url>
    <content><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä»€ä¹ˆæ˜¯ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶ï¼Ÿ</p>
<blockquote>
<p>ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶å¯æ‰§è¡Œæ“ä½œæ¥å“åº”å¦ä¸€ä¸ªç»„ä»¶ï¼ˆå¦‚ Activity å’Œ Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„å˜åŒ–ã€‚è¿™äº›ç»„ä»¶æœ‰åŠ©äºæ‚¨å†™å‡ºæ›´æœ‰æ¡ç†ä¸”å¾€å¾€æ›´ç²¾ç®€çš„ä»£ç ï¼Œè¿™æ ·çš„ä»£ç æ›´æ˜“äºç»´æŠ¤ã€‚</p>
</blockquote>
<p>Lifecycleæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>Lifecycle æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºå­˜å‚¨æœ‰å…³ç»„ä»¶ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„ä¿¡æ¯ï¼Œå¹¶å…è®¸å…¶ä»–å¯¹è±¡è§‚å¯Ÿæ­¤çŠ¶æ€ã€‚</p>
</blockquote>
<p>å®ƒæ‰€è§£å†³çš„ç—›ç‚¹é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>åœ¨ Android æ¡†æ¶ä¸­å®šä¹‰çš„å¤§å¤šæ•°åº”ç”¨ç»„ä»¶éƒ½å­˜åœ¨ç”Ÿå‘½å‘¨æœŸã€‚ç”Ÿå‘½å‘¨æœŸç”±æ“ä½œç³»ç»Ÿæˆ–è¿›ç¨‹ä¸­è¿è¡Œçš„æ¡†æ¶ä»£ç ç®¡ç†ã€‚å®ƒä»¬æ˜¯ Android å·¥ä½œåŸç†çš„æ ¸å¿ƒï¼Œåº”ç”¨å¿…é¡»éµå¾ªå®ƒä»¬ã€‚å¦‚æœä¸è¿™æ ·åšï¼Œå¯èƒ½ä¼šå¼•å‘å†…å­˜æ³„æ¼ç”šè‡³åº”ç”¨å´©æºƒã€‚</p>
</blockquote>
<p><a href="https://github.com/TinloneX/ArchitecturalComponentExample">ã€æœ¬ç³»åˆ—æ–‡ç« (JAVA/KOTLIN)æ¼”ç¤ºæ¡ˆä¾‹å‡å­˜å‚¨åœ¨githubå­˜å‚¨åº“ArchitecturalComponentExampleä¸­ã€‘</a></p>
<a id="more"></a>

<h3 id="ä½¿ç”¨Lifecycleçš„æ„ä¹‰"><a href="#ä½¿ç”¨Lifecycleçš„æ„ä¹‰" class="headerlink" title="ä½¿ç”¨Lifecycleçš„æ„ä¹‰"></a>ä½¿ç”¨Lifecycleçš„æ„ä¹‰</h3><p>è¯´èµ·Activityç”Ÿå‘½å‘¨æœŸï¼Œä¸éš¾æƒ³åˆ°Applicationæœ‰ä¸ªæ–¹æ³•<code>registerActivityLifecycleCallbacks()</code>å¯ä»¥æ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒ, ä¸”åœ¨<code>Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q</code>æ—¶çš„Activityä¹Ÿæ‰©å±•äº†è¿™ä¸ªæ–¹æ³•ï¼Œè·å–activityç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">registerActivityLifecycleCallbacks(new Application.ActivityLifecycleCallbacks() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityCreated(@NonNull Activity activity, @Nullable Bundle bundle) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityCreated&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityStarted(@NonNull Activity activity) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityStarted&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityResumed(@NonNull Activity activity) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityResumed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityPaused(@NonNull Activity activity) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityPaused&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityStopped(@NonNull Activity activity) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityStopped&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivitySaveInstanceState(@NonNull Activity activity, @NonNull Bundle bundle) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivitySaveInstanceState&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onActivityDestroyed(@NonNull Activity activity) &#123;</span><br><span class="line">        Log.i(&quot;loglog&quot;, &quot;onActivityDestroyed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨Activityä¸­å•çº¯ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå›è°ƒ<code>onCreate()</code>ã€<code>onResume()</code>ç­‰æ¥å®ç°ç”Ÿå‘½å‘¨æœŸç›‘å¬ã€‚</p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle">å…·ä½“æ¡ˆä¾‹å‚è€ƒå®˜æ–¹æ–‡æ¡£</a></p>
<p>æˆ‘ä»¬ä¸éš¾å‘ç°è¿™æ ·å†™å­˜åœ¨è¿™æ ·ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>ç”Ÿå‘½å‘¨æœŸç®¡ç†é›†ä¸­ï¼Œä¸”å¹¶éæ‰€æœ‰ç”Ÿå‘½å‘¨æœŸå›è°ƒæˆ‘ä»¬éƒ½è¦ç”¨</li>
<li>è‹¥åŒä¸€ç”Ÿå‘½å‘¨æœŸå›è°ƒä¸­è¦åšå¤šä¸ªåŠŸèƒ½ï¼ŒåŒä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸­ä»£ç é‡å°†ä¼šå¾ˆå¤§ï¼Œè¿™å°†å¸¦æ¥å·¨å¤§çš„ç»´æŠ¤æˆæœ¬</li>
<li>æ— æ³•ä¿è¯ç»„ä»¶ä¼šåœ¨ Activity æˆ– Fragment åœæ­¢ä¹‹å‰å¯åŠ¨ã€‚åœ¨æˆ‘ä»¬éœ€è¦æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼ˆå¦‚ onStart() ä¸­çš„æŸç§é…ç½®æ£€æŸ¥ï¼‰æ—¶å°¤å…¶å¦‚æ­¤ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´å‡ºç°ä¸€ç§ç«æ€æ¡ä»¶ï¼Œåœ¨è¿™ç§æ¡ä»¶ä¸‹ï¼ŒonStop() æ–¹æ³•ä¼šåœ¨ onStart() ä¹‹å‰ç»“æŸï¼Œè¿™ä½¿å¾—ç»„ä»¶ç•™å­˜çš„æ—¶é—´æ¯”æ‰€éœ€çš„æ—¶é—´è¦é•¿ã€‚</li>
</ul>
<p>Lifecycle å¯ä»¥ä¸ºä½ çš„æ¯ä¸€ä¸ªåŠŸèƒ½æä¾›ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ï¼Œåšåˆ°åŠŸèƒ½ä»£ç ä¸ç•Œé¢ï¼ˆActivity/Fragmentï¼‰æ›´å°çš„è€¦åˆï¼Œä¸”æ¯ä¸€ä¸ªåŠŸèƒ½çš„ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…éƒ½å¯ä»¥è¢«å¤ç”¨ï¼ŒåŠŸèƒ½ç»„ä»¶çš„æŠ½ç¦»ä¹Ÿèƒ½ä¸ºä½ çš„ç¨‹åºå¸¦æ¥æ›´å¼ºå¤§çš„æ‰©å±•æ€§ã€‚</p>
<h3 id="ä½¿ç”¨Lifecycle"><a href="#ä½¿ç”¨Lifecycle" class="headerlink" title="ä½¿ç”¨Lifecycle"></a>ä½¿ç”¨Lifecycle</h3><h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><p>æ–‡æ¡£ç¼–å†™æ—¶ï¼Œç¨³å®šä¾èµ–ç‰ˆæœ¬ä¸º<code>2.2.0</code> ï¼Œä¸‹ä¸€å€™é€‰é¢„è§ˆç‰ˆä¸º<code>2.3.0-rc01</code>ï¼Œå¼•å…¥æ—¶è¯·æ£€æŸ¥å®˜æ–¹æ–‡æ¡£æ¨èç‰ˆæœ¬ï¼Œä»¥å½“å‰ç¨³å®šç‰ˆä¸ºä¸»è¦é€‰æ‹©ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    def lifecycle_version &#x3D; &quot;2.3.0&quot;</span><br><span class="line">    def arch_version &#x3D; &quot;2.1.0&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ViewModelæ”¯æŒ</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-viewmodel:$lifecycle_version&quot;</span><br><span class="line">    &#x2F;&#x2F; LiveDataæ”¯æŒ</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-livedata:$lifecycle_version&quot;</span><br><span class="line">    &#x2F;&#x2F; ä»…Lifecycles (ä¸åŒ…æ‹¬ ViewModel å’Œ LiveDataæ”¯æŒ)</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-runtime:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ä¿å­˜ViewModelçš„çŠ¶æ€æ¨¡å—</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-viewmodel-savedstate:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; æ³¨è§£å¤„ç†å™¨</span><br><span class="line">    annotationProcessor &quot;androidx.lifecycle:lifecycle-compiler:$lifecycle_version&quot;</span><br><span class="line">    &#x2F;&#x2F; å¦å¤–â€”â€”å¦‚æœä½¿ç”¨Java8ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç ä»£æ›¿lifecycle-compiler</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-common-java8:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å¯é€‰â€”â€”åœ¨æœåŠ¡ä¸­å®ç°LifecycleOwnerçš„åŠ©æ‰‹</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-service:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å¯é€‰- ProcessLifecycleOwnerä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºè¿‡ç¨‹æä¾›ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-process:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å¯é€‰- ReactiveStreamsæ”¯æŒLiveData</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-reactivestreams:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å¯é€‰çš„- LiveDataçš„æµ‹è¯•åŠ©æ‰‹</span><br><span class="line">    testImplementation &quot;androidx.arch.core:core-testing:$arch_version&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä¾èµ–åº“å¹¶éæ‰€æœ‰å†…å®¹å‡éœ€è¦å¼•å…¥ï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚å¼•å…¥å¯¹åº”ä¾èµ–ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä½ å•çº¯çš„æƒ³ä½¿ç”¨Lifecycleçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ï¼Œä½ å¯ä»¥è¿™æ ·å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    def lifecycle_version &#x3D; &quot;2.3.0&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å•çº¯ç”Ÿå‘½å‘¨æœŸç»„ä»¶</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-runtime:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è´Ÿè´£è¿›ç¨‹(åº”ç”¨)çš„ç”Ÿå‘½å‘¨æœŸ</span><br><span class="line">    implementation &#39;androidx.lifecycle:lifecycle-process:$lifecycle_version&#39;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="LifecycleObserver"><a href="#LifecycleObserver" class="headerlink" title="LifecycleObserver"></a>LifecycleObserver</h4><p>ç¼–å†™ä½ çš„LifecycleObserver è§‚å¯Ÿè€…ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ç•Œé¢ç»„ä»¶çš„LifecycleOwnerè§‚å¯Ÿé˜Ÿåˆ—ï¼ˆé›†åˆï¼‰ä¸­<br>ï¼Œå³å¯å®Œæˆå¯¹ç•Œé¢ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„è§‚å¯Ÿï¼Œä½ å¯ä»¥åœ¨ä½ çš„LifecycleObserver å®šä¹‰ä½ æ„Ÿå…´è¶£çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œä¾‹å¦‚ä½ éœ€è¦æ§åˆ¶ç›¸æœºåœ¨äº®/æ¯å±æ—¶å¼€å¯æˆ–åœæ­¢ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCamera</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;ON_CREATE åˆå§‹åŒ–ç›¸æœº&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openCamera</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;ON_RESUME æ‰“å¼€ç›¸æœº&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeCamera</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;ON_PAUSE å…³é—­ç›¸æœº&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;ON_DESTROY é”€æ¯èµ„æº&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œè‹¥ä½ è¿˜æƒ³åˆ©ç”¨å…¶ä»–ç”Ÿå‘½å‘¨æœŸï¼Œæˆ–è€…ä¸»åŠ¨è·å–ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½ æˆ–å¯ä»¥å°†ç”Ÿå‘½å‘¨æœŸç»„ä»¶ä¼ å…¥CameraLifecycleObserverç»„ä»¶ä¸­ï¼Œé€šè¿‡å…¶è·å–å½“å‰ç”Ÿå‘½å‘¨æœŸï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Lifecycle mLifecycle = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å½“ç„¶ï¼Œæ­¤å¤„ä¹Ÿå¯ä»¥ä¼ é€’ LifecycleOwner ä»¥åŠå…¶ä»–ç±»å‹å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CameraLifecycleObserver</span><span class="params">(Lifecycle lifecycle)</span></span>&#123;</span><br><span class="line">        mLifecycle = lifecycle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½ åº”å½“åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨æ–¹æ³•ä½“ä¸­çš„ä¸¤ä¸ªAPIï¼Œè€Œå¹¶éä¸€å®šè¦åœ¨ ON_ANY çš„æ—¶åˆ»è°ƒç”¨</span></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_ANY)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAny</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çŠ¶æ€</span></span><br><span class="line">        Lifecycle.State currentState = mLifecycle.getCurrentState();</span><br><span class="line">        <span class="comment">// è‡³å°‘å·²ç»æ‰§è¡ŒonStartäº†</span></span><br><span class="line">        <span class="keyword">boolean</span> hasStarted = currentState.isAtLeast(Lifecycle.State.STARTED);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç»„ä»¶å®ç°LifecycleOwner"><a href="#ç»„ä»¶å®ç°LifecycleOwner" class="headerlink" title="ç»„ä»¶å®ç°LifecycleOwner"></a>ç»„ä»¶å®ç°LifecycleOwner</h4><p>å®Œæˆäº†è§‚å¯Ÿè€…çš„ç¼–å†™ï¼Œæˆ‘ä»¬å¯ä»¥å°†è§‚å¯Ÿè€…çš„å®ä¾‹ä¼ é€’ç»™LifecycleOwnerï¼Œè€Œå…³äºLifecycleownerä½ å¯èƒ½å­˜åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>ä½ ä½¿ç”¨äº†Androidxæ”¯æŒåº“ï¼Œä¸”ç‰ˆæœ¬ <code>>=26.1.0</code>, Fragment å’Œ Activity å·²å®ç° LifecycleOwner æ¥å£ï¼Œæ­¤å¤„ä¸»è¦æŒ‡ç»§æ‰¿è‡ª<code>ComponentActivity</code>åŠå…¶å­ç±»çš„Activityå’Œç»§æ‰¿è‡ª<code>androidx.fragment.app.Fragment</code>çš„Fragmentã€‚</li>
<li>å…¶ä»–æƒ…å†µï¼Œä½ éœ€è¦è‡ªè¡Œå®ç°LifecycleOwner ï¼Œå¹¶é‡å†™<code>getLifecycle()</code>æ–¹æ³•ï¼Œå¹¶æ‰‹åŠ¨åˆ†å‘ä½ éœ€è¦çš„ç”Ÿå‘½å‘¨æœŸï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">LifecycleOwner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LifecycleRegistry lifecycleRegistry;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    </span><br><span class="line">        lifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line">        lifecycleRegistry.markState(Lifecycle.State.CREATED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        lifecycleRegistry.markState(Lifecycle.State.STARTED);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lifecycleRegistry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å°†è§‚å¯Ÿè€…äº¤ç»™LifecycleOwner"><a href="#å°†è§‚å¯Ÿè€…äº¤ç»™LifecycleOwner" class="headerlink" title="å°†è§‚å¯Ÿè€…äº¤ç»™LifecycleOwner"></a>å°†è§‚å¯Ÿè€…äº¤ç»™LifecycleOwner</h4><p>å½“ä½ æ‹¥æœ‰LifecycleOwnerå¯¹è±¡åï¼Œä½ å°±å¯ä»¥å°†ä½ å®ç°çš„è§‚å¯Ÿè€…LifecycleObserver äº¤ç»™å®ƒäº†ï¼Œå½“æœ‰ç”Ÿå‘½å‘¨æœŸå˜åŒ–äº‹ä»¶å‘ç”Ÿï¼ŒLifecycleObserverå°†ä¼šé€šçŸ¥ä½ çš„LifecycleOwnerã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getLifecycle().addObserver(<span class="keyword">new</span> CameraLifecycleObserver(...params));</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I&#x2F;loglog: ON_CREATE åˆå§‹åŒ–ç›¸æœº</span><br><span class="line">I&#x2F;loglog: onActivityStarted</span><br><span class="line">I&#x2F;loglog: onActivityResumed</span><br><span class="line">I&#x2F;loglog: ON_RESUME æ‰“å¼€ç›¸æœº</span><br><span class="line">I&#x2F;loglog: ON_PAUSE å…³é—­ç›¸æœº</span><br><span class="line">I&#x2F;loglog: onActivityPaused</span><br><span class="line">I&#x2F;loglog: onActivityStopped</span><br><span class="line">I&#x2F;loglog: ON_DESTROY é”€æ¯èµ„æº</span><br><span class="line">I&#x2F;loglog: onActivityDestroyed</span><br></pre></td></tr></table></figure>
<h3 id="ä¸ºè¿›ç¨‹æ·»åŠ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶"><a href="#ä¸ºè¿›ç¨‹æ·»åŠ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶" class="headerlink" title="ä¸ºè¿›ç¨‹æ·»åŠ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶"></a>ä¸ºè¿›ç¨‹æ·»åŠ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</h3><p>å¦‚æœä½ æƒ³ç›‘å¬åº”ç”¨å‰åå°å˜åŒ–ï¼Œä½ å¯ä»¥çœ‹ä¸‹æ­¤å°èŠ‚ã€‚<br>ä»¥å¾€çš„ï¼Œè§‚å¯Ÿåº”ç”¨æ˜¯å¦å‰å°ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">inAppOnForeground</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ActivityManager activityManager = (ActivityManager) context.getSystemService(ACTIVITY_SERVICE);</span><br><span class="line">        String packageName = context.getPackageName();</span><br><span class="line">        <span class="keyword">if</span> (activityManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            List&lt;ActivityManager.RunningAppProcessInfo&gt; appProcesses = activityManager.getRunningAppProcesses();</span><br><span class="line">            <span class="keyword">if</span> (appProcesses == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo appProcess : appProcesses) &#123;</span><br><span class="line">                <span class="keyword">if</span> (packageName.equals(appProcess.processName)</span><br><span class="line">                        &amp;&amp; appProcess.importance == ActivityManager.RunningAppProcessInfo.IMPORTANCE_FOREGROUND) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ä½ åªèƒ½çŸ¥é“åº”ç”¨æ˜¯å¦å‰å°ï¼Œä½†æ— æ³•çŸ¥é“å®ƒä»€ä¹ˆæ—¶å€™è¿›å…¥å‰å°ï¼Œä»€ä¹ˆæ—¶å€™è¿›å…¥åå°ï¼Œå¦‚æœä½ æ°å¥½éœ€è¦çŸ¥é“åº”ç”¨ä½•æ—¶è¿›å…¥åå°æ‰§è¡ŒæŸé¡¹å·¥ä½œï¼Œè¿™æ ·åšå¯èƒ½å¹¶ä¸é€‚åˆã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡Application.registerActivityLifecycleCallbacks()ç›‘å¬activityçš„å¯åŠ¨å’Œé€€å‡ºï¼Œä¸ºå…¶å¯åŠ¨å’Œé€€å‡ºè®¡æ•°ï¼Œå½“é€€å‡ºæ—¶è®¡æ•°ä¸º0åˆ™å¯è§†ä½œåº”ç”¨åå°ï¼Œå½“å¯åŠ¨æ—¶è®¡æ•°ä¸º1åˆ™å¯è§†åšåº”ç”¨å‰å°ï¼Œemmmmï¼Œæƒ³æƒ³æˆ‘å°±è§‰å¾—å·¥ä½œé‡æŒºå¤§~</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨Lifecycleå¦‚ä½•ç®€å•åšåˆ°è¿™ä»¶äº‹æƒ…å§ï¼ˆéœ€å¼•å…¥ä¾èµ–androidx.lifecycle:lifecycle-process:$last_versionï¼‰ï¼š</p>
<ul>
<li>ç¼–å†™ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…</li>
<li>ä¸ºä½ çš„Applicationæ·»åŠ ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessLifecycleObserver</span> <span class="keyword">implements</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ‡è®°å‰åå°çŠ¶æ€çš„ä¸€ç§æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isForeground = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_START)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onForeground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;onForeground: ON_START&quot;</span>);</span><br><span class="line">        isForeground = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnLifecycleEvent(Lifecycle.Event.ON_STOP)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;onBackground: ON_STOP&quot;</span>);</span><br><span class="line">        isForeground = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å‰åå°çŠ¶æ€çš„ä¸€ç§æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isForeground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isForeground;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProcessLifecycleObserver observer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        observer = <span class="keyword">new</span> ProcessLifecycleObserver();</span><br><span class="line">        ProcessLifecycleOwner.get().getLifecycle().addObserver(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å‰åå°çŠ¶æ€çš„ä¸€ç§æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isForeground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> observer.isForeground();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±ç®€å•çš„å®Œæˆäº†åº”ç”¨å‰åå°åˆ‡æ¢çš„ç›‘å¬ï¼Œä»¥åŠå‰åå°çŠ¶æ€çš„æŸ¥è¯¢äº†~</p>
<h3 id="ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶çš„æœ€ä½³åšæ³•"><a href="#ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶çš„æœ€ä½³åšæ³•" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶çš„æœ€ä½³åšæ³•"></a><a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle#lc-bp">ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶çš„æœ€ä½³åšæ³•</a></h3><p>å¦‚éœ€äº†è§£ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„å»ºçš„æœ€ä½³åšæ³•ï¼Œè¯·ç‚¹å‡» <a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle#lc-bp">å®˜æ–¹æ–‡æ¡£</a> è·å¾—è¯¦ç»†å†…å®¹</p>
<p>å…³äºLifecycle ä¸LiveDataç­‰jetpackç»„ä»¶é…åˆä½¿ç”¨ï¼Œå°†åœ¨æ¶æ„ç»„ä»¶åŸºç¡€ä½¿ç”¨ç³»åˆ—å®Œç»“åä¸€å¹¶ç¼–å†™ä»‹ç»ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œè¯·å‚è€ƒ<a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle">å®˜æ–¹æ–‡æ¡£</a> </p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>Lifecycle</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(ä¸‰) - SystemAlarmService</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)%20-%20SystemAlarmService/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#part_source">æºç ç¯‡</a><ul>
<li><a href="#SystemAlarmService">2.1.1 SystemAlarmService</a><ul>
<li><a href="#processCommand">å¦‚ä½•å¤„ç½®å‘½ä»¤ (processCommand)</a></li>
<li><a href="#CommandHandler">å¦‚ä½•åˆ†å‘å‘½ä»¤ (CommandHandler)</a><ul>
<li><a href="#startWork">æ˜¯æ€ä¹ˆè°ƒç”¨åˆ°Worker.doWork()çš„ï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#DequeueAndCheckForCompletion">å¦‚ä½•å®Œæˆå›è°ƒ (DequeueAndCheckForCompletion)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="æºç ç¯‡"><a href="#æºç ç¯‡" class="headerlink" title=" æºç ç¯‡"></a><span id="part_source"> æºç ç¯‡</h3><p>ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬äº†è§£äº†WorkManagerä½¿ç”¨çš„çš„ä¸»è¦ç»„ä»¶ï¼ŒçŒœæµ‹äº†å„ä¸ªç»„ä»¶çš„ä½œç”¨ï¼Œå¹¶ç®€å•ä»‹ç»äº†WorkManageræ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚æœ¬ç¯‡å°†å»¶ç»­å‰æ–‡ï¼Œä»‹ç»WorkManagerä¸­Serviceç»„ä»¶ä¹‹ä¸€çš„SystemAlarmServiceã€‚</p>
<p><strong><span id="SystemAlarmService"> SystemAlarmService</strong></p>
<blockquote>
<p>Service invoked by {@link android.app.AlarmManager} to run work tasks.</p>
</blockquote>
<p>æœåŠ¡å°†è¢«AlarmManagerè°ƒç”¨æ¥æ‰§è¡Œå·¥ä½œä»»åŠ¡.</p>
<a id="more"></a>

<p>æ³¨: æ­¤èŠ‚ä¸­å‡¡ æè¿°ä¸­çš„ <strong>â€œå‘½ä»¤â€</strong> åŠ <strong>â€œintentâ€</strong> å‡æŒ‡ä»£åŒ…æ‹¬ <strong>[è§„åˆ’ä»»åŠ¡ã€é‡æ–°è§„åˆ’ä»»åŠ¡ã€çº¦æŸæ¡ä»¶æ”¹å˜ã€æ‰§è¡Œå®Œæ¯•ã€å»¶æ—¶æ‰§è¡Œã€åœæ­¢æ‰§è¡Œâ€¦]</strong> çš„äº‹ä»¶ï¼Œå¯è§†ä½œçŠ¶æ€æ¨¡å¼ã€‚</p>
<p><strong><span id="processCommand"> å¦‚ä½•å¤„ç½®å‘½ä»¤ (processCommand)</strong></p>
<p>SystemAlarmService ä¸»è¦é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemAlarmService</span> <span class="keyword">extends</span> <span class="title">LifecycleService</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">SystemAlarmDispatcher</span>.<span class="title">CommandsCompletedListener</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        <span class="comment">// onCreateæ—¶æ‰§è¡ŒinitializeDispatcher()åˆå§‹åŒ–å¹¶ç»‘å®šé—¹é’Ÿäº‹ä»¶è°ƒåº¦å™¨</span></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        <span class="comment">// æ·»åŠ è°ƒåº¦äº‹ä»¶,è‹¥å½“å‰æ— ä»»åŠ¡åˆ™ç«‹å³è°ƒåº¦</span></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mDispatcher.add(intent, startId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæœåŠ¡å´©æºƒï¼Œæˆ‘ä»¬å¸Œæœ›æ‰€æœ‰æœªç¡®è®¤çš„æ„å›¾éƒ½å¾—åˆ°é‡æ–°äº¤ä»˜ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> Service.START_REDELIVER_INTENT;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°, æ­¤æœåŠ¡åœ¨åˆ›å»ºæ—¶åˆå§‹åŒ–å¹¶ç»‘å®šé—¹é’Ÿäº‹ä»¶è°ƒåº¦å™¨,å½“æœåŠ¡è¢«startæ—¶,è‹¥æœ‰intentäº‹ä»¶,åˆ™å°†intentä¼ é€’ç»™è°ƒåº¦å™¨. è°ƒåº¦å™¨æ”¶åˆ°intentåæ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Intent intent, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    assertMainThread();</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// ä¿è¯å‘½ä»¤åˆ—è¡¨å®‰å…¨,åªè¿›æˆ–åªå‡º</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mIntents) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasCommands = !mIntents.isEmpty();</span><br><span class="line">        mIntents.add(intent);</span><br><span class="line">        <span class="keyword">if</span> (!hasCommands) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªå‘½ä»¤åˆ™æ‰§è¡Œ</span></span><br><span class="line">            <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹,è‹¥ä¸Šä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¼šè¢«ç§»é™¤</span></span><br><span class="line">            processCommand();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“é—¹é’Ÿè°ƒåº¦å™¨æ”¶åˆ°æ–°å‘½ä»¤,ä¼šå°†æ–°å‘½ä»¤æ”¾å…¥å‘½ä»¤é›†åˆï¼Œè‹¥æ–°å‘½ä»¤ä¸ºé›†åˆä¸­ç¬¬ä¸€ä¸ªå‘½ä»¤åˆ™ç›´æ¥è¿›å…¥æ‰§è¡Œå‘½ä»¤é€»è¾‘ä¸­ï¼Œå¦åˆ™ä¸å¤„ç†ï¼Œå‰ä¸€å‘½ä»¤æ‰§è¡Œå®Œæ¯•åå†æ¬¡è°ƒç”¨æ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    mWorkManager.getWorkTaskExecutor().executeOnBackgroundThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">     <span class="keyword">try</span> &#123;   </span><br><span class="line">        <span class="comment">// è‹¥å½“å‰å‘½ä»¤ä¸ä¸ºç©ºï¼Œåˆ™å°†å‘½ä»¤äº¤ç»™çŠ¶æ€æœºæ‰§è¡Œ</span></span><br><span class="line">        mCommandHandler.onHandleIntent(mCurrentIntent, startId, SystemAlarmDispatcher.<span class="keyword">this</span>);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;&#125;</span><br><span class="line">     <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å½“å‰å‘½ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œå›è°ƒSystemAlarmDispatcherå¤„ç†å‘½ä»¤é›†ä»¥åŠåç»­æ“ä½œ</span></span><br><span class="line">        postOnMainThread( <span class="keyword">new</span> DequeueAndCheckForCompletion(SystemAlarmDispatcher.<span class="keyword">this</span>));</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“<code>processCommand</code>è¢«è°ƒç”¨ï¼Œå°†å¼€å¯æ–°çš„çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼Œä¸»è¦å¹²äº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>å°†å‘½ä»¤äº¤ç»™CommandHandleråˆ†å‘[è§„åˆ’ä»»åŠ¡ã€é‡æ–°è§„åˆ’ä»»åŠ¡ã€çº¦æŸæ¡ä»¶æ”¹å˜ã€æ‰§è¡Œå®Œæ¯•â€¦]äº‹ä»¶</li>
<li>å°†äº‹ä»¶å¤„ç†å®Œæ¯•å›è°ƒåˆ°é—¹é’Ÿäº‹ä»¶è°ƒåº¦å™¨ï¼Œç”±è°ƒåº¦å™¨å¤„ç†åç»­äº‹å®œã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥ä¾æ¬¡è·Ÿè¿›è¿™ä¸¤ä»¶äº‹ï¼š</p>
<p><strong><span id="CommandHandler"> CommandHandlerå¦‚ä½•åˆ†å‘å‘½ä»¤</strong></p>
<p>æˆ‘ä»¬å‰é¢çœ‹åˆ°<code>processCommand</code>ä¸­è°ƒç”¨<code>CommandHandler</code>åˆ†å‘å‘½ä»¤ï¼Œå…¶ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(<span class="meta">@NonNull</span> Intent intent,<span class="keyword">int</span> startId, <span class="meta">@NonNull</span> SystemAlarmDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String action = intent.getAction();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ACTION_CONSTRAINTS_CHANGED.equals(action)) &#123;</span><br><span class="line">        <span class="comment">// çº¦æŸæ¡ä»¶æ”¹å˜</span></span><br><span class="line">        handleConstraintsChanged(intent, startId, dispatcher);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_RESCHEDULE.equals(action)) &#123;</span><br><span class="line">        <span class="comment">// å¼‚å¸¸ä¸­æ–­ï¼Œéœ€é‡æ–°è§„åˆ’</span></span><br><span class="line">        handleReschedule(intent, startId, dispatcher);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Bundle extras = intent.getExtras();</span><br><span class="line">        <span class="keyword">if</span> (!hasKeys(extras, KEY_WORKSPEC_ID)) &#123;</span><br><span class="line">            <span class="comment">// log error</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ACTION_SCHEDULE_WORK.equals(action)) &#123;</span><br><span class="line">                <span class="comment">// è§„åˆ’ä»»åŠ¡</span></span><br><span class="line">                handleScheduleWorkIntent(intent, startId, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_DELAY_MET.equals(action)) &#123;</span><br><span class="line">                <span class="comment">// æ—¶å»¶åˆ°ç‚¹</span></span><br><span class="line">                handleDelayMet(intent, startId, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_STOP_WORK.equals(action)) &#123;</span><br><span class="line">                <span class="comment">// å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">                handleStopWork(intent, dispatcher);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_EXECUTION_COMPLETED.equals(action)) &#123;</span><br><span class="line">                <span class="comment">// å®Œæˆä»»åŠ¡</span></span><br><span class="line">                handleExecutionCompleted(intent, startId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// log error</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œä¸»è¦ä¾æ®å‘½ä»¤(intent)çš„actionæ‰§è¡Œå‘½ä»¤åˆ†å‘æ“ä½œï¼Œæ­¤å¤„æˆ‘ä»¬ä¸»è¦å…³æ³¨<code>handleDelayMet</code> æ—¶å»¶ç»“æŸåï¼Œå¤„ç†ä»»åŠ¡çš„ä¸»çº¿ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleDelayMet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> SystemAlarmDispatcher dispatcher)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Bundle extras = intent.getExtras();</span><br><span class="line">    <span class="comment">// ä¿è¯ä»»åŠ¡å¤„ç†çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        String workSpecId = extras.getString(KEY_WORKSPEC_ID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to see if we are already handling an ACTION_DELAY_MET for the WorkSpec.</span></span><br><span class="line">        <span class="comment">// If we are, then there is nothing for us to do.</span></span><br><span class="line">        <span class="comment">// æ£€æŸ¥è¯¥ä»»åŠ¡æ˜¯å¦å·²ç»åœ¨å³å°†æ‰§è¡Œé˜Ÿä¼(map)ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ä¸å†é‡å¤æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (!mPendingDelayMet.containsKey(workSpecId)) &#123;</span><br><span class="line">            DelayMetCommandHandler delayMetCommandHandler = <span class="keyword">new</span> DelayMetCommandHandler(mContext, startId, workSpecId, dispatcher);</span><br><span class="line">            <span class="comment">// å°†ä»»åŠ¡æ”¾å…¥å³å°†æ‰§è¡Œé˜Ÿä¼(map)ä¸­</span></span><br><span class="line">            mPendingDelayMet.put(workSpecId, delayMetCommandHandler);</span><br><span class="line">            <span class="comment">// å¤„ç†ä»»åŠ¡</span></span><br><span class="line">            delayMetCommandHandler.handleProcessWork();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// log error</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>CommandHandler</code>ä¸­ç»´æŠ¤äº†ä¸€ä¸ª mPendingDelayMetçš„Mapæ¥ä¿è¯å•æ¬¡ä»»åŠ¡ä¸è¢«å¤šæ¬¡å¤„ç†ï¼Œè‹¥å‘½ä»¤æœªè¢«å¤„ç†è¿‡ï¼Œåˆ™å°†å…¶åŠ å…¥åˆ°é˜Ÿä¼ä¸­ï¼Œç„¶åè°ƒç”¨<code>delayMetCommandHandler.handleProcessWork()</code>å»å¤„ç†ä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleProcessWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºWakeLocks</span></span><br><span class="line">    mWakeLock = WakeLocks.newWakeLock(...);</span><br><span class="line">    <span class="comment">// è·å–WorkSpec</span></span><br><span class="line">    WorkSpec workSpec = mDispatcher.getWorkManager().getWorkDatabase().workSpecDao().getWorkSpec(mWorkSpecId);</span><br><span class="line">    <span class="comment">// å¤„ç†é€šå¸¸ä¸ä¼šå‘ç”Ÿçš„æƒ…å†µ - æœªè·å–åˆ°WorkSpecã€‚</span></span><br><span class="line">    <span class="comment">// å–æ¶ˆå·¥ä½œåº”è¯¥åˆ é™¤alarmï¼Œä½†æ˜¯å¦‚æœalarmå·²ç»è§¦å‘ï¼Œé‚£ä¹ˆå°±è§¦å‘ä¸€ä¸ªstop workè¯·æ±‚æ¥åˆ é™¤æŒ‚èµ·çš„delay metå‘½ä»¤å¤„ç†ç¨‹åºã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (workSpec == <span class="keyword">null</span>) &#123;</span><br><span class="line">        stopWork();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·Ÿè¸ªå·¥ä½œä»»åŠ¡æ˜¯å¦æœ‰çº¦æŸ</span></span><br><span class="line">    mHasConstraints = workSpec.hasConstraints();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mHasConstraints) &#123;</span><br><span class="line">        <span class="comment">// è‹¥æ— çº¦æŸ</span></span><br><span class="line">        onAllConstraintsMet(Collections.singletonList(mWorkSpecId));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…è®¸è·Ÿè¸ªå™¨æŠ¥å‘Šçº¦æŸæ›´æ”¹</span></span><br><span class="line">        <span class="comment">// æ­¤å¤„å¯è§ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¶å»¶è§†ä½œä¸€ç§ç‰¹æ®Šçš„çº¦æŸ</span></span><br><span class="line">        mWorkConstraintsTracker.replace(Collections.singletonList(workSpec));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ¤æ–­äº†ä»»åŠ¡çŠ¶æ€åŠçº¦æŸçŠ¶æ€ï¼Œä¾æ®çº¦æŸçŠ¶æ€æ‰§è¡Œä»»åŠ¡æˆ–æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œ<br>æ‰§è¡Œä»»åŠ¡æ—¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onAllConstraintsMet(@NonNull List&lt;String&gt; workSpecIds) &#123;</span><br><span class="line">    &#x2F;&#x2F; ä¿è¯ä»»åŠ¡æ­£ç¡®    </span><br><span class="line">    if (!workSpecIds.contains(mWorkSpecId)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ä¿è¯æ‰§è¡Œå®‰å…¨</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        if (mCurrentState &#x3D;&#x3D; STATE_INITIAL) &#123;</span><br><span class="line">            &#x2F;&#x2F; æ›´æ”¹çŠ¶æ€</span><br><span class="line">            mCurrentState &#x3D; STATE_START_REQUESTED;</span><br><span class="line">            &#x2F;&#x2F; startWork &#x3D;&gt; doWork</span><br><span class="line">            &#x2F;&#x2F;è¿™é‡Œæ²¡æœ‰ä½¿ç”¨WorkManagerImpl#startWork()ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çŸ¥é“å¤„ç†å™¨æ˜¯å¦åœ¨è¿™é‡Œå°†å·¥ä½œæ’é˜Ÿ</span><br><span class="line">            boolean isEnqueued &#x3D; mDispatcher.getProcessor().startWork(mWorkSpecId);</span><br><span class="line">            &#x2F;&#x2F; è‹¥ä»»åŠ¡çŠ¶æ€æ˜¯è½®è¯¢</span><br><span class="line">            if (isEnqueued) &#123;</span><br><span class="line">               &#x2F;&#x2F; è®¾ç½®è®¡æ—¶å™¨ä»¥å¼ºåˆ¶å·²è¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡é…é¢</span><br><span class="line">                mDispatcher.getWorkTimer()</span><br><span class="line">                        .startTimer(mWorkSpecId, WORK_PROCESSING_TIME_IN_MS, this);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; æ‰§è¡Œå®Œæ¯•æˆ–å–æ¶ˆï¼Œåˆ™æ¸…é™¤çŠ¶æ€</span><br><span class="line">                cleanUp();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Logger.get().debug(TAG, String.format(&quot;Already started work for %s&quot;, mWorkSpecId));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ€ç»ˆæ”¹å˜ä»»åŠ¡çŠ¶æ€å¹¶è°ƒç”¨<code>Processor.startWork()</code>æ‰§è¡Œä»»åŠ¡ï¼Œæˆ‘ä»¬å°†å…³æ³¨<code>Processor.startWork()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆæ‰§è¡Œåˆ°æˆ‘ä»¬å®šä¹‰çš„Workerä¸­<code>doWork()</code>æ–¹æ³•ï¼Œå¹¶ä¸”å‰é¢è¯´åˆ°çš„WorkManagerä¸­è´Ÿè´£ä»»åŠ¡æ‰§è¡Œçš„Serviceä»¬æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°<code>Processor.startWork()</code>ã€‚</p>
<p>ç”±äºå†…å®¹æµç¨‹è¾ƒé•¿ä¸”å±äºå…¬å…±æµç¨‹ï¼Œå…³äº<code>Processor.startWork()</code>å°†å•ç‹¬æ•´ç†æœªä¸€å°èŠ‚ï¼Œ<a href="https://tinlone.com/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%94)%20-%20Processor/">ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹</a>ã€‚</p>
<p><strong><span id="DequeueAndCheckForCompletion"> DequeueAndCheckForCompletionå¦‚ä½•å®Œæˆå›è°ƒ</strong></p>
<p><code>DequeueAndCheckForCompletion</code> æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œ<code>postOnMainThread</code>æ—¶è°ƒç”¨runï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDispatcher.dequeueAndCheckForCompletion();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå›è°ƒåˆ°<code>dequeueAndCheckForCompletion</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void dequeueAndCheckForCompletion() &#123;</span><br><span class="line">   &#x2F;&#x2F; ä¿è¯mIntentså‘½ä»¤é›†åªè¿›æˆ–åªå‡º</span><br><span class="line">    synchronized (mIntents) &#123;</span><br><span class="line">        if (mCurrentIntent !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; ä»å‘½ä»¤é›†ä¸­ç§»é™¤å·²å®Œæˆï¼ˆç¬¬ä¸€ä¸ªï¼‰å‘½ä»¤</span><br><span class="line">            if (!mIntents.remove(0).equals(mCurrentIntent)) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;something&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentIntent &#x3D; null;</span><br><span class="line">        &#125;</span><br><span class="line">        SerialExecutor serialExecutor &#x3D; mTaskExecutor.getBackgroundExecutor();</span><br><span class="line">        &#x2F;&#x2F; è‹¥æ— é¢„è®¡æ‰§è¡Œå’Œå¾…æ‰§è¡Œå‘½ä»¤ï¼Œåˆ™é€šçŸ¥SystemAlarmServiceæ‰§è¡Œå®Œæ¯•</span><br><span class="line">        if (!mCommandHandler.hasPendingCommands()</span><br><span class="line">                &amp;&amp; mIntents.isEmpty()</span><br><span class="line">                &amp;&amp; !serialExecutor.hasPendingTasks()) &#123;</span><br><span class="line">            if (mCompletedListener !&#x3D; null) &#123;</span><br><span class="line">                mCompletedListener.onAllCommandsCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (!mIntents.isEmpty()) &#123;</span><br><span class="line">           &#x2F;&#x2F; è‹¥å‘½ä»¤é›†ä¸­è¿˜æœ‰æœªæ‰§è¡Œçš„å‘½ä»¤ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ</span><br><span class="line">            processCommand();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œè‹¥å½“å‰å‘½ä»¤å­˜åœ¨ï¼Œåˆ™ä»å‘½ä»¤é›†ä¸­ç§»é™¤å½“å‰å‘½ä»¤ã€‚è‹¥æ— é¢„è®¡æ‰§è¡Œå’Œå¾…æ‰§è¡Œå‘½ä»¤ï¼Œåˆ™è°ƒç”¨<code>mCompletedListener.onAllCommandsCompleted()</code>é€šçŸ¥SystemAlarmServiceæ‰§è¡Œå®Œæ¯•ï¼›è‹¥å‘½ä»¤é›†åˆä¸­è¿˜æœ‰æœªæ‰§è¡Œå‘½ä»¤ï¼Œåˆ™è°ƒç”¨<code>processCommand()</code>ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è€Œ<code>SystemAlarmService.onAllCommandsCompleted()</code>æœ€ç»ˆä¼šæ‰§è¡Œ<code>stopSelf()</code>åœæ­¢æœåŠ¡</p>
<p>å‡è£…ä¸‹é¢æ˜¯æ—¶åºå›¾ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SystemAlarmService.java</span><br><span class="line">|- initializeDispatcher(); <span class="comment">// åˆå§‹åŒ–å¹¶ç»‘å®šé—¹é’Ÿè°ƒåº¦å™¨</span></span><br><span class="line">|- SystemAlarmService.onStartCommand()  <span class="comment">// é€šè¿‡startServiceæ·»åŠ å‘½ä»¤</span></span><br><span class="line">    |- SystemAlarmDispatcher.add()				<span class="comment">// å§”æ‰˜è°ƒåº¦å™¨æ·»åŠ å‘½ä»¤</span></span><br><span class="line">        |- mIntents.add(intent);    <span class="comment">// æ·»åŠ å‘½ä»¤è¿›å…¥å‘½ä»¤é›†</span></span><br><span class="line">        |- SystemAlarmDispatcher.processCommand()			<span class="comment">// è‹¥æ˜¯ç¬¬ä¸€ä¸ªåˆ™,æ‰§è¡Œå‘½ä»¤, è‹¥ä¸æ˜¯ç¬¬ä¸€ä¸ª,å°†åœ¨åç»­æµç¨‹ä¸­ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">            |- <span class="keyword">try</span> CommandHandler.onHandleIntent()</span><br><span class="line">                |- ACTION_CONSTRAINTS_CHANGED</span><br><span class="line">                |- ...</span><br><span class="line">                |- ACTION_DELAY_MET</span><br><span class="line">                    |- delayMetCommandHandler.handleProcessWork()</span><br><span class="line">                        |- onAllConstraintsMet()</span><br><span class="line">                            |- mDispatcher.getProcessor().startWork()</span><br><span class="line">            |- <span class="function"><span class="keyword">finally</span> <span class="title">postOnMainThread</span><span class="params">( new DequeueAndCheckForCompletion(SystemAlarmDispatcher.<span class="keyword">this</span>)</span>)<span class="comment">// åˆ†å‘å®Œæˆå‘½ä»¤äº‹ä»¶</span></span></span><br><span class="line"><span class="function">				|- SystemAlarmDispatcher.<span class="title">dequeueAndCheckForCompletion</span><span class="params">()</span>  <span class="comment">// å›è°ƒ</span></span></span><br><span class="line"><span class="function">					|- mIntents.<span class="title">remove</span><span class="params">(<span class="number">0</span>)</span></span>;					   <span class="comment">// ä»å‘½ä»¤é›†ç§»å‡º(å½“å‰)ç¬¬ä¸€ä¸ªå‘½ä»¤</span></span><br><span class="line">					|- CommandsCompletedListener.onAllCommandsCompleted() </span><br><span class="line">					    OR SystemAlarmDispatcher.processCommand()  <span class="comment">// å‘½ä»¤é›†æ‰§è¡Œå®Œæ¯• æˆ– æ‰§è¡Œä¸‹ä¸€ä¸ªå‘½ä»¤</span></span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(äºŒ) - WorkManagerInitializer</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%8C)%20-%20WorkManagerInitializer/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#part_source">æºç ç¯‡</a><ul>
<li><a href="#AndroidManifest">2.1 AndroidManifest</a><ul>
<li><a href="#WorkManagerInitializer">2.1.1 WorkManagerInitializer</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="æºç ç¯‡"><a href="#æºç ç¯‡" class="headerlink" title=" æºç ç¯‡"></a><span id="part_source"> æºç ç¯‡</h3><p>ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ç®€å•ä½¿ç”¨äº†WorkManagerçš„ä¸€èˆ¬åŠŸèƒ½ï¼ŒåŸºç¡€ä½¿ç”¨è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚<strong>â€œWorkManager æ˜¯ä¸€ä¸ª APIï¼Œå¯ä¾›æ‚¨è½»æ¾è°ƒåº¦é‚£äº›å³ä½¿åœ¨é€€å‡ºåº”ç”¨æˆ–é‡å¯è®¾å¤‡åä»åº”è¿è¡Œçš„å¯å»¶æœŸå¼‚æ­¥ä»»åŠ¡â€</strong>ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä»–åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„å§ã€‚</p>
<a id="more"></a>

<h4 id="2-1-AndroidManifest"><a href="#2-1-AndroidManifest" class="headerlink" title=" 2.1 AndroidManifest"></a><span id="AndroidManifest"> 2.1 AndroidManifest</h4><p>ç§‰æ‰¿çœ‹ä¸‰æ–¹åº“æºç çš„ä¸€èˆ¬ä¹ æƒ¯ï¼Œå…ˆä»AndroidManifest.xmlæ–‡ä»¶çœ‹èµ·ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€èˆ¬çš„ï¼Œæƒ³è¦äº†è§£ä¸€ä¸ªåº“çš„ä¸»è¦ç»„æˆå°±è¦æƒ³äº†è§£ä¸€ä¸ªAppä¸€æ ·é¦–å…ˆè¦äº†è§£å®ƒæœ‰å“ªäº›ç»„ä»¶æ„æˆï¼Œè€Œ<strong>åº“çš„AndroidManifestæ–‡ä»¶ä¸€èˆ¬éƒ½ä¼šåˆå¹¶è‡³åº”ç”¨AndroidManifest.xmlä¸­</strong>ï¼Œä¸”ä¸€èˆ¬çš„éœ€è¦åˆå§‹åŒ–çš„åº“ï¼Œå¸¸è§„çš„åˆå§‹åŒ–æ–¹æ¡ˆæ˜¯<strong>ä½¿ç”¨ContentProviderå°½æ—©åœ°åˆå§‹åŒ–ä¸”å‡å°‘ä»£ç ä¾µå…¥</strong>ï¼Œå¯¹è¿™ç§æ–¹å¼ä¸äº†è§£çš„ï¼Œè¯·å‚è§<a href="https://blog.csdn.net/a1018875550/article/details/102760643">Android-ä½¿ç”¨ContentProvideræ¥åˆå§‹åŒ–ä½ çš„sdk</a>ç³»åˆ—æ–‡ç« ã€‚</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹work-runtimeåº“çš„AndroidManifest.xmlæœ‰å“ªäº›ç„æœºã€‚</p>
<p>work-runtimeåº“çš„AndroidManifest.xmlæˆ‘ä»¬å¯ä»¥åœ¨AndroidStudioçš„ <strong>Projectçª—å£ä¸­External Libraries</strong>æ ç›®ä¸­æŸ¥æ‰¾â€work-runtimeâ€å³å¯çœ‹åˆ°WorkManagerçš„aaråŒ…ç»“æ„å’Œå†…å®¹ã€‚æ‰“å¼€AndroidManefest.xmlæˆ‘ä»¬å‘ç°ä»¥ä¸‹é‡è¦ç»„ä»¶ï¼š</p>
<ul>
<li><strong><provider></strong> <code>androidx.work.impl.WorkManagerInitializer</code></li>
<li><strong><service></strong> <code>androidx.work.impl.background.systemalarm.SystemAlarmService</code></li>
<li><strong><service></strong> <code>androidx.work.impl.background.systemjob.SystemJobService</code></li>
<li><strong><service></strong> <code>androidx.work.impl.foreground.SystemForegroundService</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.utils.ForceStopRunnable$BroadcastReceiver</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.ConstraintProxy$BatteryChargingProxy</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.ConstraintProxy$BatteryNotLowProxy</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.ConstraintProxy$StorageNotLowProxy</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.ConstraintProxy$NetworkStateProxy</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.RescheduleReceiver</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.background.systemalarm.ConstraintProxyUpdateReceiver</code></li>
<li><strong><receiver></strong> <code>androidx.work.impl.diagnostics.DiagnosticsReceiver</code></li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å¤§èƒ†çŒœæµ‹ï¼š <em>WorkManagerä½¿ç”¨ContentProvider <code>WorkManagerInitializer</code>æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ, é€šè¿‡Serviceç®¡ç†ä»»åŠ¡æ‰§è¡ŒåŠçŠ¶æ€ï¼Œé€šè¿‡BroadcastReceiveræŒæ¡ä»»åŠ¡æ‰§è¡Œæ—¶æœºå’Œæ¡ä»¶ã€‚</em></p>
<p><strong><span id="WorkManagerInitializer"> WorkManagerInitializer</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The &#123;<span class="doctag">@link</span> ContentProvider&#125; responsible for initializing &#123;<span class="doctag">@link</span> WorkManagerImpl&#125;.</span></span><br><span class="line"><span class="comment"> * // æœºç¿»ï¼šè´Ÿè´£åˆå§‹åŒ–&#123;<span class="doctag">@link</span> WorkManagerImpl&#125;çš„&#123;<span class="doctag">@link</span> ContentProvider&#125;ã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span>  // éšè—APIï¼Œå¯¹è°ƒç”¨è€…ä¸å¯è§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkManagerInitializer</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Initialize WorkManager with the default configuration.</span></span><br><span class="line">        <span class="comment">// æœºç¿»ï¼šä½¿ç”¨é»˜è®¤é…ç½®åˆå§‹åŒ–WorkManagerã€‚</span></span><br><span class="line">        WorkManager.initialize(getContext(), <span class="keyword">new</span> Configuration.Builder().build());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–æ— å…³ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WorkManager.initialize -&gt; WorkManagerImpl.initialize</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;@link WorkManagerImpl#initialize&#125;</span></span><br><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@NonNull</span> Configuration configuration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (sLock) &#123;</span><br><span class="line">     <span class="comment">// ... é‡å¤åˆ›å»ºæ£€æŸ¥ï¼Œè‹¥è¢«å¤šæ¬¡è°ƒç”¨æ­¤åˆ›å»ºæ–¹æ³•åˆ™æŠ›é”™WorkManager is already initialized.</span></span><br><span class="line">        <span class="keyword">if</span> (sDelegatedInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            context = context.getApplicationContext();</span><br><span class="line">            <span class="keyword">if</span> (sDefaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sDefaultInstance = <span class="keyword">new</span> WorkManagerImpl(</span><br><span class="line">                        context, configuration,</span><br><span class="line">                        <span class="keyword">new</span> WorkManagerTaskExecutor(configuration.getTaskExecutor()));</span><br><span class="line">            &#125;</span><br><span class="line">            sDelegatedInstance = sDefaultInstance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­<code>configuration.getTaskExecutor()</code>æœ€ç»ˆè°ƒç”¨æ–¹æ³•ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="meta">@NonNull</span> <span class="function">Executor <span class="title">createDefaultExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Executors.newFixedThreadPool(</span><br><span class="line">            <span class="comment">// This value is the same as the core pool size for AsyncTask#THREAD_POOL_EXECUTOR.</span></span><br><span class="line">            <span class="comment">// æœºç¿»ï¼šè¿™ä¸ªå€¼ä¸AsyncTask#THREAD_POOL_EXECUTORçš„æ ¸å¿ƒæ± å¤§å°ç›¸åŒã€‚</span></span><br><span class="line">            Math.max(<span class="number">2</span>, Math.min(Runtime.getRuntime().availableProcessors() - <span class="number">1</span>, <span class="number">4</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤‡æ³¨ï¼šä¸€èˆ¬åœ°ï¼ŒAsyncTaské‡Œçº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ºCPU + 1ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºCPU * 2 + 1</p>
<p>çºµè§‚ä»£ç ï¼Œæˆ‘ä»¬å‘ç°WorkManagerInitializerå°±æ˜¯ä¸€ä¸ªè´Ÿè´£åˆå§‹åŒ–WorkManagerçš„ContentProviderï¼ŒèŒè´£å•ä¸€ï¼Œç®€å•æ˜äº†ã€‚<br><code>WorkManager.initialize()</code>æœ€ç»ˆä½¿ç”¨ContentProviderä¸Šä¸‹æ–‡å¯¹è±¡contextã€é»˜è®¤configurationåŠçº¿ç¨‹æ± å®¹é‡ä¸AsyncTaskæ ¸å¿ƒçº¿ç¨‹æ•°ä¸€è‡´çš„Executoråˆ›å»ºäº†WorkManagerImplå•ä¾‹å®ä¾‹ã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(äº”) - Processor</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%94)%20-%20Processor/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#part_source">æºç ç¯‡</a><ul>
<li><a href="#Processor">Processor</a></li>
</ul>
</li>
</ul>
<hr>
<h3 id="æºç ç¯‡"><a href="#æºç ç¯‡" class="headerlink" title=" æºç ç¯‡"></a><span id="part_source"> æºç ç¯‡</h3><p>å‰é¢ä»work-runtimeåº“çš„AndroidManifest.xmlä¸­äº†è§£åˆ°ï¼ŒWorkManagerå·¥ä½œä¸»è¦é€šè¿‡ContentProviderã€Serviceã€BroadcastReceiverååŒå·¥ä½œï¼Œè€Œå…³æ³¨å‡ ä¸ªä¸»è¦Serviceå·¥ä½œæµç¨‹å‘ç°ï¼Œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œåˆ°<code>Processor.startWork()</code>æ–¹æ³•ï¼Œæ­¤ç¯‡å°†é‡ç‚¹å…³æ³¨<code>Processor.startWork()</code>æ˜¯ä½•æ–¹ç¥åœ£ã€‚</p>
<a id="more"></a>
<p>é¦–å…ˆæˆ‘ä»¬ç®€å•è¿‡ä¸€ä¸‹<code> mWorkManagerImpl.getProcessor().startWork(mWorkSpecId, mRuntimeExtras)</code>çš„ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public boolean startWork(@NonNull String id,  @Nullable WorkerParameters.RuntimeExtras runtimeExtras) &#123;</span><br><span class="line">    WorkerWrapper workWrapper;</span><br><span class="line">    &#x2F;&#x2F; ä¿è¯ä»»åŠ¡é˜Ÿåˆ—(MAP)åªè¿›æˆ–åªå‡º</span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        &#x2F;&#x2F; doing éªŒè¯idä¸åœ¨é˜Ÿåˆ—ä¸­</span><br><span class="line">        &#x2F;&#x2F; åˆå§‹åŒ–WorkerWrapper</span><br><span class="line">        workWrapper &#x3D; new WorkerWrapper.Builder(...).build();</span><br><span class="line">        ListenableFuture&lt;Boolean&gt; future &#x3D; workWrapper.getFuture();</span><br><span class="line">        &#x2F;&#x2F; ä¸ºæ‰§è¡Œç»“æœæ·»åŠ ç›‘å¬ï¼Œæ³¨æ„è¿™é‡Œç›‘å¬å›è°ƒä½•æ—¶è°ƒç”¨åé¢ä¼šè¯´æ˜</span><br><span class="line">        &#x2F;&#x2F; ç‰¹åˆ«æ³¨æ„ï¼šfuture.addListenerä¸­ FutureListener æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡</span><br><span class="line">        &#x2F;&#x2F; ç‰¹åˆ«æ³¨æ„ï¼š FutureListener æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡</span><br><span class="line">        future.addListener(</span><br><span class="line">                new FutureListener(this, id, future),</span><br><span class="line">                mWorkTaskExecutor.getMainThreadExecutor());</span><br><span class="line">        &#x2F;&#x2F; å°†æ­¤ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—</span><br><span class="line">        mEnqueuedWorkMap.put(id, workWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; ä½¿ç”¨å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span><br><span class="line">    mWorkTaskExecutor.getBackgroundExecutor().execute(workWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code> mWorkManagerImpl.getProcessor().startWork(mWorkSpecId, mRuntimeExtras)</code>ä¸»è¦åšäº†ä¸‰ä¸ªæ“ä½œï¼š</p>
<ul>
<li>å°†ä»»åŠ¡è¦ç´ å°è£…ä¸ºWorkerWrapperå¹¶ä¸ºå…¶æ‰§è¡ŒæœŸæœ›æ·»åŠ ç›‘å¬</li>
<li>ä»»åŠ¡è¦ç´ å…¥é˜Ÿ</li>
<li>å·¥ä½œçº¿ç¨‹æ‰§è¡Œå¤„ç†ä»»åŠ¡</li>
</ul>
<p>ç›¸å¯¹ä¸»è¦çš„ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›å·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡æµç¨‹<code>execute(Runnable)</code>, excuteå°†WorkerWrapperç»§ç»­å°è£…ä¸ºTaskå¹¶åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œè‹¥å½“å‰æ— æ´»è·ƒTaskåˆ™å®‰æ’ä»»åŠ¡æ‰§è¡Œï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•åç»§ç»­æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç›´åˆ°ä»»åŠ¡é˜Ÿåˆ—ç©ºç½®ä¸ºæ­¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="meta">@NonNull</span> Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿è¯ä»»åŠ¡é˜Ÿåˆ—åªè¿›æˆ–åªå‡º</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// å°è£…ä»»åŠ¡å¹¶å…¥é˜Ÿ</span></span><br><span class="line">        mTasks.add(<span class="keyword">new</span> Task(<span class="keyword">this</span>, command));</span><br><span class="line">        <span class="comment">// è‹¥æ— æ´»è·ƒä»»åŠ¡ï¼Œåˆ™å°è¯•å®‰æ’ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (mActive == <span class="keyword">null</span>) &#123;</span><br><span class="line">            scheduleNext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Synthetic access</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿è¯ä»»åŠ¡é˜Ÿåˆ—åªè¿›æˆ–åªå‡º</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// æœ‰ä»»åŠ¡ä¸”ä»»åŠ¡å‡ºé˜Ÿ</span></span><br><span class="line">        <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            mExecutor.execute(mActive);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mExecutor.execute(mActive)</code>ä¼šé€šè¿‡Taskæ‰§è¡Œ<code>execute(Runnable)</code>ä¼ å…¥çš„Runnableï¼Œå³æ‰§è¡Œ<code>WorkerWrapper</code>ï¼ˆè¿™é‡Œæœ‰ç‚¹ç»•ï¼Œå¯ä»¥å¤šçœ‹ä¸¤é~ï¼‰ï¼ŒTaskä¸è®ºWorkerWrapperæ‰§è¡Œç»“æœæœ€ç»ˆä¼šç»§ç»­è½®è¯¢ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ­¤å¤„ä¸èµ˜è¿°ï¼‰ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°†ç›®å…‰ç§»åˆ°<code>WorkerWrapper.run()</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@WorkerThread</span><br><span class="line">@Override</span><br><span class="line">public void run() &#123;</span><br><span class="line">    mTags &#x3D; mWorkTagDao.getTagsForWorkSpecId(mWorkSpecId);</span><br><span class="line">    mWorkDescription &#x3D; createWorkDescription(mTags);</span><br><span class="line">    runWorker();</span><br><span class="line">&#125;</span><br><span class="line">private void runWorker() &#123;</span><br><span class="line">&#x2F;&#x2F; å„ä¸ªçŠ¶æ€åˆ¤æ–­æœ€ç»ˆè°ƒç”¨åˆ°resolve(false);</span><br><span class="line">resolve(true); &#x2F;&#x2F; OR resolve(false);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; å°è¯•å°†å·¥ä½œè®¾ç½®ä¸ºè¿è¡ŒçŠ¶æ€ã€‚æ³¨æ„ï¼Œè¿™å¯èƒ½ä¼šå¤±è´¥ï¼Œå› ä¸ºè‡ªä»ä¸Šæ¬¡åœ¨è¿™ä¸ªå‡½æ•°çš„é¡¶éƒ¨æ£€æŸ¥ä¹‹åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å·²ç»ä¿®æ”¹äº†æ•°æ®åº“ã€‚</span><br><span class="line">if (trySetRunning()) &#123;</span><br><span class="line">    if (tryCheckForInterruptionAndResolve()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final SettableFuture&lt;ListenableWorker.Result&gt; future &#x3D; SettableFuture.create();</span><br><span class="line">    &#x2F;&#x2F; Call mWorker.startWork() on the main thread.</span><br><span class="line">    mWorkTaskExecutor.getMainThreadExecutor()</span><br><span class="line">            .execute(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        &#x2F;&#x2F; è°ƒç”¨Workeræ‰§è¡Œå·¥ä½œä»»åŠ¡</span><br><span class="line">                        mInnerFuture &#x3D; mWorker.startWork();</span><br><span class="line">                        &#x2F;&#x2F; å°†ä»»åŠ¡ç»“æœå›è°ƒæ·»åŠ åˆ°æœŸæœ›å›è°ƒä¸­</span><br><span class="line">                        future.setFuture(mInnerFuture);</span><br><span class="line">                    &#125; catch (Throwable e) &#123;</span><br><span class="line">                        future.setException(e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Avoid synthetic accessors.</span><br><span class="line">    final String workDescription &#x3D; mWorkDescription;</span><br><span class="line">    future.addListener(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        @SuppressLint(&quot;SyntheticAccessor&quot;)</span><br><span class="line">        public void run() &#123;</span><br><span class="line">           &#x2F;&#x2F; æœ€ç»ˆè°ƒç”¨åˆ°resolve(false);</span><br><span class="line">           resolve(false);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, mWorkTaskExecutor.getBackgroundExecutor());</span><br><span class="line">&#125; else &#123;</span><br><span class="line">     &#x2F;&#x2F; æœ€ç»ˆè°ƒç”¨åˆ°resolve(false);</span><br><span class="line">     resolve(boolean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void resolve(final boolean needsReschedule) &#123;</span><br><span class="line">    &#x2F;&#x2F; æ•°æ®åº“äº‹åŠ¡æ“ä½œ</span><br><span class="line">    </span><br><span class="line">    mFuture.set(needsReschedule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>runWorker()</code> ä¸­åŒ…å«å„ç§ä»»åŠ¡çŠ¶æ€çš„åˆ¤æ–­ï¼Œå¹¶å°è¯•å°†ä»»åŠ¡ç½®ä¸ºè¿è¡ŒçŠ¶æ€ï¼Œè‹¥è®¾ç½®è¿è¡ŒçŠ¶æ€æˆåŠŸï¼Œåˆ™è°ƒç”¨<code>Worker.startWork()</code> å³æœ€ç»ˆä¼šèµ°å‘ä¸ªäººå®šä¹‰çš„Workerçš„<code>doWork()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public final @NonNull ListenableFuture&lt;Result&gt; startWork() &#123;</span><br><span class="line">        mFuture &#x3D; SettableFuture.create();</span><br><span class="line">        getBackgroundExecutor().execute(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Result result &#x3D; doWork();</span><br><span class="line">                    mFuture.set(result);</span><br><span class="line">                &#125; catch (Throwable throwable) &#123;</span><br><span class="line">                    mFuture.setException(throwable);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return mFuture;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åç»­è·Ÿè¿›<code>resolve</code>, æ­¤æ–¹æ³•é™¤äº†æ•°æ®åº“ç›¸å…³æ“ä½œï¼ˆæ›´æ–°WorkerçŠ¶æ€ï¼‰å¤–ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ<code>mFuture.set(needsReschedule)</code>ï¼Œå³ç›®æ ‡æœŸæœ›å›è°ƒã€‚</p>
<p>åœ¨è·Ÿè¿›ç»•æ¥ç»•å»çš„<code>mFuture.set(needsReschedule)</code>ä¹‹å‰ï¼Œå…ˆå›æƒ³ä¸€ä¸‹ï¼Œè¿˜è®°å¾—<code>WorkManagerImpl.startWork</code>ä»£ç ç‰‡æ®µé‡Œçš„åˆå§‹åŒ–ä»£ç æ®µï¼Œfuture.addListenerä¸­ FutureListener æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œè€ŒaddListenerå…¥å‚æœ€ç»ˆä¼šè¢«å°è£…åˆ°<code>AbstractFuture.Listener</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„Runnable taskå®é™…ä¸ºFutureListener</span></span><br><span class="line">Listener(Runnable task, Executor executor) &#123;</span><br><span class="line">    <span class="keyword">this</span>.task = task;</span><br><span class="line">    <span class="keyword">this</span>.executor = executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ‡å›æ­£é¢˜ï¼Œç»§ç»­è·Ÿè¿›<code>mFuture.set(needsReschedule)</code>ï¼Œæ­¤å¤„set(boolean)æœ€ç»ˆä¼šè°ƒç”¨<code>AbstractFuture.set()</code>,ç»§è€Œè°ƒç”¨<code>AbstractFuture.complete</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(<span class="meta">@Nullable</span> V value)</span> </span>&#123;</span><br><span class="line">    Object valueToSet = value == <span class="keyword">null</span> ? NULL : value;</span><br><span class="line">    <span class="keyword">if</span> (ATOMIC_HELPER.casValue(<span class="keyword">this</span>, <span class="keyword">null</span>, valueToSet)) &#123;</span><br><span class="line">        complete(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AbstractFuture.complete</code>ä¼šéå†æœŸæœ›å›è°ƒç»“åˆï¼Œæ‰¾å‡ºå…¶ä¸­ä»£è¡¨æ‰§è¡Œç»“æœå›è°ƒçš„é¡¹å¹¶æ‰§è¡ŒRunnableå›è°ƒå°è£…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static void complete(AbstractFuture&lt;?&gt; future) &#123;</span><br><span class="line">	Listener next &#x3D; null;</span><br><span class="line">	outer:</span><br><span class="line">	while (true) &#123;</span><br><span class="line">		future.releaseWaiters();</span><br><span class="line">		future.afterDone();</span><br><span class="line">		next &#x3D; future.clearListeners(next);</span><br><span class="line">		future &#x3D; null;</span><br><span class="line">		while (next !&#x3D; null) &#123;</span><br><span class="line">			Listener curr &#x3D; next;</span><br><span class="line">			next &#x3D; next.next;</span><br><span class="line">			Runnable task &#x3D; curr.task;</span><br><span class="line">			if (task instanceof SetFuture) &#123;</span><br><span class="line">			    &#x2F;&#x2F; do something</span><br><span class="line">			    continue outer;</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">			    &#x2F;&#x2F; æ‰§è¡ŒRunnableå›è°ƒå°è£…</span><br><span class="line">				executeListener(task, curr.executor);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>executeListener(task, curr.executor)</code>ä¸­çš„taskå‚æ•°å³åœ¨Processorä¸­å°è£…<code>WorkWrapper</code>æ—¶çš„<code>FutureListener</code>å‚æ•°ï¼Œå³æ­¤å¤„æœ€ç»ˆä¼šæ‰§è¡Œ<code>FutureListener.run()</code>æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨<code>mExecutionListener.onExecuted(mWorkSpecId, needsReschedule)</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureListener</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> needsReschedule;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            needsReschedule = mFuture.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            <span class="comment">// Should never really happen(?)</span></span><br><span class="line">            needsReschedule = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mExecutionListener.onExecuted(mWorkSpecId, needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å›æƒ³ä¸€ä¸‹<code>Processor.startWork()</code>ä¸­å…³äºè®¾ç½®futureListenerçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">future.addListener(</span><br><span class="line">        <span class="keyword">new</span> FutureListener(<span class="keyword">this</span>, id, future),</span><br><span class="line">        mWorkTaskExecutor.getMainThreadExecutor());</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„FutureListenerä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ExecutionListeneræ˜¯â€œthisâ€ï¼Œå³ä¼šè°ƒç”¨<code>ExecutionListener.onExecuted()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExecuted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@NonNull</span> <span class="keyword">final</span> String workSpecId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mEnqueuedWorkMap.remove(workSpecId);</span><br><span class="line">        <span class="comment">// mOuterListenersæ¥è‡ªå“ªé‡Œï¼Œè¿˜è®°å¾—æœ¬èŠ‚SystemJobServiceæœ€å¼€å§‹éœ€è¦è®°ä½çš„addExecutionListenerå—ï¼Œæ²¡é”™ï¼Œå°±æ˜¯è¿™é‡Œã€‚</span></span><br><span class="line">        <span class="keyword">for</span> (ExecutionListener executionListener : mOuterListeners) &#123;</span><br><span class="line">            executionListener.onExecuted(workSpecId, needsReschedule);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹<code>mOuterListeners</code>èµ‹å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addExecutionListener</span><span class="params">(<span class="meta">@NonNull</span> ExecutionListener executionListener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        mOuterListeners.add(executionListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å—¨ï¼Œè·‘äº†ä¸€åœˆï¼Œæˆ‘ä»¬åˆå›æ¥äº†ï¼Œå³ä¸Šé¢<code>onExecuted</code>ä¸­éå†æ‰§è¡Œçš„<code>executionListener.onExecuted(workSpecId, needsReschedule)</code>ï¼Œ<br>ä»¥SystemJobServiceä¸ºä¾‹ï¼Œä¼šè°ƒç”¨<code>SystemJobService.onExecuted()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExecuted</span><span class="params">(<span class="meta">@NonNull</span> String workSpecId, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    Logger.get().debug(TAG, String.format(<span class="string">&quot;%s executed on JobScheduler&quot;</span>, workSpecId));</span><br><span class="line">    JobParameters parameters;</span><br><span class="line">    <span class="keyword">synchronized</span> (mJobParameters) &#123;</span><br><span class="line">        parameters = mJobParameters.remove(workSpecId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">        jobFinished(parameters, needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œä»XXXServiceè°ƒç”¨SystemXXXServiceæ‰§è¡Œä»»åŠ¡åˆ°æœ€ç»ˆä»»åŠ¡ç»“æŸåŠå›è°ƒæµç¨‹å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„é“¾ã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>æ€§èƒ½ä¼˜åŒ–ä¹‹å†…å­˜ä¼˜åŒ–</title>
    <url>/2021/04/04/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h3 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h3><p>JAVAæ˜¯åœ¨JVMæ‰€è™šæ‹Ÿå‡ºçš„å†…å­˜ç¯å¢ƒä¸­è¿è¡Œçš„ï¼ŒJVMçš„å†…å­˜å¯åˆ†ä¸ºä¸‰ä¸ªåŒºï¼š</p>
<p>å †(heap)ã€æ ˆ(stack)å’Œæ–¹æ³•åŒº(method)ã€‚</p>
<p>æ ˆ(stack)</p>
<p>æ˜¯ç®€å•çš„æ•°æ®ç»“æ„ï¼Œä½†åœ¨è®¡ç®—æœºä¸­ä½¿ç”¨å¹¿æ³›ã€‚æ ˆæœ€æ˜¾è‘—çš„ç‰¹å¾æ˜¯ï¼šLIFO(Last In, First Out, åè¿›å…ˆå‡º),æ ˆä¸­åªå­˜æ”¾åŸºæœ¬ç±»å‹å’Œå¯¹è±¡çš„å¼•ç”¨</p>
<p>å †(heap)</p>
<p>å †å†…å­˜ç”¨äºå­˜æ”¾ç”±newåˆ›å»ºçš„å¯¹è±¡å’Œæ•°ç»„ã€‚åœ¨å †ä¸­åˆ†é…çš„å†…å­˜ï¼Œç”±javaè™šæ‹Ÿæœºè‡ªåŠ¨åƒåœ¾å›æ”¶å™¨æ¥ç®¡ç†ã€‚JVMåªæœ‰ä¸€ä¸ªå †åŒº(heap)è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå †ä¸­ä¸å­˜æ”¾åŸºæœ¬ç±»å‹å’Œå¯¹è±¡å¼•ç”¨ï¼Œåªå­˜æ”¾å¯¹è±¡æœ¬èº«ã€‚</p>
<p>æ–¹æ³•åŒº(method)</p>
<p>åˆå«é™æ€åŒºï¼Œè·Ÿå †ä¸€æ ·ï¼Œè¢«æ‰€æœ‰çš„çº¿ç¨‹å…±äº«ã€‚æ–¹æ³•åŒºåŒ…å«æ‰€æœ‰çš„classå’Œstaticå˜é‡</p>
<a id="more"></a>

<h3 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h3><p>æ˜¯æŒ‡ç¨‹åºä¸­å·±åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œå¯¼è‡´ä¸€ç›´å æ®è¯¥å†…å­˜å•å…ƒï¼Œç›´è‡³ç¨‹åºç»“æŸï¼Œéƒ½æ— æ³•å†ä½¿ç”¨è¯¥å†…å­˜å•å…ƒã€‚</p>
<h4 id="å†…å­˜æ³„æ¼å¸¸è§åŸå› "><a href="#å†…å­˜æ³„æ¼å¸¸è§åŸå› " class="headerlink" title="å†…å­˜æ³„æ¼å¸¸è§åŸå› "></a>å†…å­˜æ³„æ¼å¸¸è§åŸå› </h4><p><strong>1. Contextçš„ä¸å½“å¼•ç”¨</strong></p>
<p>å½“æŒæœ‰Contextçš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿æ—¶ï¼ŒæŒæœ‰çš„Contextå³ä½¿è¢«é”€æ¯ä¹Ÿä¸ä¼šè¢«å›æ”¶æ‰ã€‚</p>
<ul>
<li>å•ä¾‹å¯¹è±¡ç›´æ¥æˆ–é—´æ¥æŒæœ‰Contextï¼š</li>
</ul>
<pre><code>å•ä¾‹ç›´æ¥æŒæœ‰Activityå¯¹è±¡ï¼Œæˆ–é€šè¿‡æŒæœ‰Fragmentã€Viewç­‰é—´æ¥æŒæœ‰Contextå¯¹è±¡ã€‚
</code></pre>
<ul>
<li><p>Activity/Fragmentä¸­çš„éé™æ€å†…éƒ¨ç±»ã€åŒ¿åå†…éƒ¨ç±»</p>
<p>  Activityä¸­ä½¿ç”¨éé™æ€å†…éƒ¨ç±»/åŒ¿åå†…éƒ¨ç±»ï¼Œå¦‚HandleråŠå„ç±»äº‹ä»¶ç›‘å¬ã€‚å½“å†…éƒ¨ç±»ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿(è€—æ—¶)æ—¶ï¼Œè‹¥Activityè¢«é”€æ¯ï¼Œæ˜“é€ æˆå†…å­˜æ³„æ¼æˆ–å´©æºƒã€‚</p>
</li>
<li><p>å¤šçº¿ç¨‹å¼‚æ­¥å›è°ƒï¼ˆå´©æºƒï¼‰</p>
<p>  å­çº¿ç¨‹æ‰§è¡Œåå›è°ƒä¸»çº¿ç¨‹æ–¹æ³•ï¼Œè‹¥æŒæœ‰ä¸»çº¿ç¨‹Handleræˆ–Contextï¼Œå½“Activityé”€æ¯ï¼Œæ­¤æ—¶æ˜“å‡ºç°å†…å­˜æ³„æ¼æˆ–å´©æºƒã€‚ </p>
</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>éå¿…è¦æƒ…å†µä¸‹ï¼Œä¸å»ºè®®è¿™æ ·ç¼–ç¨‹ï¼›</li>
<li>å•ä¾‹ç”Ÿå‘½å‘¨æœŸæ•æ„Ÿä¸”ä¸æŒæœ‰ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„Contextå¯¹è±¡å¼ºå¼•ç”¨ï¼šè‹¥éœ€ä½¿ç”¨Activityå¯¹è±¡ï¼Œåº”å¯¹Activityåšå¼±å¼•ç”¨å°è£…ï¼Œä¸”åº”æä¾›è§£é™¤å¼•ç”¨çš„æ–¹æ³•ï¼Œåœ¨Activityé”€æ¯æ—¶è§£é™¤å¼•ç”¨ï¼›å¿…é¡»æŒæœ‰contextçš„ï¼Œèƒ½ä½¿ç”¨ApplicationContextåˆ™å°½é‡ä½¿ç”¨Applicationï¼›</li>
<li>å¯¹äºHandlerï¼Œå»ºè®®ä¸ä½¿ç”¨åŒ¿åå£°æ˜çš„æ–¹å¼åˆ›å»ºï¼Œåœ¨Activityé”€æ¯æ—¶è°ƒç”¨Handler.removeCallbackï¼Œè§£é™¤å¯¹Activityçš„å¼•ç”¨ï¼›</li>
<li>ä½¿ç”¨å†…éƒ¨ç±»çš„æƒ…å†µï¼Œå¯ä½¿ç”¨é™æ€å†…éƒ¨ç±»ï¼Œéœ€æŒæœ‰Activityçš„åº”å¯¹Activityåšå¼±å¼•ç”¨å°è£…</li>
<li>å¯¹äºå†…éƒ¨ç±»æˆ–çº¿ç¨‹æ“ä½œè€—æ—¶/å¼‚æ­¥çš„æƒ…å†µï¼Œåœ¨Activityé”€æ¯æ—¶åº”é€šçŸ¥å¯¹åº”å†…éƒ¨ç±»è§£é™¤å¯¹Activityçš„å¼•ç”¨ï¼Œæ¸…ç†æœªæ‰§è¡Œå®Œæ¯•çš„çº¿ç¨‹ã€‚</li>
</ul>
<p><strong>2. èµ„æºæœªå›æ”¶</strong></p>
<ul>
<li><p>bind/unbindã€register/unregisterã€start/stopã€run/cancel </p>
<p>  åœ¨ä¸€äº›ç»„ä»¶ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œåº”æ³¨æ„å…¶ç»‘å®šå’Œè§£ç»‘ã€æ‰§è¡Œå’Œå–æ¶ˆç­‰æ“ä½œåº”æˆå¯¹å­˜åœ¨ï¼Œå¦åˆ™è‹¥å…¶æŒæœ‰Activityçš„å¼•ç”¨ï¼Œå°†ä¼šåœ¨Activityè¢«é”€æ¯æ—¶äº§ç”Ÿå†…å­˜æ³„æ¼æˆ–å´©æºƒï¼Œå¦‚å±æ€§åŠ¨ç”»ã€å¹¿æ’­ã€bindæœåŠ¡ç­‰ã€‚</p>
</li>
<li><p>Closeableå¯¹è±¡æœªè°ƒç”¨close()</p>
<p>  IOæµ/æ•°æ®åº“æ¸¸æ ‡cursoråº”åœ¨ä½¿ç”¨å®Œæ¯•åè°ƒç”¨close()æ–¹æ³•ï¼Œå³ä½¿å®ƒæ‰§è¡Œå¤±è´¥/é”™è¯¯ä¹Ÿåº”è°ƒç”¨å…³é—­ï¼Œå¦åˆ™å°†é€ æˆå†…å­˜æ³„æ¼ç”šè‡³å´©æºƒã€‚</p>
</li>
<li><p>bitmap</p>
<p>  bitmapèµ„æºåœ¨ä½¿ç”¨å®Œæˆåï¼Œæœªä¸»åŠ¨è°ƒç”¨recycle()å¹¶ç½®ç©ºï¼Œåœ¨ç³»ç»Ÿæœªä¸»åŠ¨å›æ”¶æ—¶ä¼šé€ æˆå¤§é‡å†…å­˜å ç”¨ã€‚</p>
</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å¯¹äºç»„ä»¶çš„ä½¿ç”¨ï¼Œåº”æ³¨æ„è§„èŒƒï¼ŒActivityé”€æ¯æ—¶åŠæ—¶é‡Šæ”¾èµ„æºï¼šä¾‹å¦‚EventBus.getDefault().register()/unregister()ï¼›   ButterKnife.bind(this)/unbind()ï¼› bindService()/unbindService()ç­‰ï¼›</li>
<li>Closeableå¯¹è±¡åœ¨ä½¿ç”¨å®Œæ¯•ååº”åŠæ—¶è°ƒç”¨close()ï¼›å¯ä½¿ç”¨ <code>try(IOå¯¹è±¡)</code>çš„æ–¹å¼é¿å…é—å¿˜ï¼›ç‰¹åˆ«çš„å¯¹äºå…·æœ‰ç¼“å­˜(Flushable)åŠŸèƒ½çš„æµï¼Œåº”æ³¨æ„è°ƒç”¨flush()ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼›</li>
<li>bitmapèµ„æºåœ¨ä½¿ç”¨å®Œæˆåï¼Œä¸»åŠ¨è°ƒç”¨recycle()å¹¶ç½®ç©º</li>
</ul>
<p><strong>3. åˆ›å»º/ä¿å­˜å¤§é‡å¯¹è±¡</strong></p>
<ul>
<li><p>é¢‘ç¹è°ƒç”¨çš„æ–¹æ³•ä¸­åˆ›å»ºå¯¹è±¡ï¼Œä¾‹å¦‚onDraw()ã€onResume()</p>
<p>  åœ¨é¢‘ç¹è°ƒç”¨çš„æ–¹æ³•ä¸­åˆ›å»ºå¯¹è±¡ï¼ˆå³ä½¿æ˜¯å±€éƒ¨å˜é‡ï¼‰ï¼Œä¼šå¯¼è‡´ä¸€å®šæ—¶é—´å†…ï¼Œå†…å­˜å †ç§¯ï¼Œè‹¥GCå›æ”¶ä¸åŠæ—¶ä¼šå ç”¨å¤§é‡å†…å­˜ç©ºé—´ï¼Œè‹¥GCé¢‘ç¹å›æ”¶åˆ™ä¼šäº§ç”Ÿå†…å­˜æŠ–åŠ¨ï¼Œå¯¼è‡´å¡é¡¿ã€‚</p>
</li>
<li><p>å£°æ˜çš„å…¨å±€Listæˆ–Mapï¼ˆåªè¿›ä¸å‡º/æœªåŠæ—¶æ¸…ç†ï¼‰</p>
<p>  å…¨å±€å£°æ˜çš„Listæˆ–Mapï¼Œè‹¥å­˜æ”¾å¤§é‡å¯¹è±¡ä¸”å¯¹è±¡ä¸å¸¸ä½¿ç”¨ï¼Œå°†å ç”¨å¤§é‡å†…å­˜ä¸”æ— æ³•å›æ”¶ã€‚    </p>
</li>
<li><p>æœªåŠæ—¶æ¸…ç†çš„ç¼“å­˜å¯¹è±¡</p>
<p>  åœ¨ç”¨æˆ·ä½“éªŒä¼˜åŒ–ä¸Šæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ç¼“å­˜æå‡åŠ è½½é€Ÿåº¦ï¼Œè‹¥ç¼“å­˜å¹¶éç»å¸¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œå°†ä¼šç™½ç™½å ç”¨å†…å­˜ç©ºé—´ã€‚</p>
</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å°½é‡é¿å…åœ¨é¢‘ç¹è°ƒç”¨çš„æ–¹æ³•ä¸­åˆ›å»ºå¯¹è±¡ï¼Œå¿…è¦æƒ…å†µä¸‹ä½¿ç”¨äº«å…ƒæ¨¡å¼ï¼Œæ§åˆ¶å¯¹è±¡ç”Ÿæˆæ•°é‡ï¼›</li>
<li>å…¨å±€Listå’ŒMapç­‰é›†åˆå®¹å™¨ï¼Œä¸ä½¿ç”¨çš„å…ƒç´ åº”åŠæ—¶ç§»é™¤ï¼›</li>
<li>ç¼“å­˜åº”æ ¹æ®è®¾å¤‡å†…å­˜çŠ¶å†µè®¾ç½®æœ€å¤§å­˜å‚¨å®¹é‡ï¼Œå¹¶å»ºç«‹LRUç­‰ç¼“å­˜æœºåˆ¶ï¼Œåœ¨ä¿è¯ä½“éªŒçš„æƒ…å†µä¸‹æœ€å¤§ç¨‹åº¦ä¼˜åŒ–å†…å­˜ï¼›</li>
</ul>
<p><strong>4. WebViewã€MapView</strong></p>
<p>åŸç”ŸWebViewå­˜åœ¨å·²çŸ¥çš„å†…å­˜æ³„æ¼é£é™©ï¼Œé’ˆå¯¹è¿™ç±»æ€§èƒ½æ¶ˆè€—è¾ƒå¤§çš„ç»„ä»¶ï¼ˆæ§ä»¶ï¼‰ï¼Œè‹¥æœªå¤„ç†å¥½å…¶å†…å­˜é—®é¢˜ï¼Œå°†ä¼šæ˜¯åº”ç”¨å†…å­˜ç®¡ç†çš„ç¾éš¾ã€‚</p>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å¯¹äºWebViewã€MapViewç­‰ï¼Œåº”ä¸»åŠ¨ç®¡ç†å…¶åˆ›å»º/é”€æ¯/å›æ”¶æµç¨‹ï¼Œè®©å†…å­˜å°½å¿«çš„é‡Šæ”¾å‡ºæ¥ï¼›</li>
<li>æœ‰æ¡ä»¶çš„ï¼Œå¯ä»¥ä¸ºå…¶ç”³è¯·å•ç‹¬çš„è¿›ç¨‹ï¼Œæå‡ä¸»è¿›ç¨‹çš„ç¨³å®šæ€§ï¼Œå‡å°ä¸»è¿›ç¨‹çš„å†…å­˜å‹åŠ›ï¼›</li>
</ul>
<h3 id="å†…å­˜æº¢å‡º"><a href="#å†…å­˜æº¢å‡º" class="headerlink" title="å†…å­˜æº¢å‡º"></a>å†…å­˜æº¢å‡º</h3><p>ç³»ç»Ÿä¼šç»™æ¯ä¸ªAPPåˆ†é…å†…å­˜ä¹Ÿå°±æ˜¯Heap Sizeå€¼ã€‚å½“APPå ç”¨çš„å†…å­˜åŠ ä¸Šæˆ‘ä»¬ç”³è¯·çš„å†…å­˜èµ„æºè¶…è¿‡äº†Dalvikè™šæ‹Ÿæœºçš„æœ€å¤§å†…å­˜æ—¶å°±ä¼šæŠ›å‡ºçš„Out Of Memoryå¼‚å¸¸ã€‚</p>
<ul>
<li>java.lang.OutOfMemoryError:Javaheapspaceï¼šå †å†…å­˜ä¸å¤Ÿæˆ–ç¨‹åºä¸­æœ‰æ­»å¾ªç¯</li>
<li>java.lang.OutOfMemoryError:GCoverheadlimitexceededï¼šå½“GCä¸ºé‡Šæ”¾å¾ˆå°ç©ºé—´å ç”¨å¤§é‡æ—¶é—´æ—¶æŠ›å‡ºï¼›å †å¤ªå°ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜</li>
<li>java.lang.OutOfMemoryError:PermGenspaceï¼šPåŒºå†…å­˜ä¸å¤Ÿ</li>
<li>java.lang.OutOfMemoryError:Directbuffermemoryï¼šDirectbufferå†…å­˜ä¸è¶³</li>
<li>java.lang.OutOfMemoryError:unabletocreatenewnativethreadï¼šStackç©ºé—´ä¸è¶³ä»¥åˆ›å»ºé¢å¤–çš„çº¿ç¨‹ï¼Œåˆ›å»ºçš„çº¿ç¨‹è¿‡å¤šæˆ–Stackç©ºé—´å¤ªå°</li>
<li>java.lang.StackOverflowErrorï¼šçº¿ç¨‹æ ˆçš„æº¢å‡ºï¼Œæ–¹æ³•è°ƒç”¨å±‚æ¬¡è¿‡å¤šæˆ–çº¿ç¨‹æ ˆå¤ªå°ã€‚</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å¯¹äºå¯åŠ¨å‚æ•°å†…å­˜å€¼è®¾å®šçš„è¿‡å°çš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ä¿®æ”¹å¯åŠ¨å‚æ•°çš„æ–¹æ³•è§£å†³ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-Xms3062m &#x2F;&#x2F; æå‡å †å†…å­˜</span><br><span class="line">-XX:-UseGCOverheadLimit &#x2F;&#x2F; é™åˆ¶ä½¿ç”¨å†…å­˜</span><br><span class="line">&#x2F;&#x2F; JVMçš„PermåŒºä¸»è¦ç”¨äºå­˜æ”¾Classå’ŒMetaä¿¡æ¯çš„,Classåœ¨è¢«Loaderæ—¶å°±ä¼šè¢«æ”¾åˆ°PermGenspaceï¼Œè¿™ä¸ªåŒºåŸŸæˆä¸ºå¹´è€ä»£ï¼ŒGCåœ¨ä¸»ç¨‹åºè¿è¡ŒæœŸé—´ä¸ä¼šå¯¹å¹´è€åŒºè¿›è¡Œæ¸…ç†ï¼Œ</span><br><span class="line">&#x2F;&#x2F; é»˜è®¤æ˜¯64Må¤§å°ï¼Œå½“ç¨‹åºéœ€è¦åŠ è½½çš„å¯¹è±¡æ¯”è¾ƒå¤šæ—¶ï¼Œè¶…è¿‡64Må°±ä¼šæŠ¥è¿™éƒ¨åˆ†å†…å­˜æº¢å‡ºäº†ï¼Œéœ€è¦åŠ å¤§å†…å­˜åˆ†é…ï¼Œä¸€èˆ¬128mè¶³å¤Ÿ</span><br><span class="line">-XX:MaxPermSize&#x3D;128m</span><br><span class="line">-XXermSize&#x3D;128m</span><br><span class="line">-XX:MaxDirectMemorySize&#x3D;128m  &#x2F;&#x2F; è°ƒæ•´Directbufferå†…å­˜å¤§å°</span><br></pre></td></tr></table></figure>
<ul>
<li>æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦å­˜åœ¨æ­»å¾ªç¯æˆ–é€’å½’å±‚æ¬¡è¾ƒæ·±çš„åœºæ™¯ï¼Œä¿®å¤æˆ–ä¼˜åŒ–æ­¤ç±»ä»£ç ï¼›</li>
<li>ä¼˜åŒ–å†…å­˜ï¼Œå‡å°‘å†…å­˜æ³„æ¼ï¼Œä½¿å†…å­˜ä¿æŒåœ¨å¥åº·è‰¯å¥½çš„çŠ¶æ€ã€‚</li>
</ul>
<h3 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h3><p>å†…å­˜ä¼˜åŒ–ä¸»è¦ä»å‡å°‘å†…å­˜å ç”¨ã€æœç»å†…å­˜æ³„æ¼ã€æå‡åº”ç”¨å†…å­˜é™åˆ¶è¿™å‡ ä¸ªæ–¹é¢è€ƒé‡ï¼Œå†…å­˜ä¼˜åŒ–æ˜¯ä¸ªæ²¡æœ‰æ­¢å¢ƒçš„è¯é¢˜ï¼Œå½“ç„¶ä¸æ˜¯æœ€ä¼˜å°±æ˜¯æœ€å¥½çš„ï¼Œå®ƒéœ€è¦åœ¨å†…å­˜å’Œä½“éªŒä¸Šæ‰¾å¯»ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œå½“ç„¶ï¼Œå†…å­˜æ³„æ¼æ˜¯è¶Šå°‘è¶Šå¥½ã€‚</p>
<h4 id="å‡å°‘å†…å­˜å ç”¨"><a href="#å‡å°‘å†…å­˜å ç”¨" class="headerlink" title="å‡å°‘å†…å­˜å ç”¨"></a>å‡å°‘å†…å­˜å ç”¨</h4><ul>
<li><p><strong>å¯¹è±¡</strong></p>
<ul>
<li>é¿å…é‡å¤åˆ›å»ºå¯¹è±¡ï¼Œèƒ½ä½¿ç”¨å¯¹è±¡æ± çš„å°½é‡ä½¿ç”¨å¯¹è±¡æ± ï¼Œå¦‚Message.obtain()ï¼›</li>
<li>é¿å…é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œå¯¹äºé¢‘ç¹è°ƒç”¨çš„æ–¹æ³•ï¼Œå°½é‡ä¸åœ¨å…¶ä¸­åˆ›å»ºå¤§é‡å¯¹è±¡ï¼›</li>
<li>åŠæ—¶å›æ”¶å¯¹è±¡ï¼Œå¯¹äºä¸ä½¿ç”¨æˆ–ä¸é¢‘ç¹ä½¿ç”¨çš„å¯¹è±¡åº”ä¸»åŠ¨é‡Šæ”¾</li>
</ul>
</li>
<li><p><strong>èµ„æº</strong></p>
<ul>
<li>å¯¹äºBitmapï¼ŒåŠ è½½å‰åº”é’ˆå¯¹åœºæ™¯å¯¹å…¶è¿›è¡Œå°ºå¯¸å’Œæ•°æ®é•¿åº¦å‹ç¼©ï¼Œä½¿ç”¨ååº”åŠæ—¶é‡Šæ”¾ï¼›</li>
<li>å¯¹äºiconèµ„æºï¼Œåº”ä½¿ç”¨å¯¹åº”åˆ†è¾¨ç‡çš„åˆ‡å›¾ï¼Œé¿å…iconåŠ è½½æ—¶ç³»ç»Ÿç¼©æ”¾å ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´ï¼›</li>
<li>å¯¹äºæ–‡ä»¶æµå’Œæ¸¸æ ‡ï¼Œä½¿ç”¨å®Œæ¯•ååº”åŠæ—¶å…³é—­ï¼Œé¿å…IOå ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´ï¼›</li>
<li>çæƒœçº¿ç¨‹èµ„æºï¼Œä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹çš„åˆ›å»º</li>
</ul>
</li>
<li><p><strong>ç¼“å­˜</strong></p>
<ul>
<li>å¯¹äºå†…å­˜æ¶ˆè€—è¾ƒå¤§ä¸”ä¸å¸¸ä½¿ç”¨çš„æ•°æ®é¿å…å­˜å‚¨åœ¨å†…å­˜ä¸­</li>
<li>ç¼“å­˜åº”è€ƒè™‘è®¾å¤‡åŠåº”ç”¨çš„å†…å­˜é™åˆ¶ï¼Œè®¾å®šåˆç†çš„ç¼“å­˜å®¹é‡åŠç¼“å­˜ç­–ç•¥</li>
</ul>
</li>
</ul>
<h4 id="æœç»å†…å­˜æ³„æ¼"><a href="#æœç»å†…å­˜æ³„æ¼" class="headerlink" title="æœç»å†…å­˜æ³„æ¼"></a>æœç»å†…å­˜æ³„æ¼</h4><ul>
<li><p><strong>ç¼–ç è§„èŒƒ</strong></p>
<ul>
<li>ä¾ç…§å‰æ–‡å†…å­˜æ³„æ¼ç›¸å…³è¯´æ˜ï¼Œæ£€æŸ¥ä»£ç ï¼Œå‡å°‘å†…å­˜æ³„æ¼</li>
</ul>
</li>
<li><p><strong>æ£€æŸ¥å·¥å…·</strong></p>
<ul>
<li>dumpsys meminfo package_name|pid<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adb shell dumpsys meminfo com.company.project</span><br></pre></td></tr></table></figure></li>
<li>%AndroidSDK%\platform-tools\systrace\systrace.py</li>
</ul>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; æŒ‡å®šç‰ˆæœ¬python2.7</span><br><span class="line">&#x2F;&#x2F; -oï¼š æŒ‡å®šæ–‡ä»¶è¾“å‡ºä½ç½®å’Œæ–‡ä»¶å</span><br><span class="line">&#x2F;&#x2F; -tï¼š æŠ“å–systraceçš„æ—¶é—´é•¿åº¦</span><br><span class="line">&#x2F;&#x2F; -aï¼š æŒ‡å®šç‰¹æ®Šè¿›ç¨‹åŒ…å </span><br><span class="line">python %AndroidSDK%\platform-tools\systrace\systrace.py -a com.company.project -t 10 -o trace.html</span><br></pre></td></tr></table></figure>
<ul>
<li>LeakCanary</li>
<li>MATï¼ˆMemory Analyzer Toolï¼‰</li>
</ul>
</li>
</ul>
<h4 id="æå‡åº”ç”¨å†…å­˜é™åˆ¶"><a href="#æå‡åº”ç”¨å†…å­˜é™åˆ¶" class="headerlink" title="æå‡åº”ç”¨å†…å­˜é™åˆ¶"></a>æå‡åº”ç”¨å†…å­˜é™åˆ¶</h4><ul>
<li><p><strong>åˆ›å»ºå­è¿›ç¨‹</strong></p>
<p>  åˆ›å»ºå­è¿›ç¨‹çš„æ–¹æ³•ï¼šä½¿ç”¨android:processæ ‡ç­¾</p>
<p>  å¯ä»¥å°†å†…å­˜æ¶ˆè€—è¾ƒå¤§çš„æ¨¡å—æ”¾å…¥å­è¿›ç¨‹ä¸­æ‰§è¡Œï¼Œç³»ç»Ÿä¼šä¸ºå­è¿›ç¨‹åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œä»¥è¾¾åˆ°å‡å°ä¸»è¿›ç¨‹å†…å­˜æ¶ˆè€—åœ°ç›®çš„ï¼Œä¾‹å¦‚Webæ¨¡å—ã€mapæ¨¡å—ç­‰ã€‚</p>
<p>  å½“ç„¶ï¼Œè¿™æ ·åšçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼šåˆ›å»ºå­è¿›ç¨‹ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œè¿›ç¨‹é—´é€šä¿¡å¾€å¾€æ›´åŠ å¤æ‚ã€‚</p>
</li>
<li><p><strong>ä½¿ç”¨jniåœ¨native heapä¸Šç”³è¯·ç©ºé—´</strong></p>
<p>  nativeheapçš„å¢é•¿å¹¶ä¸å—dalvik vm heapsizeçš„é™åˆ¶ï¼Œnative heap sizeå¯ä»¥è¿œè¿œè¶…è¿‡dalvik heap sizeçš„é™åˆ¶ã€‚</p>
<p>  åªè¦RAMæœ‰å‰©ä½™ç©ºé—´ï¼Œç¨‹åºå‘˜å¯ä»¥ä¸€ç›´åœ¨native heapä¸Šç”³è¯·ç©ºé—´ï¼Œå½“ç„¶å¦‚æœ RAMå¿«è€—å°½ï¼Œmemory killerä¼šæ€è¿›ç¨‹é‡Šæ”¾RAMã€‚å¤§å®¶ä½¿ç”¨ä¸€äº›è½¯ä»¶æ—¶ï¼Œæœ‰æ—¶å€™ä¼šé—ªé€€ï¼Œå°±å¯èƒ½æ˜¯è½¯ä»¶åœ¨nativeå±‚ç”³è¯·äº†æ¯”è¾ƒå¤šçš„å†…å­˜å¯¼è‡´çš„ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ€§èƒ½ä¼˜åŒ–</category>
      </categories>
      <tags>
        <tag>å†…å­˜ä¼˜åŒ–</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(å…­) - SystemForegroundService</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E5%85%AD)%20-%20SystemForegroundService/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#part_source">æºç ç¯‡</a><ul>
<li><a href="#SystemForegroundService">SystemForegroundService</a></li>
</ul>
</li>
</ul>
<hr>
<h3 id="æºç ç¯‡"><a href="#æºç ç¯‡" class="headerlink" title=" æºç ç¯‡"></a><span id="part_source"> æºç ç¯‡</h3><p>ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬äº†è§£äº†WorkManagerä½¿ç”¨çš„çš„ä¸»è¦ç»„ä»¶ï¼ŒçŒœæµ‹äº†å„ä¸ªç»„ä»¶çš„ä½œç”¨ï¼Œå¹¶ç®€å•ä»‹ç»äº†WorkManageræ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚æœ¬ç¯‡å°†å»¶ç»­å‰æ–‡ï¼Œä»‹ç»WorkManagerä¸­Serviceç»„ä»¶ä¹‹ä¸€çš„SystemForegroundServiceã€‚</p>
<p><strong><span id="SystemForegroundService"> SystemForegroundService</strong></p>
<p>åœ¨çœ‹è¿‡å‰é¢<code>SystemAlarmService & SystenJobService</code> åï¼Œæˆ‘æœ¬ä»¥ä¸º<br><code>SystemForegroundService</code>ä¹Ÿå¦‚å‰è€…ä¸€èˆ¬æ˜¯å¤„ç†ä»»åŠ¡æ‰§è¡Œçš„ï¼Œä½†ç®€å•é˜…è¯»ä»£ç åå‘ç°å¹¶éå¦‚æ­¤ï¼Œå°½ç®¡ç»“æ„ä¸Šä¸å‰è€…ç±»ä¼¼ï¼Œä½†å…¶ä¸»è¦ä½œç”¨æ˜¯<strong>ç»™è¿è¡Œä»»åŠ¡çš„æœåŠ¡ææƒï¼Œä¿è¯å…¶åœ¨å‰å°æ‰§è¡Œ</strong>ã€‚</p>
<a id="more"></a>

<p> <code>SystemAlarmService & SystenJobService</code>ç›¸ä¼¼ï¼Œ<code>SystemForegroundService</code>ä¹Ÿæ˜¯<code>LifecycleService</code>çš„å­ç±»ï¼Œä¸»è¦æ–¹æ³•æœ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate();</span><br><span class="line">    sForegroundService = <span class="keyword">this</span>;</span><br><span class="line">    initializeDispatcher();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    <span class="comment">// è‹¥æ­£åœ¨è¢«å…³é—­ï¼Œåˆ™</span></span><br><span class="line">    <span class="keyword">if</span> (mIsShutdown) &#123;</span><br><span class="line">        <span class="comment">// ç»“æŸæ—§    Dispatcher çš„ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        mDispatcher.onDestroy();</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°çš„Dispatcherå¹¶è®¾ç½®æ–°çš„ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        initializeDispatcher();</span><br><span class="line">        mIsShutdown = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å‘Šè¯‰Dispatcher æœ‰æ´»å„¿æ¥äº†</span></span><br><span class="line">        mDispatcher.onStartCommand(intent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæœåŠ¡å´©æºƒï¼Œæˆ‘ä»¬å¸Œæœ›æ‰€æœ‰æœªç¡®è®¤çš„æ„å›¾éƒ½å¾—åˆ°é‡æ–°äº¤ä»˜ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> Service.START_REDELIVER_INTENT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeDispatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</span><br><span class="line">    mNotificationManager = (NotificationManager)</span><br><span class="line">            getApplicationContext().getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">    mDispatcher = <span class="keyword">new</span> SystemForegroundDispatcher(getApplicationContext());</span><br><span class="line">    mDispatcher.setCallback(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–æ—¶åˆ›å»ºæ–°çš„SystemForegroundDispatcherç»‘å®šå¹¶è®¾ç½®æ–°çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“æ”¶åˆ°æŒ‡ä»¤è¢«å¯åŠ¨æ—¶ï¼Œè°ƒç”¨<code>SystemForegroundDispatcher.onStartCommand()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SystemForegroundDispatcher#onStartCommand</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onStartCommand</span><span class="params">(<span class="meta">@NonNull</span> Intent intent)</span> </span>&#123;</span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">    <span class="keyword">if</span> (ACTION_START_FOREGROUND.equals(action)) &#123;</span><br><span class="line">        handleStartForeground(intent);</span><br><span class="line">        <span class="comment">// è°ƒç”¨handleNotify()ï¼Œå®ƒåè¿‡æ¥è°ƒç”¨startå‰å°()ä½œä¸ºå¤„ç†è¿™ä¸ªå‘½ä»¤çš„ä¸€éƒ¨åˆ†ã€‚è¿™å¯¹ä¸€äº›åŸå§‹è®¾å¤‡åˆ¶é€ å•†æ¥è¯´å¾ˆé‡è¦ã€‚</span></span><br><span class="line">        handleNotify(intent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_NOTIFY.equals(action)) &#123;</span><br><span class="line">        handleNotify(intent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ACTION_CANCEL_WORK.equals(action)) &#123;</span><br><span class="line">        handleCancelWork(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“intent (<em>æ­¤å¤„intentå¯è§†ä½œå‰é¢æåˆ°çš„SystemXXXServiceçš„æ„å›¾</em>) çŠ¶æ€å¤„äºå¯åŠ¨ã€æ›´æ–°çŠ¶æ€æ—¶ä¼šè°ƒç”¨<code>handleNotify(intent)</code>ï¼Œå–æ¶ˆæ—¶ä¼šè°ƒç”¨<code>handleCancelWork(intent)</code>,<br>çŠ¶æ€ä¸ºå–æ¶ˆæ—¶ï¼Œåˆ™æœ€ç»ˆä¼šè°ƒç”¨<code>mWorkManagerImpl.cancelWorkById(UUID.fromString(workSpecId))</code>å–æ¶ˆä»»åŠ¡æ‰§è¡Œã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹handleNotifyå¹²äº†å“ªäº›äº‹æƒ…å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SystemForegroundDispatcher#handleNotify</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleNotify</span><span class="params">(<span class="meta">@NonNull</span> Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> notificationId = intent.getIntExtra(KEY_NOTIFICATION_ID, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> notificationType = intent.getIntExtra(KEY_FOREGROUND_SERVICE_TYPE, <span class="number">0</span>);</span><br><span class="line">    String workSpecId = intent.getStringExtra(KEY_WORKSPEC_ID);</span><br><span class="line">    Notification notification = intent.getParcelableExtra(KEY_NOTIFICATION);</span><br><span class="line">    <span class="keyword">if</span> (notification != <span class="keyword">null</span> &amp;&amp; mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ForegroundInfo info = <span class="keyword">new</span> ForegroundInfo(</span><br><span class="line">                notificationId, notification, notificationType);</span><br><span class="line">        <span class="comment">// ç¼“å­˜ä¿¡æ¯</span></span><br><span class="line">        mForegroundInfoById.put(workSpecId, info);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mCurrentForegroundWorkSpecId)) &#123;</span><br><span class="line">            <span class="comment">// è¿™æ˜¯æ‹¥æœ‰å‰å°ç”Ÿå‘½å‘¨æœŸçš„å½“å‰workSpecId.</span></span><br><span class="line">            mCurrentForegroundWorkSpecId = workSpecId;</span><br><span class="line">            mCallback.startForeground(notificationId, notificationType, notification);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ›´æ–°é€šçŸ¥</span></span><br><span class="line">            mCallback.notify(notificationId, notification);</span><br><span class="line">            <span class="comment">// å¦‚æœ‰å¿…è¦ï¼Œæ›´æ–°å‰å°çš„é€šçŸ¥ï¼Œä½¿å…¶æˆä¸ºå½“å‰æ‰€æœ‰å‰å°æœåŠ¡ç±»å‹çš„è”åˆã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (notificationType != FOREGROUND_SERVICE_TYPE_NONE</span><br><span class="line">                    &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) &#123;</span><br><span class="line">                <span class="keyword">int</span> foregroundServiceType = FOREGROUND_SERVICE_TYPE_NONE;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, ForegroundInfo&gt; entry : mForegroundInfoById.entrySet()) &#123;</span><br><span class="line">                    ForegroundInfo foregroundInfo = entry.getValue();</span><br><span class="line">                    foregroundServiceType |= foregroundInfo.getForegroundServiceType();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ç¼“å­˜ä¸­å–å‡ºä¿¡æ¯</span></span><br><span class="line">                ForegroundInfo currentInfo = mForegroundInfoById.get(mCurrentForegroundWorkSpecId);</span><br><span class="line">                <span class="keyword">if</span> (currentInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mCallback.startForeground(</span><br><span class="line">                            currentInfo.getNotificationId(),</span><br><span class="line">                            foregroundServiceType,</span><br><span class="line">                            currentInfo.getNotification()</span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥å½“å‰æœåŠ¡intentæ˜¯é¦–ä¸ªï¼Œé‚£ä¹ˆå°±å¯åŠ¨<code>SystemForegroundService.startForeground()</code>åšå‘¨æœŸæ€§é€’å½’ï¼Œè€Œ<code>SystemForegroundService.startForeground()</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œç±»ä¼¼äºä½¿ç”¨äº†<code>Looper</code>ä¿è¯<code>SystemForegroundService</code>ä¸€ç›´è¿è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; SystemForegroundService#startForeground</span><br><span class="line">@Override</span><br><span class="line">public void startForeground(</span><br><span class="line">        final int notificationId,</span><br><span class="line">        final int notificationType,</span><br><span class="line">        @NonNull final Notification notification) &#123;</span><br><span class="line"></span><br><span class="line">    mHandler.post(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            if (Build.VERSION.SDK_INT &gt;&#x3D; Build.VERSION_CODES.Q) &#123;</span><br><span class="line">                startForeground(notificationId, notification, notificationType);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                startForeground(notificationId, notification);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥å½“å‰æœåŠ¡intentä¸æ˜¯é¦–ä¸ªï¼Œåˆ™æ›´æ–°ä¸€åˆ™é€šçŸ¥ï¼Œå¹¶åˆå¹¶å‰å°æœåŠ¡ç±»å‹ï¼Œ<code>mCallback.notify(notificationId, notification)</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SystemForegroundService#notify</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> notificationId, <span class="meta">@NonNull</span> <span class="keyword">final</span> Notification notification)</span> </span>&#123;</span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mNotificationManager.notify(notificationId, notification);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>SystemForegroundService</code>ä¼šåœ¨ä»»åŠ¡å¯åŠ¨æ—¶å¯åŠ¨ï¼Œä¸”ä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼äº<code>Looper</code>çš„ç»“æ„ä¿æŒæœåŠ¡å‰å°æŒç»­è¿è¡Œï¼Œåç»­æœ‰ä»»åŠ¡è§¦å‘æ—¶ï¼Œä¼šå‘é€notificationä»¥ä¿è¯å…¶æ‰§è¡Œä»»åŠ¡çš„æœåŠ¡å¯è¢«è§†ä½œå‰å°æœåŠ¡ä¿æŒè¿è¡Œã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(å››) - SystemJobService</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E5%9B%9B)%20-%20SystemJobService/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#part_source">æºç ç¯‡</a><ul>
<li><a href="#SystemJobService">SystemJobService</a></li>
</ul>
</li>
</ul>
<hr>
<h3 id="æºç ç¯‡"><a href="#æºç ç¯‡" class="headerlink" title=" æºç ç¯‡"></a><span id="part_source"> æºç ç¯‡</h3><p>ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ç®€å•ä½¿ç”¨äº†WorkManagerçš„ä¸€èˆ¬åŠŸèƒ½ï¼ŒåŸºç¡€ä½¿ç”¨è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚<strong>â€œWorkManager æ˜¯ä¸€ä¸ª APIï¼Œå¯ä¾›æ‚¨è½»æ¾è°ƒåº¦é‚£äº›å³ä½¿åœ¨é€€å‡ºåº”ç”¨æˆ–é‡å¯è®¾å¤‡åä»åº”è¿è¡Œçš„å¯å»¶æœŸå¼‚æ­¥ä»»åŠ¡â€</strong>ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä»–åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„å§ã€‚</p>
<p><strong><span id="SystemJobService"> SystemJobService</strong></p>
<blockquote>
<p>Service invoked by {@link android.app.job.JobScheduler} to run work tasks.</p>
</blockquote>
<p>æœåŠ¡å°†è¢«JobSchedulerè°ƒç”¨æ¥æ‰§è¡Œå·¥ä½œä»»åŠ¡ã€‚<br>ä»æè¿°å¯å¾—<code>SystemJobService</code>ä¸<code>SystemAlarmService</code>èŒè´£æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯â€œrun work tasksâ€ã€‚</p>
<a id="more"></a>

<p>ç±»ä¼¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹<code>SystemJobService</code>æ‰§è¡Œæµç¨‹å§‹äº<code>onStartJob</code>ç»ˆäº<code>onStopJob</code>ã€‚</p>
<p><code>SystemJobService.onCreate()</code>è·å–äº†<code>WorkManagerImpl</code>å®ä¾‹å¹¶å°†æ‰§è¡Œç›‘å¬ç»‘å®šåˆ°ï¼ˆä»»åŠ¡ï¼‰å¤„ç†å™¨Processorï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; è¿˜è®°å¾—WorkManagerImplæ˜¯å“ªé‡Œåˆå§‹åŒ–çš„å—ï¼Ÿ</span><br><span class="line">mWorkManagerImpl &#x3D; WorkManagerImpl.getInstance(getApplicationContext());</span><br><span class="line">&#x2F;&#x2F; è®°ä½æ­¤å¤„addExecutionListener</span><br><span class="line">&#x2F;&#x2F; è®°ä½æ­¤å¤„addExecutionListener</span><br><span class="line">&#x2F;&#x2F; è®°ä½æ­¤å¤„addExecutionListener</span><br><span class="line">mWorkManagerImpl.getProcessor().addExecutionListener(this);</span><br></pre></td></tr></table></figure>
<p>å½“SystemJobServiceè¢«è°ƒç”¨æ—¶ä¼šæ‰§è¡Œ<code>SystemJobService.onStartJob()</code>ï¼Œæ­¤æ—¶ä¼šå°†JobParametersä»¥workIdä¸ºKeyå­˜å…¥å·¥ä½œMapä¸­ï¼Œå¹¶åˆå§‹åŒ–<code>WorkerParameters.RuntimeExtras</code>, æœ€ç»ˆè°ƒç”¨<code>mWorkManagerImpl.startWork(workSpecId, runtimeExtras)</code>æ‰§è¡Œä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartJob</span><span class="params">(<span class="meta">@NonNull</span> JobParameters params)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// WorkManagerImpl NonNull</span></span><br><span class="line">    String workSpecId = getWorkSpecIdFromJobParameters(params);</span><br><span class="line">    <span class="comment">// workSpecId NonNull</span></span><br><span class="line">    <span class="comment">// ä¿è¯mJobParameters å·¥ä½œå‚æ•°é›†åªè¿›æˆ–åªå‡º</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mJobParameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mJobParameters.containsKey(workSpecId)) &#123;</span><br><span class="line">           <span class="comment">// log</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å­˜å…¥å·¥ä½œå‚æ•°</span></span><br><span class="line">        mJobParameters.put(workSpecId, params);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–WorkerParameters.RuntimeExtras</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// WorkManagerImplæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    mWorkManagerImpl.startWork(workSpecId, runtimeExtras);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WorkManagerImpl.startWork</code>åç»­ä¼šæ‰§è¡Œ<code> mWorkManagerImpl.getProcessor().startWork(mWorkSpecId, mRuntimeExtras)</code>ã€‚</p>
<p>ç”±äºå†…å®¹æµç¨‹è¾ƒé•¿ä¸”å±äºå…¬å…±æµç¨‹ï¼Œå…³äº<code>Processor.startWork()</code>å°†å•ç‹¬æ•´ç†æœªä¸€å°èŠ‚ï¼Œ<a href="./WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%BA%94)+-+Processor.md">ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹</a>ã€‚</p>
<p>ç”±<code>Processor.startWork()</code>ä¸­ä»£ç å¯çŸ¥ï¼Œæµç¨‹æœ«å°¾<code>onExecuted</code>ä¸­éå†æ‰§è¡Œçš„<code>executionListener.onExecuted(workSpecId, needsReschedule)</code>ä¼šè°ƒç”¨<code>SystemJobService.onExecuted()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExecuted</span><span class="params">(<span class="meta">@NonNull</span> String workSpecId, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    Logger.get().debug(TAG, String.format(<span class="string">&quot;%s executed on JobScheduler&quot;</span>, workSpecId));</span><br><span class="line">    JobParameters parameters;</span><br><span class="line">    <span class="keyword">synchronized</span> (mJobParameters) &#123;</span><br><span class="line">        parameters = mJobParameters.remove(workSpecId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (parameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">        jobFinished(parameters, needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œæ ¹æ®JobServiceçš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¯ä»¥è®¤å®šï¼Œæœ€åä¼šè°ƒç”¨<code>SystemJobService.onStopJob()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStopJob</span><span class="params">(<span class="meta">@NonNull</span> JobParameters params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mWorkManagerImpl == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String workSpecId = getWorkSpecIdFromJobParameters(params);</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(workSpecId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mJobParametersæ•°æ®å®‰å…¨</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mJobParameters) &#123;</span><br><span class="line">        <span class="comment">// ç§»å‡ºä»»åŠ¡å‚æ•°é˜Ÿåˆ—ï¼ˆMapï¼‰</span></span><br><span class="line">        mJobParameters.remove(workSpecId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»“æŸæ­¤ä»»åŠ¡</span></span><br><span class="line">    mWorkManagerImpl.stopWork(workSpecId);</span><br><span class="line">    <span class="keyword">return</span> !mWorkManagerImpl.getProcessor().isCancelled(workSpecId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œä»JobServiceè°ƒç”¨SystemJobServiceæ‰§è¡Œä»»åŠ¡åˆ°æœ€ç»ˆä»»åŠ¡ç»“æŸæµç¨‹å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„é“¾ã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>Jetpackä¹‹åº”ç”¨å¯åŠ¨ç»„ä»¶-StartUp</title>
    <url>/2021/02/24/Jetpack%E4%B9%8B%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E7%BB%84%E4%BB%B6-StartUp/</url>
    <content><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote>
<p>åº”ç”¨ç¨‹åºå¯åŠ¨åº“<code>StartUp</code>æä¾›äº†ä¸€ç§åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–ç»„ä»¶çš„ç®€å•ã€é«˜æ•ˆçš„æ–¹æ³•ã€‚åº“å¼€å‘è€…å’Œåº”ç”¨å¼€å‘è€…éƒ½å¯ä»¥ä½¿ç”¨app Startupæ¥ç®€åŒ–å¯åŠ¨åºåˆ—ï¼Œå¹¶æ˜¾å¼è®¾ç½®åˆå§‹åŒ–é¡ºåºã€‚</p>
</blockquote>
<blockquote>
<p>ä¸åŒäºä¸ºæ¯ä¸ªéœ€è¦åˆå§‹åŒ–çš„ç»„ä»¶å®šä¹‰å•ç‹¬çš„å†…å®¹æä¾›ç¨‹åºï¼ŒApp Startupå…è®¸ä½ å®šä¹‰å…±äº«å•ä¸ªå†…å®¹æä¾›ç¨‹åºçš„ç»„ä»¶åˆå§‹åŒ–ç¨‹åºã€‚è¿™å¯ä»¥æ˜¾è‘—æé«˜åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€‚</p>
</blockquote>
<p>æ­¤ç»„ä»¶ä¸»è¦è§£å†³çš„ç—›ç‚¹é—®é¢˜æ˜¯ï¼šç®€åŒ–å„ä¸ªå¤–éƒ¨å¼•ç”¨SDKåˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¼˜åŒ–SDKåˆå§‹åŒ–æ—¶æœºï¼Œåœ¨ç¡®ä¿å¯åŠ¨é€Ÿåº¦çš„æƒ…å†µä¸‹ä»¥æ›´ä¼˜æ›´ç¨³å®šçš„æ–¹å¼æŒ‰éœ€åˆå§‹åŒ–SDKï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å®ƒçš„æŒ‰éœ€æŒ‰åºæ‰§è¡Œçš„åŠŸèƒ½æ¥åˆå§‹åŒ–æŸäº›ç±»ï¼‰ã€‚</p>
<p><a href="https://github.com/TinloneX/ArchitecturalComponentExample">ã€æœ¬ç³»åˆ—æ–‡ç« æ¼”ç¤ºæ¡ˆä¾‹å‡å­˜å‚¨åœ¨githubå­˜å‚¨åº“ArchitecturalComponentExampleä¸­ã€‘</a></p>
<a id="more"></a>

<h3 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h3><h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><p>åœ¨<code>app/build.gradle</code>æ–‡ä»¶çš„<code>dependencies</code>ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&quot;androidx.startup:startup-runtime:1.0.0&quot;</span></span><br></pre></td></tr></table></figure>
<p>è‹¥è·å–ä¾èµ–åŒ…æŠ¥é”™ï¼Œè¯·æ£€æŸ¥é¡¹ç›®ç›®å½•ä¸‹<code>build.gradle</code>ä¸­æ˜¯å¦åŒ…å«ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç¤ºä¾‹é¡¹ç›®ç»“æ„è¯´æ˜"><a href="#ç¤ºä¾‹é¡¹ç›®ç»“æ„è¯´æ˜" class="headerlink" title="ç¤ºä¾‹é¡¹ç›®ç»“æ„è¯´æ˜"></a>ç¤ºä¾‹é¡¹ç›®ç»“æ„è¯´æ˜</h4><p><a href="https://github.com/TinloneX/ArchitecturalComponentExample/tree/main/StartUpExample/StartUpExampleJava">æœ¬é¡¹ç›®Javaç‰ˆæœ¬åœ°å€</a></p>
<p><a href="https://github.com/TinloneX/ArchitecturalComponentExample/tree/main/StartUpExample/StartUpExampleKotlin">æœ¬é¡¹ç›®Kotlinç‰ˆæœ¬åœ°å€</a></p>
<p><a href="https://developer.android.google.cn/topic/libraries/app-startup">æœ€ç®€å®è·µè¯·å‚è€ƒå®˜æ–¹å¼€å‘æ–‡æ¡£</a></p>
<p>æœ¬é¡¹ç›®ç¤ºä¾‹ä¸»è¦ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://s3.ax1x.com/2021/02/23/yL3Fz9.png" alt="yL3Fz9.png"></p>
<p>å›¾ä¸­â‘¡éƒ¨åˆ†ä»£è¡¨ç”¨æ¥åˆå§‹åŒ–å„ä¸ªç»„ä»¶SDKçš„åˆå§‹åŒ–å™¨ã€‚</p>
<p>å›¾ä¸­â‘ éƒ¨åˆ†ä»£è¡¨æ¨¡æ‹Ÿçš„éœ€åˆå§‹åŒ–çš„ä¸‰æ–¹SDKï¼Œ<strong>SDKä¹‹é—´å­˜åœ¨â€æœ‰å‘æ— ç¯â€çš„ç›¸äº’ä¾èµ–å…³ç³»</strong>ï¼Œä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="https://s3.ax1x.com/2021/02/24/yXhL40.png" alt="yXhL40.png"></p>
<p>ä¸Šè¿°å›¾ä¸­è¡¨è¿°çš„ä¾èµ–å…³ç³»ä¸ºï¼š</p>
<ul>
<li>Cache ä¾èµ–äº DatabaseProxy åŠ Logger</li>
<li>DatabaseProxy ä¾èµ–äº DatabaseHelper åŠ Logger</li>
<li>DatabaseHelper åŠ TXMap å‡ä¾èµ–äº Logger</li>
</ul>
<h4 id="åˆ›å»ºåˆå§‹åŒ–å™¨"><a href="#åˆ›å»ºåˆå§‹åŒ–å™¨" class="headerlink" title="åˆ›å»ºåˆå§‹åŒ–å™¨"></a>åˆ›å»ºåˆå§‹åŒ–å™¨</h4><blockquote>
<p>é€šè¿‡åˆ›å»ºä¸€ä¸ªå®ç°äº†åˆå§‹åŒ–å™¨æ¥å£çš„ç±»æ¥å®šä¹‰æ¯ä¸ªç»„ä»¶åˆå§‹åŒ–å™¨ã€‚è¿™ä¸ªæ¥å£å®šä¹‰äº†ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•:</p>
<ul>
<li>create()æ–¹æ³•åŒ…å«åˆå§‹åŒ–ç»„ä»¶æ‰€éœ€çš„æ‰€æœ‰æ“ä½œï¼Œå¹¶è¿”å›Tçš„å®ä¾‹ã€‚</li>
<li>dependencies()æ–¹æ³•ï¼Œå®ƒè¿”å›åˆå§‹åŒ–å™¨æ‰€ä¾èµ–çš„å…¶ä»–åˆå§‹åŒ–å™¨å¯¹è±¡çš„åˆ—è¡¨ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•æ¥æ§åˆ¶åº”ç”¨ç¨‹åºåœ¨å¯åŠ¨æ—¶è¿è¡Œåˆå§‹åŒ–å™¨çš„é¡ºåºã€‚</li>
</ul>
</blockquote>
<p>ä¾ç…§ä¸Šè¿°è§„åˆ™ï¼Œæˆ‘ä»¬æ¥ç¼–å†™Loggerçš„åˆå§‹åŒ–ç±»LoggerInitializer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerInitializer</span> <span class="keyword">implements</span> <span class="title">Initializer</span>&lt;<span class="title">Logger</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Logger <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;create: LoggerInitializer&quot;</span>);</span><br><span class="line">        Logger.initialize();</span><br><span class="line">        <span class="keyword">return</span> Logger.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Initializer&lt;?&gt;&gt;&gt; dependencies() &#123;</span><br><span class="line">        <span class="comment">// é¢„ç¤ºæ²¡æœ‰å…¶ä»–ä¾èµ–éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é¦–å…ˆåˆå§‹åŒ–å™¨éœ€è¦å®ç°<code>Initializer<?></code>æ¥å£ï¼Œå¹¶ä¼ å…¥éœ€åˆå§‹åŒ–çš„å¯¹è±¡çš„æ³›å‹ï¼Œ<em>æ€è€ƒå¦‚æœä¸ä¼ æˆ–ä¼ å…¥Voidä¼šæ€æ ·ï¼Ÿ</em></li>
<li>å®ç°createæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­å®Œæˆç»„ä»¶åˆå§‹åŒ–ï¼Œå¦‚æœ‰éœ€è¦å¯è¿”å›å®ä¾‹</li>
<li>å®ç°dependenciesæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­å£°æ˜å½“å‰åˆå§‹åŒ–ç»„ä»¶ä¾èµ–äºå…¶ä»–ç»„ä»¶ï¼Œå¹¶è¿”å›è¢«ä¾èµ–ç»„ä»¶çš„åˆå§‹åŒ–å™¨ï¼Œæ­¤å¤„Loggeræœªä¾èµ–å…¶ä»–ç»„ä»¶ï¼Œæ•…è¿”å›ç©ºæ•°ç»„ï¼Œ<em>æ€è€ƒå¦‚æœè¿”å›nullä¼šæ€æ ·ï¼Ÿ</em></li>
</ul>
<p>ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬æ ¹æ®ç»„ä»¶ä¾èµ–å…³ç³»ä¾æ¬¡å®šä¹‰å‡ºå„ä¸ªç»„ä»¶çš„åˆå§‹åŒ–å™¨ï¼Œå¯¹æ¯”ä¸Šè¿°æ— ä¾èµ–çš„Loggerï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¤šä¸ªä¾èµ–çš„DatabaseProxyçš„åˆå§‹åŒ–å™¨æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseProxyInitializer</span> <span class="keyword">implements</span> <span class="title">Initializer</span>&lt;<span class="title">DatabaseProxy</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DatabaseProxy <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;create: DatabaseProxyInitializer&quot;</span>);</span><br><span class="line">        DatabaseProxy.initialize(DatabaseHelper.getInstance());</span><br><span class="line">        <span class="keyword">return</span> DatabaseProxy.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Initializer&lt;?&gt;&gt;&gt; dependencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(LoggerInitializer.class, DatabaseHelperInitializer.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°åœ¨<code>dependencies</code>ä¸­å£°æ˜äº†DatabaseProxyä¾èµ–äºLoggerå’ŒDatabaseHelperã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹ä¸Šè¿°çš„ä¸¤ä¸ªæ€è€ƒé¢˜ã€‚</p>
<ol>
<li>å½“Initializer&lt;?&gt;æ³›å‹ä¼ å…¥Voidä¼šæ€æ ·ï¼Ÿ</li>
</ol>
<p>æ­¤åœºæ™¯ç±»ä¼¼äºï¼šå½“æˆ‘ä»¬ä»…å•çº¯çš„æƒ³æ‰§è¡ŒæŸç»„ä»¶çš„åˆå§‹åŒ–è€Œæ²¡æœ‰è¿”å›å®ä¾‹çš„æƒ…å†µ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomethingInitializer</span> <span class="keyword">implements</span> <span class="title">Initializer</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Void <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;create: SomethingInitializer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Initializer&lt;?&gt;&gt;&gt; dependencies() &#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬è®©TXMapçš„åˆå§‹åŒ–å™¨å»ä¾èµ–è¿™SomethingInitializerï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapInitializer</span> <span class="keyword">implements</span> <span class="title">Initializer</span>&lt;<span class="title">TXMap</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TXMap <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;loglog&quot;</span>, <span class="string">&quot;create: MapInitializer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TXMap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;? extends Initializer&lt;?&gt;&gt;&gt; dependencies() &#123;</span><br><span class="line">        <span class="comment">// mapä¾èµ–äº†logï¼Œç°åœ¨æˆ‘ä»¬è®©å®ƒä¾èµ–Something</span></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(LoggerInitializer.class, SomethingInitializer.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬çœ‹çœ‹å…¶æ‰§è¡Œç»“æœ <em>ï¼ˆå½“ç„¶ï¼Œä»…ç¼–å†™åˆå§‹åŒ–å™¨çš„ä»£ç ä»ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œè¿˜æœªåœ¨AndroidManifestä¸­å£°æ˜åˆå§‹åŒ–ç»„ä»¶ï¼Œæ­¤å¤„æˆ‘ä»¬æš‚åªå…³æ³¨ç»“æœï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»å£°æ˜åˆå§‹åŒ–ç»„ä»¶ï¼‰</em>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I&#x2F;tag: create: LoggerInitializer</span><br><span class="line">I&#x2F;tag: Logger initialized</span><br><span class="line">I&#x2F;tag: create: SomethingInitializer</span><br><span class="line">I&#x2F;tag: create: MapInitializer</span><br><span class="line">I&#x2F;tag: Map initialized</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¾æ—§æ­£å¸¸æŒ‰éœ€æ‰§è¡Œäº†åˆå§‹åŒ–æ“ä½œï¼Œå…ˆè°ƒç”¨äº†è¢«TXMapä¾èµ–çš„LoggeråŠSomethingçš„åˆå§‹åŒ–å™¨ï¼Œæœ€ç»ˆå®ŒæˆMapçš„åˆå§‹åŒ–ã€‚è¯´æ˜ï¼ŒInitializer&lt;?&gt;ä¸­æœ‰æ— ä¼ å…¥æ³›å‹åŠä¼ å…¥Voidæ³›å‹ï¼Œå…¶å‡å¯æ­£å¸¸æ‰§è¡Œï¼Œæ­£å¸¸é€‚ç”¨äºä»…æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œæ— è¿”å›å®ä¾‹çš„æƒ…æ™¯ã€‚</p>
<ol start="2">
<li>å¦‚æœdependenciesè¿”å›å€¼ä¸ºnullä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
</ol>
<p>æˆ‘ä»¬å°†LoggerInitializerçš„ä¾èµ–ç”±<code>return Collections.emptyList()</code>ä¿®æ”¹ä¸º<code>return null</code>ç„¶åæ‰§è¡Œ <em>ï¼ˆä»…ç¼–å†™åˆå§‹åŒ–å™¨çš„ä»£ç ä»ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œè¿˜æœªåœ¨AndroidManifestä¸­å£°æ˜åˆå§‹åŒ–ç»„ä»¶ï¼Œæ­¤å¤„æˆ‘ä»¬åªå…³æ³¨ç»“æœï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»å£°æ˜åˆå§‹åŒ–ç»„ä»¶ï¼‰</em>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; æŠ¥é”™æ—¥å¿—</span><br><span class="line">java.lang.RuntimeException: Unable to get provider androidx.startup.InitializationProvider:</span><br><span class="line">androidx.startup.StartupException:</span><br><span class="line">androidx.startup.StartupException:</span><br><span class="line">java.lang.NullPointerException: Attempt to invoke interface method &#39;boolean java.util.List.isEmpty()&#39; on a null object reference</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ç¨‹åºæŠ¥é”™äº†ï¼Œæ•…dependenciesè¿”å›å€¼ä¸èƒ½ä¸ºnullï¼Œè‡³äºåŸå› å°†åœ¨åŸç†ç¯‡ä¸­å…·ä½“è¯´æ˜ï¼Œè®°ä½æ­¤å¤„ã€ä¼ç¬”1ã€‘ã€‚</p>
<h4 id="æ³¨å†Œåˆå§‹åŒ–å™¨æä¾›è€…"><a href="#æ³¨å†Œåˆå§‹åŒ–å™¨æä¾›è€…" class="headerlink" title="æ³¨å†Œåˆå§‹åŒ–å™¨æä¾›è€…"></a>æ³¨å†Œåˆå§‹åŒ–å™¨æä¾›è€…</h4><p>ä¸Šæ–‡æåˆ°ï¼Œä»…ç¼–å†™åˆå§‹åŒ–å™¨å¹¶ä¸èƒ½å®Œæˆç»„ä»¶åˆå§‹åŒ–ï¼Œæ˜¾ç„¶çš„ï¼Œæˆ‘ä»¬æ²¡æœ‰é…ç½®å…¶æ‰§è¡Œçš„æ—¶æœºã€‚</p>
<blockquote>
<p>åº”ç”¨ç¨‹åºå¯åŠ¨åŒ…æ‹¬ä¸€ä¸ªå«åšInitializationProviderçš„ç‰¹æ®Šå†…å®¹æä¾›ç¨‹åºï¼Œå®ƒç”¨æ¥å‘ç°å’Œè°ƒç”¨ä½ çš„ç»„ä»¶åˆå§‹åŒ–å™¨ã€‚åº”ç”¨å¯åŠ¨æ—¶é€šè¿‡é¦–å…ˆæ£€æŸ¥InitializationProvideræ¸…å•é¡¹ä¸‹çš„é¡¹æ¥å‘ç°ç»„ä»¶åˆå§‹åŒ–å™¨ã€‚ç„¶åï¼ŒApp Startupä¸ºå®ƒå·²ç»å‘ç°çš„ä»»ä½•åˆå§‹åŒ–å™¨è°ƒç”¨dependencies()æ–¹æ³•ã€‚<br>è¿™æ„å‘³ç€ï¼Œä¸ºäº†è®©ç»„ä»¶åˆå§‹åŒ–å™¨åœ¨åº”ç”¨å¯åŠ¨æ—¶è¢«å‘ç°ï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€:</p>
<ul>
<li>ç»„ä»¶åˆå§‹åŒ–å™¨åœ¨InitializationProvideræ¸…å•é¡¹ä¸‹æœ‰ä¸€ä¸ªå¯¹åº”çš„é¡¹ã€‚</li>
<li>ç»„ä»¶åˆå§‹åŒ–å™¨åœ¨dependencies()æ–¹æ³•ä¸­åˆ—å‡ºï¼Œå®ƒæ¥è‡ªä¸€ä¸ªå·²ç»å¯ä»¥å‘ç°çš„åˆå§‹åŒ–å™¨ã€‚</li>
</ul>
</blockquote>
<p>æ­¤æ¡ˆä¾‹ä¸­ï¼Œä¸ºäº†ç¡®ä¿åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¯ä»¥å‘ç°è¿™äº›åˆå§‹åŒ–å™¨ï¼Œè¯·å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ¸…å•æ–‡ä»¶ä¸­:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name&#x3D;&quot;androidx.startup.InitializationProvider&quot;</span><br><span class="line">    android:authorities&#x3D;&quot;$&#123;applicationId&#125;.androidx-startup&quot;</span><br><span class="line">    android:exported&#x3D;&quot;false&quot;</span><br><span class="line">    tools:node&#x3D;&quot;merge&quot;&gt;</span><br><span class="line">    &lt;!-- This entry makes ExampleLoggerInitializer discoverable. --&gt;</span><br><span class="line">    &lt;meta-data</span><br><span class="line">        android:name&#x3D;&quot;com.tinlone.startupexamplejava.initializers.CacheInitializer&quot;</span><br><span class="line">        android:value&#x3D;&quot;androidx.startup&quot; &#x2F;&gt;</span><br><span class="line">    &lt;meta-data</span><br><span class="line">        android:name&#x3D;&quot;com.tinlone.startupexamplejava.initializers.MapInitializer&quot;</span><br><span class="line">        android:value&#x3D;&quot;androidx.startup&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;provider&gt;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç å°†åˆå§‹åŒ–å™¨ä¼ é€’ç»™åˆå§‹åŒ–æä¾›è€…ã€‚</p>
<p>è‹¥åˆå§‹åŒ–é“¾æœ‰å¤šä¸ªï¼Œç±»ä¼¼æœ¬ç¤ºä¾‹ä¸­åŒ…å«ï¼š</p>
<ul>
<li>Logger -&gt; TXMap</li>
<li>Logger -&gt; DatabaseHelper -&gt; DatabaseProxy</li>
</ul>
<p>ä»¥ä¸Šä¸¤æ¡ç‹¬ç«‹çš„é“¾ï¼Œæ•…æ­¤å¤„ä¸ºæ¯æ¡ç‹¬ç«‹çš„é“¾çš„é“¾å°¾åˆå§‹åŒ–å™¨ä¼ é€’ç»™InitializationProviderï¼Œä¸ºä½•è¦è¿™æ ·å†™å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿå°†åœ¨æºç ç¯‡ä¸­å…·ä½“æ¢è®¨ï¼Œè®°ä½æ­¤å¤„ã€ä¼ç¬”2ã€‘.</p>
<h4 id="æ‰‹åŠ¨åˆå§‹åŒ–ç»„ä»¶"><a href="#æ‰‹åŠ¨åˆå§‹åŒ–ç»„ä»¶" class="headerlink" title="æ‰‹åŠ¨åˆå§‹åŒ–ç»„ä»¶"></a>æ‰‹åŠ¨åˆå§‹åŒ–ç»„ä»¶</h4><p>å½“ç„¶ï¼Œå¦‚æœä½ ä¸æƒ³InitializationProviderè‡ªåŠ¨åˆå§‹åŒ–æŸäº›ç»„ä»¶ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è°ƒç”¨åˆå§‹åŒ–æµç¨‹ï¼Œæ­¤æ—¶ä½ åº”è¯¥è¿™æ ·åšï¼š</p>
<ul>
<li>å°†ä¸éœ€è¦åˆå§‹åŒ–çš„ç»„ä»¶æ ‡è®°ä¸º<code>remove</code>:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;meta-data android:name&#x3D;&quot;com.example.ExampleLoggerInitializer&quot;</span><br><span class="line">          tools:node&#x3D;&quot;remove&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨éœ€è¦åˆå§‹åŒ–çš„æ—¶æœºè°ƒç”¨ä»¥ä¸‹ä»£ç ï¼Œä»¥Loggerä¸ºä¾‹ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AppInitializer.getInstance(context)</span><br><span class="line">    .initializeComponent(LoggerInitializer.class);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‚¨åœ¨æ¡ç›®ä¸­ä½¿ç”¨å·¥å…·:node=â€removeâ€ï¼Œè€Œä¸æ˜¯ç®€å•åœ°åˆ é™¤æ¡ç›®ï¼Œä»¥ç¡®ä¿åˆå¹¶å·¥å…·ä¹Ÿä»æ‰€æœ‰å…¶ä»–åˆå¹¶çš„æ¸…å•æ–‡ä»¶ä¸­åˆ é™¤æ¡ç›®ã€‚</p>
</blockquote>
<blockquote>
<p>æ³¨æ„:ç¦ç”¨ç»„ä»¶çš„è‡ªåŠ¨åˆå§‹åŒ–ä¹Ÿä¼šç¦ç”¨è¯¥ç»„ä»¶çš„ä¾èµ–é¡¹çš„è‡ªåŠ¨åˆå§‹åŒ–ã€‚</p>
</blockquote>
<p>è‹¥ä½ æƒ³å®Œå…¨ç¦æ­¢ç»„ä»¶è‡ªåŠ¨åˆå§‹åŒ–ï¼Œä½ å¯ä»¥å°†<code>InitializationProvider</code>ç»„ä»¶å£°æ˜ä¸º<code>remove</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;provider</span><br><span class="line">    android:name&#x3D;&quot;androidx.startup.InitializationProvider&quot;</span><br><span class="line">    android:authorities&#x3D;&quot;$&#123;applicationId&#125;.androidx-startup&quot;</span><br><span class="line">    tools:node&#x3D;&quot;remove&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>
<p>å¹¶åœ¨éœ€è¦åˆå§‹åŒ–çš„æ—¶æœºè°ƒç”¨ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AppInitializer.getInstance(context)</span><br><span class="line">    .initializeComponent(ExampleLoggerInitializer.class);</span><br></pre></td></tr></table></figure>
<h4 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h4><p>StartUpçš„ä½¿ç”¨ä»…éœ€å®Œæˆä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤å³å¯ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å™¨æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">I&#x2F;loglog: create: LoggerInitializer</span><br><span class="line">I&#x2F;loglog: Logger initialized</span><br><span class="line">I&#x2F;loglog: create: SomethingInitializer</span><br><span class="line">I&#x2F;loglog: create: MapInitializer</span><br><span class="line">I&#x2F;loglog: Map initialized</span><br><span class="line">I&#x2F;loglog: create: DatabaseHelperInitializer</span><br><span class="line">I&#x2F;loglog: DatabaseHelper initialized</span><br><span class="line">I&#x2F;loglog: create: DatabaseProxyInitializer</span><br><span class="line">I&#x2F;loglog: DatabaseHelper initialized</span><br><span class="line">I&#x2F;loglog: DatabaseProxy initialized</span><br><span class="line">I&#x2F;loglog: create: CacheInitializer</span><br><span class="line">I&#x2F;loglog: Cache initialized</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨AndroidManifestä¸­å£°æ˜çš„æ˜¯é“¾å°¾çš„åˆå§‹åŒ–å™¨<code>CacheInitializer</code>åŠ<code>MapInitializer</code>, ä»–å´æ˜¯ä»ä¾èµ–é“¾çš„å¤´å¼€å§‹æ‰§è¡Œçš„åˆå§‹åŒ–ï¼Œä»–æ˜¯å¦‚ä½•åšåˆ°å®Œå…¨ç¬¦åˆä¾èµ–é“¾é¡ºåºæ‰§è¡Œçš„å‘¢ï¼Ÿ<br>è®©æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹å…¶åŸç†ã€‚</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>ä¸Šé¢ä½¿ç”¨ç¯‡ä¸­æˆ‘ä»¬åŸ‹ä¸‹äº†ä¸€äº›ä¼ç¬”å’Œé—®é¢˜ï¼š</p>
<ul>
<li>ä¸ºä»€ä¹ˆdependenciesè¿”å›å€¼ä¸èƒ½ä¸ºnullï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆè¦å°†æ¯æ¡ç‹¬ç«‹çš„é“¾çš„é“¾å°¾åˆå§‹åŒ–å™¨ä¼ é€’ç»™InitializationProviderï¼Ÿ</li>
<li>ä»–æ˜¯å¦‚ä½•åšåˆ°å®Œå…¨ç¬¦åˆä¾èµ–é“¾é¡ºåºæ‰§è¡Œçš„ï¼Ÿ</li>
</ul>
<p>ä¸ºè§£ç­”è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆä»åˆå§‹åŒ–çš„å…¥å£ç±»<code>InitializationProvider</code>çœ‹èµ·ã€‚</p>
<h4 id="InitializationProvider"><a href="#InitializationProvider" class="headerlink" title="InitializationProvider"></a>InitializationProvider</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InitializationProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Context context = getContext();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AppInitializer.getInstance(context).discoverAndInitialize();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StartupException(<span class="string">&quot;Context cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// something else ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>InitializationProvider</code>å†…å®¹ç›¸å¯¹ç®€å•ï¼Œå…¶ä½œä¸ºå†…å®¹æä¾›è€…åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨äº†<code> AppInitializer.getInstance(context).discoverAndInitialize()</code>å»æ‰«æåˆå§‹åŒ–å™¨é…ç½®å¹¶æ‰§è¡Œåç»­æ“ä½œã€‚</p>
<h4 id="AppInitializer"><a href="#AppInitializer" class="headerlink" title="AppInitializer"></a>AppInitializer</h4><p>AppInitializer ç»´æŒäº†ä¸€ä¸ªå•ä¾‹ç»“æ„ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªé‡è¦æ–¹æ³•<code>discoverAndInitialize</code>åŠ<code>doInitialize</code>, åˆ†åˆ«è´Ÿè´£å‘ç°åˆå§‹åŒ–å™¨åŠæ‰§è¡Œåˆå§‹åŒ–å™¨ï¼Œæˆ‘ä»¬ä¸€ä¸€çœ‹æ¥ã€‚</p>
<h5 id="discoverAndInitialize"><a href="#discoverAndInitialize" class="headerlink" title="discoverAndInitialize()"></a>discoverAndInitialize()</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">discoverAndInitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.beginSection(SECTION_NAME);</span><br><span class="line">        <span class="comment">// åˆ›å»ºç»„ä»¶æ ‡è¯†ç¬¦ï¼Œè·å–InitializationProviderä¿¡æ¯</span></span><br><span class="line">        ComponentName provider = <span class="keyword">new</span> ComponentName(mContext.getPackageName(),</span><br><span class="line">                InitializationProvider.class.getName());</span><br><span class="line">        <span class="comment">// æ ¹æ®ç»„ä»¶æ ‡è¯†ç¬¦ä»åŒ…ç®¡ç†å™¨ä¸­å–å¾—ç»„ä»¶ï¼Œå¹¶è·å–ç»„ä»¶å…ƒæ•°æ®</span></span><br><span class="line">        ProviderInfo providerInfo = mContext.getPackageManager()</span><br><span class="line">                .getProviderInfo(provider, GET_META_DATA);</span><br><span class="line">        <span class="comment">// å–å¾—å…ƒæ•°æ®</span></span><br><span class="line">        Bundle metadata = providerInfo.metaData;</span><br><span class="line">        String startup = mContext.getString(R.string.androidx_startup);</span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Set&lt;Class&lt;?&gt;&gt; initializing = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">            <span class="comment">// å–å‡ºå…ƒæ•°æ®ä¸­ keyçš„é›†åˆï¼Œ æ­¤å¤„metadataçš„æœ¬è´¨å®ä¸ºArrayMapï¼Œå‚è§&#123;@link Bundle#keySet&#125;</span></span><br><span class="line">            Set&lt;String&gt; keys = metadata.keySet();</span><br><span class="line">            <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">                String value = metadata.getString(key, <span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// æ ¡éªŒæ˜¯å¦ä¸ºandroidx_startupå…ƒæ•°æ®</span></span><br><span class="line">                <span class="keyword">if</span> (startup.equals(value)) &#123;</span><br><span class="line">                    <span class="comment">// æ ¹æ®å…ƒæ•°æ®keyä¸­çš„å…¨ç±»åç”Ÿæˆå­—èŠ‚ç å¯¹è±¡</span></span><br><span class="line">                    Class&lt;?&gt; clazz = Class.forName(key);</span><br><span class="line">                    <span class="comment">// æ ¡éªŒå­—èŠ‚ç å¯¹è±¡æ˜¯å¦æ˜¯ Initializer çš„å®ç°ç±»</span></span><br><span class="line">                    <span class="keyword">if</span> (Initializer.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        Class&lt;? extends Initializer&lt;?&gt;&gt; component =</span><br><span class="line">                                (Class&lt;? extends Initializer&lt;?&gt;&gt;) clazz;</span><br><span class="line">                        <span class="comment">// åŠ å…¥Setå¤‡ç”¨</span></span><br><span class="line">                        mDiscovered.add(component);</span><br><span class="line">                        <span class="keyword">if</span> (StartupLogger.DEBUG) &#123;</span><br><span class="line">                            StartupLogger.i(String.format(<span class="string">&quot;Discovered %s&quot;</span>, key));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                        doInitialize(component, initializing);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException | ClassNotFoundException exception) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StartupException(exception);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.endSection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå…¶ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li>åˆ›å»ºç»„ä»¶æ ‡è¯†ç¬¦ï¼Œè·å–InitializationProviderä¿¡æ¯</li>
<li>æ ¹æ®ç»„ä»¶æ ‡è¯†ç¬¦ä»åŒ…ç®¡ç†å™¨ä¸­å–å¾—ç»„ä»¶ï¼Œå¹¶è·å–ç»„ä»¶å…ƒæ•°æ®</li>
<li>å–å¾—å…ƒæ•°æ®ï¼Œ å–å‡ºå…ƒæ•°æ®ä¸­ keyçš„é›†åˆ</li>
<li>éå†å…ƒæ•°æ®é›†åˆï¼ˆArrayMapï¼‰ä¸­çš„æ•°æ®ï¼Œæ ¡éªŒæ˜¯å¦ä¸ºandroidx_startupå…ƒæ•°æ®</li>
<li>æ ¹æ®å…ƒæ•°æ®keyä¸­çš„å…¨ç±»åç”Ÿæˆå­—èŠ‚ç å¯¹è±¡ï¼Œæ ¡éªŒå­—èŠ‚ç å¯¹è±¡æ˜¯å¦æ˜¯ Initializer çš„å®ç°ç±»</li>
<li>å°†Initializer çš„å®ç°ç±» å­—èŠ‚ç å¯¹è±¡åŠ å…¥å˜é‡mDiscoveredçš„Setä¸­å¤‡ç”¨</li>
<li>æ‰§è¡Œåˆå§‹åŒ–</li>
</ul>
<h5 id="doInitialize"><a href="#doInitialize" class="headerlink" title="doInitialize()"></a>doInitialize()</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;T&gt; T doInitialize(</span><br><span class="line">        @NonNull Class&lt;? extends Initializer&lt;?&gt;&gt; component,</span><br><span class="line">        @NonNull Set&lt;Class&lt;?&gt;&gt; initializing) &#123;</span><br><span class="line">    synchronized (sLock) &#123;</span><br><span class="line">        boolean isTracingEnabled &#x3D; Trace.isEnabled();</span><br><span class="line">        try &#123;</span><br><span class="line">            if (isTracingEnabled) &#123;</span><br><span class="line">                &#x2F;&#x2F; è¿™é‡Œä½¿ç”¨simpleNameï¼Œå› ä¸ºå¦åˆ™èŠ‚åä¼šå¤ªå¤§ã€‚</span><br><span class="line">                Trace.beginSection(component.getSimpleName());</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; ä¿è¯åˆå§‹åŒ–é“¾æ— ç¯ï¼Œinitializingä¸ºæ‰§è¡Œè®°å½•é›†åˆ</span><br><span class="line">            &#x2F;&#x2F; ä»discoverAndInitializeä¸­ä¼ é€’çš„initializingå€¼ä¸ºç©ºï¼Œæ•…æ­¤åˆ¤æ–­ä¸ä¼šæ‰§è¡Œ</span><br><span class="line">            &#x2F;&#x2F; ä»æœ¬å‡½æ•°é€’å½’æ‰§è¡Œä¼ é€’çš„æ˜¯å·²åŒ…å«æ‰§è¡Œçš„åˆå§‹åŒ–å™¨ï¼Œè‹¥æ­¤æ—¶åˆå§‹åŒ–å™¨æœ‰é‡å¤ï¼Œè¯´æ˜ç›¸äº’ä¾èµ–å…³ç³»æˆç¯äº†ï¼Œåº”æŠ›é”™</span><br><span class="line">            if (initializing.contains(component)) &#123;</span><br><span class="line">                String message &#x3D; String.format(</span><br><span class="line">                        &quot;Cannot initialize %s. Cycle detected.&quot;, component.getName()</span><br><span class="line">                );</span><br><span class="line">                throw new IllegalStateException(message);</span><br><span class="line">            &#125;</span><br><span class="line">            Object result;</span><br><span class="line">            &#x2F;&#x2F; è‹¥ï¼ˆè¢«å¤šæ¬¡ä¾èµ–ä¸”ï¼‰å·²åˆå§‹åŒ–åˆ™è·³è¿‡</span><br><span class="line">            if (!mInitialized.containsKey(component)) &#123;</span><br><span class="line">                &#x2F;&#x2F; å°†éœ€è¦æ‰§è¡Œçš„åˆå§‹åŒ–å™¨å­—èŠ‚ç å¯¹è±¡åŠ å…¥æ‰§è¡Œè®°å½•ä¸­</span><br><span class="line">                initializing.add(component);</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; è·å–åˆå§‹åŒ–å™¨å®ä¾‹</span><br><span class="line">                    Object instance &#x3D; component.getDeclaredConstructor().newInstance();</span><br><span class="line">                    Initializer&lt;?&gt; initializer &#x3D; (Initializer&lt;?&gt;) instance;</span><br><span class="line">                    &#x2F;&#x2F; è·å–åˆå§‹åŒ–å™¨ä¾èµ–å…³ç³»</span><br><span class="line">                    List&lt;Class&lt;? extends Initializer&lt;?&gt;&gt;&gt; dependencies &#x3D;</span><br><span class="line">                            initializer.dependencies();</span><br><span class="line">                    &#x2F;&#x2F; è‹¥æ­¤åˆå§‹åŒ–å™¨æœ‰ç›¸å…³ä¾èµ–</span><br><span class="line">                    &#x2F;&#x2F; æ˜¯å¦è®°å¾—ã€ä¼ç¬”1ã€‘æœ‰æåˆ°ä¸ºä½•dependenciesä¸èƒ½è¿”å›nullå—ï¼Ÿ</span><br><span class="line">                    &#x2F;&#x2F; æ­¤å¤„dependencieså–å¾—çš„å€¼å¹¶æœªä½œç©ºåˆ¤æ–­ï¼Œæ•… null.isEmpty()ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸</span><br><span class="line">                    if (!dependencies.isEmpty()) &#123;</span><br><span class="line">                        &#x2F;&#x2F; åˆ™éå†ä¾èµ–ï¼Œæ‰§è¡Œå…¶åˆå§‹åŒ–å™¨ï¼Œå¹¶ä¼ é€’åˆå§‹åŒ–æ‰§è¡Œè®°å½•ï¼Œé˜²æ­¢ä¾èµ–æˆç¯</span><br><span class="line">                        for (Class&lt;? extends Initializer&lt;?&gt;&gt; clazz : dependencies) &#123;</span><br><span class="line">                            if (!mInitialized.containsKey(clazz)) &#123;</span><br><span class="line">                                doInitialize(clazz, initializing);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (StartupLogger.DEBUG) &#123;</span><br><span class="line">                        StartupLogger.i(String.format(&quot;Initializing %s&quot;, component.getName()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    result &#x3D; initializer.create(mContext);</span><br><span class="line">                    if (StartupLogger.DEBUG) &#123;</span><br><span class="line">                        StartupLogger.i(String.format(&quot;Initialized %s&quot;, component.getName()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; æ‰§è¡Œå®Œæ¯•ï¼Œç§»é™¤è®°å½•</span><br><span class="line">                    initializing.remove(component);</span><br><span class="line">                    &#x2F;&#x2F; è®°å½•åˆå§‹åŒ–å®Œæˆ</span><br><span class="line">                    mInitialized.put(component, result);</span><br><span class="line">                &#125; catch (Throwable throwable) &#123;</span><br><span class="line">                    throw new StartupException(throwable);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                result &#x3D; mInitialized.get(component);</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; è¿”å›æ‰§è¡Œç»“æœ</span><br><span class="line">            return (T) result;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Trace.endSection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œå…¶ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li>é¦–å…ˆæ ¹æ®å•é“¾æ‰§è¡Œè®°å½•åˆ¤æ–­æ­¤é“¾ä¸­æ˜¯å¦æœ‰ä¾èµ–å…³ç³»æˆç¯ï¼Œæˆç¯åˆ™æŠ›é”™</li>
<li>æ ¹æ®åˆå§‹æ¢æ‰§è¡Œå®Œæˆçš„è®°å½•åˆ¤æ–­ï¼ˆè¢«å¤šæ¬¡ä¾èµ–çš„ï¼‰ä¾èµ–æ˜¯å¦å·²è¢«åˆå§‹åŒ–ï¼Œå·²åˆå§‹åŒ–åˆ™è·³è¿‡</li>
<li>å°†éœ€è¦æ‰§è¡Œçš„åˆå§‹åŒ–å™¨å­—èŠ‚ç å¯¹è±¡åŠ å…¥æ‰§è¡Œè®°å½•ä¸­å¤‡ç”¨ï¼Œç”¨ä»¥åˆ¤æ–­ä¾èµ–é“¾ä¸­æ˜¯å¦æˆç¯</li>
<li>è°ƒç”¨ initializer.dependencies() è·å–åˆå§‹åŒ–å™¨ä¾èµ–å…³ç³»</li>
<li>è‹¥æ­¤åˆå§‹åŒ–å™¨æœ‰å…¶ä»–ä¾èµ–åˆ™éå†ä¾èµ–é€’å½’è°ƒç”¨ doInitialize() æ‰§è¡Œè‡³ä¾èµ–é“¾çš„é“¾å¤´çš„åˆå§‹åŒ–</li>
<li>é“¾æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™ç§»é™¤æ­¤é“¾çš„æ‰§è¡Œè®°å½•</li>
<li>é“¾æ‰§è¡Œå®Œæ¯•ï¼Œå°†å…ƒæ•°æ®ä¸­å£°æ˜çš„åˆå§‹åŒ–å™¨åŠ å…¥è‡³å·²å®Œæˆé›†åˆä¸­ï¼Œç”¨ä»¥é¿å…é‡å¤åˆå§‹åŒ–</li>
</ul>
<p>é‚£ä¹ˆè‡³æ­¤ï¼Œæˆ‘ä»¬ä¼¼ä¹å¯ä»¥è§£é‡Šæ­¤èŠ‚åˆå§‹ç•™ä¸‹çš„ä¸‰ä¸ªä¼ç¬”é—®é¢˜äº†ã€‚</p>
<ol>
<li>ä¸ºä»€ä¹ˆdependencies()è¿”å›å€¼ä¸èƒ½ä¸ºnullï¼Ÿ</li>
</ol>
<p>ç­”ï¼šå› ä¸ºåœ¨æ‰§è¡Œåˆå§‹åŒ–å‰ï¼Œä¼šåˆ¤æ–­å½“å‰åˆå§‹åŒ–å™¨çš„dependenciesæ˜¯å¦ä¸ºç©ºï¼Œä½†æ­¤æ—¶ä½¿ç”¨çš„æ—¶ List.isEmpty() å¹¶æœªå¯¹dependenciesåˆ¤ç©ºï¼Œæ•…è€Œï¼Œè‹¥dependencies()è¿”å›nullï¼Œä¼šå¯¼è‡´null.isEmpty()çš„è°ƒç”¨ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p>
<ol start="2">
<li>ä¸ºä»€ä¹ˆè¦å°†æ¯æ¡ç‹¬ç«‹çš„é“¾çš„é“¾å°¾åˆå§‹åŒ–å™¨ä¼ é€’ç»™InitializationProviderï¼Ÿ</li>
</ol>
<p>ç­”ï¼šå› ä¸ºå¯ä»¥æ ¹æ®é“¾å°¾çš„åˆå§‹åŒ–å™¨å¯ä»¥é€šè¿‡éå†é€’å½’dependencies()è·å–è¯¥é“¾æ‰€æœ‰ä»¥æ¥çš„åˆå§‹åŒ–å™¨ï¼Œä»è€Œæ‰¾åˆ°é“¾é¦–çš„åˆå§‹åŒ–å™¨ï¼Œç„¶åä»å¤´è‡³å°¾æŠ˜å é€’å½’è¿ç®—ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†ä¾èµ–é“¾é¡ºåºæ‰§è¡Œ</p>
<ol start="3">
<li>ä»–æ˜¯å¦‚ä½•åšåˆ°å®Œå…¨ç¬¦åˆä¾èµ–é“¾é¡ºåºæ‰§è¡Œçš„ï¼Ÿ</li>
</ol>
<p>ç­”åŒé—®é¢˜2</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>StartUp</tag>
      </tags>
  </entry>
  <entry>
    <title>Jetpackä¹‹ç•Œé¢æ•°æ®å­˜å‚¨ç»„ä»¶-ViewModel</title>
    <url>/2021/03/07/Jetpack%E4%B9%8B%E7%95%8C%E9%9D%A2%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%84%E4%BB%B6-ViewModel/</url>
    <content><![CDATA[<p>ViewModelè¿™ä¸ªåç§°å¸¸å¸¸ä½¿äººè¯¯è§£ä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œé‚£ä¹ˆå®ƒæ˜¯ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿å‘¢ï¼Ÿ</p>
<p>ViewModelå¯ä»¥ä½œä¸ºMVVMä¸­çš„ViewModelå±‚ï¼Œä½†ä¸æ˜¯ç‰¹æŒ‡MVVMä¸­çš„ViewModelå±‚ã€‚</p>
<blockquote>
<p>ViewModel ç±»æ—¨åœ¨ä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®ã€‚ViewModel ç±»è®©æ•°æ®å¯åœ¨å‘ç”Ÿå±å¹•æ—‹è½¬ç­‰é…ç½®æ›´æ”¹åç»§ç»­ç•™å­˜ã€‚</p>
</blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œä½ å¯ä»¥æŠŠå®ƒè§†ä½œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ•°æ®å­˜å‚¨å·¥å…·, æŠŠå®ƒç”¨åœ¨ä½ è§‰å¾—åˆé€‚çš„ä»»æ„åœ°æ–¹ï¼Œ<strong>å®ƒå¯ä»¥æ˜¯Fragmentå…±äº«æ•°æ®çš„æ¡¥æ¢ã€å¯ä»¥æ˜¯å±å¹•æ–¹å‘åˆ‡æ¢æ—¶çš„æ•°æ®æ¥æºã€å½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ MVVM ä¸­ ViewModelå±‚çš„ æ•°æ®æä¾›è€…ï¼Œä½ å¯ä»¥ä½¿ç”¨LiveDataè®©å®ƒå˜æˆå¯è§‚å¯Ÿçš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DataBindingè®©ä»–æˆä¸ºViewçš„æ•°æ®æº</strong>ã€‚</p>
<p><a href="https://github.com/TinloneX/ArchitecturalComponentExample">ã€æœ¬ç³»åˆ—æ–‡ç« (JAVA/KOTLIN)æ¼”ç¤ºæ¡ˆä¾‹å‡å­˜å‚¨åœ¨githubå­˜å‚¨åº“ArchitecturalComponentExampleä¸­ã€‘</a></p>
<p>æœ¬ç¯‡æ‰€è¿°æºç åŠä»£ç åŸºäº <strong>API 30</strong>ï¼›</p>
<a id="more"></a>
<h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>ä»¥å¾€ï¼Œæˆ‘ä»¬åœ¨ç³»ç»Ÿé”€æ¯æˆ–é‡æ–°åˆ›å»ºç•Œé¢æ§åˆ¶å™¨æ—¶ï¼Œä¸ºä¿è¯å­˜å‚¨åœ¨å…¶ä¸­çš„ä»»ä½•ç¬æ€ç•Œé¢ç›¸å…³æ•°æ®ä¸ä¸¢å¤±ï¼Œå¾€å¾€ä½¿ç”¨Activity å¯ä»¥ä½¿ç”¨ onSaveInstanceState() æ–¹æ³•ä» onCreate() ä¸­çš„æ†ç»‘åŒ…æ¢å¤å…¶æ•°æ®ã€‚æ­¤æ–¹æ³•åœ¨ä¸€å®šåœºæ™¯ä¸‹æœ‰å¯èƒ½ä¸é€‚ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<blockquote>
<p>æ­¤æ–¹æ³•ä»…é€‚åˆå¯ä»¥åºåˆ—åŒ–å†ååºåˆ—åŒ–çš„å°‘é‡æ•°æ®ï¼Œè€Œä¸é€‚åˆæ•°é‡å¯èƒ½è¾ƒå¤§çš„æ•°æ®ï¼Œå¦‚ç”¨æˆ·åˆ—è¡¨æˆ–ä½å›¾ã€‚</p>
</blockquote>
<p>åœ¨è¿™ä¸€æ–¹é¢ä¸Šï¼ŒViewModelå¯ä»¥å­˜å‚¨ä»»æ„ä½ æƒ³è¦å­˜å‚¨çš„æ•°æ®ï¼Œç›¸å¯¹äºonSaveInstanceState() æ˜¾ç„¶æ˜¯å…·æœ‰æ˜æ˜¾ä¼˜åŠ¿çš„ã€‚åŒæ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ•æ„Ÿç»„ä»¶ï¼Œå¯¹äºåƒæ¨ªç«–å±åˆ‡æ¢ç±»ä¼¼æƒ…å†µï¼Œé‡å»ºç•Œé¢æ—¶ï¼Œå¯ä»¥ä¸å¿…åšç±»ä¼¼é‡å»ºä½å›¾ã€é‡æ–°ååºåˆ—åŒ–æ•°æ®ã€é‡æ–°è¯·æ±‚ç½‘ç»œæ•°æ®çš„æ“ä½œã€‚</p>
<p>ä»è§„èŒƒä¸Šæ¥è¯´ï¼ŒViewModelæ¨èæˆ‘ä»¬å°†æ•°æ®ä»ç•Œé¢å±‚ä¸­æ‹¿å‡ºå»ï¼š</p>
<blockquote>
<p>ä»ç•Œé¢æ§åˆ¶å™¨é€»è¾‘ä¸­åˆ†ç¦»å‡ºè§†å›¾æ•°æ®æ‰€æœ‰æƒçš„æ“ä½œæ›´å®¹æ˜“ä¸”æ›´é«˜æ•ˆã€‚</p>
</blockquote>
<h3 id="ViewModelä½¿ç”¨ç¯‡"><a href="#ViewModelä½¿ç”¨ç¯‡" class="headerlink" title="ViewModelä½¿ç”¨ç¯‡"></a>ViewModelä½¿ç”¨ç¯‡</h3><p>æ­¤ç¯‡æ‰€è®²è¿°çš„ä½¿ç”¨ç¯‡å‡ä»…ä»‹ç»ViewModelè‡ªèº«ç‰¹æ€§ï¼ŒåŒºåˆ«äº<a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel#java">å®˜æ–¹æ–‡æ¡£</a>å¯¹äºViewModelä½¿ç”¨ä¸LiveDataç­‰ç»„ä»¶æ··åœ¨ä¸€èµ·è®²çš„æƒ…æ™¯ã€‚</p>
<h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h4><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&quot;androidx.lifecycle:lifecycle-viewmodel:2.3.0&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºæ¡ˆä¾‹"><a href="#åˆ›å»ºæ¡ˆä¾‹" class="headerlink" title="åˆ›å»ºæ¡ˆä¾‹"></a>åˆ›å»ºæ¡ˆä¾‹</h4><p>é¦–å…ˆï¼Œç®€å•çš„ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•é¡µé¢ï¼Œä¸€ä¸ªè®¡æ•°Buttonä»¥åŠä¸€ä¸ªè¾“å…¥æ¡†ç”¨ä»¥åšæ•°æ®çš„è¾“å…¥å’Œå˜åŒ–ï¼Œç•Œé¢æ¯”è¾ƒç®€å•ï¼Œæ­¤å¤„ä¸åšèµ˜è¿°ã€‚</p>
<p>æˆ‘ä»¬ä½¿æ“ä½œä¸Šè¿°æ§ä»¶æ”¹å˜å“åº”çš„å€¼å¹¶å­˜å‚¨åœ¨Activityä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;ViewModelDemoLog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String input = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        Button btnCounter = findViewById(R.id.button);</span><br><span class="line">        EditText etInput = findViewById(R.id.editText);</span><br><span class="line"></span><br><span class="line">        btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, count));</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;å½“å‰è®¡æ•°å€¼ï¼š&quot;</span> + count);</span><br><span class="line"></span><br><span class="line">        btnCounter.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            count++;</span><br><span class="line">            btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, count));</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;è®¡æ•°å¢è‡³ï¼š&quot;</span> + count);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        etInput.addTextChangedListener(<span class="keyword">new</span> TextWatcher() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> count, <span class="keyword">int</span> after)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTextChanged</span><span class="params">(CharSequence s, <span class="keyword">int</span> start, <span class="keyword">int</span> before, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterTextChanged</span><span class="params">(Editable s)</span> </span>&#123;</span><br><span class="line">                input = s.toString();</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;è¾“å…¥æ¡†è¾“å…¥ï¼š&quot;</span> + s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        findViewById(R.id.button2).setOnClickListener(v -&gt; startActivity(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, SecActivity.class)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹è¿è¡Œï¼Œç‚¹å‡»è®¡æ•°Buttonæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š3</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œç¿»è½¬å±å¹•åæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼š</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è§‚å¯Ÿåˆ°é€šè¿‡ç‚¹å‡»buttonæ”¹å˜çš„countå€¼åœ¨ç¿»è½¬å±å¹•åè¢«æ¸…é™¤äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•éªŒè¯äº†ç¿»è½¬å±å¹•æ—¶å±å¹•é‡å»ºï¼ŒActivityä¸­ä¿å­˜çš„ç¬æ—¶é‡æ•°æ®ä¸ä¼šè¢«ä¿å­˜ï¼ˆçœŸçš„ä¸ä¼šå—ï¼‰ã€‚è¿™é‡Œæˆ‘ä»¬å‘ç°å¤šäº†ä¸€è¡Œçš„æ—¥å¿—ï¼Œä¼¼ä¹EditTextåœ¨å±å¹•é‡å»ºåè¢«å¡«å……äº†ä¸€æ¬¡å€¼ï¼Œä¸å¦‚æˆ‘ä»¬åœ¨ç¿»è½¬å±å¹•å‰ä¸ºEditTextè¾“å…¥ä¸€ä¸ªå€¼å†è¯•ä¸€ä¸‹ï¼š<br>ç¿»è½¬å±å¹•å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼ša</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaa</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaaa</span><br></pre></td></tr></table></figure>
<p>ç¿»è½¬å±å¹•åï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è¾“å…¥æ¡†è¾“å…¥ï¼šaaa</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°è¾“å…¥æ¡†çš„æ•°æ®è¢«ä¿å­˜ä¸‹æ¥å¹¶åœ¨é‡å»ºå±å¹•æ—¶è¢«é‡æ–°èµ‹å€¼ï¼Œéœ€è¦å…³æ³¨æ­¤éƒ¨åˆ†åŸç†è¯·è§ã€<a href="#edit_text_save_state">é™„å½•</a>ã€‘ã€‚</p>
<p>å›åˆ°æ­£é¢˜ï¼Œé‚£ä¹ˆï¼Œä¸Šè¿°æ•°æ®å¦‚æœä¿å­˜åœ¨ViewModelä¸­ä¼šæ€æ ·å‘¢ï¼Ÿ</p>
<h4 id="ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹"><a href="#ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹" class="headerlink" title="ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹"></a>ä½¿ç”¨ViewModelæ”¹é€ æ¡ˆä¾‹</h4><p>é¦–å…ˆï¼Œåˆ›å»ºæˆ‘ä»¬çš„ViewModelï¼Œå¹¶æŠŠéœ€è¦å­˜å‚¨çš„æ•°æ®æ”¾åˆ°ViewModelä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeDataViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String logText = <span class="string">&quot;==start==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendLog</span><span class="params">(String log)</span> </span>&#123;</span><br><span class="line">        logText += <span class="string">&quot;\n&quot;</span> + log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>ä¸ºé¿å…EditTexté—®é¢˜å½±å“æ•ˆæœè§‚æµ‹ï¼Œåç»­æµç¨‹å°†ä¼šç§»é™¤EditTextã€‚</em></p>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªç±»ç»§æ‰¿ViewModelï¼Œå¹¶å°†ä½ éœ€è¦å­˜å‚¨çš„æ•°æ®æ”¾åœ¨ViewModelä¸­å³å¯ã€‚</p>
<p>è€Œä½¿ç”¨ViewModelä»£ç ä¹Ÿç›¸å¯¹ç®€å•ï¼Œä½ åªéœ€è¦é€šè¿‡<code>ViewModelProvider(activity).get(HomeDataViewModel.class)</code>å³å¯è·å–åˆ°ViewModelå¯¹è±¡ã€‚è‡³äºä¸ºä½•éœ€è¦ä½¿ç”¨è¿™æ ·ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ–¹å¼è·å–ViewModelï¼Œæˆ‘ä»¬ç¨ååœ¨åŸç†ç¯‡ä¸­å…·ä½“è¯´æ˜ã€‚</p>
<p>å½“ç„¶ä½ å¯èƒ½åœ¨æƒ³ï¼Œå¦‚æœæˆ‘çš„ViewModeléœ€è¦ä½¿ç”¨æœ‰å‚æ„é€ å™¨æ€ä¹ˆåŠï¼Ÿ<br>ä¸ç”¨æ‹…å¿ƒï¼Œå®ƒä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†è§£å†³åŠæ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyViewModelFactory</span> <span class="keyword">implements</span> <span class="title">ViewModelProvider</span>.<span class="title">Factory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String defaultConfig = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyViewModelFactory</span><span class="params">(String defaultConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultConfig = defaultConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="keyword">new</span> HomeDataViewModel(defaultConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨æ—¶</span></span><br><span class="line">viewModel = <span class="keyword">new</span> ViewModelProvider(<span class="keyword">this</span>, </span><br><span class="line">                <span class="keyword">new</span> MyViewModelFactory(<span class="string">&quot;i have default config&quot;</span>))</span><br><span class="line">                .get(HomeDataViewModel.class);</span><br></pre></td></tr></table></figure>
<p>å³åˆ›å»ºä¸€ä¸ª ViewModelProvider.Factory ä¸ºViewModelProvideræä¾›ViewModelçš„åˆå§‹åŒ–æ“ä½œï¼Œå°†ViewModeléœ€è¦çš„å‚æ•°ä¼ å€¼ç»™ MyViewModelFactory ï¼Œç”±MyViewModelFactoryåœ¨åˆ›å»º ViewModelæ—¶è°ƒç”¨å¯¹åº”çš„æ„é€ å™¨æ–¹æ³•å³å¯ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ”¹é€ Activityä»£ç ï¼Œä½¿å…¶ä½¿ç”¨ViewModelä½œä¸ºæ•°æ®å­˜å‚¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;ViewModelDemoLog&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HomeDataViewModel viewModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_sec);</span><br><span class="line"></span><br><span class="line">        Button btnCounter = findViewById(R.id.button);</span><br><span class="line"></span><br><span class="line">        viewModel = <span class="keyword">new</span> ViewModelProvider(<span class="keyword">this</span>).get(HomeDataViewModel.class);</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;è¯»å–viewModel.hashCode(): &quot;</span> + viewModel.hashCode());</span><br><span class="line"></span><br><span class="line">        btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, viewModel.count));</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, <span class="string">&quot;å½“å‰è®¡æ•°å€¼ï¼š&quot;</span> + viewModel.count);</span><br><span class="line"></span><br><span class="line">        btnCounter.setOnClickListener(v -&gt; &#123;</span><br><span class="line">            viewModel.count++;</span><br><span class="line">            btnCounter.setText(String.format(<span class="string">&quot;UP COUNT (%s)&quot;</span>, viewModel.count));</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;è®¡æ•°å¢è‡³ï¼š&quot;</span> + viewModel.count);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥å°†å…ˆå‰ä½¿ç”¨Activityä¸­å˜é‡æ”¹ä¸ºä½¿ç”¨ViewModelä¸­çš„å˜é‡å³å¯ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶æ•ˆæœï¼š</p>
<p>ç¿»è½¬å±å¹•å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¯»å–viewModel.hashCode(): 210932679</span><br><span class="line">å½“å‰è®¡æ•°å€¼ï¼š0</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š1</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š2</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š3</span><br></pre></td></tr></table></figure>
<p>ç¿»è½¬å±å¹•åï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¯»å–viewModel.hashCode(): 210932679</span><br><span class="line">å½“å‰è®¡æ•°å€¼ï¼š3</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å†ç‚¹å‡»ä¸¤æ¬¡è®¡æ•°æŒ‰é’®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è®¡æ•°å¢è‡³ï¼š4</span><br><span class="line">è®¡æ•°å¢è‡³ï¼š5</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬çš„countå­—æ®µå€¼è¢«ä¿å­˜äº†ä¸‹æ¥ï¼Œè€Œä¸”ç¿»è½¬å±å¹•å‰åçš„ViewModelæ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>æ—¢ç„¶ç¿»è½¬å‰åçš„ViewModelæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆï¼Œå¯é¢„è§åœ°ï¼Œ<strong>æˆ‘ä»¬æ”¾åœ¨å…¶å†…éƒ¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«æ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­è·å–ç½‘ç»œæ•°æ®ã€ç¼“å­˜ç½‘ç»œå›¾ç‰‡ç­‰ç­‰ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåœ¨å±å¹•ç¿»è½¬ç­‰æ”¹å˜Activityé…ç½®æ—¶ï¼Œä½ çš„æ“ä½œè¢«ä¸­æ–­ä»¥åŠé‡æ–°åˆ›å»ºæ—¶è¢«é‡å¤è°ƒç”¨ã€‚</strong></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel">å…³äºæ›´å¤šViewModelä½¿ç”¨çš„æ¡ˆä¾‹ï¼Œè¯·ç‚¹å‡»æ­¤å¤„å‚è§å®˜æ–¹æ–‡æ¡£</a></p>
<p>ViewModelçš„ä½¿ç”¨ç›¸å¯¹ç®€å•ï¼Œå…¶èŒè´£å•ä¸€ï¼Œæ³¨é‡ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨ç¯‡å°±ä»‹ç»åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…¶æºç åŠå·¥ä½œåŸç†å§ã€‚</p>
<h4 id="ViewModelç”Ÿå‘½å‘¨æœŸ"><a href="#ViewModelç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ViewModelç”Ÿå‘½å‘¨æœŸ"></a>ViewModelç”Ÿå‘½å‘¨æœŸ</h4><p>é¦–å…ˆï¼ŒViewModelä½œä¸ºä¸€ä¸ªä»¥æ³¨é‡ç”Ÿå‘½å‘¨æœŸçš„æ–¹å¼å­˜å‚¨å’Œç®¡ç†ç•Œé¢ç›¸å…³çš„æ•°æ®çš„ç»„ä»¶ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæˆ‘ä»¬å¼•ç”¨å®˜ç½‘å¯¹äº<a href="https://developer.android.google.cn/topic/libraries/architecture/viewmodel#lifecycle">ViewModel çš„ç”Ÿå‘½å‘¨æœŸ</a>ä»‹ç»çš„ä¸€å¼ å›¾æ¥è¯´æ˜ï¼š<br><img src="https://developer.android.google.cn/images/topic/libraries/architecture/viewmodel-lifecycle.png" alt="viewmodel_lifecycle.png"></p>
<blockquote>
<p>æ‚¨é€šå¸¸åœ¨ç³»ç»Ÿé¦–æ¬¡è°ƒç”¨ Activity å¯¹è±¡çš„ onCreate() æ–¹æ³•æ—¶è¯·æ±‚ ViewModelã€‚ç³»ç»Ÿå¯èƒ½ä¼šåœ¨ Activity çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å¤šæ¬¡è°ƒç”¨ onCreate()ï¼Œå¦‚åœ¨æ—‹è½¬è®¾å¤‡å±å¹•æ—¶ã€‚ViewModel å­˜åœ¨çš„æ—¶é—´èŒƒå›´æ˜¯ä»æ‚¨é¦–æ¬¡è¯·æ±‚ ViewModel ç›´åˆ° Activity å®Œæˆå¹¶é”€æ¯ã€‚</p>
</blockquote>
<p>é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å…¶å…·ä½“æ˜¯æ€ä¹ˆåšåˆ°çš„å§ï¼</p>
<p>é¦–å…ˆæˆ‘ä»¬å…ˆä»ViewModelå¯¹è±¡çš„è·å–å¼€å§‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ViewModelStoreä¸­å–</span></span><br><span class="line">    ViewModel viewModel = mViewModelStore.get(key);</span><br><span class="line">    <span class="comment">// ç±»å‹æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> OnRequeryFactory) &#123;</span><br><span class="line">            ((OnRequeryFactory) mFactory).onRequery(viewModel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//noinspection StatementWithEmptyBody</span></span><br><span class="line">        <span class="keyword">if</span> (viewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœªå–åˆ°åˆ™åˆ›å»º</span></span><br><span class="line">    <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">        viewModel = ((KeyedFactory) mFactory).create(key, modelClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        viewModel = mFactory.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­˜å…¥ViewModelStore</span></span><br><span class="line">    mViewModelStore.put(key, viewModel);</span><br><span class="line">    <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦åˆ©ç”¨ViewModelStoreåšäº†ç¼“å­˜ï¼ˆå­˜å‚¨ï¼‰ï¼Œç¼“å­˜ä¸­æœ‰åˆ™å–å‡ºï¼Œæ— åˆ™åˆ›å»ºå¹¶åŠ å…¥ç¼“å­˜ã€‚</p>
<p>ViewModelStoreå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>HashMap<String, ViewModel></code>å­˜å‚¨ViewModel:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewModelStore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, ViewModel viewModel)</span> </span>&#123;</span><br><span class="line">        ViewModel oldViewModel = mMap.put(key, viewModel);</span><br><span class="line">        <span class="keyword">if</span> (oldViewModel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldViewModel.onCleared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ViewModel <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;&gt;(mMap.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Clears internal storage and notifies ViewModels that they are no longer used.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">// è®°ä½æ­¤å¤„ï¼Œç¨åä¼šè®²</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">            vm.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        mMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç æ¯”è¾ƒç®€å•,æ­¤å¤„ä¸åšèµ˜è¿°ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å®ƒçš„æ³¨é‡Šä¸­å‘ç°äº†è¿™æ ·ä¸€å¥è¯ï¼š</p>
<blockquote>
<p>Use {@link ViewModelStoreOwner#getViewModelStore()} to retrieve a {@code ViewModelStore} for activities and fragments.</p>
</blockquote>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ ViewModelStoreOwner ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewModelStoreOwner</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns owned &#123;<span class="doctag">@link</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function">ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åªæœ‰ä¸€ä¸ª getViewModelStoreçš„å®šä¹‰ï¼ŒæŸ¥çœ‹å…¶å®ç°ç±»ï¼Œæ‰¾åˆ°<code>androidx.activity.ComponentActivity</code>çš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewModelStore <span class="title">getViewModelStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getApplication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Your activity is not yet attached to the &quot;</span></span><br><span class="line">                + <span class="string">&quot;Application instance. You can&#x27;t request ViewModel before onCreate call.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">        NonConfigurationInstances nc =</span><br><span class="line">                (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">        <span class="keyword">if</span> (nc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Restore the ViewModelStore from NonConfigurationInstances</span></span><br><span class="line">            mViewModelStore = nc.viewModelStore;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mViewModelStore == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mViewModelStore = <span class="keyword">new</span> ViewModelStore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼ŒViewModelStoreæ¥è‡ªäº NonConfigurationInstances ï¼Œè€Œ NonConfigurationInstances åˆ™å–è‡ª getLastNonConfigurationInstance()ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ NonConfigurationInstances ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class ComponentActivity&#123;</span><br><span class="line">    </span><br><span class="line">    static final class NonConfigurationInstances &#123;</span><br><span class="line">        Object custom;</span><br><span class="line">        ViewModelStore viewModelStore;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Activity&#123;</span><br><span class="line">    </span><br><span class="line">    static final class NonConfigurationInstances &#123;</span><br><span class="line">        Object activity;</span><br><span class="line">        HashMap&lt;String, Object&gt; children;</span><br><span class="line">        FragmentManagerNonConfig fragments;</span><br><span class="line">        ArrayMap&lt;String, LoaderManager&gt; loaders;</span><br><span class="line">        VoiceInteractor voiceInteractor;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Object getLastNonConfigurationInstance() &#123;</span><br><span class="line">        return mLastNonConfigurationInstances !&#x3D; null</span><br><span class="line">                ? mLastNonConfigurationInstances.activity : null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šè¿°ä¸¤æ®µä»£ç å¯çŸ¥ï¼ŒViewModelStoreæœ€ç»ˆä¼šå­˜å‚¨åœ¨ Activity.NonConfigurationInstancesä¸­çš„ activityå­—æ®µä¸­ï¼Œæˆ‘ä»¬ç»§ç»­è¿½æº¯<code>Activity.NonConfigurationInstances mLastNonConfigurationInstances;</code>æ˜¯ä»å“ªé‡Œè·å–å’Œå–å€¼çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">@link&#123;Activity#attach&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        Window window, ActivityConfigCallback activityConfigCallback, IBinder assistToken)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    mLastNonConfigurationInstances = lastNonConfigurationInstances;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†è§£è¿‡Activityå¯åŠ¨æµç¨‹çš„åº”è¯¥éƒ½çŸ¥é“ activity.attach() ä¼šåœ¨ ActivityThread.performLaunchActivity()ä¸­è¢«è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ... å¿½ç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">    activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                        <span class="comment">// r.lastNonConfigurationInstances ä»ActivityClientRecordä¸­å–å¾—</span></span><br><span class="line">                        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                        r.referrer, r.voiceInteractor, window, r.configCallback,</span><br><span class="line">                        r.assistToken);</span><br><span class="line">    <span class="comment">// ... å¿½ç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾å‘ç°ï¼ŒlastNonConfigurationInstancesæ¥è‡ªäºActivityClientRecordå¯¹è±¡ï¼Œæˆ‘ä»¬ä»…å…³æ³¨é…ç½®å˜åŒ–æ—¶çš„Activityé‡å»ºæµç¨‹ï¼Œç»§ç»­è¿½æº¯ï¼Œæˆ‘ä»¬ä¸€æ¬¡å¯ä»¥å‘å‰æ‰¾åˆ°ä¸€ä¸‹è°ƒç”¨ï¼š</p>
<ul>
<li>ActivityThread.handleLaunchActivity(ActivityClientRecord r ,â€¦)</li>
<li>ActivityThread.handleRelaunchActivityInner(ActivityClientRecord r ,â€¦)</li>
<li>ActivityThread.handleRelaunchActivity(ActivityClientRecord r ,â€¦)</li>
<li>ClientTransactionHandler.handleRelaunchActivity(ActivityThread.ActivityClientRecord r,â€¦)</li>
<li>ActivityRelaunchItem.excute(ClientTransactionHandler client,â€¦)</li>
<li>ActivityConfigurationChangeItem.excute(ClientTransactionHandler client,â€¦)</li>
</ul>
<p>æˆ‘ä»¬è§‚å¯ŸActivityé‡å»ºçš„é‡å»ºæµç¨‹ï¼Œåªæ˜¯å¯¹å½“å‰Activityå¯¹åº”çš„ActivityClientRecordè¿›è¡Œäº†è½¬æ¢, æ–°åˆ›å»ºçš„Activityçš„ActivityClientRecordä¾æ—§æŒæœ‰åŸActivityçš„lastNonConfigurationInstanceså¯¹è±¡ã€‚</p>
<p>é‚£ä¹ˆè¿™å°±<strong>æœ€ç»ˆä¿è¯äº†NonConfigurationInstancesä¸­çš„ViewModelStoreåœ¨é…ç½®æ›´æ”¹Activityé‡å»ºè¿‡ç¨‹ä¸­ä¸ä¼šè¢«æ”¹å˜ï¼Œé‚£ä¹ˆå­˜å‚¨åœ¨å…¶ä¸­çš„ViewModelè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å˜åŒ–ã€‚</strong></p>
<p>å‰é¢æˆ‘ä»¬äº†è§£äº†ViewModelçš„å­˜å‚¨åŸç†ï¼Œå…¶ä¸»è¦ä¾èµ–äºActivityClientRecordçš„ç‰¹æ€§æ¥å­˜å‚¨NonConfigurationInstanceså¯¹è±¡ï¼Œä¿è¯ViewModelå­˜åœ¨ï¼Œè€Œç•Œé¢é”€æ¯æ—¶ActivityClientRecordä¹Ÿä¼šè¢«é”€æ¯ï¼Œé‚£ä¹ˆä¿å­˜åœ¨å…¶ä¸­çš„NonConfigurationInstancesåŠå…¶åŒ…å«çš„ViewModelè‡ªç„¶ä¹Ÿå°±ä¼šè¢«é”€æ¯ã€‚</p>
<p>å½“ç„¶é”€æ¯çš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šçŸ¥åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ViewModelï¼Œç”¨ä»¥åšå†…å­˜åŠèµ„æºçš„å›æ”¶ï¼Œå…·ä½“å®ç°ä¸ºé‡å†™ onCleared()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeDataViewModel</span> <span class="keyword">extends</span> <span class="title">ViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCleared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCleared();</span><br><span class="line">        <span class="comment">// åšæµçš„å…³é—­ï¼Œèµ„æºå›æ”¶ç­‰</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘å‰è¿½æº¯å¯ä»¥çœ‹åˆ°è°ƒç”¨æ­¤æ–¹æ³•çš„å®ä¸ºViewModel.clear()æ–¹æ³•ã€æ­¤å¤„æ‡’å¾—è´´ä»£ç ã€‘ï¼Œ<br>åœ¨ä¹‹å‰çš„ViewModelStoreä»£ç ä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°æœ‰ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ViewModel.clear()</span></span><br><span class="line">        vm.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    mMap.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è¿½æº¯ï¼Œä½ ä¼šå‘ç°ï¼Œä»–ä¼šåœ¨ComponentActivityæ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå…·ä½“ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public ComponentActivity() &#123;</span><br><span class="line">    &#x2F;&#x2F; å¿½ç•¥å…¶ä»–ä»£ç </span><br><span class="line">    getLifecycle().addObserver(new LifecycleEventObserver() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onStateChanged(@NonNull LifecycleOwner source,</span><br><span class="line">                @NonNull Lifecycle.Event event) &#123;</span><br><span class="line">            if (event &#x3D;&#x3D; Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                if (!isChangingConfigurations()) &#123;</span><br><span class="line">                    getViewModelStore().clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> &#x2F;&#x2F; å¿½ç•¥å…¶ä»–ä»£ç </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ›å»ºå¹¶æ³¨å†Œäº†ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ï¼Œåœ¨Lifecycle.Event.ON_DESTROYäº‹ä»¶ï¼ˆç•Œé¢é”€æ¯ï¼‰æ—¶è°ƒç”¨ViewModelStore.clear();</p>
<p>è‡³æ­¤ï¼ŒViewModelçš„ä½¿ç”¨åŠå·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å°±å¤§è‡´æ¢³ç†äº†ä¸€éäº†~ï¼</p>
<h3 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a><span id="edit_text_save_state">é™„å½•</h3><h4 id="EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤"><a href="#EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤" class="headerlink" title="EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤"></a>EditTextæ§ä»¶æ•°æ®å­˜å‚¨ä¸æ¢å¤</h4><p>åœ¨ViewModelä»¥å‰ï¼ŒActivityé‡å»ºæ•°æ®æ¢å¤ä¸»è¦ä¾é Activit.onSaveInstanceState, æˆ‘ä»¬å¤§èƒ†çŒœæµ‹EditTextæ•°æ®åœ¨ç¿»è½¬å±å¹•æ—¶æ•°æ®ä¾æ—§å­˜åœ¨ä¸æ­¤æœ‰å…³ï¼Œæˆ‘ä»¬å°è¯•è·Ÿè¿›ä¸€ä¸‹å…¶ä¿å­˜æ•°æ®çš„æµç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protected void onSaveInstanceState(@NonNull Bundle outState) &#123;</span><br><span class="line">    &#x2F;&#x2F; è·å–Windowå±‚çº§</span><br><span class="line">    outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState());</span><br><span class="line"></span><br><span class="line">    outState.putInt(LAST_AUTOFILL_ID, mLastAutofillId);</span><br><span class="line">    Parcelable p &#x3D; mFragments.saveAllState();</span><br><span class="line">    if (p !&#x3D; null) &#123;</span><br><span class="line">        outState.putParcelable(FRAGMENTS_TAG, p);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mAutoFillResetNeeded) &#123;</span><br><span class="line">        outState.putBoolean(AUTOFILL_RESET_NEEDED, true);</span><br><span class="line">        getAutofillManager().onSaveInstanceState(outState);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; åˆ†å‘Activityå­˜å‚¨çŠ¶æ€</span><br><span class="line">    dispatchActivitySaveInstanceState(outState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆEditTextä½œä¸ºViewæ˜¾ç„¶æ˜¯ä¾å­˜åœ¨Windowä¸‹çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•ä»Windowä¸‹æ‰‹ï¼Œå…ˆæ¥çœ‹çœ‹è¿™é‡Œè°ƒç”¨çš„<code>mWindow.saveHierarchyState()</code>, ç”±äºè¿™é‡Œæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å»çœ‹<code>PhoneWindow.saveHierarchyState()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bundle <span class="title">saveHierarchyState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Bundle outState = <span class="keyword">new</span> Bundle();</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> outState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">    <span class="comment">// æ”¶é›†çˆ¶å®¹å™¨ä¸­çš„å±‚çº§çŠ¶æ€</span></span><br><span class="line">    mContentParent.saveHierarchyState(states);</span><br><span class="line">    outState.putSparseParcelableArray(VIEWS_TAG, states);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å®¹å™¨ä¸­å–å¾—æœ‰ç„¦ç‚¹çš„æ§ä»¶</span></span><br><span class="line">    <span class="keyword">final</span> View focusedView = mContentParent.findFocus();</span><br><span class="line">    <span class="keyword">if</span> (focusedView != <span class="keyword">null</span> &amp;&amp; focusedView.getId() != View.NO_ID) &#123;</span><br><span class="line">        <span class="comment">// å­˜å‚¨æ§ä»¶ID</span></span><br><span class="line">        outState.putInt(FOCUSED_ID_TAG, focusedView.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save the panels</span></span><br><span class="line">    SparseArray&lt;Parcelable&gt; panelStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">    savePanelState(panelStates);</span><br><span class="line">    <span class="keyword">if</span> (panelStates.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        outState.putSparseParcelableArray(PANELS_TAG, panelStates);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mDecorContentParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        SparseArray&lt;Parcelable&gt; actionBarStates = <span class="keyword">new</span> SparseArray&lt;Parcelable&gt;();</span><br><span class="line">        mDecorContentParent.saveToolbarHierarchyState(actionBarStates);</span><br><span class="line">        outState.putSparseParcelableArray(ACTION_BAR_TAG, actionBarStates);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> outState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·å–å®¹å™¨Viewå±‚çº§åŠçŠ¶æ€<code>mContentParent.saveHierarchyState(states)</code>æœ€ç»ˆä¼šè°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CallSuper</span></span><br><span class="line"><span class="meta">@Nullable</span> <span class="function"><span class="keyword">protected</span> Parcelable <span class="title">onSaveInstanceState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mPrivateFlags |= PFLAG_SAVE_STATE_CALLED;</span><br><span class="line">    <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span> || isAutofilled()</span><br><span class="line">            || mAutofillViewId &gt; LAST_APP_AUTOFILL_ID) &#123;</span><br><span class="line">        BaseSavedState state = <span class="keyword">new</span> BaseSavedState(AbsSavedState.EMPTY_STATE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mStartActivityRequestWho != <span class="keyword">null</span>) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.START_ACTIVITY_REQUESTED_WHO_SAVED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isAutofilled()) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.IS_AUTOFILLED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAutofillViewId &gt; LAST_APP_AUTOFILL_ID) &#123;</span><br><span class="line">            state.mSavedData |= BaseSavedState.AUTOFILL_ID;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        state.mStartActivityRequestWhoSaved = mStartActivityRequestWho;</span><br><span class="line">        state.mIsAutofilled = isAutofilled();</span><br><span class="line">        state.mHideHighlight = hideAutofillHighlight();</span><br><span class="line">        state.mAutofillViewId = mAutofillViewId;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BaseSavedState.EMPTY_STATE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PhoneWindow.saveHierarchyState()</code>çš„ä½œç”¨æ˜¯ï¼šè·å–å®¹å™¨ä¸­æ‰€æœ‰Viewçš„å±‚çº§åŠçŠ¶æ€ï¼Œç„¶åç­›é€‰å‡ºé¢æ¿panelså’Œå…·æœ‰ç„¦ç‚¹çš„æ§ä»¶è¿”å›ç»™Activityï¼ŒEditTextè‡ªç„¶å°±è¢«ç­›é€‰è®°å½•ï¼Œå¹¶è¢«<code>outState.putBundle(WINDOW_HIERARCHY_TAG, mWindow.saveHierarchyState())</code>è®°å½•ä¸‹æ¥ï¼Œæœ€ç»ˆè¢«onSaveInstanceState()å­˜å‚¨ï¼Œè‡³äºonSaveInstanceçš„å…·ä½“åŸç†æ­¤å¤„ä¸åšè®¨è®ºï¼Œæœ‰å…´è¶£å¯è‡ªè¡Œæ·±æŒ–ã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>ViewModel</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(ä¸€) - ä½¿ç”¨ç¯‡</title>
    <url>/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%80)%20-%20%E4%BD%BF%E7%94%A8%E7%AF%87/</url>
    <content><![CDATA[<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li><a href="#zero">ZERO</a></li>
<li><a href="#part_use">1. ä½¿ç”¨ç¯‡</a><ul>
<li><a href="#dependencies">1.1 å£°æ˜ä¾èµ–é¡¹</a></li>
<li><a href="#how_to_use">1.2 è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ</a></li>
<li><a href="#task_type">1.3 WorkRequestç±»å‹</a></li>
<li><a href="#general_operation">1.4 ä¸€èˆ¬æ“ä½œ</a><ul>
<li><a href="#task_listener">1.4.1 ä»»åŠ¡ç›‘å¬</a></li>
<li><a href="#transfer_data">1.4.2 ä¼ é€’æ•°æ®</a></li>
<li><a href="#multiple_ask">1.4.3 å¤šä»»åŠ¡ä¸²è”</a></li>
<li><a href="#UniqueWork">1.4.4 å”¯ä¸€ä»»åŠ¡</a></li>
<li><a href="#task_onstraint">1.4.5 ä»»åŠ¡çº¦æŸ</a></li>
<li><a href="#task_delay">1.4.6 ä»»åŠ¡å»¶æ—¶</a></li>
<li><a href="#retry_rollback">1.4.7 é‡è¯•å’Œé€€é¿æ”¿ç­–</a></li>
<li><a href="#work_tag">1.4.8 æ ‡è®°å·¥ä½œ</a></li>
<li><a href="#work_cancel">1.4.9 å–æ¶ˆå·¥ä½œ</a></li>
</ul>
</li>
<li><a href="#attention">1.5 æ³¨æ„äº‹é¡¹</a></li>
</ul>
</li>
</ul>
<hr>
<h3 id="ZERO"><a href="#ZERO" class="headerlink" title="ZERO"></a><a href="#zero">ZERO</a></h3><p><strong>Q:</strong> ä»€ä¹ˆæ˜¯WorkManagerï¼Ÿä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒï¼Ÿ</p>
<blockquote>
<p>WorkManager æ˜¯ä¸€ä¸ª APIï¼Œå¯ä¾›æ‚¨è½»æ¾è°ƒåº¦é‚£äº›å³ä½¿åœ¨é€€å‡ºåº”ç”¨æˆ–é‡å¯è®¾å¤‡åä»åº”è¿è¡Œçš„å¯å»¶æœŸå¼‚æ­¥ä»»åŠ¡ã€‚WorkManager API æ˜¯ä¸€ä¸ªé€‚åˆç”¨æ¥æ›¿æ¢å…ˆå‰çš„ Android åå°è°ƒåº¦ APIï¼ˆåŒ…æ‹¬ FirebaseJobDispatcherã€GcmNetworkManager å’Œ JobSchedulerï¼‰çš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä¹Ÿå»ºè®®æ‚¨è¿™æ ·åšã€‚WorkManager åœ¨å…¶ç°ä»£ã€ä¸€è‡´çš„ API ä¸­æ•´åˆäº†å…¶å‰èº«çš„åŠŸèƒ½ï¼Œè¯¥ API æ”¯æŒ API çº§åˆ« 14ï¼Œåœ¨å¼€å‘æ—¶å³è€ƒè™‘åˆ°äº†å¯¹ç”µæ± ç»­èˆªçš„å½±å“ã€‚</p>
</blockquote>
<p><strong>Q:</strong> ä¸€å®šè¦ä½¿ç”¨WorkManagerå—ï¼Ÿ</p>
<blockquote>
<p>å¦‚æœæ‚¨çš„åº”ç”¨ä»¥ Android 10ï¼ˆAPI çº§åˆ« 29ï¼‰æˆ–æ›´é«˜ç‰ˆæœ¬ä¸ºç›®æ ‡å¹³å°ï¼Œé‚£ä¹ˆæ‚¨å¯¹ FirebaseJobDispatcher å’Œ GcmNetworkManager API çš„è°ƒç”¨åœ¨æ­è½½ Android Marshmallow (6.0) åŠæ›´é«˜ç‰ˆæœ¬çš„è®¾å¤‡ä¸Šå°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚</p>
</blockquote>
<p>ç”±ä¸Šä¸€é—®é¢˜å¯çŸ¥ï¼ŒWorkManageræ˜¯å¯¹ FirebaseJobDispatcher å’Œ GcmNetworkManager API çš„æ›¿æ¢ï¼Œåœ¨ä¸€å®šæƒ…å¢ƒä¸‹ï¼Œæ˜¾ç„¶æ›´æ¨èæ‚¨ä½¿ç”¨WorkManagerã€‚</p>
<hr>
<p>æœ¬ç« ä¸»è¦å†…å®¹ä¸ºWorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æï¼Œæ¶‰åŠWorkManagerå…¥é—¨ä½¿ç”¨ã€æºç åˆ†æä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¯æ ¹æ®ä¸ªäººéœ€è¦é€‰æ‹©éƒ¨åˆ†å†…å®¹é˜…è¯»ã€‚</p>
<p>æœ¬ç« æ‰€è¿°WorkManagerç›¸å…³å†…å®¹å‡åŸºäº<code>WorkManager:2.4.0</code>;</p>
<p>æœ¬ç« æ¶‰åŠä»£ç å†…å®¹å‡ä½¿ç”¨<strong>Java</strong>è¯­è¨€ç¼–å†™ï¼ŒJavaç‰ˆæœ¬1.8ï¼›</p>
<p><a href="https://github.com/TinloneX">æœ¬ç« æ¼”ç¤ºé¡¹ç›®åœ°å€ï¼šhttps://github.com/TinloneX</a></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager">å‚è€ƒå®˜æ–¹æ–‡æ¡£è¯·ç‚¹å‡»è¿™é‡Œ</a></p>
<a id="more"></a>

<h3 id="1-ä½¿ç”¨ç¯‡"><a href="#1-ä½¿ç”¨ç¯‡" class="headerlink" title=" 1. ä½¿ç”¨ç¯‡"></a><span id="part_use"> 1. ä½¿ç”¨ç¯‡</h3><blockquote>
<p>WorkManager is a library used to enqueue deferrable work that is guaranteed to execute sometime after its Constraints are met. WorkManager allows observation of work status and the ability to create complex chains of work. </p>
</blockquote>
<p>WorkManageræ˜¯ä¸€ä¸ªç”¨äºå°†å¯å»¶è¿Ÿçš„å·¥ä½œæ”¾å…¥é˜Ÿåˆ—çš„åº“ï¼Œè¿™äº›å·¥ä½œä¿è¯åœ¨æ»¡è¶³å…¶çº¦æŸåçš„æŸä¸ªæ—¶é—´å†…æ‰§è¡Œã€‚WorkManagerå…è®¸è§‚å¯Ÿå·¥ä½œçŠ¶æ€ï¼Œå¹¶èƒ½å¤Ÿåˆ›å»ºå¤æ‚çš„å·¥ä½œé“¾ã€‚</p>
<p><strong>æ³¨æ„ï¼šWorkManager éœ€è¦ compileSdk ç‰ˆæœ¬ 28 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</strong></p>
<h4 id="1-1-å£°æ˜ä¾èµ–é¡¹"><a href="#1-1-å£°æ˜ä¾èµ–é¡¹" class="headerlink" title=" 1.1 å£°æ˜ä¾èµ–é¡¹"></a><span id="dependencies"> 1.1 å£°æ˜ä¾èµ–é¡¹</h4><p>å¦‚éœ€æ·»åŠ  WorkManager çš„ä¾èµ–é¡¹ï¼Œæ‚¨å¿…é¡»å°† Google Maven ä»£ç åº“æ·»åŠ åˆ°é¡¹ç›®ä¸­ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¡¹ç›®æ ¹ç›®å½•ä¸‹build.gradle</span></span><br><span class="line"><span class="keyword">allprojects</span> &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨åº”ç”¨æˆ–æ¨¡å—çš„ build.gradle æ–‡ä»¶ä¸­æ·»åŠ æ‰€éœ€å·¥ä»¶çš„ä¾èµ–é¡¹ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/build.gradle</span></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">def</span> work_version = <span class="string">&quot;2.4.0&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// (Java only) å•çº¯ä½¿ç”¨javaå¯å¼•ç”¨æ­¤ä¾èµ–</span></span><br><span class="line">    implementation <span class="string">&quot;androidx.work:work-runtime:$work_version&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Kotlin + coroutines ä½¿ç”¨kotlin+åç¨‹å¯å¼•ç”¨æ­¤ä¾èµ–</span></span><br><span class="line">    implementation <span class="string">&quot;androidx.work:work-runtime-ktx:$work_version&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - RxJava2 support æ„å›¾æ”¯æŒRxJava2çš„WorkManagerå¯å¼•ç”¨æ­¤ä¾èµ–</span></span><br><span class="line">    implementation <span class="string">&quot;androidx.work:work-rxjava2:$work_version&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - GCMNetworkManager support   @â‘ </span></span><br><span class="line">    implementation <span class="string">&quot;androidx.work:work-gcm:$work_version&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// optional - Test helpers  æµ‹è¯•å·¥ä»¶</span></span><br><span class="line">    androidTestImplementation <span class="string">&quot;androidx.work:work-testing:$work_version&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>ä»¥ä¸Šä¾èµ–å‡åªéœ€å¼•ç”¨ä¸€ä¸ªå³å¯ï¼Œæ­¤æ–‡æ¡£åŠä»£ç å‡ä½¿ç”¨<code>androidx.work:work-runtime:2.4.0</code>ã€‚</li>
<li>ç‰¹åˆ«çš„ï¼Œâ‘  <blockquote>
<p>androidx.work:work-gcm:2.2.0 æ˜¯ä¸€ä¸ªæ–°çš„ Maven å·¥ä»¶ï¼Œå½“ Google Play æœåŠ¡å¯ç”¨äº API çº§åˆ« 22 æˆ–æ›´ä½çº§åˆ«æ—¶ï¼Œè¯¥å·¥ä»¶æ”¯æŒå°† GCMNetworkManager ç”¨ä½œè°ƒåº¦ç¨‹åºã€‚è¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„ä¾èµ–é¡¹ï¼Œæœ‰åŠ©äºåœ¨è¾ƒæ—§çš„ API ç‰ˆæœ¬ä¸Šè¿›è¡Œæ›´ç¨³å®šä¸”æ€§èƒ½æ›´é«˜çš„åå°å¤„ç†å·¥ä½œã€‚å¦‚æœæ‚¨çš„åº”ç”¨ä½¿ç”¨ Google Play æœåŠ¡ï¼Œè¯·å°†æ­¤ä¾èµ–é¡¹æ·»åŠ åˆ° gradle æ–‡ä»¶ï¼Œä»¥è‡ªåŠ¨è·å¾— GCMNetworkManager æ”¯æŒã€‚å¦‚æœ Play æœåŠ¡ä¸å¯ç”¨ï¼ŒWorkManager å°†ç»§ç»­åœ¨æ—§æ¬¾è®¾å¤‡ä¸Šå›é€€åˆ° AlarmManagerã€‚</p>
</blockquote>
</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬å°†æ­£å¼è¿›å…¥WorkManagerä½¿ç”¨ç¯‡</p>
<h4 id="1-2-è¯¥å¦‚ä½•ä½¿ç”¨"><a href="#1-2-è¯¥å¦‚ä½•ä½¿ç”¨" class="headerlink" title=" 1.2 è¯¥å¦‚ä½•ä½¿ç”¨"></a><span id="how_to_use"> 1.2 è¯¥å¦‚ä½•ä½¿ç”¨</h4><p>åœ¨è®²è§£ä»»åŠ¡ç±»å‹åŠå…¶ä¸€èˆ¬ä½¿ç”¨å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£WorkManagerå·¥ä½œçš„æµç¨‹ï¼š</p>
<ul>
<li><strong>è°æ¥åš</strong> å®šä¹‰ä¸€ä¸ªè´Ÿè´£å·¥ä½œçš„<strong>Worker</strong><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SimpleWorker extends Worker &#123;</span><br><span class="line">@NonNull</span><br><span class="line">    @Override</span><br><span class="line">    public Result doWork() &#123;</span><br><span class="line">        &#x2F;&#x2F; return Result.failure(); &#x2F;&#x2F; æ‰§è¡Œå¤±è´¥</span><br><span class="line">        &#x2F;&#x2F; return Result.retry();   &#x2F;&#x2F; é‡è¯• </span><br><span class="line">        &#x2F;&#x2F; return Result.success(); &#x2F;&#x2F; æ‰§è¡ŒæˆåŠŸ</span><br><span class="line">        return null;                &#x2F;&#x2F; æ‰§è¡Œç»“æŸï¼Ÿ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Workeræ˜¯WorkManageræœ€ç»ˆå®ç°ä»»åŠ¡çš„â€œå·¥äººâ€ï¼Œå®ƒä¸ç”¨ç®¡ä¼šåœ¨ä»€ä¹ˆå®é™…æ‰§è¡Œä»»åŠ¡ï¼Œè¢«å®‰æ’æ€æ ·æ‰§è¡Œä»»åŠ¡ï¼Œåªç®¡åŸ‹å¤´å¤„ç†ä»»åŠ¡<code>doWork</code>å¹¶æ ¹æ®ä»»åŠ¡æ‰§è¡Œæƒ…å†µåé¦ˆä»»åŠ¡ç»“æœ<code>return Result</code>ã€‚</li>
</ul>
<p>Workeræ‰§è¡Œç»“æœResultï¼šè¡¨ç¤ºä»»åŠ¡çŠ¶æ€ï¼Œä»–ä¸€èˆ¬æœ‰<code>failure</code>ã€<code>retry</code>ã€<code>success</code>ä¸‰ä¸ªçŠ¶æ€ï¼Œä¸”<code>failure</code>ã€<code>success</code>å¯ä»¥æºå¸¦æ•°æ®<code>Data</code>ï¼Œæ­¤å¤„ä»…åšäº†è§£ï¼Œ<a href="#periodic_task">ä¼ é€’æ•°æ®</a>ä¸­å°†åšå…·ä½“è¯´æ˜ã€‚</p>
<ul>
<li><strong>æ€ä¹ˆåš</strong> å®šä¹‰åˆ¶å®šå·¥ä½œæ–¹æ¡ˆçš„<strong>WorkRequest</strong></li>
</ul>
<ol>
<li><strong>éé‡å¤æ€§å·¥ä½œï¼š</strong> å·¥äººåº”è¯¥ä¸€æ¬¡æ€§æŠŠå·¥ä½œåšæ‰<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">OneTimeWorkRequest workRequest1 = OneTimeWorkRequest.from(SimpleWorker.class);</span><br></pre></td></tr></table></figure></li>
<li><strong>å‘¨æœŸä»»åŠ¡ï¼š</strong> å·¥äººåº”è¯¥æ¯éš”å¤šä¹…åšä¸€æ¬¡å·¥ä½œ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PeriodicWorkRequest request &#x3D; new PeriodicWorkRequest</span><br><span class="line">               .Builder(SimpleWorker.class, 16, TimeUnit.MINUTES).build();</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong> å…³äºå‘¨æœŸä»»åŠ¡æœ‰ä¸€ä¸ª<strong>éœ¸ç‹æ¡æ¬¾ï¼š</strong></p>
<blockquote>
<p>æ³¨æ„ï¼šå¯ä»¥å®šä¹‰çš„æœ€çŸ­é‡å¤é—´éš”æ˜¯ 15 åˆ†é’Ÿï¼ˆä¸ JobScheduler API ç›¸åŒï¼‰ã€‚</p>
</blockquote>
<blockquote>
<p>å¦‚æœæ‚¨çš„å·¥ä½œçš„æ€§è´¨è‡´ä½¿å…¶å¯¹è¿è¡Œæ—¶é—´æ•æ„Ÿï¼Œæ‚¨å¯ä»¥å°† PeriodicWorkRequest é…ç½®ä¸ºåœ¨æ¯ä¸ªæ—¶é—´é—´éš”çš„çµæ´»æ—¶é—´æ®µå†…è¿è¡Œã€‚</p>
</blockquote>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/define-work#flexible_run_intervals">ç‚¹æ­¤è·å–â€œçµæ´»çš„è¿è¡Œé—´éš”â€è¯´æ˜</a></p>
<ul>
<li><strong>è°æ¥ç®¡</strong> å·¥ä½œæ–¹æ¡ˆè°æ¥å®¡æ‰¹è°æ¥ç®¡ç†<strong>WorkManager</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkManager.getInstance(myContext).enqueue(myWorkRequest);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è‡ªæ­¤ï¼Œé€šè¿‡Worker + WorkRequest + WorkManagerå°±å¯ä»¥å®Œæˆä¸€æ¬¡æœ€ç®€å·¥ä½œçš„è°ƒç”¨æµç¨‹ï¼Œå…¶ä¸­<strong>Workeræ‰§è¡Œå·¥ä½œï¼ŒWorkRequestå°è£…å·¥ä½œï¼ŒWorkManagerç®¡ç†å·¥ä½œ</strong>ã€‚</p>
<h4 id="1-3-WorkRequestç±»å‹"><a href="#1-3-WorkRequestç±»å‹" class="headerlink" title=" 1.3 WorkRequestç±»å‹"></a><span id="task_type"> 1.3 WorkRequestç±»å‹</h4><p>WorkRequest ç›®å‰æœ‰ä¸¤ä¸ªå­ç±»ï¼Œåˆ†åˆ«ä¸ºå•æ¬¡æ‰§è¡Œä»»åŠ¡ <code>OneTimeWorkRequest</code>å’Œå‘¨æœŸæ‰§è¡Œä»»åŠ¡ <code>PeriodicWorkRequest</code>. ä»–ä»¬çš„ä¸»è¦åŒºåˆ«æ˜¯ä»»åŠ¡æ‰§è¡Œæ–¹æ¡ˆä¸åŒå¯¼è‡´çš„çŠ¶æ€å˜åŒ–ä¸åŒã€‚</p>
<p><a href="https://github.com/TinloneX/WorkManagerDemo/blob/main/images/OneTimeWork_state.png">ç®€å•å•æ¬¡æ‰§è¡Œä»»åŠ¡ OneTimeWorkRequest å·¥ä½œçŠ¶æ€å›¾</a>ï¼š</p>
<p><img src="https://github.com/TinloneX/WorkManagerDemo/blob/main/images/OneTimeWork_state.png" alt="OneTimeWork_STATE"></p>
<blockquote>
<p>å¯¹äº one-time å·¥ä½œè¯·æ±‚ï¼Œå·¥ä½œçš„åˆå§‹çŠ¶æ€ä¸º ENQUEUEDã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨ ENQUEUED çŠ¶æ€ä¸‹ï¼Œæ‚¨çš„å·¥ä½œä¼šåœ¨æ»¡è¶³å…¶ Constraints å’Œåˆå§‹å»¶è¿Ÿè®¡æ—¶è¦æ±‚åç«‹å³è¿è¡Œã€‚æ¥ä¸‹æ¥ï¼Œè¯¥å·¥ä½œä¼šè½¬ä¸º RUNNING çŠ¶æ€ï¼Œç„¶åå¯èƒ½ä¼šæ ¹æ®å·¥ä½œçš„ç»“æœè½¬ä¸º SUCCEEDEDã€FAILED çŠ¶æ€ï¼›æˆ–è€…ï¼Œå¦‚æœç»“æœæ˜¯ retryï¼Œå®ƒå¯èƒ½ä¼šå›åˆ° ENQUEUED çŠ¶æ€ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œéšæ—¶éƒ½å¯ä»¥å–æ¶ˆå·¥ä½œï¼Œå–æ¶ˆåå·¥ä½œå°†è¿›å…¥ CANCELLED çŠ¶æ€ã€‚</p>
</blockquote>
<p><a href="https://github.com/TinloneX/WorkManagerDemo/blob/main/images/PeriodicWork_state.png">å‘¨æœŸæ‰§è¡Œä»»åŠ¡ PeriodicWorkRequest å·¥ä½œçŠ¶æ€å›¾</a>ï¼š</p>
<p><img src="https://github.com/TinloneX/WorkManagerDemo/blob/main/images/PeriodicWork_state.png" alt="PeriodicWork_STATE"></p>
<p>å‘¨æœŸæ€§å·¥ä½œçš„åˆå§‹çŠ¶æ€ä¸º ENQUEUEDï¼Œæ­£å¸¸æ‰§è¡Œæƒ…å†µä¸‹ï¼Œå‘¨æœŸæ€§å·¥ä½œçš„çŠ¶æ€åœ¨ENQUEUED â†”RUNNINGä¹‹é—´äº¤æ›¿ï¼ŒçŸ¥é“ä»»åŠ¡è¢«å–æ¶ˆæ—¶ï¼ŒçŠ¶æ€ä¸ºCANCELLEDã€‚</p>
<blockquote>
<p>æˆåŠŸå’Œå¤±è´¥çŠ¶æ€ä»…é€‚ç”¨äºä¸€æ¬¡æ€§å·¥ä½œå’Œé“¾å¼å·¥ä½œã€‚å®šæœŸå·¥ä½œåªæœ‰ä¸€ä¸ªç»ˆæ­¢çŠ¶æ€ CANCELLEDã€‚è¿™æ˜¯å› ä¸ºå®šæœŸå·¥ä½œæ°¸è¿œä¸ä¼šç»“æŸã€‚æ¯æ¬¡è¿è¡Œåï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œç³»ç»Ÿéƒ½ä¼šé‡æ–°å¯¹å…¶è¿›è¡Œè°ƒåº¦ã€‚</p>
</blockquote>
<p>è‹¥å·¥ä½œçŠ¶æ€å›¾æ— æ³•å±•ç¤ºï¼Œå‚è§<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/states-and-observation">Android-Developers/WorkManager</a>ã€‚</p>
<h4 id="1-4-ä¸€èˆ¬æ“ä½œ"><a href="#1-4-ä¸€èˆ¬æ“ä½œ" class="headerlink" title=" 1.4 ä¸€èˆ¬æ“ä½œ"></a><span id="general_operation"> 1.4 ä¸€èˆ¬æ“ä½œ</h4><p>ä¸Š<a href="#how_to_use">1.2</a>ä¸­ï¼Œæè¿°äº†æœ€ç®€å·¥ä½œçš„ç¼–å†™ï¼Œé‚£ä¹ˆé™¤äº†è¿™äº›åŸºæœ¬çš„<strong>è°æ¥åš</strong>ã€<strong>æ€ä¹ˆåš</strong>ã€<strong>è°æ¥ç®¡</strong>å¤–ï¼ŒWorkManagerè¿˜æœ‰å“ªäº›å¯ä»¥æ“ä½œçš„ç‚¹å‘¢ï¼Ÿ</p>
<p><strong><span id="task_listener">1.4.1 ä»»åŠ¡ç›‘å¬</strong> ï¼ˆæ€ä¹ˆå…³æ³¨ä»»åŠ¡è¿›åº¦ï¼‰</p>
<p>ä¸Šé¢<a href="#task_type">1.3</a>ä¸­ä»‹ç»äº†çš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•ç›‘å¬è¿™äº›çŠ¶æ€å‘¢ï¼Ÿ</p>
<p>æ–¹å¼1 ï¼š</p>
<p><em>æ³¨ï¼šæœ¬æ–‡åŠæ¡ˆä¾‹æœªè¯¦å°½çš„å®è·µæ­¤æ–¹å¼, æ­¤å°èŠ‚å†…å®¹å‡æ¥è‡ª<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/managing-work#observing">å®˜æ–¹æ–‡æ¡£</a></em></p>
<blockquote>
<p>åœ¨å°†å·¥ä½œåŠ å…¥é˜Ÿåˆ—åï¼Œæ‚¨å¯ä»¥éšæ—¶æŒ‰å…¶ nameã€id æˆ–ä¸å…¶å…³è”çš„ tag åœ¨ WorkManager ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œä»¥æ£€æŸ¥å…¶çŠ¶æ€</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; by id</span><br><span class="line">workManager.getWorkInfoById(syncWorker.id); &#x2F;&#x2F; ListenableFuture&lt;WorkInfo&gt;</span><br><span class="line">&#x2F;&#x2F; by name</span><br><span class="line">workManager.getWorkInfosForUniqueWork(&quot;sync&quot;); &#x2F;&#x2F; ListenableFuture&lt;List&lt;WorkInfo&gt;&gt;</span><br><span class="line">&#x2F;&#x2F; by tag</span><br><span class="line">workManager.getWorkInfosByTag(&quot;syncTag&quot;); &#x2F;&#x2F; ListenableFuture&lt;List&lt;WorkInfo&gt;&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ­¤å¤„å°è¯•ä½¿ç”¨æ­¤æ–¹å¼ç›‘å¬ï¼Œå¯ç›‘å¬åˆ°éƒ¨åˆ†çŠ¶æ€</span><br><span class="line">WorkManager.getInstance(this).getWorkInfoById(workRequest.getId()).addListener(() -&gt; Utils.log(future), Runnable::run);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¯¥æŸ¥è¯¢ä¼šè¿”å› WorkInfo å¯¹è±¡çš„ ListenableFutureï¼Œè¯¥å€¼åŒ…å«å·¥ä½œçš„ idã€å…¶æ ‡è®°ã€å…¶å½“å‰çš„ State ä»¥åŠé€šè¿‡ Result.success(outputData) è®¾ç½®çš„ä»»ä½•è¾“å‡ºæ•°æ®ã€‚</p>
</blockquote>
<p>æ–¹å¼2ï¼š</p>
<blockquote>
<p>åˆ©ç”¨æ¯ä¸ªæ–¹æ³•çš„ LiveData å˜ç§ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ³¨å†Œç›‘å¬å™¨æ¥è§‚å¯Ÿ WorkInfo çš„å˜åŒ–ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkManager.getInstance(context)</span><br><span class="line">            .getWorkInfoByIdLiveData(workRequest.getId())</span><br><span class="line">            .observe(lifecycleOwner, new Observer&lt;WorkInfo&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onChanged(WorkInfo workInfo) &#123;</span><br><span class="line">                    &#x2F;&#x2F; workInfo.getState() å¯è·å–ä»»åŠ¡çŠ¶æ€</span><br><span class="line">                    Utils.log(workInfo.getState());</span><br><span class="line">                    &#x2F;&#x2F; workInfo.getOutputData() å¯è·å–ä»»åŠ¡ä¼ é€’çš„æ•°æ®ï¼ˆè¯¦è§1.4.2ï¼‰</span><br><span class="line">                    if (workInfo.getState().isFinished()) &#123;</span><br><span class="line">                        Utils.log(workInfo.getOutputData());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>
<p>å¤æ‚çš„å·¥ä½œæŸ¥è¯¢ï¼š</p>
<p> <em><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/managing-work#complex-queries">å®˜æ–¹æ–‡æ¡£</a></em></p>
<blockquote>
<p>WorkManager 2.4.0 åŠæ›´é«˜ç‰ˆæœ¬æ”¯æŒä½¿ç”¨ WorkQuery å¯¹è±¡å¯¹å·²åŠ å…¥é˜Ÿåˆ—çš„ä½œä¸šè¿›è¡Œå¤æ‚æŸ¥è¯¢ã€‚WorkQuery æ”¯æŒæŒ‰å·¥ä½œçš„æ ‡è®°ã€çŠ¶æ€å’Œå”¯ä¸€å·¥ä½œåç§°çš„ç»„åˆè¿›è¡ŒæŸ¥è¯¢ã€‚</p>
</blockquote>
<blockquote>
<p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†å¦‚ä½•æŸ¥æ‰¾å¸¦æœ‰â€œsyncTagâ€æ ‡è®°ã€å¤„äº FAILED æˆ– CANCELLED çŠ¶æ€ï¼Œä¸”å”¯ä¸€å·¥ä½œåç§°ä¸ºâ€œpreProcessâ€æˆ–â€œsyncâ€çš„æ‰€æœ‰å·¥ä½œã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WorkQuery workQuery = WorkQuery.Builder</span><br><span class="line">       .fromTags(Arrays.asList(<span class="string">&quot;syncTag&quot;</span>))</span><br><span class="line">       .addStates(Arrays.asList(WorkInfo.State.FAILED, WorkInfo.State.CANCELLED))</span><br><span class="line">       .addUniqueWorkNames(Arrays.asList(<span class="string">&quot;preProcess&quot;</span>, <span class="string">&quot;sync&quot;</span>)</span><br><span class="line">     )</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">ListenableFuture&lt;List&lt;WorkInfo&gt;&gt; workInfos = workManager.getWorkInfos(workQuery);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ³¨ï¼šç»å®è·µï¼Œæ­¤æ–¹æ³•è·å–çš„æ˜¯<code>workManager.getWorkInfos(workQuery)</code>è°ƒç”¨æ—¶ä»»åŠ¡çš„çŠ¶æ€ï¼Œè‹¥æƒ³ä½¿ç”¨æ­¤æ–¹æ³•æŒç»­è§‚å¯Ÿä»»åŠ¡çŠ¶æ€ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„åº”å°†Utils.executor()è§†ä½œ ThreadPoolExecutor</span></span><br><span class="line">Utils.executor().execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    ListenableFuture&lt;List&lt;WorkInfo&gt;&gt; workInfos = WorkManager.getInstance(MainActivity.<span class="keyword">this</span>)</span><br><span class="line">                            .getWorkInfos(workQuery);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        List&lt;WorkInfo&gt; infos = workInfos.get();</span><br><span class="line">                        Utils.log(infos);</span><br><span class="line">                        <span class="keyword">for</span> (WorkInfo info : infos) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (info.getState() == WorkInfo.State.SUCCEEDED ||</span><br><span class="line">                                    info.getState() == WorkInfo.State.CANCELLED) &#123;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Utils.log(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>é™„ï¼šå¦‚éœ€äº†è§£<strong>å¦‚ä½•è§‚å¯Ÿå·¥ä½œå™¨çš„ä¸­é—´è¿›åº¦</strong>ï¼Œå¯<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/intermediate-progress#observing_progress">ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹</a></p>
<p>ç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©AndroidStudioçœ‹æ¿è§‚å¯ŸWorkManagerçŠ¶æ€ã€‚</p>
<ul>
<li>AndroidStudioç™½ç‹ä¹‹å‰çš„ç‰ˆæœ¬å¯ä½¿ç”¨DataBase Inspector è§‚å¯Ÿ androidx.work.workdbæ•°æ®åº“ä¸­WorkSpecè¡¨è·å–WorkRequestä¿¡æ¯ï¼›</li>
<li>AndroidStudioç™½ç‹ç‰ˆåˆ™å¯ç›´æ¥ä½¿ç”¨WorkManager InspectoræŸ¥çœ‹WorkRequestä¿¡æ¯ã€‚</li>
</ul>
<p><strong><span id="transfer_data">1.4.2 ä¼ é€’æ•°æ®</strong></p>
<p>åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å‘ä»»åŠ¡ä¸­ä¼ é€’æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨<code>androidx.work.Data</code>å‘WorkRequestä¸­æ·»åŠ æ•°æ®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; åˆ›å»ºéœ€ä¼ é€’çš„æ•°æ®</span><br><span class="line">Data data &#x3D; new Data.Builder().putString(&quot;message&quot;, &quot;MainActivity&quot;).build();</span><br><span class="line">&#x2F;&#x2F; å•æ¬¡æ‰§è¡Œä»»åŠ¡</span><br><span class="line">OneTimeWorkRequest request1 &#x3D; new OneTimeWorkRequest.Builder(Task4DataWorker.class)</span><br><span class="line">        &#x2F;&#x2F; å‘WorkRequestä¸­æ·»åŠ æ•°æ®</span><br><span class="line">        .setInputData(data).build();</span><br><span class="line">&#x2F;&#x2F; å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—</span><br><span class="line">WorkManager.getInstance(this).enqueue(request1);</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±Dataæºç å¯çŸ¥ï¼Œæ­¤å¤„ä¼ é€’æ•°æ®ä»…æ”¯æŒåŸºç¡€æ•°æ®ç±»å‹åŠå…¶å°è£…ã€Stringä»¥åŠä¸Šè¿°ç±»å‹çš„æ•°ç»„ï¼š</p>
<blockquote>
<p>Puts an input key-value pair into the Builder. Valid types are: Boolean, Integer,  Long, Float, Double, String, and array versions of each of those types. Invalid types throw an {@link IllegalArgumentException}.</p>
</blockquote>
<p><em>å½“ç„¶çš„ï¼Œæœ‰æ²¡æœ‰æƒ³ä½¿ç”¨åå°„å‘Dataä¸­çš„mValuesæ³¨å…¥å…¶ä»–ç±»å‹å‘¢ï¼Ÿ<code>Map<String, Object> mValues = new HashMap<>();</code>, æœŸå¾…ä½ çš„å°è¯•ï¼</em></p>
<p>æœ‰ä¼ é€’æ•°æ®è‡ªç„¶æœ‰è·å–æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥Workerä¸­é€šè¿‡<code>getInputData()</code>è·å–<br>ä¼ å…¥çš„Dataå¯¹è±¡ï¼Œé€šè¿‡Dataè·å–ä¼ å…¥çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Dataå’ŒResultå°†å€¼ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class Task4DataWorker extends Worker &#123;</span><br><span class="line"></span><br><span class="line">    public Task4DataWorker(@NonNull Context context, @NonNull WorkerParameters workerParams) &#123;</span><br><span class="line">        super(context, workerParams);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressLint(&quot;RestrictedApi&quot;)</span><br><span class="line">    @NonNull</span><br><span class="line">    @Override</span><br><span class="line">    public Result doWork() &#123;</span><br><span class="line">        String message &#x3D; getInputData().getString(&quot;message&quot;);</span><br><span class="line">        Data myMsg &#x3D; new Data.Builder().putString(&quot;message&quot;, &quot;message from Worker&quot;).build();</span><br><span class="line">        return new Result.Success(myMsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œä»Workerä¸­ä¼ å‡ºçš„Dataåˆ™å¯åœ¨WorkRequestçš„å·¥ä½œçŠ¶æ€WorkInfoä¸­å–å¾—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkManager.getInstance(context)</span><br><span class="line">               .getWorkInfoByIdLiveData(workRequest.getId())</span><br><span class="line">               .observe(context, workInfo -&gt; &#123;</span><br><span class="line">                   if (workInfo!&#x3D;null)&#123;</span><br><span class="line">                       if (workInfo.getState().isFinished()) &#123;</span><br><span class="line">                           String message &#x3D; workInfo.getOutputData().getString(&quot;message&quot;);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>
<p><strong><span id="multiple_ask">1.4.3 å¤šä»»åŠ¡ä¸²è”</strong></p>
<p>é™¤ä¸€èˆ¬çš„å•ä¸€ä»»åŠ¡çš„åœºæ™¯å¤–ï¼Œæˆ‘ä»¬é¢å¯¹çš„ä¸šåŠ¡å¾€å¾€ä¹Ÿè¦å¤„ç†å¤šä¸ªä»»åŠ¡çš„åœºæ™¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¸²è”å¤šä¸ªä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥å°†å¤šä¸ªä»»åŠ¡ç¼–ç»„æˆä»»åŠ¡é“¾å»ä½¿ç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkManager.getInstance(this).beginWith(workRequest2)</span><br><span class="line">                .then(workRequest3)</span><br><span class="line">                .then(workRequest4)</span><br><span class="line">                .enqueue();</span><br><span class="line">&#x2F;&#x2F; or</span><br><span class="line">WorkContinuation continuation &#x3D; WorkManager.getInstance(this)</span><br><span class="line">                .beginWith(workRequest2)</span><br><span class="line">                .then(workRequest3)</span><br><span class="line">                .then(workRequest4);</span><br><span class="line"></span><br><span class="line">continuation.then(workRequest).enqueue();</span><br></pre></td></tr></table></figure>
<p>ç‰¹åˆ«çš„ï¼Œå¦‚éœ€äº†è§£<strong>ä»»åŠ¡é“¾çš„é«˜çº§ç”¨æ³•åŠåˆå¹¶å™¨</strong>ç›¸å…³å†…å®¹ï¼Œ<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/chain-work#input-mergers">è¯·ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£</a>ï¼Œå…¶ä¸­å…³äº<a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/chain-work#work-statuses">é“¾æ¥å’Œå·¥ä½œçŠ¶æ€</a>çš„è¯´æ˜å›¾æ–‡å¹¶èŒ‚ï¼Œæ›´æ˜“äºç†è§£ã€‚</p>
<p><strong><span id="UniqueWork">1.4.4 å”¯ä¸€ä»»åŠ¡</strong></p>
<blockquote>
<p>å”¯ä¸€å·¥ä½œæ˜¯ä¸€ä¸ªå¾ˆå®ç”¨çš„æ¦‚å¿µï¼Œå¯ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå…·æœ‰ç‰¹å®šåç§°çš„å·¥ä½œå®ä¾‹ã€‚ä¸ ID ä¸åŒçš„æ˜¯ï¼Œå”¯ä¸€åç§°æ˜¯äººç±»å¯è¯»çš„ï¼Œç”±å¼€å‘è€…æŒ‡å®šï¼Œè€Œä¸æ˜¯ç”± WorkManager è‡ªåŠ¨ç”Ÿæˆã€‚ä¸æ ‡è®°ä¸åŒï¼Œå”¯ä¸€åç§°ä»…ä¸ä¸€ä¸ªå·¥ä½œå®ä¾‹ç›¸å…³è”ã€‚</p>
</blockquote>
<blockquote>
<p>å”¯ä¸€å·¥ä½œæ—¢å¯ç”¨äºä¸€æ¬¡æ€§å·¥ä½œï¼Œä¹Ÿå¯ç”¨äºå®šæœŸå·¥ä½œã€‚æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•ä¹‹ä¸€åˆ›å»ºå”¯ä¸€å·¥ä½œåºåˆ—ï¼Œå…·ä½“å–å†³äºæ‚¨æ˜¯è°ƒåº¦é‡å¤å·¥ä½œè¿˜æ˜¯ä¸€æ¬¡æ€§å·¥ä½œã€‚WorkManager.enqueueUniqueWork()ï¼ˆç”¨äºä¸€æ¬¡æ€§å·¥ä½œï¼‰<br>    WorkManager.enqueueUniquePeriodicWork()ï¼ˆç”¨äºå®šæœŸå·¥ä½œï¼‰</p>
</blockquote>
<p>è¿™ä¸¤ç§æ–¹æ³•éƒ½æ¥å— 3 ä¸ªå‚æ•°ï¼š</p>
<pre><code>uniqueWorkName - ç”¨äºå”¯ä¸€æ ‡è¯†å·¥ä½œè¯·æ±‚çš„ Stringã€‚
existingWorkPolicy - æ­¤ enum å¯å‘ŠçŸ¥ WorkManagerï¼šå¦‚æœå·²æœ‰ä½¿ç”¨è¯¥åç§°ä¸”å°šæœªå®Œæˆçš„å”¯ä¸€å·¥ä½œé“¾ï¼Œåº”æ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚å¦‚éœ€äº†è§£è¯¦æƒ…ï¼Œè¯·å‚é˜…å†²çªè§£å†³æ”¿ç­–ã€‚
work - è¦è°ƒåº¦çš„ WorkRequestã€‚
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OneTimeWorkRequest workRequest &#x3D; new OneTimeWorkRequest.Builder(SimpleWorker2.class).build();</span><br><span class="line">OneTimeWorkRequest workRequest2 &#x3D; new OneTimeWorkRequest.Builder(SimpleWorker2.class).build();</span><br><span class="line"></span><br><span class="line">WorkManager.getInstance(this).beginUniqueWork(&quot;SimpleWorker&quot;,</span><br><span class="line">        ExistingWorkPolicy.REPLACE, workRequest)</span><br><span class="line">&#x2F;&#x2F;      ExistingWorkPolicy.APPEND, workRequest)</span><br><span class="line">&#x2F;&#x2F;      ExistingWorkPolicy.KEEP, workRequest)</span><br><span class="line">        .then(workRequest2)</span><br><span class="line">&#x2F;&#x2F;      .then(workRequest)</span><br><span class="line">        .enqueue();</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„å®šä¹‰çš„å”¯ä¸€ï¼Œä»…åœ¨ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸”å‡ºç°ç›¸åŒ<code>uniqueWorkName</code>åç§°æ—¶ï¼ŒexistingWorkPolicyæ‰ç”Ÿæ•ˆï¼Œæ— æ³•å½±å“å·²ç»“æŸçš„åŒåä»»åŠ¡ï¼ˆæ­¤åŒåä»…ä¸uniqueWorkNameæœ‰å…³ï¼‰ã€‚<br>ä»¥å®šä¹‰ä¸¤ä¸ªç›¸åŒ<code>uniqueWorkName</code>çš„WorkRequestä¸ºä¾‹ï¼Œæ¥è§‚å¯ŸexistingWorkPolicyå€¼çš„ä½œç”¨åŠå½±å“ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; è‹¥å‘ç°åä¸ºâ€œSimpleWorkerâ€çš„ä»»åŠ¡ï¼Œåˆ™ä½¿ç”¨æ­¤é“¾æ›¿æ¢ç›®æ ‡åç»­æ“ä½œ</span><br><span class="line">&#x2F;&#x2F; ä»»åŠ¡é“¾ A</span><br><span class="line">WorkManager.getInstance(this).beginUniqueWork(&quot;SimpleWorker&quot;,</span><br><span class="line">        ExistingWorkPolicy.REPLACE, workRequest)</span><br><span class="line">        .then(request3)</span><br><span class="line">        .enqueue();</span><br><span class="line">&#x2F;&#x2F; è‹¥å‘ç°åä¸ºâ€œSimpleWorkerâ€çš„ä»»åŠ¡ï¼Œåˆ™ä¿ç•™ç›®æ ‡çš„åŸæ“ä½œï¼Œæ­¤é“¾ä¸æ‰§è¡Œ</span><br><span class="line">&#x2F;&#x2F; ä»»åŠ¡é“¾ B</span><br><span class="line">WorkManager.getInstance(this).beginUniqueWork(&quot;SimpleWorker&quot;,</span><br><span class="line">        ExistingWorkPolicy.KEEP, workRequest5)</span><br><span class="line">        .then(request2)</span><br><span class="line">        .enqueue();</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä¸¤ä¸ªä»»åŠ¡é“¾ï¼Œè‹¥å…ˆæ‰§è¡ŒAå†æ‰§è¡ŒBï¼Œæ­¤æ—¶æ•ˆæœä¸ºï¼š</p>
<pre><code>workUnique2 start   // ä»»åŠ¡é“¾Aè§¦å‘
workUnique2 end     // ä»»åŠ¡é“¾Aè§¦å‘å®Œæ¯•
doWork start: SimpleWorker  // ä»»åŠ¡é“¾Aè€—æ—¶ä»»åŠ¡workRequestå¼€å§‹æ‰§è¡Œ
workUnique start    // ä»»åŠ¡é“¾Bè§¦å‘
workUnique end      // ä»»åŠ¡é“¾Bè§¦å‘å®Œæ¯•
doWork end: SimpleWorker // ä»»åŠ¡é“¾Aè€—æ—¶ä»»åŠ¡workRequestæ‰§è¡Œå®Œæ¯•
doWork: SimpleWorker3   // ä»»åŠ¡é“¾Aæ‰§è¡Œåç»­ä»»åŠ¡request3
ä»»åŠ¡é“¾Bå¹¶æœªæ‰§è¡Œ
</code></pre>
<p>ä¸Šè¿°ä¸¤ä¸ªä»»åŠ¡é“¾ï¼Œè‹¥å…ˆæ‰§è¡ŒBå†æ‰§è¡ŒAï¼Œæ­¤æ—¶æ•ˆæœä¸ºï¼š</p>
<pre><code>workUnique start    // ä»»åŠ¡é“¾Bè§¦å‘
workUnique end      // ä»»åŠ¡é“¾Bè§¦å‘å®Œæ¯•
doWork start: SimpleWorker5 // ä»»åŠ¡é“¾Bè€—æ—¶ä»»åŠ¡workRequest5å¼€å§‹æ‰§è¡Œ
workUnique2 start   // ä»»åŠ¡é“¾Aè§¦å‘
workUnique2 end     // ä»»åŠ¡é“¾Aè§¦å‘å®Œæ¯•
doWork start: SimpleWorker  // ä»»åŠ¡é“¾Aè€—æ—¶ä»»åŠ¡workRequestå¼€å§‹æ‰§è¡Œ
doWork end: SimpleWorker5   // ä»»åŠ¡é“¾Bè€—æ—¶ä»»åŠ¡workRequest5æ‰§è¡Œå®Œæ¯•
doWork end: SimpleWorker    // ä»»åŠ¡é“¾Aè€—æ—¶ä»»åŠ¡workRequestæ‰§è¡Œå®Œæ¯•
doWork: SimpleWorker3       // ä»»åŠ¡é“¾Aæ‰§è¡Œåç»­ä»»åŠ¡request3
ä»»åŠ¡é“¾Bè€—æ—¶ä»»åŠ¡è¢«æ‰§è¡Œä½†åç»­æ“ä½œè¢«åŒåä»»åŠ¡é“¾Aè¦†ç›–
</code></pre>
<p>åŒç†ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡é“¾Açš„å†²çªæ–¹æ¡ˆåˆ†åˆ«å®šä¹‰ä¸º<code>ExistingWorkPolicy.APPEND</code>ã€<code>ExistingWorkPolicy.APPEND_OR_REPLACE</code>ï¼Œè§‚å¯Ÿæ‰§è¡Œæƒ…å†µï¼Œå¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ul>
<li>ExistingWorkPolicy.REPLACE ä¼šæ›¿æ¢æ­£åœ¨æ‰§è¡Œçš„åŒåä»»åŠ¡é‡æ–°æ‰§è¡Œï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„ä»»åŠ¡é“¾è¦†ç›–åŸä»»åŠ¡é“¾ï¼›</li>
<li>ExistingWorkPolicy.KEEP ä¼šä¿æŒåŸä»»åŠ¡é“¾æ‰§è¡Œï¼Œè‡ªå·±ä¸æ‰§è¡Œï¼›</li>
<li>ExistingWorkPolicy.APPEND ä¼šç­‰å¾…åŸä»»åŠ¡é“¾åŒåä»»åŠ¡åŠåç»­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰æ‰§è¡Œè‡ªå·±çš„ä»»åŠ¡é“¾ï¼›</li>
<li>ExistingWorkPolicy.APPEND_OR_REPLACE è‹¥åŸä»»åŠ¡é“¾åŠæ–°ä»»åŠ¡é“¾æœªè¢«å–æ¶ˆæˆ–ä¸­æ–­ï¼Œåˆ™<br>ä¸APPENDæ€§è´¨ä¸€è‡´, å…¶ä»–æƒ…å†µï¼š<blockquote>
<p>If there is existing pending (uncompleted) work with the same unique name, append the newly-specified work as the child of all the leaves of that work sequence. Otherwise, insert the newly-specified work as the start of a new sequence. Note: If there are failed or cancelled prerequisites, these prerequisites are dropped and the newly-specified work is the start of a new sequence.å¦‚æœå­˜åœ¨å…·æœ‰ç›¸åŒå”¯ä¸€åç§°çš„æœªå†³(æœªå®Œæˆ)å·¥ä½œï¼Œåˆ™å°†æ–°æŒ‡å®šçš„å·¥ä½œé™„åŠ ä¸ºè¯¥å·¥ä½œåºåˆ—çš„æ‰€æœ‰å¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ã€‚å¦åˆ™ï¼Œæ’å…¥æ–°æŒ‡å®šçš„å·¥ä½œä½œä¸ºæ–°åºåˆ—çš„å¼€å§‹ã€‚æ³¨æ„:å¦‚æœæœ‰å¤±è´¥æˆ–å–æ¶ˆçš„å…ˆå†³æ¡ä»¶ï¼Œè¿™äº›å…ˆå†³æ¡ä»¶å°†è¢«åˆ é™¤ï¼Œè€Œæ–°æŒ‡å®šçš„å·¥ä½œå°†æ˜¯ä¸€ä¸ªæ–°åºåˆ—çš„å¼€å§‹ã€‚</p>
</blockquote>
</li>
</ul>
<p><strong><span id="task_onstraint">1.4.5 ä»»åŠ¡çº¦æŸ</strong></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/define-work#work-constraints">å‚è§æ–‡æ¡£</a></p>
<blockquote>
<p>Constraintså¯ç¡®ä¿å°†å·¥ä½œå»¶è¿Ÿåˆ°æ»¡è¶³æœ€ä½³æ¡ä»¶æ—¶è¿è¡Œã€‚ä»¥ä¸‹çº¦æŸé€‚ç”¨äº WorkManagerã€‚</p>
</blockquote>
<pre><code>NetworkType     çº¦æŸè¿è¡Œå·¥ä½œæ‰€éœ€çš„ç½‘ç»œç±»å‹ã€‚ä¾‹å¦‚ Wi-Fi (UNMETERED)ã€‚
BatteryNotLow     å¦‚æœè®¾ç½®ä¸º trueï¼Œé‚£ä¹ˆå½“è®¾å¤‡å¤„äºâ€œç”µé‡ä¸è¶³æ¨¡å¼â€æ—¶ï¼Œå·¥ä½œä¸ä¼šè¿è¡Œã€‚
RequiresCharging     å¦‚æœè®¾ç½®ä¸º trueï¼Œé‚£ä¹ˆå·¥ä½œåªèƒ½åœ¨è®¾å¤‡å……ç”µæ—¶è¿è¡Œã€‚
DeviceIdle     å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™è¦æ±‚ç”¨æˆ·çš„è®¾å¤‡å¿…é¡»å¤„äºç©ºé—²çŠ¶æ€ï¼Œæ‰èƒ½è¿è¡Œå·¥ä½œã€‚å¦‚æœæ‚¨è¦è¿è¡Œæ‰¹é‡æ“ä½œï¼Œå¦åˆ™å¯èƒ½ä¼šé™ä½ç”¨æˆ·è®¾å¤‡ä¸Šæ­£åœ¨ç§¯æè¿è¡Œçš„å…¶ä»–åº”ç”¨çš„æ€§èƒ½ï¼Œå»ºè®®æ‚¨ä½¿ç”¨æ­¤çº¦æŸã€‚
StorageNotLow     å¦‚æœè®¾ç½®ä¸º trueï¼Œé‚£ä¹ˆå½“ç”¨æˆ·è®¾å¤‡ä¸Šçš„å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶ï¼Œå·¥ä½œä¸ä¼šè¿è¡Œ
</code></pre>
<p>æ³¨æ„ï¼š<br>å®é™…æµ‹è¯•ä¸­ï¼Œä½¿ç”¨Android 6.0~11.0ç­‰ä¸€ç³»åˆ—ç‰ˆæœ¬çš„æ¨¡æ‹Ÿå™¨æµ‹è¯•å‘ç°</p>
<ul>
<li>9.0ä»¥ä¸‹ç‰ˆæœ¬æ‰‹æœºï¼Œä¸è®ºåº”ç”¨æ˜¯å¦åœ¨å‰å°ï¼Œè¿›ç¨‹æ˜¯å¦å­˜æ´»ï¼Œåªè¦æ»¡è¶³çº¦æŸæ¡ä»¶ä»»åŠ¡å°±ä¼šå°½å¿«æ‰§è¡Œï¼›</li>
<li>9.0åŠä»¥ä¸Šç‰ˆæœ¬æ‰‹æœºï¼Œåº”ç”¨è¿›ç¨‹DEADçŠ¶æ€ï¼Œåœ¨ç¬¦åˆçº¦æŸæ¡ä»¶æ—¶ä»»åŠ¡ä¹Ÿä¸ä¸€å®šä¼šå°½å¿«æ‰§è¡Œï¼Œç”šè‡³å³ä½¿è¿›å…¥Appä¹Ÿä¸ä¸€å®šèƒ½ç«‹é©¬å¾—åˆ°æ‰§è¡Œï¼Œé™¤éæœ‰æ–°çš„WorkRequestå…¥é˜Ÿã€‚</li>
</ul>
<p><strong><span id="task_delay">1.4.6 ä»»åŠ¡å»¶æ—¶</strong></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/define-work#delayed_work">å‚è§æ–‡æ¡£</a></p>
<blockquote>
<p>å¦‚æœå·¥ä½œæ²¡æœ‰çº¦æŸï¼Œæˆ–è€…å½“å·¥ä½œåŠ å…¥é˜Ÿåˆ—æ—¶æ‰€æœ‰çº¦æŸéƒ½å¾—åˆ°äº†æ»¡è¶³ï¼Œé‚£ä¹ˆç³»ç»Ÿå¯èƒ½ä¼šé€‰æ‹©ç«‹å³è¿è¡Œè¯¥å·¥ä½œã€‚å¦‚æœæ‚¨ä¸å¸Œæœ›å·¥ä½œç«‹å³è¿è¡Œï¼Œå¯ä»¥å°†å·¥ä½œæŒ‡å®šä¸ºåœ¨ç»è¿‡ä¸€æ®µæœ€çŸ­åˆå§‹å»¶è¿Ÿæ—¶é—´åå†å¯åŠ¨ã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkRequest myWorkRequest &#x3D;</span><br><span class="line">      new OneTimeWorkRequest.Builder(MyWork.class)</span><br><span class="line">               .setInitialDelay(10, TimeUnit.MINUTES)</span><br><span class="line">               .build();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šæ‰§è¡Œå·¥ä½œå™¨çš„ç¡®åˆ‡æ—¶é—´è¿˜å–å†³äº WorkRequest ä¸­ä½¿ç”¨çš„çº¦æŸå’Œç³»ç»Ÿä¼˜åŒ–æ–¹å¼ã€‚WorkManager ç»è¿‡è®¾è®¡ï¼Œèƒ½å¤Ÿåœ¨æ»¡è¶³è¿™äº›çº¦æŸçš„æƒ…å†µä¸‹æä¾›å¯èƒ½çš„æœ€ä½³è¡Œä¸ºã€‚<br>å®šæœŸå·¥ä½œåªæœ‰é¦–æ¬¡è¿è¡Œæ—¶ä¼šå»¶è¿Ÿ</p>
</blockquote>
<p><strong><span id="retry_rollback">1.4.7 é‡è¯•å’Œé€€é¿æ”¿ç­–</strong></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/define-work#retry_and_backoff_policy">å‚è§æ–‡æ¡£</a></p>
<p>è‹¥Workerè¿”å›ç»“æœResult.retry()æ—¶ï¼Œè§¦å‘é‡è¯•é€€é¿æ”¿ç­–ï¼Œå³ä¸‹æ¬¡è°ƒåº¦Workeråº”åœ¨å¤šé•¿æ—¶é—´ä»¥åï¼Œæ”¯æŒè®¾ç½®é€€é¿æ—¶é—´åŸºæ•°å’ŒåŸºæ•°é€’å¢æ–¹å¼ï¼Œé€’å¢æ–¹å¼ç›®å‰æ”¯æŒçº¿æ€§<code>LINEAR</code>å’ŒæŒ‡æ•°<code>EXPONENTIAL</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OneTimeWorkRequest workRequest &#x3D; new OneTimeWorkRequest.Builder(RetryWorker.class)</span><br><span class="line">                .setBackoffCriteria(BackoffPolicy.LINEAR,</span><br><span class="line">                        OneTimeWorkRequest.MIN_BACKOFF_MILLIS,</span><br><span class="line">                        TimeUnit.MILLISECONDS)</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šé€€é¿å»¶è¿Ÿæ—¶é—´ä¸ç²¾ç¡®ï¼Œåœ¨ä¸¤æ¬¡é‡è¯•ä¹‹é—´å¯èƒ½ä¼šæœ‰å‡ ç§’é’Ÿçš„å·®å¼‚ï¼Œä½†ç»ä¸ä¼šä½äºé…ç½®ä¸­æŒ‡å®šçš„åˆå§‹é€€é¿å»¶è¿Ÿæ—¶é—´ã€‚</p>
</blockquote>
<p>é€€é¿æ—¶é—´åœ¨æ»¡è¶³æ‰§è¡Œæ¡ä»¶æƒ…å†µä¸‹ä¹Ÿå¹¶ä¸ä¼šå®Œå…¨ç²¾ç¡®ï¼Œè‹¥ä¸æ»¡è¶³æ‰§è¡Œæ¡ä»¶åˆ™ä¼šç­‰å¾…å…¶æ¡ä»¶æ»¡è¶³ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; æ— çº¦æŸ</span><br><span class="line">é—´éš”æ—¶é—´(ms): 10109 </span><br><span class="line">é—´éš”æ—¶é—´(ms): 20094</span><br><span class="line">é—´éš”æ—¶é—´(ms): 30093</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F; çº¦æŸï¼šè®¡è´¹(é‡)ç½‘ç»œç¯å¢ƒä¸‹</span><br><span class="line">é—´éš”æ—¶é—´(ms): 10121</span><br><span class="line">é—´éš”æ—¶é—´(ms): 20143</span><br><span class="line">é—´éš”æ—¶é—´(ms): 30103</span><br><span class="line">&#x2F;&#x2F; å…³é—­wifiå–ä¸ªèŒ¶å†è¿æ¥wifi</span><br><span class="line">é—´éš”æ—¶é—´(ms): 146521</span><br><span class="line">é—´éš”æ—¶é—´(ms): 50132</span><br></pre></td></tr></table></figure>
<p><strong><span id="work_tag">1.4.8 æ ‡è®°å·¥ä½œ</strong></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/define-work#tag_work">å‚è§æ–‡æ¡£</a></p>
<p>ä½ å¯ä»¥ä¸ºWorkRequestæ·»åŠ tagï¼Œä»è€Œä½¿å¾—ä½ å¯ä»¥é€šè¿‡<code>WorkManager.getWorkInfosByTag(String)</code>è·å–WorkRequestçš„å·¥ä½œçŠ¶æ€WorkInfoï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡<code>WorkManager.cancelAllWorkByTag(String)</code>å–æ¶ˆå¯¹åº”æ ‡è®°çš„æ‰€æœ‰WorkRequest.</p>
<p>ç”±WorkRequestä¸­å…³äºtagçš„å®šä¹‰<code>Set<String> mTags</code>å¯çŸ¥ï¼Œä½ å¯ä»¥ä¸ºWorkRequestå®šä¹‰å¤šä¸ªæ ‡è®°ï¼Œå½“ç„¶çš„ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºå¤šä¸ªWorkRequestå®šä¹‰åŒä¸€ä¸ªæ ‡è®°ç”¨ä»¥ç»Ÿä¸€ç®¡ç†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WorkRequest request &#x3D;</span><br><span class="line">       new OneTimeWorkRequest.Builder(SimpleWorker.class)</span><br><span class="line">       .addTag(&quot;TAG&quot;)</span><br><span class="line">       .build();</span><br><span class="line">&#x2F;&#x2F; æ ¹æ®tagå–æ¶ˆä»»åŠ¡</span><br><span class="line">WorkManager.getInstance(this).cancelAllWorkByTag(&quot;TAG&quot;);</span><br><span class="line">&#x2F;&#x2F; æ ¹æ®tagæŸ¥æ‰¾ä»»åŠ¡çŠ¶æ€</span><br><span class="line">WorkManager.getInstance(this).getWorkInfosByTag(&quot;TAG&quot;);</span><br></pre></td></tr></table></figure>
<p><strong><span id="work_cancel">1.4.9 å–æ¶ˆå·¥ä½œ</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; by id</span><br><span class="line">workManager.cancelWorkById(syncWorker.id);</span><br><span class="line">&#x2F;&#x2F; by name</span><br><span class="line">workManager.cancelUniqueWork(&quot;sync&quot;);</span><br><span class="line">&#x2F;&#x2F; by tag</span><br><span class="line">workManager.cancelAllWorkByTag(&quot;syncTag&quot;);</span><br></pre></td></tr></table></figure>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager/how-to/managing-work#stop-worker">ç‚¹æ­¤äº†è§£â€œåœæ­¢æ­£åœ¨è¿è¡Œçš„å·¥ä½œå™¨â€çš„ç›¸å…³å†…å®¹</a></p>
<h4 id="1-5-æ³¨æ„äº‹é¡¹"><a href="#1-5-æ³¨æ„äº‹é¡¹" class="headerlink" title=" 1.5 æ³¨æ„äº‹é¡¹"></a><span id="attention"> 1.5 æ³¨æ„äº‹é¡¹</h4><p>è¿™é‡Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä½¿ç”¨WorkManagerçš„ä¸€äº›å°Tipsã€‚</p>
<ul>
<li>PeriodicWorkRequestå‘¨æœŸä»»åŠ¡å¯ä»¥å®šä¹‰çš„æœ€çŸ­é‡å¤é—´éš”æ˜¯ 15 åˆ†é’Ÿï¼ˆä¸ JobScheduler API ç›¸åŒï¼‰</li>
<li>å»¶è¿Ÿå·¥ä½œï¼šæ‰§è¡Œå·¥ä½œå™¨çš„ç¡®åˆ‡æ—¶é—´è¿˜å–å†³äº WorkRequest ä¸­ä½¿ç”¨çš„çº¦æŸå’Œç³»ç»Ÿä¼˜åŒ–æ–¹å¼ã€‚WorkManager ç»è¿‡è®¾è®¡ï¼Œèƒ½å¤Ÿåœ¨æ»¡è¶³è¿™äº›çº¦æŸçš„æƒ…å†µä¸‹æä¾›å¯èƒ½çš„æœ€ä½³è¡Œä¸ºã€‚</li>
<li>é€€é¿å»¶è¿Ÿæ—¶é—´ä¸ç²¾ç¡®ï¼Œåœ¨ä¸¤æ¬¡é‡è¯•ä¹‹é—´å¯èƒ½ä¼šæœ‰å‡ ç§’é’Ÿçš„å·®å¼‚ï¼Œä½†ç»ä¸ä¼šä½äºé…ç½®ä¸­æŒ‡å®šçš„åˆå§‹é€€é¿å»¶è¿Ÿæ—¶é—´ã€‚</li>
<li>cancelAllWorkByTag(String) ä¼šå–æ¶ˆå…·æœ‰ç»™å®šæ ‡è®°çš„æ‰€æœ‰å·¥ä½œã€‚</li>
<li>WorkRequestä¿è¯ä¸€å®šæ‰§è¡Œï¼Œä½†ä¸ä¿è¯ä¸€å®šåœ¨ä»€ä¹ˆæ—¶é—´æ‰§è¡Œã€‚</li>
</ul>
<hr>
<p>å¼•ç”¨æ–‡çŒ®ï¼š</p>
<ol>
<li><a href="https://developer.android.google.cn/topic/libraries/architecture/workmanager">WorkManagerå®˜æ–¹æ–‡æ¡£</a></li>
</ol>
<h4 id="æºç ç¯‡æ­£åœ¨å¥‹åŠ›ç å­—ä¸­ã€‚ã€‚ã€‚"><a href="#æºç ç¯‡æ­£åœ¨å¥‹åŠ›ç å­—ä¸­ã€‚ã€‚ã€‚" class="headerlink" title="æºç ç¯‡æ­£åœ¨å¥‹åŠ›ç å­—ä¸­ã€‚ã€‚ã€‚"></a>æºç ç¯‡æ­£åœ¨å¥‹åŠ›ç å­—ä¸­ã€‚ã€‚ã€‚</h4>]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(ä¸ƒ) - BroadcastReceiver</title>
    <url>/2021/02/15/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%83)%20-%20BroadcastReceiver/</url>
    <content><![CDATA[<ul>
<li><a href="#source_broadcast">æºç ç¯‡ - å¹¿æ’­æ¥æ”¶è€…</a></li>
<li><a href="#ForceStopRunnable">ForceStopRunnable</a><ul>
<li><a href="#fsr_BroadcastReceiver">BroadcastReceiver</a></li>
</ul>
</li>
<li><a href="#ConstraintProxy">ConstraintProxy</a><ul>
<li><a href="#BatteryNotLowProxy">BatteryNotLowProxy</a></li>
<li><a href="#BatteryChargingProxy">BatteryChargingProxy</a></li>
<li><a href="#StorageNotLowProxy">StorageNotLowProxy</a></li>
<li><a href="#NetworkStateProxy">NetworkStateProxy</a></li>
</ul>
</li>
<li><a href="#ConstraintProxyUpdateReceiver">ConstraintProxyUpdateReceiver</a></li>
<li><a href="#RescheduleReceiver">RescheduleReceiver</a></li>
<li><a href="#DiagnosticsReceiver">DiagnosticsReceiver</a></li>
</ul>
<h3 id="æºç ç¯‡-å¹¿æ’­æ¥æ”¶è€…"><a href="#æºç ç¯‡-å¹¿æ’­æ¥æ”¶è€…" class="headerlink" title=" æºç ç¯‡ - å¹¿æ’­æ¥æ”¶è€…"></a><span id="source_broadcast"> æºç ç¯‡ - å¹¿æ’­æ¥æ”¶è€…</h3><p>æ­¤ç¯‡å°†é‡ç‚¹ä»‹ç»WorkManagerä½¿ç”¨çš„é‡è¦ç»„ä»¶:å¹¿æ’­æ¥æ”¶è€…,ä¸»è¦æ¶‰åŠæ„å¤–åœæ­¢ç›‘å¬å¹¿æ’­<code>ForceStopRunnable.BroadcastReceiver</code>ã€çº¦æŸçŠ¶æ€ç›‘å¬å¹¿æ’­<code>ConstraintProxy.*</code>ã€å¯åŠ¨é‡æ–°è§„åˆ’æœåŠ¡çš„å¹¿æ’­<code>RescheduleReceiver</code>ã€ä»£ç†çº¦æŸæ›´æ–°å¹¿æ’­<code>ConstraintProxyUpdateReceiver</code>ã€æµ‹è¯•è¯Šæ–­å¹¿æ’­<code>DiagnosticsReceiver</code>ã€‚æ­¤ç±»ç»„ä»¶ä¸ºWorkManagerç¨³å®šè¿è¡Œã€é‡æ–°è§„åˆ’ã€çº¦æŸæ›´æ–°æä¾›äº†æ”¯æŒã€‚</p>
<a id="more"></a>

<h4 id="ForceStopRunnable"><a href="#ForceStopRunnable" class="headerlink" title=" ForceStopRunnable"></a><span id="ForceStopRunnable"> ForceStopRunnable</h4><blockquote>
<p>WorkManager is restarted after an app was force stopped. Alarms and Jobs get cancelled when an application is force-stopped. To reschedule, we create a pending alarm that will not survive force stops.</p>
</blockquote>
<p>å¼ºåˆ¶åœæ­¢åº”ç”¨ç¨‹åºåï¼Œ<code>WorkManager</code>å°†é‡æ–°å¯åŠ¨ã€‚å½“åº”ç”¨è¢«å¼ºåˆ¶åœæ­¢æ—¶ï¼Œ<code>Alarms</code>å’Œ<code>Jobs</code>å°†è¢«å–æ¶ˆã€‚ä¸ºäº†é‡æ–°å®‰æ’ï¼Œæˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªæ— æ³•é€šè¿‡å¼ºåˆ¶åœæ­¢çš„<code>Alarm</code>ã€‚</p>
<p>åœ¨ä»‹ç»<code>ForceStopRunnable.BroadcastReceiver</code>å‰,æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹å®ƒçš„å¤–éƒ¨ç±»<code>ForceStopRunnable</code>ã€‚</p>
<p><code>ForceStopRunnable</code>æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯<code>run</code>, å…¶åœ¨<code>WorkManager</code>åˆå§‹åŒ–æ—¶è°ƒç”¨<code>WorkManagerImpl.internalInit()</code>, æ„é€ å¹¶è°ƒç”¨äº†<code>ForceStopRunnable.run()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦ï¼Œå°†æ•°æ®åº“è¿ç§»åˆ°ä¸å¤‡ä»½çš„ç›®å½•ã€‚</span></span><br><span class="line">    WorkDatabasePathHelper.migrateDatabase(mContext);</span><br><span class="line">    <span class="comment">// æ¸…é™¤å±äºWorkManagerçš„æ— æ•ˆä½œä¸šï¼Œä»¥åŠç”±äºåº”ç”¨ç¨‹åºå´©æºƒ(è¿è¡ŒçŠ¶æ€)è€Œå¯èƒ½è¢«ä¸­æ–­çš„ä½œä¸šã€‚</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> needsScheduling = cleanUp();</span><br><span class="line">        <span class="keyword">if</span> (shouldRescheduleWorkers()) &#123;</span><br><span class="line">            mWorkManager.rescheduleEligibleWork();</span><br><span class="line">            <span class="comment">// å°†WorkManageræ ‡è®°ä¸ºå·²è¿ç§»ã€‚</span></span><br><span class="line">            mWorkManager.getPreferenceUtils().setNeedsReschedule(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isForceStopped()) &#123;</span><br><span class="line">            <span class="comment">// å¼‚å¸¸é€€å‡ºï¼Œé‡æ–°è§„åˆ’ä»»åŠ¡</span></span><br><span class="line">            mWorkManager.rescheduleEligibleWork();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (needsScheduling) &#123;</span><br><span class="line">           <span class="comment">// å‘ç°æœªå®Œæˆä»»åŠ¡ï¼Œè§„åˆ’å®ƒä»¬</span></span><br><span class="line">            Schedulers.schedule(</span><br><span class="line">                    mWorkManager.getConfiguration(),</span><br><span class="line">                    mWorkManager.getWorkDatabase(),</span><br><span class="line">                    mWorkManager.getSchedulers());</span><br><span class="line">        &#125;</span><br><span class="line">        mWorkManager.onForceStopRunnableCompleted();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLiteCantOpenDatabaseException</span><br><span class="line">            | SQLiteDatabaseCorruptException</span><br><span class="line">            | SQLiteAccessPermException exception) &#123;</span><br><span class="line">        <span class="comment">// ForceStopRunnableé€šå¸¸æ˜¯è®¿é—®æ•°æ®åº“(æˆ–åº”ç”¨ç¨‹åºçš„å†…éƒ¨æ•°æ®ç›®å½•)çš„ç¬¬ä¸€ä»¶äº‹ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™æ„å‘³ç€å¥‡æ€ªçš„PackageManageré”™è¯¯è¢«å½’å’äºForceStopRunnableï¼Œè¿™æ˜¯ä¸å¹¸çš„ã€‚</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ºå¼€å‘äººå‘˜æä¾›äº†æ›´å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚</span></span><br><span class="line">        String message =</span><br><span class="line">                <span class="string">&quot;The file system on the device is in a bad state. WorkManager cannot access &quot;</span></span><br><span class="line">                        + <span class="string">&quot;the app&#x27;s internal data store.&quot;</span>;</span><br><span class="line">        Logger.get().error(TAG, message, exception);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(message, exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°<code>ForceStopRunable</code>ä¸»è¦èŒè´£æ˜¯å¤„ç†å¼‚å¸¸ä¸­æ–­åå¯¹WorkManagerä¸­ä»»åŠ¡è¿›è¡Œæ¸…ç†å’Œé‡æ–°è§„åˆ’,<code>run()</code>ä¸»è¦å¹²äº†3ä»¶äº‹:</p>
<ul>
<li>å¦‚æœéœ€è¦ï¼Œå°†æ•°æ®åº“è¿ç§»åˆ°ä¸å¤‡ä»½çš„ç›®å½•</li>
<li>å–æ¶ˆæ— æ•ˆçš„JobSchedulerä½œä¸š/é‡æ–°è°ƒåº¦ä»¥å‰æ­£åœ¨è¿è¡Œçš„ä½œä¸š</li>
<li>é’ˆå¯¹å¼‚å¸¸ä¸­æ–­æ—¶WorkManagerçš„çŠ¶æ€è¿›è¡Œä¸åŒçš„è°ƒåº¦æ“ä½œ</li>
</ul>
<p>é‚£ä¹ˆä»–æ˜¯å¦‚ä½•åˆ¤æ–­æ˜¯å¦æ˜¯å¼ºåˆ¶ä¸­æ–­çš„å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å¼ºåˆ¶ä¸­æ–­åˆ¤æ–­ä»£ç <code>isForceStopped()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isForceStopped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“åº”ç”¨ç¨‹åºåœ¨Eclair MR1å¼ºåˆ¶åœæ­¢å¯åŠ¨æ—¶ï¼ŒAlarmè¢«å–æ¶ˆã€‚</span></span><br><span class="line">    <span class="comment">// åœ¨N-MR1ä¸­å¼•å…¥äº†å¼ºåˆ¶åœæ­¢ä½œä¸šçš„å–æ¶ˆ(SDK 25)ã€‚</span></span><br><span class="line">    <span class="comment">// å°½ç®¡API 23ã€24å¯èƒ½æ˜¯å®‰å…¨çš„ï¼Œä½†oemå¯èƒ½ä¼šé€‰æ‹©é‡‡ç”¨ä¸åŒçš„æ–¹æ³•ã€‚</span></span><br><span class="line">    PendingIntent pendingIntent = getPendingIntent(mContext, FLAG_NO_CREATE);</span><br><span class="line">    <span class="keyword">if</span> (pendingIntent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        setAlarm(mContext);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åˆ¤æ–­é—¹é’Ÿå¹¿æ’­æ˜¯å¦å­˜åœ¨æ¥ç¡®å®šåº”ç”¨æ˜¯å¦è¢«å¼ºè¡Œåœæ­¢ï¼Œè‹¥ä¸å­˜åœ¨å³é—¹é’ŸAlarmè¢«å–æ¶ˆå³æ˜¯å¼ºåˆ¶ä¸­æ–­ï¼Œæ­¤æ—¶å°†é‡æ–°è®¾ç½®ä¸€ä¸ªé—¹é’ŸAlarm;</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¸Šæ–‡ä¸­çš„<code>ForceStopRunnable.BroadcastReceiver</code>é—¹é’Ÿå¹¿æ’­ã€‚</p>
<h5 id="BroadcastReceiver"><a href="#BroadcastReceiver" class="headerlink" title=" BroadcastReceiver"></a><span id="BroadcastReceiver"> BroadcastReceiver</h5><blockquote>
<p>A {@link android.content.BroadcastReceiver} which takes care of recreating the long lived alarm which helps track force stops for an application.  This is the target of the alarm set by ForceStopRunnable in {@link #setAlarm(Context)}. ä¸€ä¸ª{@link android.content.BroadcastReceiver}è´Ÿè´£é‡æ–°åˆ›å»ºé•¿å¯¿å‘½çš„Alarmï¼Œè¿™æœ‰åŠ©äºè·Ÿè¸ªåº”ç”¨ç¨‹åºçš„å¼ºåˆ¶åœæ­¢ã€‚è¿™æ˜¯åœ¨{@link #setAlarm(Context)}ä¸­ç”±forceoprunnableè®¾ç½®çš„Alarmç›®æ ‡ã€‚</p>
</blockquote>
<p>ä»æè¿°å¯çŸ¥ï¼Œæ­¤å¹¿æ’­çš„ä¸»è¦ç›®çš„æ˜¯è´Ÿè´£åˆ›å»ºé•¿æœŸå­˜æ´»çš„é—¹é’Ÿï¼Œç”¨ä»¥è¿½è¸ªåº”ç”¨ç¨‹åºçš„å¼ºåˆ¶åœæ­¢ã€‚</p>
<p>å…¶ä»£ç ç›¸å¯¹ç®€å•ï¼Œè‹¥æ”¶åˆ°actionä¸º<code>ACTION_FORCE_STOP_RESCHEDULE</code>çš„å¹¿æ’­ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªé•¿è¾¾åå¹´çš„å¯å”¤é†’è®¾å¤‡çš„é—¹é’Ÿï¼Œç„¶åå†æ¥ä¸€æ¬¡ï¼ˆå‘é€actionä¸º<code>ACTION_FORCE_STOP_RESCHEDULE</code>çš„å¹¿æ’­ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ForceStopRunnable</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PendingIntent <span class="title">getPendingIntent</span><span class="params">(Context context, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    Intent intent = getIntent(context);</span><br><span class="line">    <span class="comment">// å‘é€å¹¿æ’­çš„PendingIntent</span></span><br><span class="line">    <span class="keyword">return</span> PendingIntent.getBroadcast(context, ALARM_ID, intent, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Intent <span class="title">getIntent</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    intent.setComponent(<span class="keyword">new</span> ComponentName(context, ForceStopRunnable.BroadcastReceiver.class));</span><br><span class="line">    <span class="comment">// å¹¿æ’­intent</span></span><br><span class="line">    intent.setAction(ACTION_FORCE_STOP_RESCHEDULE);</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAlarm</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">    <span class="comment">//ä½¿ç”¨FLAG_UPDATE_CURRENTï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è¦è¿™ä¸ªAlarmçš„ä¸€æ¬¡å®ä¾‹</span></span><br><span class="line">    PendingIntent pendingIntent = getPendingIntent(context, FLAG_UPDATE_CURRENT);</span><br><span class="line">    <span class="comment">// è®¾ç½®æ‰§è¡Œæ—¶é—´ä¸ºåå¹´</span></span><br><span class="line">    <span class="keyword">long</span> triggerAt = System.currentTimeMillis() + TEN_YEARS;</span><br><span class="line">    <span class="keyword">if</span> (alarmManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</span><br><span class="line">            <span class="comment">// RTC_WAKEUPï¼šç»å¯¹æ—¶é—´å¯å”¤é†’ç±»å‹ï¼Œåå¹´åï¼Œå¹²å•¥</span></span><br><span class="line">            alarmManager.setExact(RTC_WAKEUP, triggerAt, pendingIntent);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alarmManager.set(RTC_WAKEUP, triggerAt, pendingIntent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">content</span>.<span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Our alarm somehow got triggered, so make sure we reschedule it.  This should really never happen because we set it so far in the future.</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬çš„é—¹é’Ÿä¸çŸ¥æ€ä¹ˆè¢«è§¦å‘äº†ï¼Œæ‰€ä»¥ä¸€å®šè¦é‡æ–°å®‰æ’æ—¶é—´ã€‚è¿™æ˜¯ä¸åº”è¯¥å‘ç”Ÿçš„ï¼Œå› ä¸ºæˆ‘ä»¬å°†å®ƒè®¾ç½®åœ¨é¥è¿œçš„æœªæ¥ï¼ˆå˜¿ï¼Œåå¹´åå†è§ï¼‰ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String action = intent.getAction();</span><br><span class="line">            <span class="keyword">if</span> (ACTION_FORCE_STOP_RESCHEDULE.equals(action)) &#123;</span><br><span class="line">                Logger.get().verbose(</span><br><span class="line">                        TAG,</span><br><span class="line">                        <span class="string">&quot;Rescheduling alarm that keeps track of force-stops.&quot;</span>);</span><br><span class="line">                ForceStopRunnable.setAlarm(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰å‰æ–‡å¯çŸ¥ï¼Œåº”ç”¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–WorkManagerï¼ŒWorkManageråˆå§‹åŒ–åˆ™ä¼šæ‰§è¡Œ<code>ForceStopRunnable.run()</code>, æ­¤æ—¶ä¸€èˆ¬ä¼šè°ƒç”¨setAlarm(), åˆ›å»ºAlarmï¼Œæç«¯æƒ…å†µä¸‹ä¼šå­˜åœ¨åº”ç”¨å­˜æ´»åå¹´çš„æƒ…å†µï¼Œæ­¤<code>BroadcastReceiver</code>å³æ˜¯ç”¨äºå¤„ç†è¿™ç§æƒ…å†µçš„ï¼Œå½“åå¹´ååˆæ”¶åˆ°äº†è¿™ä¸ªå¹¿æ’­ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨åˆ›å»ºä¸€ä¸ªåå¹´æœŸçš„é—¹é’ŸAlarmï¼Œå“¦ï¼Œå¤©å‘ã€‚</p>
<h4 id="ConstraintProxy"><a href="#ConstraintProxy" class="headerlink" title=" ConstraintProxy"></a><span id="ConstraintProxy"> ConstraintProxy</h4><h5 id="BatteryNotLowProxy"><a href="#BatteryNotLowProxy" class="headerlink" title=" BatteryNotLowProxy"></a><span id="BatteryNotLowProxy"> BatteryNotLowProxy</h5><h5 id="BatteryChargingProxy"><a href="#BatteryChargingProxy" class="headerlink" title=" BatteryChargingProxy"></a><span id="BatteryChargingProxy"> BatteryChargingProxy</h5><h5 id="StorageNotLowProxy"><a href="#StorageNotLowProxy" class="headerlink" title=" StorageNotLowProxy"></a><span id="StorageNotLowProxy"> StorageNotLowProxy</h5><h5 id="NetworkStateProxy"><a href="#NetworkStateProxy" class="headerlink" title=" NetworkStateProxy"></a><span id="NetworkStateProxy"> NetworkStateProxy</h5><p>ä¸Šè¿°<code>BatteryNotLowProxy</code>ã€<code>BatteryChargingProxy</code>ã€<code>StorageNotLowProxy</code>ã€<code>NetworkStateProxy</code>å‡æ˜¯<code>ConstraintProxy</code>çš„å­ç±»,å®ç°å‡ä¸€è‡´,ä»…æœ‰æ³¨å†Œactionä¸åŒ,ç”¨ä»¥é’ˆå¯¹ä¸åŒactionçš„ç³»ç»Ÿå¹¿æ’­æ›´æ–°çº¦æŸçŠ¶æ€, æ­¤å¤„ä¸€å¹¶åˆ†æä¹‹ã€‚</p>
<p>ä»¥<code>NetworkStateProxy</code>ä¸ºä¾‹ï¼Œå½“ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œåº”ç”¨æ”¶åˆ°<code>"android.net.conn.CONNECTIVITY_CHANGE"</code>å¹¿æ’­ï¼Œè§¦å‘<code>NetworkStateProxy.onReceive()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">    Logger.get().debug(TAG, String.format(<span class="string">&quot;onReceive : %s&quot;</span>, intent));</span><br><span class="line">    Intent constraintChangedIntent = CommandHandler.createConstraintsChangedIntent(context);</span><br><span class="line">    context.startService(constraintChangedIntent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>CommandHandler.createConstraintsChangedIntent(context)</code>è°ƒèµ·<code>SystemAlarmService</code>, å…¶intentçš„actionä¸º<code>"ACTION_CONSTRAINTS_CHANGED"</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Intent <span class="title">createConstraintsChangedIntent</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(context, SystemAlarmService.class);</span><br><span class="line">    intent.setAction(ACTION_CONSTRAINTS_CHANGED);</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±<a href="#https://tinlone.com/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)%20-%20SystemAlarmService/">WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(ä¸‰) - SystemAlarmService</a>è®²è¿°æµç¨‹å¯çŸ¥ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>CommandHandler.onHandleIntent()</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void onHandleIntent(@NonNull Intent intent, int startId, @NonNull SystemAlarmDispatcher dispatcher) &#123;</span><br><span class="line">        String action &#x3D; intent.getAction();</span><br><span class="line"></span><br><span class="line">        if (ACTION_CONSTRAINTS_CHANGED.equals(action)) &#123;</span><br><span class="line">            handleConstraintsChanged(intent, startId, dispatcher);</span><br><span class="line">        &#125; </span><br><span class="line">        &#x2F;&#x2F; å…¶ä»–</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void handleConstraintsChanged(</span><br><span class="line">        @NonNull Intent intent, int startId,</span><br><span class="line">        @NonNull SystemAlarmDispatcher dispatcher) &#123;</span><br><span class="line">    ConstraintsCommandHandler changedCommandHandler &#x3D;</span><br><span class="line">            new ConstraintsCommandHandler(mContext, startId, dispatcher);</span><br><span class="line">    changedCommandHandler.handleConstraintsChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶intentçš„actionä¸º<code>"ACTION_CONSTRAINTS_CHANGED"</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>ConstraintsCommandHandler.handleConstraintsChanged()</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void handleConstraintsChanged() &#123;</span><br><span class="line">    List&lt;WorkSpec&gt; candidates &#x3D; mDispatcher.getWorkManager().getWorkDatabase()</span><br><span class="line">            .workSpecDao()</span><br><span class="line">            .getScheduledWork();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;æ›´æ–°çº¦æŸä»£ç†ä»¥æ½œåœ¨åœ°ç¦ç”¨å…ˆå‰å®Œæˆçš„WorkSpecsçš„ä»£ç†ã€‚</span><br><span class="line">    ConstraintProxy.updateAll(mContext, candidates);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è¿™éœ€è¦åœ¨æ¯ä¸ªçº¦æŸæ§åˆ¶å™¨ä¸­å¡«å……åŒ¹é…çš„WorkSpec idã€‚æ ‡è®°æ­£åœ¨æ›´æ–°è¿™äº›å·¥ä½œçš„çŠ¶æ€</span><br><span class="line">    mWorkConstraintsTracker.replace(candidates);</span><br><span class="line"></span><br><span class="line">    List&lt;WorkSpec&gt; eligibleWorkSpecs &#x3D; new ArrayList&lt;&gt;(candidates.size());</span><br><span class="line">    &#x2F;&#x2F; ç­›é€‰å€™é€‰äººåº”è¯¥å·²ç»è§„åˆ’å¥½äº†ã€‚</span><br><span class="line">    long now &#x3D; System.currentTimeMillis();</span><br><span class="line">    for (WorkSpec workSpec : candidates) &#123;</span><br><span class="line">        String workSpecId &#x3D; workSpec.id;</span><br><span class="line">        long triggerAt &#x3D; workSpec.calculateNextRunTime();</span><br><span class="line">        &#x2F;&#x2F; æ—¶é—´æ¡ä»¶ç¬¦åˆä¸”æ— çº¦æŸæˆ–çº¦æŸå·²ç¬¦åˆï¼Œåˆ™åŠ å…¥ç¬¦åˆæ¡ä»¶é›†åˆ</span><br><span class="line">        if (now &gt;&#x3D; triggerAt &amp;&amp; (!workSpec.hasConstraints()</span><br><span class="line">                || mWorkConstraintsTracker.areAllConstraintsMet(workSpecId))) &#123;</span><br><span class="line">            eligibleWorkSpecs.add(workSpec);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (WorkSpec workSpec : eligibleWorkSpecs) &#123;</span><br><span class="line">        String workSpecId &#x3D; workSpec.id;</span><br><span class="line">        Intent intent &#x3D; CommandHandler.createDelayMetIntent(mContext, workSpecId);</span><br><span class="line">        &#x2F;&#x2F; å‘Šè¯‰SystemAlarmDispatcherè¿™ä¸ªå·¥ä½œå·²ç»ç¬¦åˆæ¡ä»¶äº†ï¼Œè¯·ç»™å®‰æ’ä¸Š</span><br><span class="line">        mDispatcher.postOnMainThread(</span><br><span class="line">                new SystemAlarmDispatcher.AddRunnable(mDispatcher, intent, mStartId));</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; é‡ç½®æ­£åœ¨æ›´æ–°è¿™äº›å·¥ä½œçŠ¶æ€çš„æ ‡è®°</span><br><span class="line">    mWorkConstraintsTracker.reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•å…ˆè·å–äº†è§„åˆ’ä¸­çš„å·¥ä½œç”Ÿæˆé›†åˆï¼Œè°ƒç”¨äº†<code>ConstraintProxy.updateAll()</code>æ–¹æ³•æ›´æ–°çº¦æŸä»£ç†ä»¥æ½œåœ¨åœ°ç¦ç”¨å…ˆå‰å®Œæˆçš„WorkSpecsçš„ä»£ç†ï¼Œéå†åˆ¤æ–­æ¯ä¸ªWorkSpecæ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œéå†ç¬¦åˆçº¦æŸæ¡ä»¶çš„åˆ—è¡¨ï¼Œå‘Šè¯‰<code>SystemAlarmDispatcher</code>æ·»åŠ ä»»åŠ¡ï¼Œè‹¥<code>SystemAlarmDispatcher</code>ä¸­æ— ä»»åŠ¡åˆ™åˆ†å‘æ‰§è¡Œä»»åŠ¡ï¼ˆè¿˜è®°å¾—processCommand()æ˜¯ä¸€ä¸ªç¯çŠ¶çš„è½®è¯¢å—ï¼Ÿï¼‰ã€‚</p>
<p><code>SystemAlarmDispatcher.AddRunnable()</code>åç»­è°ƒç”¨<code>SystemAlarmDispatcher.add()</code>åœ¨<a href="#https://tinlone.com/2021/02/06/WorkManager%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90(%E4%B8%89)%20-%20SystemAlarmService/">WorkManageråŸºæœ¬ä½¿ç”¨åŠæºç åˆ†æ(ä¸‰) - SystemAlarmService</a>ä¸­æœ‰è¯¦ç»†è¯´æ˜ï¼Œæ­¤å¤„ä»…æ‘˜è¦æµç¨‹ã€‚<br><code>SystemAlarmDispatcher.AddRunnable()</code> -&gt; <code>SystemAlarmDispatcher.add()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SystemAlarmDispatcher</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Intent intent, <span class="keyword">final</span> <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String action = intent.getAction();</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(action)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CommandHandler.ACTION_CONSTRAINTS_CHANGED.equals(action)</span><br><span class="line">            &amp;&amp; hasIntentWithAction(CommandHandler.ACTION_CONSTRAINTS_CHANGED)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    intent.putExtra(KEY_START_ID, startId);</span><br><span class="line">    <span class="keyword">synchronized</span> (mIntents) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> hasCommands = !mIntents.isEmpty();</span><br><span class="line">        mIntents.add(intent);</span><br><span class="line">        <span class="keyword">if</span> (!hasCommands) &#123;</span><br><span class="line">            processCommand();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mDispatcher.add(mIntent, mStartId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ConstraintProxyUpdateReceiver"><a href="#ConstraintProxyUpdateReceiver" class="headerlink" title=" ConstraintProxyUpdateReceiver"></a><span id="ConstraintProxyUpdateReceiver"> ConstraintProxyUpdateReceiver</h4><p>ä¸Šé¢è®²åˆ°<code>ConstraintsCommandHandler.handleConstraintsChanged()</code>ç¬¬ä¸€æ­¥ä¼šè°ƒç”¨<code>ConstraintProxy.updateAll(mContext, candidates)</code>æœ€ç»ˆä¼šå‘é€å¹¿æ’­ç»™<code>ConstraintProxyUpdateReceiver</code>æ›´æ–°çº¦æŸä»£ç†ä»¥æ½œåœ¨åœ°ç¦ç”¨å…ˆå‰å®Œæˆçš„WorkSpecsçš„ä»£ç†,æˆ‘ä»¬ç®€å•è¿‡ä¸€ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static void updateAll(Context context, List&lt;WorkSpec&gt; workSpecs) &#123;</span><br><span class="line">    boolean batteryNotLowProxyEnabled &#x3D; false;</span><br><span class="line">    boolean batteryChargingProxyEnabled &#x3D; false;</span><br><span class="line">    boolean storageNotLowProxyEnabled &#x3D; false;</span><br><span class="line">    boolean networkStateProxyEnabled &#x3D; false;</span><br><span class="line">&#x2F;&#x2F; æŸ¥æ‰¾æ¯ä¸ªWorkSpecï¼ˆæ˜¯å¦æœ‰ï¼‰çº¦æŸæ¡ä»¶çŠ¶æ€</span><br><span class="line">    for (WorkSpec workSpec : workSpecs) &#123;</span><br><span class="line">        Constraints constraints &#x3D; workSpec.constraints;</span><br><span class="line">        batteryNotLowProxyEnabled |&#x3D; constraints.requiresBatteryNotLow();</span><br><span class="line">        batteryChargingProxyEnabled |&#x3D; constraints.requiresCharging();</span><br><span class="line">        storageNotLowProxyEnabled |&#x3D; constraints.requiresStorageNotLow();</span><br><span class="line">        networkStateProxyEnabled |&#x3D; constraints.getRequiredNetworkType() !&#x3D; NOT_REQUIRED;</span><br><span class="line">&#x2F;&#x2F; çŸ¥é“éœ€è¦å…¨éƒ¨å¹¿æ’­æ¥æ”¶è€…ï¼Œå°±ä¸ç”¨åˆ¤æ–­äº†</span><br><span class="line">        if (batteryNotLowProxyEnabled &amp;&amp; batteryChargingProxyEnabled</span><br><span class="line">                &amp;&amp; storageNotLowProxyEnabled &amp;&amp; networkStateProxyEnabled) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Intent updateProxyIntent &#x3D;</span><br><span class="line">            ConstraintProxyUpdateReceiver.newConstraintProxyUpdateIntent(</span><br><span class="line">                    context,</span><br><span class="line">                    batteryNotLowProxyEnabled,</span><br><span class="line">                    batteryChargingProxyEnabled,</span><br><span class="line">                    storageNotLowProxyEnabled,</span><br><span class="line">                    networkStateProxyEnabled);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ConstraintProxies are being updated via a separate broadcast receiver.</span><br><span class="line">    &#x2F;&#x2F; For more information on why we do this look at b&#x2F;73549299</span><br><span class="line">    context.sendBroadcast(updateProxyIntent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå…ˆæ˜¯åˆ¤æ–­éœ€è¦å“ªäº›å¹¿æ’­æ¥æ”¶è€…ï¼Œä¼šå‘é€å¹¿æ’­ç»™ConstraintProxyUpdateReceiverï¼Œæœ€ç»ˆä¼šè°ƒç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onReceive(@NonNull final Context context, @Nullable final Intent intent) &#123;</span><br><span class="line">    String action &#x3D; intent !&#x3D; null ? intent.getAction() : null;</span><br><span class="line">    if (!ACTION.equals(action)) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        final PendingResult pendingResult &#x3D; goAsync();</span><br><span class="line">        WorkManagerImpl workManager &#x3D; WorkManagerImpl.getInstance(context);</span><br><span class="line">        TaskExecutor taskExecutor &#x3D; workManager.getWorkTaskExecutor();</span><br><span class="line">        taskExecutor.executeOnBackgroundThread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; åœ¨åå°çº¿ç¨‹ä¸Šæ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºä½¿ç”¨PackageManageræ¥å¯ç”¨æˆ–ç¦ç”¨ä»£ç†æ¶‰åŠåˆ°å¯¹æ–‡ä»¶ç³»ç»Ÿçš„å†™æ“ä½œã€‚</span><br><span class="line">                    boolean batteryNotLowProxyEnabled &#x3D; intent.getBooleanExtra(</span><br><span class="line">                            KEY_BATTERY_NOT_LOW_PROXY_ENABLED, false);</span><br><span class="line">                    boolean batteryChargingProxyEnabled &#x3D; intent.getBooleanExtra(</span><br><span class="line">                            KEY_BATTERY_CHARGING_PROXY_ENABLED, false);</span><br><span class="line">                    boolean storageNotLowProxyEnabled &#x3D; intent.getBooleanExtra(</span><br><span class="line">                            KEY_STORAGE_NOT_LOW_PROXY_ENABLED, false);</span><br><span class="line">                    boolean networkStateProxyEnabled &#x3D; intent.getBooleanExtra(</span><br><span class="line">                            KEY_NETWORK_STATE_PROXY_ENABLED, false);</span><br><span class="line"></span><br><span class="line">                    Logger.get().debug(</span><br><span class="line">                            TAG,</span><br><span class="line">                            String.format(&quot;Updating proxies: BatteryNotLowProxy enabled (%s), &quot;</span><br><span class="line">                                            + &quot;BatteryChargingProxy enabled (%s), &quot;</span><br><span class="line">                                            + &quot;StorageNotLowProxy (%s), &quot;</span><br><span class="line">                                            + &quot;NetworkStateProxy enabled (%s)&quot;,</span><br><span class="line">                                    batteryNotLowProxyEnabled,</span><br><span class="line">                                    batteryChargingProxyEnabled,</span><br><span class="line">                                    storageNotLowProxyEnabled,</span><br><span class="line">                                    networkStateProxyEnabled));</span><br><span class="line"></span><br><span class="line">                    PackageManagerHelper.setComponentEnabled(context, BatteryNotLowProxy.class,</span><br><span class="line">                            batteryNotLowProxyEnabled);</span><br><span class="line">                    PackageManagerHelper.setComponentEnabled(context,</span><br><span class="line">                            BatteryChargingProxy.class,</span><br><span class="line">                            batteryChargingProxyEnabled);</span><br><span class="line">                    PackageManagerHelper.setComponentEnabled(context, StorageNotLowProxy.class,</span><br><span class="line">                            storageNotLowProxyEnabled);</span><br><span class="line">                    PackageManagerHelper.setComponentEnabled(context, NetworkStateProxy.class,</span><br><span class="line">                            networkStateProxyEnabled);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    pendingResult.finish();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ‰§è¡Œäº†è·å–å‰æ–‡æä¾›çš„éœ€è¦å“ªäº›çº¦æŸå¹¿æ’­æ¥æ”¶å™¨ï¼Œè°ƒç”¨<code>PackageManagerHelper.setComponentEnabled(context, StorageNotLowProxy.class, storageNotLowProxyEnabled)</code>æ›´æ”¹å¹¿æ’­æ¥æ”¶è€…æ³¨å†Œä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * ä½¿ç”¨&#123;@link PackageManager&#125; å»å¼€&#x2F;å…³manifestå£°æ˜çš„ç»„ä»¶</span><br><span class="line"> *</span><br><span class="line"> * @param context &#123;@link Context&#125;</span><br><span class="line"> * @param klazz The class of component</span><br><span class="line"> * @param enabled &#123;@code true&#125; å¼€å…³ç»„ä»¶</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static void setComponentEnabled(</span><br><span class="line">        @NonNull Context context,</span><br><span class="line">        @NonNull Class&lt;?&gt; klazz,</span><br><span class="line">        boolean enabled) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        PackageManager packageManager &#x3D; context.getPackageManager();</span><br><span class="line">        ComponentName componentName &#x3D; new ComponentName(context, klazz.getName());</span><br><span class="line">        packageManager.setComponentEnabledSetting(componentName,</span><br><span class="line">                enabled</span><br><span class="line">                        ? PackageManager.COMPONENT_ENABLED_STATE_ENABLED</span><br><span class="line">                        : PackageManager.COMPONENT_ENABLED_STATE_DISABLED,</span><br><span class="line">                PackageManager.DONT_KILL_APP);</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception exception) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="RescheduleReceiver"><a href="#RescheduleReceiver" class="headerlink" title=" RescheduleReceiver"></a><span id="RescheduleReceiver"> RescheduleReceiver</h4><blockquote>
<p>Reschedules alarms on BOOT_COMPLETED and other similar scenarios.</p>
</blockquote>
<p>åœ¨BOOT_COMPLETEDå’Œå…¶ä»–ç±»ä¼¼åœºæ™¯ä¸‹é‡æ–°è°ƒåº¦Alarmã€‚</p>
<h4 id="DiagnosticsReceiver"><a href="#DiagnosticsReceiver" class="headerlink" title=" DiagnosticsReceiver"></a><span id="DiagnosticsReceiver"> DiagnosticsReceiver</h4><blockquote>
<p>The {@link android.content.BroadcastReceiver} which dumps out useful diagnostics information. è¾“å‡ºæœ‰ç”¨çš„è¯Šæ–­ä¿¡æ¯</p>
</blockquote>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>WorkManager</tag>
      </tags>
  </entry>
  <entry>
    <title>ç™½è¯è¯´Handler-MessageQueue-Looper</title>
    <url>/2021/03/08/%E7%99%BD%E8%AF%9D%E8%AF%B4Handler-MessageQueue-Looper/</url>
    <content><![CDATA[<p><em>è‹¥æ— æ˜ç¤ºæºç ç‰ˆæœ¬ï¼Œå…¨æ–‡ä»¥Android API23ä¸ºå‡†åˆ†æ</em></p>
<h3 id="ä»ä½•å¼€å§‹"><a href="#ä»ä½•å¼€å§‹" class="headerlink" title="ä»ä½•å¼€å§‹"></a>ä»ä½•å¼€å§‹</h3><p>å¦‚ä½•è§£é‡Šï¼šæˆ‘å†™çš„Javaä»£ç æ˜¯å¦‚ä½•åœ¨æ‰‹æœºä¸Šä¸€ç›´è¿è¡Œç€çš„ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œæ˜¾è€Œæ˜“è§çš„ï¼Œä½œä¸ºä¸€ä¸ªJavaç¨‹åºï¼Œä¸€å®šæœ‰ä¸€ä¸ªç¨‹åºå…¥å£main(String[] args), é‚£ä¹ˆAndroidç¨‹åºçš„å…¥å£main()åœ¨å“ªé‡Œå‘¢ï¼Œæˆ‘ä»¬ç”¨ <a href="https://www.baidu.com/s?wd=Source_Insight%E4%B8%8B%E8%BD%BD%E5%92%8C%E4%BD%BF%E7%94%A8">Source Insight</a>æŸ¥æ‰¾ä¸€ä¸‹ï¼Œæœ€ç»ˆæˆ‘ä»¬åœ¨<a href="https://www.androidos.net.cn/android/6.0.1_r16/xref/frameworks/base/core/java/android/app/ActivityThread.java">android.app.ActivityThread</a>ä¸­æ‰¾åˆ°äº†å®ƒçš„èº«å½±ã€‚</p>
<p><span id="code_main">è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ActivityThread.main()åˆ°åº•å¹²äº†äº›å•¥:</span></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&#123;@link android.app.ActivityThread&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//  ... something for environment &amp; log</span></span><br><span class="line">        </span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// init ActivityThread; ActivityManager.attachApplication</span></span><br><span class="line">        <span class="comment">// init Instrumentation; ContextImpl.createAppContext</span></span><br><span class="line">        <span class="comment">// context.mPackageInfo.makeApplication; application.onCreate</span></span><br><span class="line">        <span class="comment">// and so on ...</span></span><br><span class="line">        </span><br><span class="line">        Looper.loop();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸”å…ˆä¸çœ‹ç¨‹åºæ˜¯å¦‚ä½•åˆå§‹åŒ–ç¯å¢ƒä»¥åŠæ˜¯å¦‚ä½•ä»ActivityThreadå¼€å§‹ä¸€æ­¥æ­¥å¯åŠ¨applicationçš„ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“Javaç¨‹åºç»ˆæœ‰æ‰§è¡Œå®Œçš„ä¸€åˆ»ï¼Œé‚£ä¹ˆappæ˜¯å¦‚ä½•ä¿è¯åœ¨æ‰‹æœºä¸çˆ†ç‚¸çš„æƒ…å†µä¸‹ä¸€ç›´è¿è¡Œä¸é€€å‡ºçš„ï¼Ÿæ‰‹ç—’ç”¨Java JFrameã€JPanelçš„åšè¿‡å°æ¸¸æˆçš„æœ‹å‹åº”è¯¥å°±æƒ³åˆ°äº†ï¼šæ— é™å¾ªç¯åˆ·æ–°ï¼</p>
<p>å¯æ˜¯è‚‰çœ¼çœ‹è¿‡å»ï¼Œè¿™é‡Œåˆ«è¯´æ­»å¾ªç¯ï¼Œè¿ä¸ªforéƒ½æ²¡æœ‰ï¼Œæ€ä¹ˆè‚¥å››ï¼Ÿ</p>
<p>æ‰€å¹¸ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ç»„ç‰¹åˆ«çš„å•è¯ <strong>ã€Looperã€‘</strong>ï¼ˆç¿»è¯‘ï¼šæ‰“ç¯è£…ç½®ï¼‰å’Œ <strong>ã€loopã€‘</strong>(ç¿»è¯‘ï¼šå¾ªç¯ç”µå½±èƒ¶ç‰‡ï¼›é‡å¤æŒ‡ä»¤)ï¼Œæ˜¾ç„¶Looperåº”è¯¥å°±æ˜¯ç»´æŒç¨‹åºä¸€ç›´è¿è¡Œçš„å…³é”®ã€‚</p>
<a id="more"></a>

<h3 id="ä½•ä¸ºLooper"><a href="#ä½•ä¸ºLooper" class="headerlink" title="ä½•ä¸ºLooper"></a>ä½•ä¸ºLooper</h3><p>ä»<a href="#code_main">ActivityThread.main()</a>ä»£ç ä¸éš¾çœ‹å‡ºï¼Œ<strong>Looper.prepare()ä¸Looper.loop()æˆå¯¹å‡ºç°</strong>(prepareMainLooper()æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨prepare()) ï¼Œè¦ä½¿ç”¨loop()ä¿æŒå¾ªç¯ï¼Œé‚£ä¹ˆå°±å¿…é¡»å…ˆprepare()ï¼Œæˆ‘ä»¬ä¸”çœ‹ä¸€ä¸‹<span id="code_prepare">Looper.prepare()</span>åšäº†å“ªäº›å‡†å¤‡å·¥ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;@link android.os.Looper#prepare()&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸€å…±å¹²äº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>ä»ThreadLocalä¸­æŸ¥è¯¢å½“å‰çº¿ç¨‹çš„Looperå¯¹è±¡ï¼Œæœ‰æŸ¥åˆ°ï¼Œè¯´æ˜å·²è¢«prepareè¿‡ï¼Œåˆ™æŠ›é”™ï¼Œç”±äºä¸€ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªThreadLocalï¼Œä»è€Œä¿è¯ä¸€ä¸ªçº¿ç¨‹ä»…ä¼šæŒæœ‰ä¸€ä¸ªLooper</li>
<li>å¦åˆ™ï¼Œä¸ºå½“å‰çº¿ç¨‹é…å¤‡ä¸€ä¸ªLooperï¼Œè€Œåˆå§‹åŒ–Looperæ—¶ï¼ŒåŒæ—¶åˆ›å»ºäº†ä¸€ä¸ªMessageQueueã€‚</li>
</ul>
<p>é‚£è®©æˆ‘ä»¬çœ‹çœ‹ <strong><span id="code_loop">Looper.loop()</span></strong> æ˜¯ä¸æ˜¯å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ <strong>è®©ç¨‹åºåƒæ”¾ç”µå½±ä¸€æ ·ä¸€ç›´è·‘ä¸‹å»çš„åŸå› </strong>ï¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> MessageQueue mQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;@link android.os.Looper#loop()&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// something for Binder</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... something for log</span></span><br><span class="line">        <span class="comment">// æ‰§è¡ŒHandler.Callback.handleMessage</span></span><br><span class="line">        msg.target.dispatchMessage(msg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// something for log</span></span><br><span class="line">        </span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸è´Ÿä¼—æœ›ï¼ŒLooper.loop()ç¡®å®ä¿æŒç€ä¸€ä¸ªæ­»å¾ªç¯ï¼Œ<strong>åªè¦ç»™é©¬å„¿(Looper)è‰(Message)ï¼Œé©¬å„¿å°±èƒ½ä¸€ç›´è·‘ï¼</strong> Looper.loop()çš„å¾ªç¯ä¸­ä¸»è¦å¹²äº†ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>ä»MessageQueueä¸­å–å‡ºä¸€æ¡Messageï¼Œè‹¥Messageä¸ºç©ºåˆ™é€€å‡ºå¾ªç¯</li>
<li>Messageä¸ä¸ºç©ºï¼Œåˆ™å¤„ç†æ¶ˆæ¯</li>
<li>å›æ”¶Message</li>
</ul>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“äº†Looperå®ç°äº†ç¨‹åºçš„æŒç»­è¿è¡Œï¼Œè€Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªæ§åˆ¶Looperæ‰§è¡Œå’Œä¸­æ–­çš„é‡è¦è§’è‰²ï¼š<strong>MessageQueueå’ŒMessage</strong></p>
<h3 id="MessageQueueå’ŒMessage"><a href="#MessageQueueå’ŒMessage" class="headerlink" title="MessageQueueå’ŒMessage"></a>MessageQueueå’ŒMessage</h3><p><a href="#code_loop">Looper.loop()</a>ä¸­å¾ªç¯é€šè¿‡MessageQueue.next()å–å‡ºMessageï¼ŒMessageQueueçœ‹èµ·æ¥æ˜¯Messageçš„å®¹å™¨ï¼ŒMessageQueueçœŸçš„ä»…ä»…æ˜¯Messageçš„å®¹å™¨å—ï¼Ÿ</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹<span id="code_message">Message</span>çš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class Message &#123;</span><br><span class="line">    &#x2F;&#x2F; å‡ºé˜Ÿæ—¶æœº</span><br><span class="line">    public long when;</span><br><span class="line">    &#x2F;&#x2F; å‘é€&#x2F;å¤„ç†æ¶ˆæ¯çš„Handlerå¯¹è±¡</span><br><span class="line">    Handler target;</span><br><span class="line">    &#x2F;&#x2F; ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span><br><span class="line">    Message next;</span><br><span class="line">    &#x2F;&#x2F; æ¶ˆæ¯ç¼“å­˜æ± </span><br><span class="line">    private static Message sPool;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; ... other</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•°æ®ç»“æ„ä¸Š Messageå¯¹è±¡è‡ªèº«æŒæœ‰ä¸‹ä¸€ä¸ªMessageçš„å¼•ç”¨ï¼Œå½¢æˆå•é“¾è¡¨ç»“æ„æˆ–è€…é˜Ÿåˆ—ï¼Œä»ä»£ç ä¸éš¾çœ‹å‡ºMessageæœ¬èº«ä»…å®ç°äº†å•é“¾è¡¨ç»“æ„ã€ç¼“å­˜æœºåˆ¶ã€æŒæœ‰æ¶ˆè´¹è‡ªèº«çš„Handlerã€‚</p>
<p>è¯•è®¾æƒ³ï¼Œè‹¥ä»…è§†MessageQueueä¸ºMessageçš„å®¹å™¨ï¼Œä»¥Messageç°æœ‰çš„æ¡ä»¶å‚ä¸Looperçš„è½®è¯¢ä»¥ä¾›Handleræ¶ˆè´¹ï¼ŒMessageä»…èƒ½å®ç°å…ˆå…¥å…ˆå‡ºï¼Œè‹¥æŸä¸€ä¸ªMessageçš„æ‰§è¡Œæ—¶æœºä¸ºä¸€å¹´åï¼Œé‚£ä¹ˆè¿™ä¸ªMessageåç»­çš„nextå°†ä»…èƒ½åœ¨1å¹´åè·å¾—è¢«æ¶ˆè´¹çš„æœºä¼šï¼Œæ˜¾ç„¶ä¸åˆç†ï¼Œè€Œå®é™…æƒ…å†µä¹Ÿå¹¶éå¦‚æ­¤ã€‚é‚£ä¹ˆæ˜¯è°å¸®åŠ©Messageæ­£ç¡®çš„è¢«æ¶ˆè´¹å‘¢ï¼Ÿæ˜¾ç„¶å°±æ˜¯MessageQueueï¼</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹MessageQueueæ˜¯å¦‚ä½•å¤„ç†Messageçš„æ’å…¥å’Œå–å‡ºä»¥åŠMessageçš„åˆ†é…çš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ‰¾å¯»ä¸€ä¸‹MessageQueueæ˜¯å¦‚ä½•æ’å…¥Messageæˆ–è€…è¯´è·å–åˆ°Messageå¯¹è±¡çš„ï¼Œä»å‰é¢<a href="#code_message">Message</a>ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒMessageæŒæœ‰Handlerå¯¹è±¡ï¼Œæœ‰ç”¨è¿‡<strong>android.os.Handler</strong>çš„ä¸éš¾è”æƒ³å‡ºè¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myHandler.sendMessage(message);</span><br></pre></td></tr></table></figure>
<p>Messageå¯¹è±¡ç”±æˆ‘ä»¬ç”Ÿäº§ï¼Œç”±Handlerå‘é€ï¼Œæœ€ç»ˆåœ¨åˆé€‚çš„æ—¶æœºè¢«Handleræ¶ˆè´¹ã€‚é‚£ä¹ˆï¼ŒHandleræ˜¯æ€ä¹ˆæŠŠMessageäº¤ç»™MessageQueueçš„ï¼ŒMessageQueueåˆæ˜¯åœ¨ä»€ä¹ˆæ—¶æœºæŠŠMessageäº¤ç»™Looperè½¬è¿ç»™Handlerå¤„ç†çš„å‘¢ï¼Ÿ</p>
<p>è¿½è¸ªä»£ç å‘ç°ï¼ŒHandler.sendMessage(message)æœ€ç»ˆæ˜¯è°ƒç”¨<span id="code_enqueueMessage">Handler.enqueueMessage</span>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; &#123;@link android.os.Handler#enqueueMessage&#125;</span><br><span class="line">private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123;</span><br><span class="line">    msg.target &#x3D; this;</span><br><span class="line">    if (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(true);</span><br><span class="line">    &#125;</span><br><span class="line">    return queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Handlerå°†è‡ªå·±è®¾ç½®ä¸ºMessageçš„targetï¼Œå¹¶å°†Messageå’ŒMessageæ‰§è¡Œæ—¶æœºä¼ é€’ç»™MessageQueueï¼Œè€ŒMessageQueueçš„æ¥æºåˆ™æ˜¯ä»<span id="code_handler">Handler</span>æ„é€ æ–¹æ³•å‚æ•°Looperä¸­å–å¾—:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public Handler(Callback callback, boolean async) &#123;</span><br><span class="line">       &#x2F;&#x2F;... doSomething</span><br><span class="line"></span><br><span class="line">       mLooper &#x3D; Looper.myLooper();</span><br><span class="line">       if (mLooper &#x3D;&#x3D; null) &#123;</span><br><span class="line">           throw new RuntimeException(</span><br><span class="line">               &quot;Can&#39;t create handler inside thread that has not called Looper.prepare()&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       mQueue &#x3D; mLooper.mQueue;</span><br><span class="line">       mCallback &#x3D; callback;</span><br><span class="line">       mAsynchronous &#x3D; async;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ææ¸…æ¥šMessageçš„æ¥æºåï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹MessageQueueæ˜¯å¦‚ä½•å¤„ç†æ”¶åˆ°çš„è¿™ä¸ªMessageå¯¹è±¡çš„ï¼Œé¦–å…ˆæˆ‘ä»¬è·Ÿç€<a href="#code_enqueueMessage">Handler.enqueueMessage</a>æ‰¾åˆ°äº†MessageQueueçš„<span id="code_mq_eqMsg">enqueueMessage</span>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">boolean enqueueMessage(Message msg, long when) &#123;</span><br><span class="line">   &#x2F;&#x2F; ...  å¦‚æœMessageæ­£åœ¨è¢«ä½¿ç”¨æˆ–targetä¸ºç©ºåˆ™æŠ›é”™</span><br><span class="line"></span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        if (mQuitting) &#123;</span><br><span class="line">            msg.recycle();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        msg.markInUse();</span><br><span class="line">        msg.when &#x3D; when;</span><br><span class="line">        Message p &#x3D; mMessages;</span><br><span class="line">        boolean needWake;</span><br><span class="line">        if (p &#x3D;&#x3D; null || when &#x3D;&#x3D; 0 || when &lt; p.when) &#123;</span><br><span class="line">            &#x2F;&#x2F; New head, wake up the event queue if blocked.</span><br><span class="line">            msg.next &#x3D; p;</span><br><span class="line">            mMessages &#x3D; msg;</span><br><span class="line">            needWake &#x3D; mBlocked;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            needWake &#x3D; mBlocked &amp;&amp; p.target &#x3D;&#x3D; null &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            Message prev;</span><br><span class="line">            for (;;) &#123;</span><br><span class="line">                prev &#x3D; p;</span><br><span class="line">                p &#x3D; p.next;</span><br><span class="line">                if (p &#x3D;&#x3D; null || when &lt; p.when) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                if (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    needWake &#x3D; false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next &#x3D; p; &#x2F;&#x2F; invariant: p &#x3D;&#x3D; prev.next</span><br><span class="line">            prev.next &#x3D; msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; We can assume mPtr !&#x3D; 0 because mQuitting is false.</span><br><span class="line">        if (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç®€å•åˆ†æä»£ç ï¼Œå¾—çŸ¥MessageQueueæ‰§è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>æ£€æŸ¥æ–°Messageæ˜¯å¦æœ‰æ¶ˆè´¹è€…æˆ–æ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨ï¼Œè‹¥æ— æ¶ˆè´¹è€…æˆ–æ­£è¢«ä½¿ç”¨ï¼Œåˆ™æŠ›é”™</li>
<li>é”å®šMessageQueueï¼Œä¿è¯Messageå¯¹è±¡ä¸è¢«é‡å¤æˆ–é”™è¯¯æ“ä½œ</li>
<li>æ£€æŸ¥å¦‚æœMessageQueueè¢«æ ‡è®°ä¸ºé€€å‡ºï¼Œåˆ™ä¸éœ€å¤„ç†æœ¬æ¬¡æ’å…¥</li>
<li>å°†Messageæ ‡è®°ä¸ºæ­£åœ¨è¢«ä½¿ç”¨</li>
<li>æ‰¾å¯»æ–°Messageä½ç½®<ul>
<li>è‹¥å½“å‰ä¸º<strong>ç¬¬ä¸€æ¬¡æ·»åŠ ï¼ˆp == nullï¼‰</strong> æˆ– <strong>æœ€ä¼˜æ‰§è¡Œï¼ˆwhen == 0ï¼‰</strong> æˆ– <strong>æ–°Messageæ‰§è¡Œæ—¶æœºå…ˆäºå¤´éƒ¨Messageï¼ˆwhen &lt; p.whenï¼‰</strong>ï¼Œåˆ™å°†æ–°Messageè®°å½•ä¸ºMessageQueueä¸­çš„å¤´éƒ¨Messageï¼ˆ<strong>mMessages</strong>ï¼‰ï¼Œå¹¶å°†æ—§çš„å¤´éƒ¨Messageè®¾ç½®ä¸ºæ–°Messageçš„Next</li>
<li>è‹¥æ–°Messageä¸æ»¡è¶³ä¸å¤´éƒ¨Messageç«äº‰çš„æ¡ä»¶ï¼Œåˆ™ä¾æ¬¡é€’è¿›æ¯”è¾ƒæ–°Messageä¸MessageQueueä¸­å¤´éƒ¨Message.nextçš„æ‰§è¡Œæ—¶æœºwhenï¼Œç›´åˆ°Messageé˜Ÿåˆ—çš„æœ€å°¾ç«¯ï¼ˆp == nullï¼‰æˆ–è€…åˆé€‚çš„ä½ç½®(when &lt; p.when)ï¼Œå°†æ–°Messageæ’å…¥åˆ°è¯¥ä½ç½®</li>
</ul>
</li>
<li>è‹¥å½“å‰å¤´éƒ¨Messageéœ€è¦è¢«æ‰§è¡Œï¼Œåˆ™å”¤é†’MessageQueueä»¥å‘Looperæä¾›Messageå¯¹è±¡</li>
</ul>
<p>ä»ä¸Šè¿°é€»è¾‘å¯çœ‹å‡ºï¼Œå½“æ–°çš„Messageè¢«ä¼ å…¥MessageQueueæ—¶ï¼ŒMessageQueueä¼šç­‰å¾…è¿‡å¾€æ“ä½œæ‰§è¡Œå®Œæ¯•å¹¶é”å®šå…¶ä»–æ“ä½œï¼ˆ<strong>synchronized (this)<strong>ï¼‰ï¼Œ</strong>æ ¹æ®ä¼˜å…ˆçº§æ‰§è¡Œæ’å…¥æ’åº</strong>é€»è¾‘å°†æ–°Messageæ”¾ç½®åˆ°é˜Ÿåˆ—çš„åˆé€‚ä½ç½®ï¼Œè®°å½•å¹¶æŒæœ‰é˜Ÿåˆ—ä¼˜å…ˆçº§æœ€é«˜çš„å¤´éƒ¨Messageå¯¹è±¡ï¼Œè‹¥å¤´éƒ¨Messageéœ€è¦è¢«æ¶ˆè´¹ï¼Œåˆ™å–æ¶ˆæ¶ˆæ¯é˜Ÿåˆ—é˜»å¡ï¼ˆé˜»å¡ç”±Messageä¸ºç©ºæ—¶æ— é™ç­‰å¾…äº§ç”Ÿï¼‰</p>
<p>æŠŠè§†é‡æ”¾å›åˆ°<a href="#code_loop">Looper.loop()</a>,MessageQueueä¸­çš„Messageæ˜¯å¦‚ä½•è¢«å–èµ°çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹ä¸‹<span id="code_next">MessageQueue.next()&lt;&gt;åšäº†å“ªäº›æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">               Binder.flushPendingCommands();</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">               Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">               Message msg = mMessages;</span><br><span class="line">               <span class="comment">// msg.target == null æºè‡ª&#123;@link #postSyncBarrier&#125;</span></span><br><span class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       prevMsg = msg;</span><br><span class="line">                       msg = msg.next;</span><br><span class="line">                       <span class="comment">// è‹¥æ¶ˆæ¯ä¸ä¸ºç©ºä¸”æ¶ˆæ¯ä¸ºéå¼‚æ­¥æ¶ˆæ¯ï¼Œåˆ™ç»§ç»­è½®è¯¢ï¼Œç›´åˆ°æ‰¾åˆ°å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line">                   &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                       nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           prevMsg.next = msg.next;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           mMessages = msg.next;</span><br><span class="line">                       &#125;</span><br><span class="line">                       msg.next = <span class="keyword">null</span>;</span><br><span class="line">                       msg.markInUse();</span><br><span class="line">                       <span class="keyword">return</span> msg;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// No more messages.</span></span><br><span class="line">                   nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                   dispose();</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// ... é˜Ÿåˆ—ä¸ºç©ºæˆ–æ— å¯æ¶ˆè´¹å¯¹è±¡æ—¶ç›¸å…³é€»è¾‘</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// ... é˜Ÿåˆ—ä¸ºç©ºæˆ–æ— å¯æ¶ˆè´¹å¯¹è±¡æ—¶ï¼ŒçŠ¶æ€é‡ç½®ã€è°ƒç”¨é—²ç½®å›è°ƒ</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Looperå¾ªç¯ä»MessageQueueå–Messageæ—¶ï¼ŒMessageQueueåšäº†å¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>è‹¥å¤´éƒ¨Massageéœ€ç­‰å¾…ï¼Œåˆ™ç­‰å¾…ä¸€å®šæ—¶é—´ ï¼ˆnativePollOnce(ptr, nextPollTimeoutMillis);ï¼‰</li>
<li>éå†é˜Ÿåˆ—ï¼Œé”å®šMessageQueueå¯¹è±¡</li>
<li>è‹¥å¤´éƒ¨æ¶ˆæ¯æ¶ˆè´¹è€…ä¸ºnullï¼Œåˆ™æ¶ˆæ¯ä¸ºåŒæ­¥å±éšœï¼Œè¯´æ˜æœ‰ç«‹å³æ‰§è¡Œçš„æ¶ˆæ¯ï¼Œåˆ™éå†ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªéœ€è¦ç«‹å³æ‰§è¡Œçš„å¼‚æ­¥æ¶ˆæ¯</li>
<li>æŸ¥æ‰¾åˆé€‚çš„å¯è¢«æ¶ˆè´¹çš„Messageï¼Œè‹¥Messageä¸ä¸ºç©ºï¼š<ul>
<li>å¦‚æœMessageä»éœ€ç­‰å¾…ï¼Œåˆ™è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´nextPollTimeoutMillis </li>
<li>è‹¥Messageä¸éœ€è¦ç­‰å¾…ï¼Œåˆ™ä¼ é€’å½“å‰å¯æ¶ˆè´¹Messageçš„åç»­å…ƒç´ ï¼š<ul>
<li>è‹¥æœ‰é˜Ÿåˆ—å‰ä¸å¯è¢«æ¶ˆè´¹çš„å¯¹è±¡ï¼Œåˆ™å°†next-Messageä½œä¸ºå…¶next</li>
<li>è‹¥å½“å‰å¯æ¶ˆè´¹Messageä¸ºå¤´éƒ¨ï¼Œåˆ™å°†nextè®°å½•ä¸ºæ–°å¤´éƒ¨</li>
</ul>
</li>
<li>åˆ‡æ–­å¯æ¶ˆè´¹Messageä¸åç»­å…ƒç´ çš„è”ç³»ï¼Œå°†å…¶ç½®ä¸ºä½¿ç”¨çŠ¶æ€å¹¶è¿”å›</li>
</ul>
</li>
<li>æŸ¥è¯¢åˆ°Messageä¸ºç©ºï¼Œè‹¥éœ€é€€å‡ºåˆ™é”€æ¯MessageQueueï¼Œå¦åˆ™æ‰§è¡Œé—²ç½®å›è°ƒã€é‡ç½®ç›¸å…³çŠ¶æ€å±æ€§æ‰§è¡Œä¸‹æ¬¡è½®è¯¢ï¼Œè®¾ç½®æ— é™ç­‰å¾…ï¼ˆå½“æœ‰æ–°äº‹ä»¶å¦‚enqueueMessageæ—¶æ‰§è¡Œå”¤é†’ï¼‰</li>
</ul>
<p>ç»¼åˆMessageQueueå¯¹Messageå­˜å–çš„æ“ä½œä¸éš¾æ€»ç»“å‡ºï¼ŒMessageQueueä»¥Messageçš„ä¼˜å…ˆçº§whenä¸ºä¾æ®ç®¡ç†ç€Messageä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå¹¶å§‹ç»ˆæŒæœ‰Messageé˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ï¼ŒMessageQueueæ—¢æ˜¯Messageé˜Ÿåˆ—çš„å®¹å™¨ä¹Ÿç®¡ç†ç€Messageçš„å…¥é˜Ÿå‡ºé˜Ÿé¡ºåºï¼Œä¿è¯Messageç¨³å®šæœ‰åºçš„è¢«ä¼ é€’ã€‚</p>
<h3 id="Handleræ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²"><a href="#Handleræ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²" class="headerlink" title="Handleræ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²"></a>Handleræ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²</h3><p>çºµè§‚Messageçš„ä¸€ç”Ÿï¼Œç”Ÿäºnewæˆ–ç¼“å­˜é˜Ÿåˆ—ï¼Œèµ·äºHandlerï¼Œå­˜äºMessageQueueï¼Œè¡ŒäºLooperï¼Œå…œå…œè½¬è½¬åˆå›åˆ°äº†Handlerï¼Œå½’äºç¼“å­˜é˜Ÿåˆ—ï¼Œé‚£ä¹ˆHandleråˆ°åº•æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²å‘¢ï¼Ÿ<br>è®©æˆ‘ä»¬æ¥çœ‹ä¸€æ®µç®€å•ä»£ç ï¼Œå¸®æˆ‘ä»¬ç†è§£Handlerçš„è§’è‰²ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HandlerTest&quot;</span>;</span><br><span class="line">    ScheduledExecutorService executorService = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">5</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">                    thread.setName(<span class="string">&quot;test-Thread&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> thread;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    Handler myHandler = <span class="keyword">new</span> MyHandler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    Runnable taskRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            myHandler.sendEmptyMessage(<span class="number">1</span>);</span><br><span class="line">            MyHandler handler = <span class="keyword">new</span> MyHandler(subThread.getLooper());</span><br><span class="line">            handler.sendEmptyMessage(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    HandlerThread subThread = <span class="keyword">new</span> HandlerThread(<span class="string">&quot;test-Thread2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        subThread.start();</span><br><span class="line">        executorService.schedule(taskRunnable, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        myHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                MyHandler handler = <span class="keyword">new</span> MyHandler(subThread.getLooper());</span><br><span class="line">                handler.sendEmptyMessage(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyHandler</span><span class="params">(<span class="meta">@NonNull</span> Looper looper)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// doSomething</span></span><br><span class="line">            Log.i(TAG, String.format(<span class="string">&quot;ThreadName: %s, msg.what = %s&quot;</span>,</span><br><span class="line">                    Thread.currentThread().getName(), msg.what));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ—¢ï¼š</p>
<ul>
<li>ä¸»çº¿ç¨‹åˆå§‹åŒ–myHandlerï¼Œåœ¨å­çº¿ç¨‹ä¸­å‘é€Message [1]ï¼Œæœ€ç»ˆmyHandleræ‰“å°å‡ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯</li>
<li>ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨å­çº¿ç¨‹çš„Looperåˆå§‹åŒ–handlerï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­å‘é€Message [2]ï¼Œæœ€ç»ˆhandleræ‰“å°å‡ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯</li>
<li>å­çº¿ç¨‹åˆå§‹åŒ–Handlerï¼Œåœ¨å­çº¿ç¨‹ä¸­å‘é€Message [3]ï¼Œæœ€ç»ˆsubHandleræ‰“å°å‡ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯</li>
</ul>
<p>æœ€ç»ˆæ‰§è¡Œçš„ç»“æœæ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">08-23 13:37:26.579 12969-12983&#x2F;a.b.c I&#x2F;HandlerTest: ThreadName: test-Thread2, msg.what &#x3D; 2</span><br><span class="line">08-23 13:37:28.578 12969-12969&#x2F;a.b.c I&#x2F;HandlerTest: ThreadName: main, msg.what &#x3D; 1</span><br><span class="line">08-23 13:37:28.578 12969-12983&#x2F;a.b.c I&#x2F;HandlerTest: ThreadName: test-Thread2, msg.what &#x3D; 3</span><br></pre></td></tr></table></figure>
<p>ç»“æœåˆ†æï¼š</p>
<ul>
<li>å­çº¿ç¨‹taskRunnerä¸­ä½¿ç”¨myHandlerå‘é€çš„æ¶ˆæ¯1æœ€ç»ˆåœ¨ä¸»çº¿ç¨‹ä¸­è¢«å¤„ç†</li>
<li>å­çº¿ç¨‹taskRunnerä¸­ä½¿ç”¨subyHandlerå‘é€çš„æ¶ˆæ¯3æœ€ç»ˆåœ¨å­çº¿ç¨‹ä¸­è¢«å¤„ç†</li>
<li>è€Œä¸»çº¿ç¨‹(<em>myHandler.postDelayed</em>) ä¸­ä½¿ç”¨subHandlerå‘é€çš„æ¶ˆæ¯2æœ€ç»ˆåœ¨å­çº¿ç¨‹ä¸­è¢«å¤„ç†ï¼›</li>
</ul>
<p>ç”±æ­¤å¯è§ï¼ŒHandler.handleMessage()æ‰§è¡Œçš„çº¿ç¨‹æ˜¯Handleråˆå§‹åŒ–æ‰€ä¼ é€’çš„Looperçš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œä¸æ˜¯æ‰§è¡ŒsendMessage()çš„æ‰€åœ¨çº¿ç¨‹ã€‚é‚£ä¹ˆï¼Œæƒ³è¦å®ç°è·¨çº¿ç¨‹é€šä¿¡ï¼Œåªéœ€è¦åœ¨å“åº”çº¿ç¨‹ä¸­åˆå§‹åŒ–Handlerä¼ å…¥å¯¹åº”çº¿ç¨‹çš„Looperï¼Œå°†Handlerå¯¹è±¡äº¤ç»™ä»»æ„å·¥ä½œçº¿ç¨‹éƒ½å¯ä¸ä¹‹å®ç°æ•°æ®äº¤æ¢ã€‚</p>
<p>ä»¥<strong>Looperä¸ºåŠ¨åŠ›</strong>ï¼Œä»¥<strong>MessageQueueä¸ºåˆ†æ‹£å™¨</strong>ï¼Œ<strong>Handlerä½œä¸ºè·Ÿç€Messageäº§å“èµ°çš„å·¥äºº</strong>ï¼Œå°†ä¸€ä¸ªä¸ªMessageäº§å“ï¼Œæ¬è¿è‡³MessageQueueä»¥å“è´¨å¥½å(ä¼˜å…ˆçº§)åˆ†æ‹£æ’åºã€åŠ¨åŠ›Looperç£ä¿ƒåˆ†æ‹£å™¨MessageQueueå·¥ä½œï¼Œä¼˜å…ˆçš„Messageäº§å“è¢«é€å‡ºï¼Œå†ç”±æ“ä½œå·¥Handleræ¬ç¦»æµæ°´çº¿ï¼Œæœ€ç»ˆå®ŒæˆMessageäº§å“æŒ‰å“è´¨ä»ä¸Šæ¸¸è¿é€åˆ°ä¸‹æ¸¸ã€‚</p>
]]></content>
      <categories>
        <category>Framework</category>
      </categories>
      <tags>
        <tag>Handler</tag>
      </tags>
  </entry>
  <entry>
    <title>Activityå¯åŠ¨æµç¨‹æµ…æï¼ˆä¸€ï¼‰-- è°ƒç”¨æµç¨‹</title>
    <url>/2021/04/11/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%B5%85%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89--%20API30%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Activityä¸€èˆ¬æ˜¯å®‰å“å¼€å‘æ¥è§¦åˆ°çš„ç¬¬ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œä»£è¡¨ç€ä¸ç”¨æˆ·äº¤äº’çš„æ´»åŠ¨è§†çª—ï¼Œæ´»åŠ¨ä¸æ´»åŠ¨ä¹‹é—´å¾€å¾€ä¸æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œ<code>startActivity()</code>å°±æ˜¯ä»ä¸€ä¸ªæ´»åŠ¨è·³è½¬åˆ°å¦ä¸€ä¸ªæ´»åŠ¨çš„æ¡¥æ¢ã€‚è€Œå¯¹äº<code>startActivity()</code>çš„äº†è§£ï¼Œæˆ‘ä»¬å¾€å¾€åªåœç•™åœ¨å®ƒçš„ä½¿ç”¨ä¸Šï¼Œå¾ˆå°‘å»æ·±ç©¶å®ƒçš„åŸç†<br>ã€‚</p>
<p>ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬è·Ÿéšç€æºç ï¼Œä¸€æ­¥ä¸€æ­¥çš„è¿½æº¯å®ƒçš„è°ƒç”¨æµç¨‹ï¼Œåˆæ­¥äº†è§£ä¸‹å®ƒçš„è°ƒç”¨é“¾ï¼Œåç»­æˆ‘ä»¬è¿˜å¯ä»¥ç»§ç»­æŒ–æ˜ï¼Œå…³äºåº”ç”¨å¯åŠ¨ã€å¯åŠ¨æ¨¡å¼ã€hookå¯åŠ¨æµç¨‹ç­‰ç›¸å…³æŠ€æœ¯æ”¯æŒã€‚</p>
<p>æ­¤ç³»åˆ—åšå®¢åœ¨æœªå£°æ˜APIç‰ˆæœ¬æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨<strong>API30</strong> ç‰ˆæœ¬çš„AndroidSDKæºç ã€‚</p>
<p>æºç æŸ¥çœ‹å·¥å…·ä½¿ç”¨AndroidStudioã€‚æºç æ¥æº<code>%AndroidSDK%/sources</code>ã€‚ä¸€èˆ¬æ–¹å¼ï¼šå¤‡ä»½ä¸€ä»½sourceç›®å½•ï¼Œä½¿ç”¨AndroidStudio Openä½ æƒ³è§‚å¯Ÿçš„apiç‰ˆæœ¬çš„æºç ç›®å½•ã€‚</p>
<a id="more"></a>

<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><h4 id="Activity-startActivity"><a href="#Activity-startActivity" class="headerlink" title="Activity.startActivity()"></a>Activity.startActivity()</h4><p>æˆ‘ä»¬æ—¥å¸¸ç¼–å†™çš„<code>activity.startActivity(intent)</code>çš„ä»£ç ï¼Œå®é™…æ˜¯è°ƒç”¨ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;@link android.app.Activity#startActivity&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// API 30 æ­¤å¤„æ–°å¢å…³äºè‡ªåŠ¨å¡«å……ç›¸å…³çš„å¤„ç†ä»£ç ï¼ŒAPI26æ— æ­¤é¡¹</span></span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Activity-startActivityForResult"><a href="#Activity-startActivityForResult" class="headerlink" title="Activity.startActivityForResult()"></a>Activity.startActivityForResult()</h4><p>æœ‰ä¸Šè¿°ä»£ç å¯çŸ¥ï¼ŒstartActivity() å®é™…æ˜¯è°ƒç”¨ startActivityForResult()ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;@link android.app.Activity#startActivityForResult&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(<span class="meta">@RequiresPermission</span> Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Nullable</span> Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤å¤„ï¼ŒmMainThread.getApplicationThread() å®é™…ä¸º IApplicationThread</span></span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœè¿™ä¸ªstartè¯·æ±‚ä¸€ä¸ªç»“æœï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ”¶åˆ°ç»“æœä¹‹å‰é¿å…ä½¿æ´»åŠ¨å¯è§ã€‚</span></span><br><span class="line">            <span class="comment">//åœ¨onCreate(Bundle savedInstanceState)æˆ–onResume()æœŸé—´è®¾ç½®æ­¤ä»£ç å°†ä¿æŒæ´»åŠ¨åœ¨æ­¤æœŸé—´éšè—ï¼Œä»¥é¿å…é—ªçƒã€‚</span></span><br><span class="line">            <span class="comment">//è¿™åªèƒ½åœ¨è¯·æ±‚ç»“æœæ—¶æ‰§è¡Œï¼Œå› ä¸ºè¿™ä¿è¯äº†æ— è®ºæ´»åŠ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨æ´»åŠ¨å®Œæˆæ—¶è·å¾—ä¿¡æ¯</span></span><br><span class="line">            mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å®é™…ä¹Ÿæ˜¯è°ƒç”¨mInstrumentation.execStartActivity(this, mMainThread.getApplicationThread(), mToken, this, intent, requestCode, options);æ­¤å¤„ä¸åšèµ˜è¿°</span></span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼Œæˆ‘ä»¬æƒ³è¦éå†è¿™ä¸ªæ–¹æ³•ï¼Œä»¥ä¾¿ä¸å¯èƒ½å·²è¦†ç›–å®ƒçš„ç°æœ‰åº”ç”¨ç¨‹åºå…¼å®¹ã€‚</span></span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„ï¼Œæˆ‘ä»¬æŠ›å¼€å…¶ä»–ä»£ç ï¼Œå…³æ³¨è¿™é‡Œçš„if else æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨mInstrumentation.execStartActivity()ï¼Œä»å­—é¢æ„ä¹‰ä¸Šè¯´ï¼Œå®ƒä»£è¡¨â€œæ‰§è¡Œå¯åŠ¨æ´»åŠ¨â€ï¼Œæ˜¾ç„¶æˆ‘ä»¬åº”å½“å…³æ³¨æ­¤æ–¹æ³•ã€‚</p>
<h4 id="Instrumentation-execStartActivity"><a href="#Instrumentation-execStartActivity" class="headerlink" title="Instrumentation.execStartActivity()"></a>Instrumentation.execStartActivity()</h4><p>Instrumentationç±»ã€‚æ­¤å¤„æˆ‘ä»¬ä¸åšè¯¦ç»†åˆ†æï¼Œä½†åº”å½“çŸ¥é“çš„æ˜¯ï¼Œå®ƒçš„ä½œç”¨åŠèƒ½åŠ›ï¼š</p>
<blockquote>
<p>å®ç°åº”ç”¨ç¨‹åºæ’è£…ä»£ç çš„åŸºç±»ã€‚åœ¨å¯åŠ¨æ’è£…çš„æƒ…å†µä¸‹è¿è¡Œæ—¶ï¼Œè¿™ä¸ªç±»å°†åœ¨ä»»ä½•åº”ç”¨ç¨‹åºä»£ç ä¹‹å‰ä¸ºæ‚¨å®ä¾‹åŒ–ï¼Œå…è®¸æ‚¨ç›‘è§†ç³»ç»Ÿä¸åº”ç”¨ç¨‹åºä¹‹é—´çš„æ‰€æœ‰äº¤äº’ã€‚é€šè¿‡AndroidManifest.xmlçš„&lt; Instrumentation &gt;æ ‡ç­¾å‘ç³»ç»Ÿæè¿°äº†ä¸€ä¸ªInstrumentationå®ç°ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;@link android.app.Instrumentation#execStartActivity&#125;</span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    <span class="comment">// æ­¤å¤„çœç•¥ä»£ç </span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData(who);</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤å¤„</span></span><br><span class="line">        <span class="keyword">int</span> result = ActivityTaskManager.getService().startActivity(whoThread,</span><br><span class="line">                who.getBasePackageName(), who.getAttributionTag(), intent,</span><br><span class="line">                intent.resolveTypeIfNeeded(who.getContentResolver()), token,</span><br><span class="line">                target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒInstrumentation.execStartActivity()è°ƒç”¨äº†ActivityTaskManager.getService().startActivity()å°†å¯åŠ¨æ´»åŠ¨å§”æ‰˜ç»™äº†æŸä¸ªâ€œæœåŠ¡â€æ‰§è¡Œï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªâ€œæœåŠ¡â€æ˜¯ä»€ä¹ˆã€‚</p>
<h4 id="ActivityTaskManager-getService"><a href="#ActivityTaskManager-getService" class="headerlink" title="ActivityTaskManager.getService()"></a>ActivityTaskManager.getService()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> android.app.ActivityTaskManager&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityTaskManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IActivityTaskManagerSingleton.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage(trackingBug = 129726065)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityTaskManager&gt; IActivityTaskManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> Singleton&lt;IActivityTaskManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> IActivityTaskManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_TASK_SERVICE);</span><br><span class="line">                <span class="keyword">return</span> IActivityTaskManager.Stub.asInterface(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä»£ç çš„ä½œç”¨å…¶å®æ˜¯é€šè¿‡è·å–IBinderç±»å‹çš„æœåŠ¡ç”Ÿäº§ä¸€ä¸ªå¯åŠ¨æ´»åŠ¨çš„ä»£ç†ç±»ï¼Œå®ç°æ–¹å¼ï¼š <strong>ä½¿ç”¨çš„æ˜¯åä¸ºACTIVITY_TASK_SERVICEçš„IBinderç”Ÿäº§äº†ä¸€ä¸ªIActivityTaskManager</strong>ã€‚</p>
<p>ä½¿ç”¨è¿‡AIDLçš„åŒå­¦åº”è¯¥çœ‹å‡ºæ¥äº†ï¼Œè¿™é‡Œç±»ä¼¼çš„ï¼Œä¹Ÿæ˜¯é€šè¿‡è·¨è¿›ç¨‹é€šä¿¡çš„æ–¹å¼æ“ä½œçš„ã€‚</p>
<h4 id="IActivityTaskManager-startActivity"><a href="#IActivityTaskManager-startActivity" class="headerlink" title="IActivityTaskManager.startActivity()"></a>IActivityTaskManager.startActivity()</h4><p>ç”±äºæˆ‘ä»¬æ²¡åŠæ³•ç›´æ¥è·å–åˆ°IActivityTaskManagerçš„å®ç°ç±»ï¼Œæˆ‘ä»¬é€šè¿‡æœç´¢<code>IActivityTaskManager.Stub</code>çš„å®ç°ç±»æ¥å¯»æ‰¾å‰é¢æåˆ°çš„â€œæœåŠ¡â€å…·ä½“æ˜¯ä»€ä¹ˆã€‚</p>
<p><img src="https://z3.ax1x.com/2021/04/11/cwgcp6.png" alt="api30_IActivityTaskManager"></p>
<p>ç”±ä¸Šå›¾å¯çŸ¥ï¼Œè¿™ä¸ªâ€œæœåŠ¡â€åº”è¯¥å°±æ˜¯<code>com.android.server.wm.ActivityTaskManagerService</code>ï¼Œæˆ‘ä»¬æ‰¾åˆ°startActivity()æ–¹æ³•ï¼ŒéªŒè¯å…¶å…¥å‚æ˜¯å¦ä¸€è‡´ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityTaskManagerService&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingFeatureId, Intent intent, String resolvedType, IBinder resultTo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, callingFeatureId, intent, resolvedType,</span><br><span class="line">            resultTo, resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å…¥å‚æ¯”å¯¹ï¼ŒåŸºæœ¬ç¡®è®¤æ­¤æ–¹æ³•æ˜¯Instrumentation.execStartActivity()ä¸­è°ƒç”¨<code>ActivityTaskManager.getService().startActivity()</code>çš„åç»­æµç¨‹äº†ã€‚</p>
<p><strong>ActivityTaskManagerService.startActivityAsUser</strong></p>
<p>startActivityAsUseråŒ…å«ä¸€ç³»åˆ—é‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityTaskManagerService&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@Nullable</span> String callingFeatureId, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> validateIncomingUser)</span> </span>&#123;</span><br><span class="line">    assertPackageMatchesCallingUid(callingPackage);</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">&quot;startActivityAsUser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    userId = getActivityStartController().checkTargetUser(userId, validateIncomingUser,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="string">&quot;startActivityAsUser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œçš„callerä¸º IApplicationThread</span></span><br><span class="line">    <span class="keyword">return</span> getActivityStartController().obtainStarter(intent, <span class="string">&quot;startActivityAsUser&quot;</span>)</span><br><span class="line">            .setCaller(caller)</span><br><span class="line">            .setCallingPackage(callingPackage)</span><br><span class="line">            .setCallingFeatureId(callingFeatureId)</span><br><span class="line">            .setResolvedType(resolvedType)</span><br><span class="line">            .setResultTo(resultTo)</span><br><span class="line">            .setResultWho(resultWho)</span><br><span class="line">            .setRequestCode(requestCode)</span><br><span class="line">            .setStartFlags(startFlags)</span><br><span class="line">            .setProfilerInfo(profilerInfo)</span><br><span class="line">            .setActivityOptions(bOptions)</span><br><span class="line">            .setUserId(userId)</span><br><span class="line">            .execute();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦é€šè¿‡å·¥å‚ç”Ÿäº§å‡ºActivityStarterå¯¹è±¡ï¼Œå¹¶è°ƒç”¨execute()æ‰§è¡Œã€‚</p>
<h4 id="ActivityStarter-execute"><a href="#ActivityStarter-execute" class="headerlink" title="ActivityStarter.execute()"></a>ActivityStarter.execute()</h4><p>ç”±è¯¥æ–¹æ³•æ³¨é‡Šæˆ‘ä»¬å¯çŸ¥å…¶ä½œç”¨ï¼š</p>
<blockquote>
<p>æ ¹æ®å‰é¢æä¾›çš„è¯·æ±‚å‚æ•°è§£æå¿…è¦çš„ä¿¡æ¯ï¼Œå¹¶æ‰§è¡Œå¼€å§‹å¯åŠ¨æ´»åŠ¨æ—…ç¨‹çš„è¯·æ±‚ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStarter&#125;</span><br><span class="line">&#123;<span class="meta">@link</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ­¤å¤„çœç•¥ä»£ç </span></span><br><span class="line">        <span class="keyword">int</span> res;</span><br><span class="line">        <span class="keyword">synchronized</span> (mService.mGlobalLock) &#123;</span><br><span class="line">            <span class="comment">// æ­¤å¤„çœç•¥ä»£ç </span></span><br><span class="line">            res = executeRequest(mRequest);</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">            <span class="comment">// æ­¤å¤„çœç•¥ä»£ç </span></span><br><span class="line">            <span class="keyword">return</span> getExternalResult(mRequest.waitResult == <span class="keyword">null</span> ? res</span><br><span class="line">                    : waitForResult(res, mLastStartActivityRecord));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        onExecutionComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œè¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒæ˜¯è°ƒç”¨<code>executeRequest(mRequest)</code>ï¼Œç”±äºä»£ç è¾ƒé•¿ï¼Œæ­¤å¤„çœç•¥å…·ä½“å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStarter&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">executeRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–å®šä¹‰</span></span><br><span class="line">    <span class="keyword">final</span> IApplicationThread caller = request.caller;</span><br><span class="line">    <span class="keyword">final</span> IBinder resultTo = request.resultTo;</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–æ£€æŸ¥ä»£ç </span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æƒé™ç­‰</span></span><br><span class="line">    <span class="keyword">boolean</span> abort = !mSupervisor.checkStartAnyActivityPermission(intent, aInfo, resultWho,</span><br><span class="line">        requestCode, callingPid, callingUid, callingPackage, callingFeatureId,</span><br><span class="line">        request.ignoreTargetSecurity, inTask != <span class="keyword">null</span>, callerApp, resultRecord, resultStack);</span><br><span class="line">    abort |= !mService.mIntentFirewall.checkStartActivity(intent, callingUid,</span><br><span class="line">            callingPid, resolvedType, aInfo.applicationInfo);</span><br><span class="line">    abort |= !mService.getPermissionPolicyInternal().checkStartActivity(intent, callingUid,</span><br><span class="line">            callingPackage);</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–æ£€æŸ¥åŠè®¾ç½®çŠ¶æ€ä»£ç </span></span><br><span class="line">    <span class="comment">// åˆ›å»ºActivityRecordï¼Œæ³¨æ„æ­¤å¤„callerAppä¸º å¯¹ IApplicationThreadçš„å°è£…</span></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingPid, callingUid,</span><br><span class="line">            callingPackage, callingFeatureId, intent, resolvedType, aInfo,</span><br><span class="line">            mService.getGlobalConfiguration(), resultRecord, resultWho, requestCode,</span><br><span class="line">            request.componentSpecified, voiceSession != <span class="keyword">null</span>, mSupervisor, checkedOptions,</span><br><span class="line">            sourceRecord);</span><br><span class="line">    mLastStartActivityRecord = r;</span><br><span class="line">    <span class="comment">// çœç•¥ä»£ç </span></span><br><span class="line">    mService.onStartActivitySetDidAppSwitch();</span><br><span class="line">    mController.doPendingActivityLaunches(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    mLastStartActivityResult = startActivityUnchecked(r, sourceRecord, voiceSession,</span><br><span class="line">            request.voiceInteractor, startFlags, <span class="keyword">true</span> <span class="comment">/* doResume */</span>, checkedOptions, inTask,</span><br><span class="line">            restrictedBgActivity, intentGrants);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.outActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        request.outActivity[<span class="number">0</span>] = mLastStartActivityRecord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mLastStartActivityResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>executeRequest åšäº†åŸºæœ¬çš„å¯åŠ¨æ£€æŸ¥ï¼Œåˆ›å»ºåŒ…å«IApplicationThreadå¯¹è±¡çš„Activityçš„è¡¨ç¤ºç±»ActivityRecordï¼ˆå†å²å †æ ˆä¸­çš„ä¸€ä¸ªæ¡ç›®ï¼Œè¡¨ç¤ºä¸€ä¸ªæ´»åŠ¨ï¼‰ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ startActivityUnchecked() æ–¹æ³•ï¼ŒstartActivityUnchecked()ä¸­ä¸»è¦è°ƒç”¨ startActivityInner() æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStarter&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startActivityInner</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, Task inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> restrictedBgActivity, NeededUriGrants intentGrants)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥ä»£ç </span></span><br><span class="line">    <span class="comment">// è®¡ç®—æ˜¯å¦æœ‰ä¸€ä¸ªç°æœ‰çš„ä»»åŠ¡å¯ç”¨äºåŠ è½½Activityã€‚</span></span><br><span class="line">    <span class="keyword">final</span> Task targetTask = reusedTask != <span class="keyword">null</span> ? reusedTask : computeTargetTask();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> newTask = targetTask == <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// çœç•¥ä»¥ä¸‹ä»£ç ï¼š</span></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹åˆ¤æ–­ä¸»è¦é’ˆå¯¹ç›®æ ‡Activity</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æ­£åœ¨æ ˆé¡¶</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¹¶æ‰§è¡Œæ˜¯å¦å¯ä»¥æ ˆé¡¶å¤ç”¨</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¹¶æ‰§è¡Œæ˜¯å¦éœ€è¦å¼€å¯æ–°æ ˆ</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å¹¶æ‰§è¡Œæ˜¯å¦ç§»åŠ¨åˆ°æ ˆé¡¶ï¼ˆsingleTaskå¼¹æ ˆï¼‰</span></span><br><span class="line">    <span class="comment">// =====</span></span><br><span class="line">    <span class="comment">// æ“ä½œç›®æ ‡Activityæ ˆï¼Œå¯åŠ¨æ¨¡å¼ã€è½¬åœºåŠ¨ç”»ç›¸å…³é€»è¾‘</span></span><br><span class="line">    mTargetStack.startActivityLocked(mStartActivity, topStack.getTopNonFinishingActivity(),</span><br><span class="line">                newTask, mKeepCurTransition, mOptions);</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord topTaskActivity =</span><br><span class="line">                mStartActivity.getTask().topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (!mTargetStack.isTopActivityFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.isTaskOverlay()</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè¯¥æ´»åŠ¨æ˜¯ä¸å¯è°ƒç„¦çš„ï¼Œæˆ‘ä»¬ä¸èƒ½æ¢å¤å®ƒï¼Œä½†ä»ç„¶å¸Œæœ›ç¡®ä¿å®ƒåœ¨å¼€å§‹æ—¶å¯è§(è¿™ä¹Ÿå°†è§¦å‘è¿›å…¥åŠ¨ç”»)ã€‚</span></span><br><span class="line">            <span class="comment">// è¿™æ–¹é¢çš„ä¸€ä¸ªä¾‹å­æ˜¯PIPæ´»åŠ¨ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­æ¢å¤å½“å‰æœ‰è¦†ç›–çš„æ´»åŠ¨ï¼Œå› ä¸ºå¼€å§‹çš„æ´»åŠ¨åªæ˜¯éœ€è¦åœ¨å¯è§çš„æš‚åœçŠ¶æ€ï¼Œç›´åˆ°è¦†ç›–è¢«åˆ é™¤ã€‚</span></span><br><span class="line">            <span class="comment">// ä¼ é€’&#123;@code null&#125;ä½œä¸ºstartå‚æ•°å¯ä»¥ç¡®ä¿æ‰€æœ‰æ´»åŠ¨éƒ½æ˜¯å¯è§çš„ã€‚</span></span><br><span class="line">            mTargetStack.ensureActivitiesVisible(<span class="keyword">null</span> <span class="comment">/* starting */</span>,</span><br><span class="line">                    <span class="number">0</span> <span class="comment">/* configChanges */</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            <span class="comment">// ç»§ç»­å¹¶å‘Šè¯‰çª—å£ç®¡ç†å™¨ä¸ºè¿™ä¸ªæ´»åŠ¨æ‰§è¡Œåº”ç”¨ç¨‹åºè¿‡æ¸¡ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºè¿‡æ¸¡ä¸ä¼šé€šè¿‡resumeé€šé“è§¦å‘ã€‚</span></span><br><span class="line">            mTargetStack.getDisplay().mDisplayContent.executeAppTransition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœç›®æ ‡å †æ ˆä¹‹å‰ä¸æ˜¯å¯è°ƒç„¦çš„(è¯¥å †æ ˆä¸Šä¹‹å‰çš„topè¿è¡Œæ´»åŠ¨ä¸å¯è§)ï¼Œé‚£ä¹ˆä¹‹å‰ä»»ä½•å°†è¯¥å †æ ˆç§»åŠ¨åˆ°è¯¥å †æ ˆçš„è°ƒç”¨éƒ½ä¸ä¼šæ›´æ–°è¢«è°ƒç„¦çš„å †æ ˆã€‚</span></span><br><span class="line">            <span class="comment">// å¦‚æœç°åœ¨å¯åŠ¨æ–°çš„æ´»åŠ¨å…è®¸ä»»åŠ¡å †æ ˆå¯è°ƒç„¦ï¼Œé‚£ä¹ˆè¯·ç¡®ä¿æˆ‘ä»¬ç°åœ¨ç›¸åº”åœ°æ›´æ–°å·²è°ƒç„¦çš„å †æ ˆã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (mTargetStack.isTopActivityFocusable()</span><br><span class="line">                    &amp;&amp; !mRootWindowContainer.isTopDisplayFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                mTargetStack.moveToFront(<span class="string">&quot;startActivityInner&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRootWindowContainer.resumeFocusedStacksTopActivities(</span><br><span class="line">                    mTargetStack, mStartActivity, mOptions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     mRootWindowContainer.updateUserStack(mStartActivity.mUserId, mTargetStack);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“æ´»åŠ¨å¯åŠ¨æ—¶ï¼Œç«‹å³æ›´æ–°æœ€è¿‘ä»»åŠ¡åˆ—è¡¨</span></span><br><span class="line">    mSupervisor.mRecentTasks.add(mStartActivity.getTask());</span><br><span class="line">    mSupervisor.handleNonResizableTaskIfNeeded(mStartActivity.getTask(),</span><br><span class="line">            mPreferredWindowingMode, mPreferredTaskDisplayArea, mTargetStack);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> START_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºè¿™é‡Œä»£ç è¾ƒé•¿ï¼Œæ•…å¿½ç•¥äº†å¤§é‡ä»£ç ï¼Œæˆ‘ä»¬å¯¹è¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½åšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š</p>
<ul>
<li>æ ¹æ®å½“å‰æ ˆçš„æƒ…å†µï¼Œåˆ¤æ–­ç›®æ ‡Activityå…¥æ ˆæ“ä½œï¼šæ˜¯å¦éœ€è¦æ–°æ ˆï¼Œæ˜¯å¦æ ˆé¡¶å¤ç”¨ï¼Œæ˜¯å¦å¼¹æ ˆç­‰</li>
<li>è½¬åœºåŠ¨ç”»ç›¸å…³æ“ä½œ</li>
<li>åˆ¤æ–­ç›®æ ‡æ´»åŠ¨æ˜¯å¦å¯è·å¾—ç„¦ç‚¹ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œ</li>
</ul>
<p>é‚£ä¹ˆï¼Œåœ¨åˆ¤æ–­ç›®æ ‡æ´»åŠ¨æ˜¯å¦å¯è·å¾—ç„¦ç‚¹çš„åˆ†æ”¯é‡Œï¼Œæˆ‘ä»¬å¯åŠ¨çš„activityè‡ªç„¶æ˜¯éœ€è¦ç„¦ç‚¹ï¼ˆå¯è§å¯æ“ä½œï¼‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦å…³æ³¨<code>mRootWindowContainer.resumeFocusedStacksTopActivities(mTargetStack, mStartActivity, mOptions);</code>.</p>
<h4 id="RootWindowContainer-resumeFocusedStacksTopActivities"><a href="#RootWindowContainer-resumeFocusedStacksTopActivities" class="headerlink" title="RootWindowContainer.resumeFocusedStacksTopActivities()"></a>RootWindowContainer.resumeFocusedStacksTopActivities()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.RootWindowContainer&#125;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStacksTopActivities</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mStackSupervisor.readyToResume()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœç›®æ ‡åœ¨æ ˆé¡¶å±•ç¤ºåŒºåŸŸï¼Œåˆ™è°ƒç”¨ï¼ˆçŠ¶æ€æ¨¡å¼ï¼‰ResumeActivityItemæ‰§è¡Œresumeæ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; (targetStack.isTopStackInDisplayArea()</span><br><span class="line">            || getTopDisplayFocusedStack() == targetStack)) &#123;</span><br><span class="line">        result = targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = getChildCount() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        <span class="comment">// çœç•¥å±•ç¤ºåŒºåŸŸç›¸å…³åˆ¤æ–­åŠè®¡ç®—</span></span><br><span class="line">        <span class="keyword">if</span> (!resumedOnDisplay) &#123;</span><br><span class="line">            <span class="comment">// åœ¨æ²¡æœ‰æœ‰æ•ˆæ´»åŠ¨çš„æƒ…å†µä¸‹(ä¾‹å¦‚ï¼Œè®¾å¤‡åˆšåˆšå¯åŠ¨æˆ–å¯åŠ¨ç¨‹åºå´©æºƒ)ï¼Œå¯èƒ½ä»€ä¹ˆéƒ½æ²¡æœ‰æ¢å¤æ˜¾ç¤ºã€‚</span></span><br><span class="line">            <span class="comment">// æ˜¾å¼åœ°è¯·æ±‚é›†ä¸­å †æ ˆä¸­çš„topæ´»åŠ¨çš„resumeå°†ç¡®ä¿è‡³å°‘homeæ´»åŠ¨è¢«å¯åŠ¨å’Œæ¢å¤ï¼Œå¹¶ä¸”ä¸ä¼šå‘ç”Ÿé€’å½’ã€‚</span></span><br><span class="line">            <span class="keyword">final</span> ActivityStack focusedStack = display.getFocusedStack();</span><br><span class="line">            <span class="keyword">if</span> (focusedStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result |= focusedStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</span><br><span class="line">                result |= resumeHomeActivity(<span class="keyword">null</span> <span class="comment">/* prev */</span>, <span class="string">&quot;no-focusable-task&quot;</span>,</span><br><span class="line">                        display.getDefaultTaskDisplayArea());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä¸Šè¿°ä»£ç ï¼Œä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ul>
<li>å¦‚æœç›®æ ‡å·²å±•ç¤ºåœ¨æ ˆé¡¶å¯è§åŒºåŸŸï¼Œåˆ™æ‰§è¡Œresume</li>
<li>å¦‚æœä¸å­˜åœ¨æœ‰æ•ˆçš„æ´»åŠ¨ï¼ˆå´©æºƒæˆ–é¦–æ¬¡å¯åŠ¨ï¼‰ï¼Œåˆ™å¯åŠ¨é¦–é¡µ</li>
<li>å¦‚æœå­˜åœ¨æœ‰æ•ˆæ´»åŠ¨ï¼ˆå­˜åœ¨æœ‰ç„¦ç‚¹çš„æ ˆï¼‰ï¼Œç»§ç»­æ‰§è¡Œå¯åŠ¨æµç¨‹</li>
</ul>
<p>æ­¤å¤„ï¼Œæˆ‘ä»¬ä»¥å­˜åœ¨æœ‰æ•ˆæ´»åŠ¨ä¸ºæ¡ä»¶ï¼Œç»§ç»­å…³æ³¨å¯åŠ¨æµç¨‹ï¼Œè·Ÿè¿›resumeTopActivityUncheckedLocked()ï¼›</p>
<h4 id="ActivityStack-resumeTopActivityUncheckedLocked"><a href="#ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="ActivityStack.resumeTopActivityUncheckedLocked()"></a>ActivityStack.resumeTopActivityUncheckedLocked()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStack&#125;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mInResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// ï¼ˆå¦‚æœåœ¨æ ˆé¡¶å¯è§ï¼‰,ç”šè‡³ä¸è¦å¼€å§‹é€’å½’.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é˜²æ­¢é€’å½’ã€‚</span></span><br><span class="line">        mInResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">        result = resumeTopActivityInnerLocked(prev, options);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“æ¢å¤topæ´»åŠ¨æ—¶ï¼Œå¯èƒ½éœ€è¦æš‚åœtopæ´»åŠ¨(ä¾‹å¦‚ï¼Œè¿”å›é”å±ã€‚</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬åœ¨&#123;@link #resumeTopActivityUncheckedLocked&#125;ä¸­å–æ¶ˆäº†æ­£å¸¸çš„æš‚åœé€»è¾‘ï¼Œå› ä¸ºé¡¶éƒ¨æ´»åŠ¨åœ¨ç»“æŸæ—¶æ¢å¤ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå†æ¬¡è°ƒç”¨&#123;@link ActivityStackSupervisor# checkreadyforsleepplocked&#125;æ¥ç¡®ä¿ä»»ä½•å¿…è¦çš„æš‚åœé€»è¾‘å‘ç”Ÿã€‚</span></span><br><span class="line">        <span class="comment">// åœ¨ä¸è€ƒè™‘é”å±çš„æƒ…å†µä¸‹ï¼Œæ´»åŠ¨å°†è¢«æ˜¾ç¤ºï¼Œå¯¹&#123;@link ActivityStackSupervisor# checkreadyforsleepplocked&#125;çš„è°ƒç”¨è¢«è·³è¿‡ã€‚</span></span><br><span class="line">        <span class="keyword">final</span> ActivityRecord next = topRunningActivity(<span class="keyword">true</span> <span class="comment">/* focusableOnly */</span>);</span><br><span class="line">        <span class="keyword">if</span> (next == <span class="keyword">null</span> || !next.canTurnScreenOn()) &#123;</span><br><span class="line">            checkReadyForSleep();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mInResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä»£ç ï¼Œè¿™é‡Œä¸»è¦åšäº†é˜²æ­¢é€’å½’è°ƒç”¨çš„æªæ–½ï¼Œä»¥åŠè°ƒç”¨äº†resumeTopActivityInnerLocked()æ–¹æ³•ï¼Œä»£ç è¾ƒé•¿ï¼Œæ­¤å¤„å°†åšå¿½ç•¥å’Œæ‹†è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStack&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¿½ç•¥éƒ¨åˆ†åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (!hasRunningActivity) &#123;</span><br><span class="line">        <span class="comment">// æ ˆé‡Œæ²¡æœ‰æ´»åŠ¨äº†ï¼Œæˆ‘ä»¬å»åˆ«çš„åœ°æ–¹çœ‹çœ‹ã€‚</span></span><br><span class="line">        <span class="comment">// å¤‡æ³¨ï¼šæ³¨æ„ï¼Œæ­¤å¤„å¯èƒ½ä¼šå‡ºç°é€’å½’è°ƒç”¨ï¼Œå³ä¼šè°ƒç”¨å‰é¢çš„æµç¨‹ï¼šRootWindowContainer.resumeFocusedStacksTopActivities()</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œä¹Ÿæ˜¯å‰åºæµç¨‹ä¸­é˜²èŒƒé€’å½’çš„åŸå› </span></span><br><span class="line">        <span class="keyword">return</span> resumeNextFocusableActivityWhenStackIsEmpty(prev, options);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥å¤§é‡ä»£ç </span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ ˆä¸­å…¶ä»–activityçš„pauseæ“ä½œ</span></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬æ­£åœ¨å¯åŠ¨ä¸‹ä¸€ä¸ªæ´»åŠ¨ï¼Œå› æ­¤å‘Šè¯‰çª—å£ç®¡ç†å™¨å‰ä¸€ä¸ªæ´»åŠ¨å°†å¾ˆå¿«è¢«éšè—ã€‚è¿™æ ·å®ƒå°±å¯ä»¥çŸ¥é“åœ¨è®¡ç®—æ‰€éœ€çš„å±å¹•æ–¹å‘æ—¶å¿½ç•¥å®ƒã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (next.attachedToProcess()) &#123;</span><br><span class="line">    <span class="comment">// æ›´æ–°è¿›ç¨‹ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// æ£€æŸ¥ç‰¹æ®Šåœºæ™¯ï¼Œä¾‹å¦‚åŠé€æ˜Activityç­‰</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å“å‘€ï¼Œéœ€è¦é‡æ–°å¯åŠ¨è¿™ä¸ªActivity!</span></span><br><span class="line">        <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</span><br><span class="line">            next.hasBeenLaunched = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</span><br><span class="line">                next.showStartingWindow(<span class="keyword">null</span> <span class="comment">/* prev */</span>, <span class="keyword">false</span> <span class="comment">/* newTask */</span>,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* taskSwich */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH) Slog.v(TAG_SWITCH, <span class="string">&quot;Restarting: &quot;</span> + next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES, <span class="string">&quot;resumeTopActivityLocked: Restarting &quot;</span> + next);</span><br><span class="line">        mStackSupervisor.startSpecificActivity(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç æ¯”è¾ƒé•¿ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†çš„æ“ä½œåœ¨ä¸Šè¿°ä»£ç çš„æ³¨é‡Šä¸­æœ‰è¯´æ˜ï¼Œæ­¤å¤„ä¸åšè¿‡å¤šå…³æ³¨ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸startActivity()æœ‰å…³çš„ä»£ç ä¸º<code>mStackSupervisor.startSpecificActivity(next, true, true)</code>, æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ä½œç”¨æ˜¯ä»€ä¹ˆã€‚</p>
<h4 id="ActivityStackSupervisor-startSpecificActivity"><a href="#ActivityStackSupervisor-startSpecificActivity" class="headerlink" title="ActivityStackSupervisor.startSpecificActivity()"></a>ActivityStackSupervisor.startSpecificActivity()</h4><p>Supervisor ï¼šä¸»ç®¡ã€‚è¿™ä¸ªç±»å­—é¢æ„æ€æ˜¯æ´»åŠ¨æ ˆçš„ä¸»ç®¡ï¼Œå®ƒçš„ä½œç”¨ä»æ³¨é‡Šä¸­å¯ä»¥äº†è§£åˆ°ï¼š</p>
<blockquote>
<ul>
<li>å°†ä¸å±‚æ¬¡ç»“æ„ç›¸å…³çš„ä¸œè¥¿ç§»åŠ¨åˆ°RootWindowContainer</li>
<li>å°†ä¸æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ä¸œè¥¿ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°çš„ç±»ActivityLifeCyclerä¸­</li>
<li>ç§»åŠ¨æ¥å£äº‹ç‰©åˆ°ActivityTaskManagerServiceã€‚</li>
<li>æ‰€æœ‰å…¶ä»–çš„å°äº‹æƒ…åˆ°å…¶ä»–æ–‡ä»¶ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void startSpecificActivity(ActivityRecord r, boolean andResume, boolean checkConfig) &#123;</span><br><span class="line">    &#x2F;&#x2F; Is this activity&#39;s application already running?</span><br><span class="line">    &#x2F;&#x2F; çœŸæ˜¯ä¸ªç³Ÿç³•çš„æ³¨é‡Šï¼Œè®©æˆ‘æƒ³èµ·äº†å¶å°”ä¼šé‡åˆ°çš„ä¸€ä¸ªæŠ¥é”™  â”—|ï½€Oâ€²|â”›</span><br><span class="line">    final WindowProcessController wpc &#x3D;</span><br><span class="line">            mService.getProcessController(r.processName, r.info.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">    boolean knownToBeDead &#x3D; false;</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœapplicationThreadå­˜åœ¨ï¼Œåˆ™æ‰§è¡ŒçœŸå®çš„å¯åŠ¨Activity</span><br><span class="line">    if (wpc !&#x3D; null &amp;&amp; wpc.hasThread()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            realStartActivityLocked(r, wpc, andResume, checkConfig);</span><br><span class="line">            return;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Exception when starting activity &quot;</span><br><span class="line">                    + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; å¦‚æœæŠ›å‡ºäº†æ­»å¯¹è±¡å¼‚å¸¸â€”â€”é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åºã€‚</span><br><span class="line">        knownToBeDead &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r.notifyUnknownVisibilityLaunchedForKeyguardTransition();</span><br><span class="line"></span><br><span class="line">    final boolean isTop &#x3D; andResume &amp;&amp; r.isTopRunningActivity();</span><br><span class="line">    &#x2F;&#x2F; è‹¥applicationThreadä¸å­˜åœ¨ï¼Œå°†å¯åŠ¨æ–°çš„è¿›ç¨‹</span><br><span class="line">    mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? &quot;top-activity&quot; : &quot;activity&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œä¸»è¦åšäº†ä¸‰æ¬¡æ ¡éªŒï¼š</p>
<ul>
<li>è‹¥ç›®æ ‡ApplicationThreadå¯¹è±¡å­˜åœ¨ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¯åŠ¨æµç¨‹</li>
<li>è‹¥å¯åŠ¨æµç¨‹æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é‡å¯åº”ç”¨ç¨‹åº</li>
<li>è‹¥ç›®æ ‡ApplicationThreadå¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™å¯åŠ¨æ–°çš„è¿›ç¨‹ï¼›æ­¤æµç¨‹æš‚ä¸åšå…³æ³¨ï¼Œå¯è‡ªè¡Œè·Ÿè¿›ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ActivityManagerService.startProcessLocked()åŠåç»­ZygoteProcessç›¸å…³æ–¹æ³•ã€‚</li>
</ul>
<h4 id="ActivityStackSupervisor-realStartActivityLocked"><a href="#ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="ActivityStackSupervisor.realStartActivityLocked()"></a>ActivityStackSupervisor.realStartActivityLocked()</h4><p>ActivityStackSupervisor.realStartActivityLocked()åŸºæœ¬ç®—å¾—ä¸Šå¯åŠ¨æµç¨‹ä¸­ç›¸å½“é‡è¦çš„ä¸€éƒ¨åˆ†äº†ï¼ŒåŸºæœ¬ç®—å¾—ä¸Šæ˜¯è°ƒç”¨é“¾çš„ç»“æŸï¼Œåç»­å°†æ‰§è¡Œç›®æ ‡ActivityThreadæ‰§è¡ŒLaunchæ“ä½œï¼Œæ•…å•ç‹¬åšä¸€å°èŠ‚è®²è¿°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ActivityStackSupervisor&#125;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, WindowProcessController proc,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mRootWindowContainer.allPausedActivitiesComplete()) &#123;</span><br><span class="line">        <span class="comment">// å½“æœ‰æ´»åŠ¨æš‚åœæ—¶ï¼Œæˆ‘ä»¬è·³è¿‡å¼€å§‹ä»»ä½•æ–°çš„æ´»åŠ¨ï¼Œç›´åˆ°æš‚åœå®Œæˆã€‚</span></span><br><span class="line">        <span class="comment">// æ³¨æ„:å¯¹äºåœ¨æš‚åœçŠ¶æ€ä¸‹å¯åŠ¨çš„æ´»åŠ¨ï¼Œæˆ‘ä»¬ä¹Ÿä¼šè¿™æ ·åšï¼Œå› ä¸ºå®ƒä»¬é¦–å…ˆä¼šè¢«æ¢å¤ï¼Œç„¶ååœ¨å®¢æˆ·ç«¯æš‚åœã€‚</span></span><br><span class="line">        <span class="comment">// æ€è€ƒï¼šé‚£ä¹ˆï¼Œä½ ä¼šæ‹…å¿ƒå½“æ­¤å¯åŠ¨æœªæˆåŠŸå—ï¼Ÿå¯è¿˜è®°å¾—ã€‚æˆ‘ä»¬å¯åŠ¨æµç¨‹å…¶å®åŒ…å«é€’å½’æ“ä½œï¼Œå¦‚æœæ­¤æ¬¡ä¸­æ–­ï¼Œä¸ä»£è¡¨åç»­å°±ä¸å†æ‰§è¡Œå¯åŠ¨æ“ä½œäº†ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_PAUSE || DEBUG_STATES) Slog.v(TAG_PAUSE,</span><br><span class="line">                <span class="string">&quot;realStartActivityLocked: Skipping start of r=&quot;</span> + r</span><br><span class="line">                + <span class="string">&quot; some activities pausing...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çœç•¥å¤§é‡ä»£ç     </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šåœ¨ç³»ç»Ÿè¿›ç¨‹ä¸­å¯åŠ¨ä¸€ä¸ªæ´»åŠ¨ï¼Œæ‰€ä»¥è¿™å¯èƒ½ä¸ä¼šè·¨è¶Šåˆ›å»ºæ–°é…ç½®çš„ç»‘å®šå™¨æ¥å£ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ€»æ˜¯åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> MergedConfiguration mergedConfiguration = <span class="keyword">new</span> MergedConfiguration(</span><br><span class="line">            proc.getConfiguration(), r.getMergedOverrideConfiguration());</span><br><span class="line">    r.setLastReportedConfiguration(mergedConfiguration);</span><br><span class="line"></span><br><span class="line">    logIfTransactionTooLarge(r.intent, r.getSavedState());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ´»åŠ¨å¯åŠ¨äº‹åŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">final</span> ClientTransaction clientTransaction = ClientTransaction.obtain(</span><br><span class="line">            proc.getThread(), r.appToken);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DisplayContent dc = r.getDisplay().mDisplayContent;</span><br><span class="line">    clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent),</span><br><span class="line">            System.identityHashCode(r), r.info,</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">            <span class="comment">// and override configs.</span></span><br><span class="line">            mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">            mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">            r.launchedFromPackage, task.voiceInteractor, proc.getReportedProcState(),</span><br><span class="line">            r.getSavedState(), r.getPersistentSavedState(), results, newIntents,</span><br><span class="line">            dc.isNextTransitionForward(), proc.createProfilerInfoIfNeeded(),</span><br><span class="line">            r.assistToken, r.createFixedRotationAdjustmentsIfNeeded()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set desired final state.</span></span><br><span class="line">    <span class="keyword">final</span> ActivityLifecycleItem lifecycleItem;</span><br><span class="line">    <span class="keyword">if</span> (andResume) &#123;</span><br><span class="line">        lifecycleItem = ResumeActivityItem.obtain(dc.isNextTransitionForward());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lifecycleItem = PauseActivityItem.obtain();</span><br><span class="line">    &#125;</span><br><span class="line">    clientTransaction.setLifecycleStateRequest(lifecycleItem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule transaction.</span></span><br><span class="line">    mService.getLifecycleManager().scheduleTransaction(clientTransaction);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†æ¬¡çœç•¥å¤§é‡ä»£ç </span></span><br><span class="line">    <span class="comment">// è®¾ç½®æ´»åŠ¨çŠ¶æ€åï¼Œæ‰§è¡ŒOOMè¯„åˆ†ï¼Œä½¿æµç¨‹å¯ä»¥æ›´æ–°ä¸ºæœ€æ–°çŠ¶æ€ã€‚    </span></span><br><span class="line">    proc.onStartActivity(mService.mTopProcessState, r.info);</span><br><span class="line">    <span class="comment">//å¦‚æœéœ€è¦ï¼Œå¯åŠ¨æ–°ç‰ˆæœ¬è®¾ç½®å±å¹•ã€‚æˆ‘ä»¬åœ¨å¯åŠ¨åˆå§‹åŒ–çš„activity(å³home)ä¹‹ååšè¿™ä¸ªæ“ä½œï¼Œè¿™æ ·å®ƒå°±æœ‰æœºä¼šåœ¨åå°åˆå§‹åŒ–è‡ªå·±ï¼Œä½¿åˆ‡æ¢å›å®ƒæ›´å¿«ï¼Œçœ‹èµ·æ¥æ›´å¥½ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (mRootWindowContainer.isTopDisplayFocusedStack(stack)) &#123;</span><br><span class="line">        mService.getActivityStartController().startSetupActivity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°æˆ‘ä»¬ç»‘å®šåˆ°çš„ä»»ä½•å¯èƒ½å…³å¿ƒå…¶å®¢æˆ·ç«¯æ˜¯å¦æœ‰æ´»åŠ¨çš„æœåŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.app.updateServiceConnectionActivities();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šè¿°ä»£ç åŠæ³¨é‡Šæˆ‘ä»¬å¯çŸ¥ï¼ŒrealStartActivityLockedçš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p>
<ul>
<li>è‹¥æœ‰æ­£åœ¨pauseçš„æ´»åŠ¨ï¼Œç­‰å¾…å®ƒæ“ä½œå®Œæ¯•</li>
<li>åˆ›å»º LaunchActivityItem ï¼ˆå¯åŠ¨Activityçš„ç­–ç•¥/çŠ¶æ€ï¼‰å¹¶å°è£…æˆäº‹åŠ¡</li>
<li>æ‰§è¡Œå¯åŠ¨Activityçš„äº‹åŠ¡</li>
<li>æ›´æ–°è¿›ç¨‹ä¿¡æ¯åŠå…¶ä»–ç›¸å…³æœåŠ¡</li>
</ul>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬çŸ¥é“activityå¯åŠ¨æµç¨‹çš„æœ€åä¸¤æ­¥å³æ˜¯ï¼šåˆ›å»º LaunchActivityItem åŠæ‰§è¡Œ ClientTransactionï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸¤å„éƒ¨åˆ†ä»‹ç»ï¼Œå…ˆä»‹ç» ClientTransaction çš„è°ƒç”¨æµç¨‹ï¼Œå†ä»‹ç» LaunchActivityItem æ˜¯ä»€ä¹ˆã€‚</p>
<h4 id="æ‰§è¡ŒLaunchActivityItemäº‹åŠ¡"><a href="#æ‰§è¡ŒLaunchActivityItemäº‹åŠ¡" class="headerlink" title="æ‰§è¡ŒLaunchActivityItemäº‹åŠ¡"></a>æ‰§è¡ŒLaunchActivityItemäº‹åŠ¡</h4><p>ActivityStackSupervisor.realStartActivityLocked()ä¸­è°ƒç”¨çš„<code>mService.getLifecycleManager().scheduleTransaction(clientTransaction);</code>å®é™…æ˜¯ClientLifecycleManager.scheduleTransaction()ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> com.android.server.wm.ClientLifecycleManager&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTransaction</span><span class="params">(ClientTransaction transaction)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IApplicationThread client = transaction.getClient();</span><br><span class="line">    transaction.schedule();</span><br><span class="line">    <span class="keyword">if</span> (!(client <span class="keyword">instanceof</span> Binder)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœclientä¸æ˜¯Binderçš„å®ä¾‹â€”â€”å®ƒæ˜¯ä¸€ä¸ªè¿œç¨‹è°ƒç”¨ï¼Œæ­¤æ—¶å¯ä»¥å®‰å…¨åœ°å›æ”¶å¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="comment">// åœ¨ActivityThreadçš„å®¢æˆ·ç«¯ä¸Šæ‰§è¡Œäº‹åŠ¡åï¼Œç”¨äºæœ¬åœ°è°ƒç”¨çš„æ‰€æœ‰å¯¹è±¡éƒ½å°†è¢«å›æ”¶ã€‚</span></span><br><span class="line">        transaction.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸»è¦è°ƒç”¨äº†<code>ClientTransaction.schedule()</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> android.app.servertransaction.ClientTransaction&#125;</span><br><span class="line"><span class="comment">/** Target client. */</span></span><br><span class="line"><span class="keyword">private</span> IApplicationThread mClient;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    mClient.scheduleTransaction(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œè¿™é‡Œè°ƒç”¨äº†IApplicationThread.scheduleTransaction()ã€‚è¿™é‡Œçš„IApplicationThreadæ¥æºäºClientTransaction.obtain()å…¥å‚ï¼Œå‘å‰è¿½æº¯åˆ™æ˜¯é€šè¿‡ActivityRecorderè·å–çš„ï¼Œå®é™…æ˜¯å‰è¿°å¯åŠ¨æµç¨‹ä¸­ä¼ é€’çš„callerã€æ­¤å¤„æè¿°å¯èƒ½ä¸å¤Ÿä¸¥è°¨ï¼Œå¦‚æœ‰é”™è¯¯è¯·è¯„è®ºæˆ–è”ç³»ä½œè€…ã€‘ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆåº”è¯¥æ‰¾åˆ° IApplicationThreadçš„å®ç°ï¼Œå¦‚æœä½ å¯¹ActivityThreadæœ‰ä¸€å®šäº†è§£çš„è¯ï¼Œå¯ä»¥çŸ¥é“å…¶å†…éƒ¨ç±» ApplicationThread å®ç°äº† IApplicationThread.Stubï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;@link android.app.ActivityThread&#125;</span><br><span class="line"></span><br><span class="line">public final class ActivityThread extends ClientTransactionHandler &#123;</span><br><span class="line"></span><br><span class="line">    private class ApplicationThread extends IApplicationThread.Stub &#123;</span><br><span class="line">        &#x2F;&#x2F; å¿½ç•¥å…¶ä»–ä»£ç </span><br><span class="line">        @Override</span><br><span class="line">        public void scheduleTransaction(ClientTransaction transaction) throws RemoteException &#123;</span><br><span class="line">            ActivityThread.this.scheduleTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public abstract class ClientTransactionHandler &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Schedule phase related logic and handlers.</span><br><span class="line"></span><br><span class="line">    &#x2F;** Prepare and schedule transaction for execution. *&#x2F;</span><br><span class="line">    void scheduleTransaction(ClientTransaction transaction) &#123;</span><br><span class="line">        transaction.preExecute(this);</span><br><span class="line">        sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  class H extends Handler &#123;</span><br><span class="line">      </span><br><span class="line">      public void handleMessage(Message msg) &#123;</span><br><span class="line">            switch (msg.what) &#123;</span><br><span class="line">                case EXECUTE_TRANSACTION:</span><br><span class="line">                    final ClientTransaction transaction &#x3D; (ClientTransaction) msg.obj;</span><br><span class="line">                    mTransactionExecutor.execute(transaction);</span><br><span class="line">                    if (isSystem()) &#123;</span><br><span class="line">                        &#x2F;&#x2F; ç³»ç»Ÿè¿›ç¨‹å†…éƒ¨çš„å®¢æˆ·ç«¯äº‹åŠ¡åœ¨å®¢æˆ·ç«¯å¾ªç¯ï¼Œè€Œä¸æ˜¯åœ¨ClientLifecycleManagerä¸­å¾ªç¯ï¼Œä»¥é¿å…åœ¨æ­¤æ¶ˆæ¯è¢«å¤„ç†ä¹‹å‰è¢«æ¸…é™¤ã€‚</span><br><span class="line">                        transaction.recycle();</span><br><span class="line">                    &#125;</span><br><span class="line">                    &#x2F;&#x2F; TODO(lifecycler): Recycle locally scheduled transactions.</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œè°ƒç”¨IApplicationThread.scheduleTransaction()ï¼Œå®é™…ä¸Šæ˜¯å‘ActivityThread.Hå‘é€äº†Messageï¼Œè€ŒåActivityThread.Hå¤„ç†æ¶ˆæ¯å¹¶è°ƒç”¨äº†<code>mTransactionExecutor.execute(transaction)</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> android.app.servertransaction.TransactionExecutor&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¿½ç•¥ä»£ç </span></span><br><span class="line"></span><br><span class="line">    executeCallbacks(transaction);</span><br><span class="line"></span><br><span class="line">    executeLifecycleState(transaction);</span><br><span class="line">    mPendingActions.clear();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESOLVER) Slog.d(TAG, tId(transaction) + <span class="string">&quot;End resolving transaction&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cycle through all states requested by callbacks and execute them at proper times. */</span></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeCallbacks</span><span class="params">(ClientTransaction transaction)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¿½ç•¥ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = callbacks.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="keyword">final</span> ClientTransactionItem item = callbacks.get(i);</span><br><span class="line">        <span class="comment">// å¿½ç•¥ä»£ç </span></span><br><span class="line"></span><br><span class="line">        item.execute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        item.postExecute(mTransactionHandler, token, mPendingActions);</span><br><span class="line">        <span class="comment">// å¿½ç•¥ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TransactionExecutor.execute()åŠåç»­executeCallbacks()æœ€ç»ˆè°ƒç”¨åˆ°äº† BaseClientRequest.execute()ï¼Œä¹Ÿå°±æ˜¯LaunchActivityItem.execute()ã€‚</p>
<h4 id="LaunchActivityItem"><a href="#LaunchActivityItem" class="headerlink" title="LaunchActivityItem"></a>LaunchActivityItem</h4><p>åœ¨Android API 29åŠä»¥ä¸ŠSDKä¸­ï¼ŒGoogleå°†å¯ä»¥è°ƒåº¦å’Œæ‰§è¡Œçš„åˆ°å®¢æˆ·ç«¯çš„å›è°ƒæ¶ˆæ¯å°è£…ä¸ºäº‹åŠ¡ï¼ŒåŒ…å«Launchã€Startã€Stopç­‰å„ç§çŠ¶æ€ã€‚</p>
<p>ç»§æ‰¿è‡ª ClientTransactionItem åŠä¸Šå±‚ BaseClientRequestï¼Œæ ¸å¿ƒæ–¹æ³•ä¸ºexecute(ClientTransactionHandler client, IBinder token, PendingTransactionActions pendingActions)ï¼Œå·²çŸ¥çš„ClientTransactionHandler æœ‰ActivityThreadã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="meta">@link</span> android.app.servertransaction.LaunchActivityItem&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ClientTransactionHandler client, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord(token, mIntent, mIdent, mInfo,</span><br><span class="line">            mOverrideConfig, mCompatInfo, mReferrer, mVoiceInteractor, mState, mPersistentState,</span><br><span class="line">            mPendingResults, mPendingNewIntents, mIsForward,</span><br><span class="line">            mProfilerInfo, client, mAssistToken, mFixedRotationAdjustments);</span><br><span class="line">    client.handleLaunchActivity(r, pendingActions, <span class="keyword">null</span> <span class="comment">/* customIntent */</span>);</span><br><span class="line">    Trace.traceEnd(TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LaunchActivityItem.execute()ä¸­ä¸»è¦è°ƒç”¨äº†<code>client.handleLaunchActivity(r, pendingActions, null /* customIntent */)</code>ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†ActivityThreadçš„ç›¸å…³æ–¹æ³•ã€‚</p>
<p>å½“ç„¶çš„ActivityThread.handleLaunchActivity() å°±æ˜¯å®é™…çš„æ–°çš„Activityä»åˆ›å»ºåˆ°å±•ç¤ºçš„æµç¨‹äº†ã€‚</p>
<p>è‡³æ­¤ï¼Œå…¶å®æ•´ä¸ªä» startActivityçš„è°ƒç”¨åˆ°ç›®æ ‡Activityåˆ›å»ºçš„è°ƒç”¨æµç¨‹å°±å·²ç»åˆ†æå®Œæ¯•äº†ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥ç”»ä¸€ç”»æ•´ä¸ªæµç¨‹çš„æ—¶åºå›¾ã€‚</p>
<p>ã€æ—¶åºå›¾è¿˜åœ¨ç”»ï¼Œè§‚ä¼—è€çˆ·è¯·ç¨å€™ã€‘</p>
]]></content>
      <categories>
        <category>framework</category>
      </categories>
      <tags>
        <tag>Activity</tag>
      </tags>
  </entry>
  <entry>
    <title>Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-LifecycleåŸç†ç¯‡</title>
    <url>/2021/02/28/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E5%8E%9F%E7%90%86%E7%AF%87/</url>
    <content><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è®²äº†<a href="https://tinlone.com/2021/02/25/Jetpack%E4%B9%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%84%9F%E7%9F%A5%E7%BB%84%E4%BB%B6-Lifecycle%E4%BD%BF%E7%94%A8%E7%AF%87/">Jetpackä¹‹ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥ç»„ä»¶-Lifecycleä½¿ç”¨ç¯‡</a>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä»–æ˜¯å¦‚ä½•å·¥ä½œçš„å§ã€‚</p>
<p>åœ¨äº†è§£å…¶å·¥ä½œåŸç†å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä»¥ä¸‹ActivityThreadå¯¹Activityç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘æµç¨‹ï¼Œä»¥ä¾¿ç†è§£Lifecycleçš„å·¥ä½œåŸç†ã€‚</p>
<p>æ­¤ç¯‡å‰åŠéƒ¨åˆ†å°†è®²è¿°API26åŠAPI30ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ï¼ŒååŠéƒ¨åˆ†ä¾ç…§å‰åŠéƒ¨åˆ†å¯¹ç…§è®²è¿°Lifecycleç”Ÿå‘½å‘¨æœŸåˆ†å‘æ—¶æœºï¼Œæœ€åå°†ä»‹ç»Lifecycleæºç æ‰§è¡Œæµç¨‹åŠProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬çš„ã€‚</p>
<a id="more"></a>

<h3 id="ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘"><a href="#ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘"></a>ç”Ÿå‘½å‘¨æœŸçš„äº§ç”ŸåŠåˆ†å‘</h3><p>æ­¤éƒ¨åˆ†æºç å–è‡ª<code>Android SDK api26 & api30</code>, è·å–æ–¹å¼ä¸ºä½¿ç”¨Android Studio çš„ SDK Manager ä¸‹è½½ api26 åŠ api30 æºä»£ç ï¼Œæºä»£ç ç›®å½•ä¸º<code> %AndroidSDK%/source/android-ç‰ˆæœ¬å·</code>ï¼Œä½ å¯ä»¥ä½¿ç”¨SublimeTextç­‰å·¥å…·æ‰“å¼€æºç å¯¹ç…§é˜…è¯»ã€‚</p>
<p>Lifecycleä»¥Api29ä¸ºåˆ†ç•Œç‚¹æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œè¿™æ˜¯å…ˆè®²è¿°æ­¤èŠ‚å†…å®¹çš„åŸå› ï¼Œæ­¤å¤„ä»¥Api26åŠApi30ä¸ºä»£è¡¨è®²è¿°ã€‚</p>
<h4 id="API-26"><a href="#API-26" class="headerlink" title="API 26"></a>API 26</h4><p>æˆ‘ä»¬çŸ¥é“ï¼ŒActivityæ˜¯ç”±ActivityThreadç”ŸæˆåŠç®¡ç†çš„ã€‚æ­¤å¤„ä»¥<code>ActivityThread.performLaunchActivity()</code>ä¸ºèµ·ç‚¹ï¼Œåˆ†æActivity onCreate()/onStart()äº‹ä»¶çš„äº§ç”ŸåŠåˆ†å‘ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ç®€åŒ–ç‰ˆçš„performLaunchActivity()ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something create Activity</span></span><br><span class="line">    activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">    <span class="comment">// ... init Activity</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        <span class="comment">// logs </span></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// activity attach &amp; setTheme ...</span></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                <span class="comment">// onCreate()</span></span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// some log</span></span><br><span class="line">            r.activity = activity;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="comment">// onStart()</span></span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">// do something</span></span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">// do something</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       <span class="comment">// log error</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œåœ¨å®Œæˆäº†Activityå¯åŠ¨æ¡ä»¶åè°ƒç”¨äº†<code>mInstrumentation.callActivityOnCreate(</code>åŠ<code>activity.performStart()</code>( å³ç”Ÿå‘½å‘¨æœŸonCreate()å’ŒonStart()ï¼‰, ä¸ºäº†ä¸€å¹¶äº†è§£Fragmentç”Ÿå‘½å‘¨æœŸçš„åˆ†å‘ï¼Œæˆ‘ä»¬ä»¥onStart()ä¸ºä¾‹ï¼ŒonStart()äº‹ä»¶äº§ç”Ÿäºæ­¤ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿› <code>activity.performStart()</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œä¼šå›è°ƒåˆ°activity.onStart();</span></span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// logs</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„mFragmentsæ˜¯ FragmentControllerï¼Œ</span></span><br><span class="line">    <span class="comment">// åç»­ä¼šè°ƒç”¨FragmentManager.dispatchStart()ã€fragment.performStart()</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‰§è¡Œåˆ° fragment.onStart()</span></span><br><span class="line">    mFragments.dispatchStart();</span><br><span class="line">    mFragments.reportLoaderStart();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do Something others</span></span><br><span class="line"></span><br><span class="line">    mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Instrumentation&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä¸Šé¢ä»£ç ä»£ç æˆ‘ä»¬äº†è§£äº†<strong>API26</strong>æ—¶ Activityçš„onStart()äº‹ä»¶çš„äº§ç”Ÿåˆ°ä¼ é€’ï¼Œä»¥åŠä¼ é€’ç»™Fragmentçš„æ–¹å¼ã€æ­¤å¤„ä»£ç è·Ÿè¿›çœç•¥ï¼Œä½†åº”äº†è§£è¿™ä¸ªæµç¨‹ï¼Œåç»­åœ¨è®²è¿°Lifecycleæ—¶å°†ä¼šç”¨åˆ°ã€‘ã€‚</p>
<h4 id="API-30-ï¼ˆAPI-lvl-â‰¥-29ï¼‰"><a href="#API-30-ï¼ˆAPI-lvl-â‰¥-29ï¼‰" class="headerlink" title="API 30 ï¼ˆAPI lvl â‰¥ 29ï¼‰"></a>API 30 ï¼ˆAPI lvl â‰¥ 29ï¼‰</h4><p>åŒæ ·çš„ï¼Œæ­¤å¤„ä»¥<code>ActivityThread.performLaunchActivity()</code>ä¸ºèµ·ç‚¹ï¼Œåˆ†æActivity onCreate()/onStart()äº‹ä»¶çš„äº§ç”ŸåŠåˆ†å‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create Activity</span></span><br><span class="line">    activity = mInstrumentation.newActivity(</span><br><span class="line">            cl, component.getClassName(), r.intent);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        <span class="comment">// init Activity &amp; setTheme</span></span><br><span class="line">        activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">            <span class="comment">// onCreate()</span></span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// some log</span></span><br><span class="line">        r.activity = activity;</span><br><span class="line">        mLastReportedWindowingMode.put(activity.getActivityToken(),</span><br><span class="line">                config.windowConfiguration.getWindowingMode());</span><br><span class="line">        <span class="comment">// è®¾ç½®ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">        r.setState(ON_CREATE);</span><br><span class="line">        <span class="comment">// something</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// log error</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸ API 26 åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯æ­¤æ—¶onCreateäº‹ä»¶ä¸onStartäº‹ä»¶çš„äº§ç”Ÿå·²ä¸æ˜¯è€¦åˆç›¸å…³ï¼ŒåŒæ ·çš„å…³æ³¨onStart()ç”Ÿå‘½å‘¨æœŸï¼Œæ­¤å¤„å·²ä¸åŒ…å«onStart()ç›¸å…³çš„ä»£ç åŠè°ƒç”¨ï¼Œæˆ‘ä»¬å‘ç°æœ‰æ–°çš„ä»£ç <code>r.setState(ON_CREATE);</code>å¯èƒ½ä¸ç”Ÿå‘½å‘¨æœŸæœ‰å…³ï¼ŒçŒœæµ‹æ˜¯å¦onStart()äº‹ä»¶ä¹Ÿä¼šæœ‰ç±»ä¼¼æ–¹æ³•ï¼Œæœç„¶ï¼Œåœ¨ç›¸é‚»çš„ä¸‹ä¸€ä¸ªæ–¹æ³•<code>handleStartActivity</code>ä¸­æˆ‘ä»¬å‘ç°ç±»ä¼¼ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ActivityThread&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStartActivity</span><span class="params">(IBinder token, PendingTransactionActions pendingActions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// Start</span></span><br><span class="line">    activity.performStart(<span class="string">&quot;handleStartActivity&quot;</span>);</span><br><span class="line">    r.setState(ON_START);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// something Restore instance state</span></span><br><span class="line">   </span><br><span class="line">    updateVisibility(r, <span class="keyword">true</span> <span class="comment">/* show */</span>);</span><br><span class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼çš„ï¼Œè¿™é‡Œè°ƒç”¨äº†<code>activity.performStart("handleStartActivity");</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performStart</span><span class="params">(String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„æ³¨æ„</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„æœ‰æ–°ä»£ç ï¼Œç”¨ä»¥é€šçŸ¥æ³¨å†Œåœ¨ApplicationåŠActivityä¸­çš„ActivityLifecycleCallbackså½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œç”±è¿™äº›å›è°ƒæ–¹æ³•åˆ†å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">    dispatchActivityPreStarted();</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆè°ƒç”¨onStart()</span></span><br><span class="line">    mInstrumentation.callActivityOnStart(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„mFragmentsæ˜¯ FragmentControllerï¼Œ</span></span><br><span class="line">    <span class="comment">// åç»­ä¼šè°ƒç”¨FragmentManager.dispatchStart()ã€fragment.performStart()</span></span><br><span class="line">    <span class="comment">// æœ€ç»ˆæ‰§è¡Œåˆ° fragment.onStart()</span></span><br><span class="line">    mFragments.dispatchStart();</span><br><span class="line">    mFragments.reportLoaderStart();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do something debug</span></span><br><span class="line"></span><br><span class="line">    mActivityTransitionState.enterReady(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨æ„æ³¨æ„</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ­¤å¤„æœ‰æ–°ä»£ç ï¼Œç”¨ä»¥é€šçŸ¥æ³¨å†Œåœ¨ApplicationåŠActivityä¸­çš„ActivityLifecycleCallbackså½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œç”±è¿™äº›å›è°ƒæ–¹æ³•åˆ†å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">    dispatchActivityPostStarted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Instrumentation&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnStart</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    activity.onStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤„ä¸»ä½“é€»è¾‘ä¸API 26ä¸€è‡´ï¼Œå‡æ˜¯è°ƒç”¨Activity onStart()å›è°ƒå’Œåˆ†å‘äº‹ä»¶ç»™Fragmentï¼Œæˆ‘ä»¬æ³¨æ„åˆ°æ­¤å¤„å¤šäº†ä¸¤ä¸ª â€œdispatchActivityXXX()â€ æ–¹æ³•ï¼Œè·Ÿè¿›è¿™ä¸¤ä¸ª â€œdispatchActivityXXX()â€ æ–¹æ³•ï¼Œå‡ä¸ºæ‰§è¡Œä»¥ä¸‹ç±»ä¼¼ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;Activity&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchActivityPreStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    getApplication().dispatchActivityPreStarted(<span class="keyword">this</span>);</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((Application.ActivityLifecycleCallbacks) callbacks[i]).onActivityPreStarted(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@link</span>&#123;Application&#125;</span><br><span class="line"><span class="comment">/* package */</span> <span class="function"><span class="keyword">void</span> <span class="title">dispatchActivityPreStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">    Object[] callbacks = collectActivityLifecycleCallbacks();</span><br><span class="line">    <span class="keyword">if</span> (callbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callbacks.length; i++) &#123;</span><br><span class="line">            ((ActivityLifecycleCallbacks) callbacks[i]).onActivityPreStarted(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•åˆ†æä»£ç ï¼Œå¯ä»¥å‘ç°ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸ŠæŠ¥ç»™Applicaitonè¿›è¡Œå›è°ƒåˆ†å‘ä»¥åŠé€šçŸ¥æ³¨å†Œåœ¨Activityä¸­çš„å›è°ƒåˆ†å‘ã€è®°ä½æ­¤å¤„ï¼Œä¸Lifecycleåœ¨Api29å‰åä¸åŒå¤„ç†æ–¹å¼æœ‰å…³ã€‘ã€‚</p>
<p>è€Œç›¸æ¯”äº API26ï¼Œé€šè¿‡è·Ÿè¿›<code>collectActivityLifecycleCallbacks()</code>å‘ç°ï¼Œ Activityåœ¨API29ä¹‹åæ–°å¢äº†ç”Ÿå‘½å‘¨æœŸæ³¨å†ŒåŠŸèƒ½ï¼Œå³ç»´æŠ¤äº†ä¸€ä¸ª <code> ActivityLifecycleCallbacks</code>é›†åˆï¼Œè€Œç”Ÿå‘½å‘¨æœŸåœ¨Activityä¸­çš„æœ€åä½¿å‘½å°±æ˜¯é€šè¿‡ dispatchActivityXXX() å‘æ³¨å†Œåœ¨Activity/Applicationä¸­çš„ ActivityLifecycleCallbacks åˆ†å‘äº‹ä»¶ã€‚</p>
<h3 id="Lifecycleæºç è§£æ"><a href="#Lifecycleæºç è§£æ" class="headerlink" title="Lifecycleæºç è§£æ"></a>Lifecycleæºç è§£æ</h3><p>å‰åŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬è®²è¿°äº†Activityç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„äº§ç”Ÿå’Œåˆ†å‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Lifecycleæ˜¯å¦‚ä½•è®¢é˜…å’Œæ¶ˆè´¹è¿™äº›äº‹ä»¶çš„å§ã€‚</p>
<h4 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h4><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Lifecycleçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> State <span class="title">getCurrentState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">        ON_CREATE,</span><br><span class="line">        ON_START,</span><br><span class="line">        ON_RESUME,</span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        ON_STOP,</span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        ON_ANY;</span><br><span class="line">       <span class="comment">// some apis</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">        DESTROYED,</span><br><span class="line">        INITIALIZED,</span><br><span class="line">        CREATED,</span><br><span class="line">        STARTED,</span><br><span class="line">        RESUMED;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Lifecycle æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºå­˜å‚¨æœ‰å…³ç»„ä»¶ï¼ˆå¦‚ Activity æˆ– Fragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„ä¿¡æ¯ï¼Œå¹¶å…è®¸å…¶ä»–å¯¹è±¡è§‚å¯Ÿæ­¤çŠ¶æ€ã€‚<br>Lifecycle ä½¿ç”¨ä¸¤ç§ä¸»è¦æšä¸¾è·Ÿè¸ªå…¶å…³è”ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š</p>
<ul>
<li>äº‹ä»¶<pre><code> ä»æ¡†æ¶å’Œ Lifecycle ç±»åˆ†æ´¾çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚è¿™äº›äº‹ä»¶æ˜ å°„åˆ° Activity å’Œ Fragment ä¸­çš„å›è°ƒäº‹ä»¶ã€‚
</code></pre>
</li>
<li>çŠ¶æ€<pre><code> ç”± Lifecycle å¯¹è±¡è·Ÿè¸ªçš„ç»„ä»¶çš„å½“å‰çŠ¶æ€ã€‚ 
</code></pre>
</li>
</ul>
</blockquote>
<p><img src="https://developer.android.google.cn/images/topic/libraries/architecture/lifecycle-states.svg" alt="Lifecycle.png"></p>
<p>Lifecycleçš„ä¸»è¦å­ç±»æ˜¯LifecycleRegistryï¼Œä¸»è¦ç”¨äºæœ€ç»ˆå¤„ç†å’Œåˆ†å‘äº‹ä»¶ç»™å¯¹åº”çš„Observerï¼Œç”±äºå…¶åœ¨è°ƒç”¨æµç¨‹çš„æœ€å°¾ç«¯ï¼Œæ•…æˆ‘ä»¬æ”¾åˆ°åé¢æµç¨‹ä¸­ä¸€èµ·è®²è§£ã€‚</p>
<h4 id="ComponentActivity"><a href="#ComponentActivity" class="headerlink" title="ComponentActivity"></a>ComponentActivity</h4><blockquote>
<p>æ”¯æŒåº“ 26.1.0 åŠæ›´é«˜ç‰ˆæœ¬ä¸­çš„ Fragment å’Œ Activity å·²å®ç° LifecycleOwner æ¥å£ã€‚</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£æœ‰æŒ‡å‡ºæ”¯æŒåº“ 26.1.0ä»¥ä¸Šçš„Fragmentå’ŒActivityä¸­å·²å®ç°LifecycleOwner æ¥å£ï¼Œæˆ‘ä»¬ä»<code>androidx.appcompat.app.AppCompatActivity</code>å‘ä¸Šæ‰¾å¯»LifecycleOwnerçš„èº«å½±ï¼Œ<code>androidx.activity.ComponentActivity</code>åŠ<code>androidx.core.app.ComponentActivity</code>å‡æœ‰å¯¹ LifecycleOwnerçš„å®ç°ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹çˆ¶ç±»<code>androidx.core.app.ComponentActivity</code>ä¸­çš„å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComponentActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">LifecycleOwner</span>,</span></span><br><span class="line"><span class="class">        <span class="title">KeyEventDispatcher</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LifecycleRegistry mLifecycleRegistry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&quot;RestrictedApi&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        ReportFragment.injectIfNeededIn(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallSuper</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSaveInstanceState</span><span class="params">(<span class="meta">@NonNull</span> Bundle outState)</span> </span>&#123;</span><br><span class="line">        mLifecycleRegistry.markState(Lifecycle.State.CREATED);</span><br><span class="line">        <span class="keyword">super</span>.onSaveInstanceState(outState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œå…¶ä»£ç ä¸å¤šï¼Œä¸ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ ¸å¿ƒä»£ç ä»…å®ç°äº†onCreateåŠonSaveInstanceStateï¼Œå…¶ä¸­onCreate()ä¸­ä¸­ä»…æœ‰ä¸€å¥ç‰¹åˆ«çš„ä»£ç <code>ReportFragment.injectIfNeededIn(this);</code>æˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡ä»–ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ‰å…³ï¼Œæˆ‘ä»¬å°è¯•è·Ÿè¿›ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ReportFragment&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;</span><br><span class="line">        <span class="comment">// åœ¨API 29+ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ³¨å†Œæ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</span></span><br><span class="line">        LifecycleCallbacks.registerIn(activity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¹‹å‰çš„API 29å’Œä¿æŒä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§</span></span><br><span class="line">    <span class="comment">// ProcessLifecycleOwner(å½“ç”Ÿå‘½å‘¨æœŸè¿è¡Œæ—¶æ›´æ–°æ—¶å¯èƒ½ä¸ä¼šæ›´æ–°ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”éœ€è¦æ”¯æŒä¸ä»æ”¯æŒåº“çš„FragmentActivityæ‰©å±•çš„æ´»åŠ¨)ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ¡†æ¶ç‰‡æ®µæ¥è·å¾—ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æ­£ç¡®æ—¶é—´</span></span><br><span class="line">    android.app.FragmentManager manager = activity.getFragmentManager();</span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        manager.beginTransaction().add(<span class="keyword">new</span> ReportFragment(), REPORT_FRAGMENT_TAG).commit();</span><br><span class="line">        <span class="comment">// å¸Œæœ›æˆ‘ä»¬æ˜¯ç¬¬ä¸€ä¸ªè¾¾æˆäº¤æ˜“çš„ã€‚</span></span><br><span class="line">        manager.executePendingTransactions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœä¸å…¶ç„¶ï¼Œæˆ‘ä»¬å‘ç°è¿™é‡Œæœ‰<code>LifecycleCallbacks</code>å…³é”®å­—ï¼Œè¿˜è®°å¾—å‰é¢è®²åˆ°çš„ç”Ÿå‘½å‘¨æœŸåˆ†å‘æµç¨‹ä¸­æåˆ°çš„APIä¸åŒç‰ˆæœ¬å¯¹äºç”Ÿå‘½å‘¨æœŸå¤„ç†æ–¹å¼çš„ä¸åŒå—ï¼Œä¸»è¦åŒºåˆ«åœ¨äºAPI29 Activityä¸­æ–°å¢äº†<code>ActivityLifecycleCallbacks</code>çš„æ³¨å†Œå’Œåˆ†å‘ï¼Œè€ŒAPI 29ä¹‹å‰ç”Ÿå‘½å‘¨æœŸå‡ä¼šä¼ é€’ç»™Fragmentã€‚ æ­¤å¤„æˆ‘ä»¬å‘ç°è¿™é‡Œçš„ ReportFragment æœ¬è´¨æ˜¯ä¸€ä¸ªFragmentï¼Œåœ¨Activityåˆ›å»ºï¼ˆonCreateï¼‰çš„æ—¶å€™ï¼š</p>
<ul>
<li>å¯¹äºAPI â‰¥ 29 å°†ä¼šæ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå¹¶å°†ReportFragmentæ·»åŠ åˆ°Activityä¸­</li>
<li>å¯¹äºAPI &lt; 29 å°†ReportFragmentæ·»åŠ åˆ°Activityä¸­.</li>
</ul>
<p>é‚£ä¹ˆè¿™æ ·åšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™é‡ŒinjectIfNeededInå…·ä½“å¹²äº†ä»€ä¹ˆã€‚<br>é¦–å…ˆ <code>LifecycleCallbacks.registerIn(activity)</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequiresApi(29)</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleCallbacks</span> <span class="keyword">implements</span> <span class="title">Application</span>.<span class="title">ActivityLifecycleCallbacks</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        activity.registerActivityLifecycleCallbacks(<span class="keyword">new</span> LifecycleCallbacks());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostCreated</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostResumed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPrePaused</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreStopped</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreDestroyed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">        dispatch(activity, Lifecycle.Event.ON_DESTROY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ignore empty function</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°†ä¼šæŠŠä¸€ä¸ª Application.ActivityLifecycleCallbacks æ³¨å†Œåˆ°å½“å‰Activityä¸­ï¼Œè¿˜è®°å¾—å‰é¢è®²åˆ°çš„ï¼Œç”Ÿå‘½å‘¨æœŸåœ¨Activityä¸­çš„æœ€åä½¿å‘½å°±æ˜¯é€šè¿‡ dispatchActivityXXX() å‘æ³¨å†Œåœ¨Activity/Applicationä¸­çš„ ActivityLifecycleCallbacks åˆ†å‘äº‹ä»¶ã€‚<br>å¯¹åº”æ­¤å¤„ï¼Œå³æ˜¯ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¼šåé¦ˆåˆ° <code> ReportFragment.LifecycleCallbacks</code> å¹¶æœ€ç»ˆè°ƒç”¨<code>dispatch(activity, Lifecycle.Event.ON_XXXX);</code>åˆ†å‘ã€‚</p>
<p>é‚£ä¹ˆåœ¨API29ä»¥å‰å‘¢ï¼Ÿï¼Ÿ</p>
<p>å‰é¢æœ‰è¦æ±‚æ³¨æ„è¿‡ åœ¨ç”Ÿå‘½å‘¨æœŸåˆ†å‘è¿‡ç¨‹ä¸­ å‡ä¼šè°ƒç”¨<code> FragmentController.dispatchXXX();</code> æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨Fragmentçš„ onXXXX()æ–¹æ³•ï¼Œæˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡åœ¨ReportFragmentä¸­ä¼šå­˜åœ¨å¯¹è¿™äº›ç”Ÿå‘½å‘¨æœŸçš„å®ç°åŠåˆ†å‘ï¼Œè®©æˆ‘ä»¬æ¥éªŒè¯ä¸‹æˆ‘ä»¬çš„çŒœæµ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REPORT_FRAGMENT_TAG = <span class="string">&quot;androidx.lifecycle&quot;</span></span><br><span class="line">            + <span class="string">&quot;.LifecycleDispatcher.report_fragment_tag&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">injectIfNeededIn</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è§ä¸Šä¸€codepod</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">            <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// private ActivityInitializationListener mProcessListener;</span></span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStart();</span><br><span class="line">        dispatchStart(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_START);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onResume();</span><br><span class="line">        dispatchResume(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_RESUME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onPause();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onStop();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_STOP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        dispatch(Lifecycle.Event.ON_DESTROY);</span><br><span class="line">        <span class="comment">// just want to be sure that we won&#x27;t leak reference to an activity</span></span><br><span class="line">        mProcessListener = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">            <span class="comment">//åªåœ¨API 29ä¹‹å‰çš„APIçº§åˆ«ä¸Šä»ReportFragmentåˆ†æ´¾äº‹ä»¶ã€‚åœ¨API 29+ä¸­ï¼Œ</span></span><br><span class="line">            <span class="comment">//è¿™æ˜¯ç”±reportfragment . injectifneeddinä¸­æ·»åŠ çš„ActivityLifecycleCallbackså¤„ç†çš„</span></span><br><span class="line">            dispatch(getActivity(), event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœç„¶ï¼ŒéªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼Œå¹¶ä» dispatch() ä¸­çš„ä»£ç æ³¨é‡Šæˆ‘ä»¬å¯çŸ¥:</p>
<blockquote>
<p>åªåœ¨API 29ä¹‹å‰çš„APIçº§åˆ«ä¸Šä»ReportFragmentåˆ†æ´¾äº‹ä»¶ã€‚åœ¨API 29+ä¸­ï¼Œè¿™æ˜¯ç”±reportfragment . injectifneeddinä¸­æ·»åŠ çš„ActivityLifecycleCallbackså¤„ç†çš„</p>
</blockquote>
<p>è¿™å¥è¯åŸºæœ¬æ€»ç»“äº†ReportFragmentåœ¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘è¿‡ç¨‹ä¸­çš„æ‰®æ¼”çš„è§’è‰²ï¼Œç»“åˆå‰é¢è®²çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘ï¼Œæˆ‘ä»¬å¯¹äºç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¼ é€’åˆ°åˆ†å‘ç»™å…·ä½“çš„Lifecycleä»¬çš„æµç¨‹åŸºæœ¬å·²ç»æ¸…æ™°äº†ï¼š</p>
<ul>
<li>ActivityThreadäº§ç”Ÿç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¹¶é€šè¿‡Instrumentationå’ŒActivityä¼ é€’æˆ–è°ƒç”¨ Activity.onXXX()</li>
<li>Activityåˆ›å»ºæ—¶(onCreate)ä¼šè¢«æ³¨å…¥ReportFragmentï¼Œè€ŒReportFragmentè´Ÿè´£å°†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„Lifecycle</li>
<li>API29åŠä»¥ä¸Šæ—¶ï¼ŒActivityåœ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸæ—¶ä¼šé€šçŸ¥ Application å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒä¸”è‡ªèº«ä¹ŸåŒæ ·å¤„ç†ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ŒAPI29ä»¥ä¸Šè¿™äº›å›è°ƒå°†ä¼šè¢«ReportFragmentæ¥æ”¶ï¼Œè€ŒAPI29ä»¥ä¸‹åˆ™ç”±FragmentControllerç›´æ¥åˆ†å‘ç»™ReportFragmentã€‚</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å‰©ä¸‹ä¸€ä¸ªé—®é¢˜äº†ï¼ŒReportFragmentåˆ†å‘äº‹ä»¶æ˜¯å¦‚ä½•åˆ°è¾¾æˆ‘ä»¬æ³¨å†Œçš„LifecycleObserverçš„ï¼Ÿ</p>
<h4 id="dispatch-Activity-Lifecycle-Event"><a href="#dispatch-Activity-Lifecycle-Event" class="headerlink" title="dispatch(Activity, Lifecycle.Event);"></a>dispatch(Activity, Lifecycle.Event);</h4><p>æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ReportFragmentä¸­æœ€ç»ˆåˆ†å‘çš„æ–¹æ³•<code>dispatch(Activity, Lifecycle.Event)</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;ReportFragment&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleRegistryOwner) &#123;</span><br><span class="line">        ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activity <span class="keyword">instanceof</span> LifecycleOwner) &#123;</span><br><span class="line">        Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();</span><br><span class="line">        <span class="keyword">if</span> (lifecycle <span class="keyword">instanceof</span> LifecycleRegistry) &#123;</span><br><span class="line">            ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéƒ½ä¼šè°ƒç”¨<code>LifecycleRegistry.handleLifecycleEvent(Lifecycle.Event event)</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLifecycleEvent</span><span class="params">(<span class="meta">@NonNull</span> Lifecycle.Event event)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;handleLifecycleEvent&quot;</span>);</span><br><span class="line">    moveToState(event.getTargetState());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToState</span><span class="params">(State next)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// somethingã€‚ã€‚ã€‚ </span></span><br><span class="line">    sync();</span><br><span class="line">    <span class="comment">// code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">    <span class="keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        backwardPass(lifecycleOwner);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line">    <span class="keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        forwardPass(lifecycleOwner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// // something</span></span><br><span class="line">    observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forwardPass</span><span class="params">(LifecycleOwner lifecycleOwner)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">    observer.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œæ­¤å¤„åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¯»å–LifecycleObserverä¸­çš„è¿è¡Œæ—¶</span></span><br><span class="line">        <span class="comment">// æ³¨è§£@OnLifecycleEventï¼Œä¸ºåç»­åå°„æ–¹æ³•åšå‡†å¤‡</span></span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = event.getTargetState();</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°ï¼Œæ— è®ºå¦‚ä½•ï¼Œæœ€ç»ˆéƒ½ä¼šèµ°åˆ°<code>(ObserverWithState)observer.dispatchEvent(lifecycleOwner, event)</code>, å³æœ€ç»ˆè°ƒç”¨<code>LifecycleObserver.onStateChanged(owner, event)</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleEventObserver</span> <span class="keyword">extends</span> <span class="title">LifecycleObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source, <span class="meta">@NonNull</span> Lifecycle.Event event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ é€šè¿‡<code>Go to implementation(s)</code> å¿«æ·é”® <strong>ã€å¦‚æœ‰ä¸æ¸…æ¥šå¿«æ·é”®çš„ï¼Œè¯·æ‰“å¼€ File -&gt; Settings -&gt; Keymap æœç´¢ Go to implementation(s)ã€‘</strong> æŸ¥çœ‹å…¶å®ç°ä»¥è·Ÿè¿›å…¶æµç¨‹ã€‚<br>æˆ‘ä»¬ä»¥ åå°„é€šç”¨ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿå™¨ <code>ReflectiveGenericLifecycleObserver</code> ä¸ºä¾‹ç»§ç»­è·Ÿè¿›ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; å‘½åç›´è¯‘ä¸º åå°„é€šç”¨ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿå™¨</span><br><span class="line">class ReflectiveGenericLifecycleObserver implements LifecycleEventObserver &#123;</span><br><span class="line">    private final Object mWrapped;</span><br><span class="line">    private final CallbackInfo mInfo;</span><br><span class="line"></span><br><span class="line">    ReflectiveGenericLifecycleObserver(Object wrapped) &#123;</span><br><span class="line">        mWrapped &#x3D; wrapped;</span><br><span class="line">        mInfo &#x3D; ClassesInfoCache.sInstance.getInfo(mWrapped.getClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onStateChanged(@NonNull LifecycleOwner source, @NonNull Event event) &#123;</span><br><span class="line">        mInfo.invokeCallbacks(source, event, mWrapped);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé€šè¿‡å§”æ‰˜ CallbackInfo å»æ‰§è¡ŒCallback ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static class CallbackInfo &#123;</span><br><span class="line">    &#x2F;&#x2F; something</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;ConstantConditions&quot;)</span><br><span class="line">    void invokeCallbacks(LifecycleOwner source, Lifecycle.Event event, Object target) &#123;</span><br><span class="line">        invokeMethodsForEvent(mEventToHandlers.get(event), source, event, target);</span><br><span class="line">        invokeMethodsForEvent(mEventToHandlers.get(Lifecycle.Event.ON_ANY), source, event,</span><br><span class="line">                target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void invokeMethodsForEvent(List&lt;MethodReference&gt; handlers,</span><br><span class="line">            LifecycleOwner source, Lifecycle.Event event, Object mWrapped) &#123;</span><br><span class="line">        if (handlers !&#x3D; null) &#123;</span><br><span class="line">            for (int i &#x3D; handlers.size() - 1; i &gt;&#x3D; 0; i--) &#123;</span><br><span class="line">                handlers.get(i).invokeCallback(source, event, mWrapped);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static final class MethodReference &#123;</span><br><span class="line">   &#x2F;&#x2F; something</span><br><span class="line"></span><br><span class="line">    void invokeCallback(LifecycleOwner source, Lifecycle.Event event, Object target) &#123;</span><br><span class="line">        &#x2F;&#x2F;noinspection TryWithIdenticalCatches</span><br><span class="line">        try &#123;</span><br><span class="line">            switch (mCallType) &#123;</span><br><span class="line">                case CALL_TYPE_NO_ARG:</span><br><span class="line">                    mMethod.invoke(target);</span><br><span class="line">                    break;</span><br><span class="line">                case CALL_TYPE_PROVIDER:</span><br><span class="line">                    mMethod.invoke(target, source);</span><br><span class="line">                    break;</span><br><span class="line">                case CALL_TYPE_PROVIDER_WITH_EVENT:</span><br><span class="line">                    mMethod.invoke(target, source, event);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            throw new RuntimeException(&quot;Failed to call observer method&quot;, e.getCause());</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; something</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒCallbackInfo.invokeCallbacks æœ€ç»ˆè°ƒç”¨ MethodReference.invokeCallback() é€šè¿‡åå°„å®Œæˆæœ€ç»ˆè°ƒç”¨ï¼Œå…¶å®è‡³æ­¤ï¼Œæ•´ä¸ªæµç¨‹å°±ä»¥å®Œç»“ã€‚</p>
<p>ä½†æ˜¯ï¼ï¼ï¼</p>
<p>æ­¤æ—¶æœ‰ä¸€ä¸ªç–‘é—®ï¼Œè¿™äº›è¿™é‡Œåå°„ä½¿ç”¨çš„æ–¹æ³•æ˜¯å“ªé‡Œè·å–çš„ï¼Œä¸ºä»€ä¹ˆä»–èƒ½æ‰¾åˆ°æˆ‘ä»¬æ·»åŠ äº†@OnLifecycleEventæ³¨è§£çš„æ–¹æ³•ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>æ¥ï¼Œè®©æˆ‘ä»¬åå‘æŸ¥æ‰¾ä¸€ä¸‹ï¼Œ æ—¢ç„¶ä»–ç”¨äº†CallbackInfoï¼Œæˆ‘ä»¬æ¥æ‰¾æ‰¾ä»å“ªé‡Œåˆ›å»ºäº†CallbackInfoï¼Œæˆ‘ä»¬ä»”ç»†å¯»æ‰¾ä¸€ä¸‹ CallbackInfoæ‰€åœ¨çš„classæ–‡ä»¶ï¼Œå˜¿ï¼Œå°±åœ¨å†…éƒ¨ç±» CallbackInfoå®šä¹‰çš„ä¸Šé¢ä¸€è¡Œ~ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CallbackInfo <span class="title">createInfo</span><span class="params">(Class&lt;?&gt; klass, <span class="meta">@Nullable</span> Method[] declaredMethods)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; superclass = klass.getSuperclass();</span><br><span class="line">    Map&lt;MethodReference, Lifecycle.Event&gt; handlerToEvent = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (superclass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        CallbackInfo superInfo = getInfo(superclass);</span><br><span class="line">        <span class="keyword">if</span> (superInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            handlerToEvent.putAll(superInfo.mHandlerToEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] interfaces = klass.getInterfaces();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; intrfc : interfaces) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;MethodReference, Lifecycle.Event&gt; entry : getInfo(</span><br><span class="line">                intrfc).mHandlerToEvent.entrySet()) &#123;</span><br><span class="line">            verifyAndPutHandler(handlerToEvent, entry.getKey(), entry.getValue(), klass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–classä¸­çš„æ–¹æ³•</span></span><br><span class="line">    Method[] methods = declaredMethods != <span class="keyword">null</span> ? declaredMethods : getDeclaredMethods(klass);</span><br><span class="line">    <span class="keyword">boolean</span> hasLifecycleMethods = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// éå†æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°æ–¹æ³•çš„OnLifecycleEventæ³¨è§£</span></span><br><span class="line">        OnLifecycleEvent annotation = method.getAnnotation(OnLifecycleEvent.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hasLifecycleMethods = <span class="keyword">true</span>;</span><br><span class="line">        Class&lt;?&gt;[] params = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">int</span> callType = CALL_TYPE_NO_ARG;</span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            callType = CALL_TYPE_PROVIDER;</span><br><span class="line">            <span class="keyword">if</span> (!params[<span class="number">0</span>].isAssignableFrom(LifecycleOwner.class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;invalid parameter type. Must be one and instanceof LifecycleOwner&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span></span><br><span class="line">        Lifecycle.Event event = annotation.value();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            callType = CALL_TYPE_PROVIDER_WITH_EVENT;</span><br><span class="line">            <span class="keyword">if</span> (!params[<span class="number">1</span>].isAssignableFrom(Lifecycle.Event.class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;invalid parameter type. second arg must be an event&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (event != Lifecycle.Event.ON_ANY) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">&quot;Second arg is supported only for ON_ANY value&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (params.length &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;cannot have more than 2 params&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°è£…æˆMethodReferenceä»¥å¾…ä½¿ç”¨</span></span><br><span class="line">        MethodReference methodReference = <span class="keyword">new</span> MethodReference(callType, method);</span><br><span class="line">        <span class="comment">// æ ¡éªŒåŠå­˜å‚¨ MethodReference</span></span><br><span class="line">        verifyAndPutHandler(handlerToEvent, methodReference, event, klass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è£…æˆ CallbackInfo ä»¥å¾…ä½¿ç”¨</span></span><br><span class="line">    CallbackInfo info = <span class="keyword">new</span> CallbackInfo(handlerToEvent);</span><br><span class="line">    <span class="comment">// å­˜å‚¨ CallbackInfo</span></span><br><span class="line">    mCallbackMap.put(klass, info);</span><br><span class="line">    mHasLifecycleMethods.put(klass, hasLifecycleMethods);</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸€ç®©ç­ï¼Œçœ‹èµ·æ¥å“äººï¼Œå®é™…å‡ å¥è¯ï¼Œæˆ‘ä»¬ç®€å•è§£é‡Šä¸€ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>è·å–classä¸­çš„æ–¹æ³• ã€æ­¤å¤„classå®ä¸ºæˆ‘ä»¬å®šä¹‰çš„LifecycleObserverï¼Œæ¥è‡ªäºaddObserverã€‘</li>
<li>éå†æ–¹æ³•<ul>
<li>æ‹¿åˆ°æ–¹æ³•çš„OnLifecycleEventæ³¨è§£</li>
<li>è·å–å…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
<li>å°è£…æˆMethodReferenceä»¥å¾…ä½¿ç”¨</li>
<li>æ ¡éªŒåŠå­˜å‚¨ MethodReference</li>
</ul>
</li>
<li>å°è£…æˆ CallbackInfo ä»¥å¾…ä½¿ç”¨</li>
<li>å­˜å‚¨ CallbackInfo</li>
</ul>
<p>æˆ‘ä»¬ç»§ç»­å…³æ³¨ï¼Œæ˜¯å“ªé‡Œè°ƒç”¨ä»–çš„å‘¢ï¼Ÿï¼Ÿ</p>
<p>å‘å‰å‘å‰ï¼šClassesInfoCache.hasLifecycleMethods()<br>ç»§ç»­å‘å‰ï¼šLifecycling.resolveObserverCallbackType()<br>         -&gt; Lifecycling.getObserverConstructorType()<br>         -&gt; Lifecycling.lifecycleEventObserver()</p>
<p>å˜¿ï¼Œä¼¼ä¹æœ‰ç‚¹çœ¼ç†Ÿï¼Œæ²¡é”™ï¼Œåœ¨å‰é¢æµç¨‹ä¸­è°ƒç”¨ LifecycleRegistry.ObserverWithState.dispatchEvent()æ—¶ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ä¸­æˆ‘ä»¬è§è¿‡è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@link</span>&#123;LifecycleRegistry.ObserverWithState&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverWithState</span> </span>&#123;</span><br><span class="line">    State mState;</span><br><span class="line">    LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">    ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œè¿™é‡Œ</span></span><br><span class="line">        mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">        mState = initialState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dispatchEvent</span><span class="params">(LifecycleOwner owner, Event event)</span> </span>&#123;</span><br><span class="line">        State newState = event.getTargetState();</span><br><span class="line">        mState = min(mState, newState);</span><br><span class="line">        mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">        mState = newState;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŸ¥æ‰¾å®ƒçš„è°ƒç”¨æ—¶æœºå‘ç°ï¼Œåœ¨ addObserverä¸­æœ‰è°ƒç”¨å…¶åˆå§‹åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span> </span>&#123;</span><br><span class="line">    enforceMainThreadIfNeeded(<span class="string">&quot;addObserver&quot;</span>);</span><br><span class="line">    State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">    <span class="comment">// åˆ›å»º ObserverWithState</span></span><br><span class="line">    ObserverWithState statefulObserver = <span class="keyword">new</span> ObserverWithState(observer, initialState);</span><br><span class="line">    ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line">   <span class="comment">// something</span></span><br><span class="line">        statefulObserver.dispatchEvent(lifecycleOwner, event);</span><br><span class="line">    <span class="comment">// something</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isReentrance) &#123;</span><br><span class="line">        <span class="comment">// we do sync only on the top level.</span></span><br><span class="line">        sync();</span><br><span class="line">    &#125;</span><br><span class="line">    mAddingObserverCounter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„æ•´ä¸ªæµç¨‹ç®—æ˜¯å®Œå…¨èµ°é€šäº†ï¼š</p>
<p><strong>æ³¨å†Œæ—¶addObserver</strong></p>
<ul>
<li>ç¼–å†™LifecycleObserverå¹¶é€šè¿‡ Lifecycle.addObserveræ–¹æ³•å°†è§‚å¯Ÿè€…æ³¨å†Œåˆ°LifecycleRegistry</li>
<li>LifecycleRegistryé€šè¿‡ ObserverWithState è°ƒç”¨ Lifecycling æœ€ç»ˆé€šè¿‡åå°„è·å–LifecycleObserverä¸­å…³æ³¨ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•å’Œå…³æ³¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°è£…æˆMethodReferenceå’ŒCallbackInfoå¹¶ç¼“å­˜</li>
<li>ObserverWithState.dispatchEvent() åˆ†å‘å½“å‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
</ul>
<p><strong>ç”Ÿå‘½å‘¨æœŸå˜åŒ–æ—¶</strong></p>
<ul>
<li>ActivityThreadé€šçŸ¥Activityï¼ŒActivityï¼ˆæ— è®ºä½•ç§æ–¹å¼ï¼‰é€šçŸ¥ ReportFragment</li>
<li>ReportFragmentè°ƒç”¨ LifecycleRegistry.handleLifecycleEvent(event)</li>
<li>LifecycleRegistryç»è¿‡ moveToState() -&gt; sync() -&gt; backwardPass()/forwardPass() æœ€ç»ˆè°ƒç”¨ObserverWithState.dispatchEvent()</li>
<li>ObserverWithState.dispatchEvent() è°ƒç”¨LifecycleObserver.onStateChanged() é€šçŸ¥ CallbackInfo é€šè¿‡åå°„æ‰§è¡Œå¯¹åº”æ–¹æ³•</li>
<li>CallbackInfo.invokeCallbacks()æŸ¥æ‰¾åˆ°å¯¹åº”ç”Ÿå‘½å‘¨æœŸçš„ MethodReference ç¼“å­˜ï¼Œé€šè¿‡Method.invoke()è°ƒç”¨ï¼Œæœ€ç»ˆæ‰§è¡ŒLifecycleObserverä¸­å…³æ³¨å¯¹åº”ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ•´ç†ä¸€ä¸‹ç”»ä¸€ä¸ªæ—¶åºå›¾ï¼š</p>
<p><img src="https://s3.ax1x.com/2021/03/01/6i7Ubj.png" alt="Lifecycleæ—¶åºå›¾.png"></p>
<h3 id="é™„-ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬"><a href="#é™„-ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬" class="headerlink" title="é™„ - ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬"></a>é™„ - ProcessLifecycleOwneræ˜¯å¦‚ä½•å®ç°åº”ç”¨å‰åå°ç›‘å¬</h3><p>åœ¨ lifecycle-process.aarä¸­å­˜åœ¨AndroidManifest.xmlæ–‡ä»¶ï¼Œå…¶ä¸­æ³¨å†Œäº†ä¸€ä¸ªproviderç»„ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">    &lt;provider</span><br><span class="line">        android:name=&quot;androidx.lifecycle.ProcessLifecycleOwnerInitializer&quot;</span><br><span class="line">        android:authorities=&quot;$&#123;applicationId&#125;.lifecycle-process&quot;</span><br><span class="line">        android:exported=&quot;false&quot;</span><br><span class="line">        android:multiprocess=&quot;true&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessLifecycleOwnerInitializer</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LifecycleDispatcher.init(getContext());</span><br><span class="line">        ProcessLifecycleOwner.init(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»„ä»¶åœ¨åˆ›å»ºæ—¶æœºåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œå…¶onCreateä¸­åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>LifecycleDispatcher.init(getContext()) å‘Applicationä¸­æ³¨å†Œç”Ÿå‘½å‘¨æœŸäº‹ä»¶ç›‘å¬</li>
<li>ProcessLifecycleOwner.init(getContext()) å‘ProcessLifecycleOwnerä¸­ç»‘å®šApplicationï¼Œä¸”ä¸ºReportFragmentæ·»åŠ ActivityInitializationListenerã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mHandler = <span class="keyword">new</span> Handler();</span><br><span class="line">    mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    Application app = (Application) context.getApplicationContext();</span><br><span class="line">    app.registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</span><br><span class="line">        <span class="meta">@RequiresApi(29)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPreCreated</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// log</span></span><br><span class="line">            activity.registerActivityLifecycleCallbacks(<span class="keyword">new</span> EmptyActivityLifecycleCallbacks() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostStarted</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">                    activityStarted();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPostResumed</span><span class="params">(<span class="meta">@NonNull</span> Activity activity)</span> </span>&#123;</span><br><span class="line">                    activityResumed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Activity activity, Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// log</span></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">29</span>) &#123;</span><br><span class="line">                <span class="comment">// æ³¨æ„æ­¤å¤„ï¼Œä¸ºReportFragmentæ·»åŠ ActivityInitializationListener</span></span><br><span class="line">                ReportFragment.get(activity).setProcessListener(mInitializationListener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityPaused</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„æ­¤å¤„</span></span><br><span class="line">            activityPaused();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityStopped</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">             <span class="comment">// æ³¨æ„æ­¤å¤„</span></span><br><span class="line">            activityStopped();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‘ç°è¿™é‡Œä¸ºApplicationæ·»åŠ äº†ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œæ­¤ç›‘å¬åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>åˆ›å»ºéƒ¨åˆ†åˆ†åˆ«ä¸º api29ä»¥ä¸‹å’ŒAPI29åŠä»¥ä¸Š æ³¨å†Œäº†ç›‘å¬</li>
<li>åœæ­¢éƒ¨åˆ†è°ƒç”¨äº†å†…éƒ¨æ–¹æ³•activityPausedå’ŒactivityStopped</li>
</ul>
<p>ç”±å‰æ–‡å¯çŸ¥ï¼Œç”Ÿå‘½å‘¨æœŸå˜åŒ–æ˜¯ä¼šé€šçŸ¥å›è°ƒï¼Œæœ€ç»ˆä¼šé€šçŸ¥ReportFragmentï¼Œåœ¨å‰é¢ä»‹ç»ç”Ÿå‘½å‘¨æœŸåˆ†å‘è¿‡ç¨‹ä¸­ReportFragmentä¸­æœ‰ä¸€éƒ¨åˆ†å…³äºActivityInitializationListener æˆ‘æ²¡æœ‰ä»‹ç»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportFragment</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">app</span>.<span class="title">Fragment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityInitializationListener mProcessListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchCreate</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onCreate();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchStart</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onStart();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchResume</span><span class="params">(ActivityInitializationListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onResume();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">        <span class="comment">// ä¼šé€šçŸ¥ç›‘å¬å™¨ï¼Œå…¶ä»–ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯å¦‚æ­¤</span></span><br><span class="line">        dispatchCreate(mProcessListener);</span><br><span class="line">        dispatch(Lifecycle.Event.ON_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// others</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ProcessLifecycleOwnerä¸ºReportFragmentæ·»åŠ  ActivityInitializationListenerï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸå˜åŒ–æ˜¯ä¼šé€šçŸ¥ProcessLifecycleOwnerä¸­çš„ActivityInitializationListenerå¯¹è±¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ActivityInitializationListener mInitializationListener &#x3D;</span><br><span class="line">            new ActivityInitializationListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onCreate() &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onStart() &#123;</span><br><span class="line">                    activityStarted();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                public void onResume() &#123;</span><br><span class="line">                    activityResumed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line"> void activityStarted() &#123;</span><br><span class="line">        mStartedCounter++;</span><br><span class="line">        if (mStartedCounter &#x3D;&#x3D; 1 &amp;&amp; mStopSent) &#123;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);</span><br><span class="line">            mStopSent &#x3D; false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityResumed() &#123;</span><br><span class="line">        mResumedCounter++;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            if (mPauseSent) &#123;</span><br><span class="line">                mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</span><br><span class="line">                mPauseSent &#x3D; false;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mHandler.removeCallbacks(mDelayedPauseRunnable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityPaused() &#123;</span><br><span class="line">        mResumedCounter--;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            mHandler.postDelayed(mDelayedPauseRunnable, TIMEOUT_MS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void activityStopped() &#123;</span><br><span class="line">        mStartedCounter--;</span><br><span class="line">        dispatchStopIfNeeded();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void dispatchPauseIfNeeded() &#123;</span><br><span class="line">        if (mResumedCounter &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            mPauseSent &#x3D; true;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_PAUSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void dispatchStopIfNeeded() &#123;</span><br><span class="line">        if (mStartedCounter &#x3D;&#x3D; 0 &amp;&amp; mPauseSent) &#123;</span><br><span class="line">            mRegistry.handleLifecycleEvent(Lifecycle.Event.ON_STOP);</span><br><span class="line">            mStopSent &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»£ç å¯çŸ¥ï¼Œåœ¨å±•ç¤ºæ—¶è°ƒç”¨ activityStarted å’Œ activityResumed å¹¶ä½œè®¡æ•°é€’å¢ï¼Œåœ¨åœæ­¢æ—¶è°ƒç”¨ activityPaused å’Œ activityStopped åšè®¡æ•°é€’å‡ï¼Œå¹¶åˆ¤æ–­è®¡æ•°æ˜¯å¦ä¸º0ï¼Œ ä¸ºé›¶åˆ™æ‰§è¡Œ LifecycleRegistry.handleLifecycleEvent é€šçŸ¥åˆ°æˆ‘ä»¬æ³¨å†Œçš„ LifecycleObserverï¼Œ å…¶é€šçŸ¥æµç¨‹ä¸Activityç”Ÿå‘½å‘¨æœŸåˆ†å‘åˆ°LifecycleObserverä¸€è‡´ã€‚</p>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªæµç¨‹ç»“æŸã€‚</p>
]]></content>
      <categories>
        <category>Jetpack</category>
      </categories>
      <tags>
        <tag>Lifecycle</tag>
      </tags>
  </entry>
</search>
